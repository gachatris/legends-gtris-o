const audioMaster=new class{constructor(){this.ctx=new(window.AudioContext||window.webkitAudioContext)({latencyHint:"interactive"}),this.gain=this.ctx.createGain(),this.gain.connect(this.ctx.destination),this.gain.gain.value=1,this.buffers={},this.globalCounter=0,this.playbacks={}}Audio=class{constructor(parent,parameters){this.parameters=parameters,this.parent=parent,this.gain=this.parent.ctx.createGain(),this.gain.connect(this.parent.gain),this.buffer=null,this.duration=0,this.seekTime=0,this.isReady=!1,this.isPlaying=!1,this.playbacks=[],this.listeners={}}load(){return new Promise(async res=>{if(this.parameters.src){if(this.parameters.src in this.parent.buffers)this.buffer=this.parent.buffers[this.parameters.src];else{let array=await memoryManager.asyncLoad(this.parameters.src,"blob",!0),ab=await array.arrayBuffer(),buffer=await this.parent.ctx.decodeAudioData(ab);this.buffer=buffer,this.parent.buffers[this.parameters.src]=buffer}this.duration=this.buffer.duration,this.isReady=!0,res()}})}async loadSync(callback){if(!this.parameters.arrayBuffer)return;let buffer=await this.parent.ctx.decodeAudioData(this.parameters.arrayBuffer);this.buffer=buffer,this.parent.buffers[this.parameters.src]=buffer,this.duration=this.buffer.duration,this.isReady=!0,callback()}volume(value){this.gain.gain.value=value}play(parameters){parameters=parameters||{};let now=this.parent.ctx.currentTime;if(!this.isReady)return;let source=this.parent.ctx.createBufferSource(),pan=this.parent.ctx.createPanner();pan.connect(this.gain),source.connect(pan),source.buffer=this.buffer,pan.value="pan"in parameters?parameters?.pan:0,source.loop=this.parameters.loop,source.playbackRate.value=parameters?.rate||1,source.start("when"in parameters?parameters?.when:now+("delay"in parameters?parameters?.delay:0),parameters?.seek||void 0,parameters?.duration||void 0);let id=this.parent.globalCounter;this.parent.globalCounter++,this.playbacks.push(id),this.isPlaying=!0;let h={id:id,source:source,gain:this.gain,pan:pan.pan,rate:source.playbackRate};return this.parent.playbacks[id]=h,source.addEventListener("ended",()=>{delete this.parent.playbacks[id],this.playbacks.shift(),0==this.playbacks.length&&(this.isPlaying=!1)}),h}stop(){let now=this.parent.ctx.currentTime;for(let f of this.playbacks)this.parent.playbacks[f].source.stop(now)}rate(value){for(let f of this.playbacks)this.parent.playbacks[f].source.playbackRate.value=void 0!==value?value:1}unload(){}checkPlaying(){return this.isPlaying}once(event,func){}};createAudio(p){return new this.Audio(this,p)}getPlaybackById(id){return id in this.playbacks?this.playbacks[id]:null}suspendResume(sr){sr?this.ctx.suspend():this.ctx.resume()}};addEventListener("click",()=>{"suspended"===audioMaster.ctx.state&&audioMaster.ctx.resume()},{once:!0}),addEventListener("keydown",()=>{"suspended"===audioMaster.ctx.state&&audioMaster.ctx.resume()},{once:!0});let memoryManager=new class{constructor(){this.mem={},this.loadMax=0,this.loaded=0,this.ready=!0,this.waitingQueue={},this.loadTimes={}}#checkLoad(count,max){}directAsyncLoad(url,type){return new Promise(async(resolve,reject)=>{let a;a="image"==type?await loadImage(path):await load(path,type),resolve(a)})}async _fetch(path,type){this.mem[path]={a:null,isLoaded:!1};let a=null;path in this.loadTimes||(this.loadTimes[path]=0),this.loadTimes[path]++;try{a="image"==type?await loadImage(path):await load(path,type)}catch(e){}let g=this.mem[path];g.a=a,g.isLoaded=!0;for(let h of this.waitingQueue[path])h();delete this.waitingQueue[path]}syncLoad(path,type,func){if(!func)throw"The load method of Memory Manager needs the func argument provided.";path in this.mem?path in this.waitingQueue?this.waitingQueue[path].push(()=>{func(this.mem[path].a)}):this.mem[path].isLoaded?func(this.mem[path].a):this.waitingQueue[path]=[()=>{func(this.mem[path].a)}]:(this.waitingQueue[path]=[()=>{func(this.mem[path].a)}],this._fetch(path,type,func))}asyncLoad(path,type){return new Promise((res,rej)=>{path in this.mem?path in this.waitingQueue?this.waitingQueue[path].push(()=>{res(this.mem[path].a)}):this.mem[path].isLoaded?res(this.mem[path].a):this.waitingQueue[path]=[()=>{res(this.mem[path].a)}]:(this.waitingQueue[path]=[()=>{res(this.mem[path].a)}],this._fetch(path,type))})}};function $(gid){return document.getElementById(gid)}__main_params__.__private.memoryManager=memoryManager;const id=$,bitwiseSL=pos=>1<<pos,generateUUID=function(){let uuid="";for(let u=0;u<32;u++)u%4==0&&~~(u/4)>=2&&~~(u/4)<=5&&(uuid+="-"),uuid+="0123456789abcdef"[~~(16*Math.random())];return uuid},elem=function(el,func){func(document.createElement(el))},style=function(i,prop,val){let a=$(i).style;a[prop]!==val&&(a[prop]=val)},ih=function(i,val){$(i).innerHTML!==val&&($(i).innerHTML=val)},iha=function(i,val){$(i).innerHTML+=val},ihelem=function(i,val){i.innerHTML!==val&&(i.innerHTML=val)},createSVG=function(width,height,innerhtml){let a=document.createElementNS("http://www.w3.org/2000/svg","svg");return a.setAttribute("width",width),a.setAttribute("height",height),a.setAttribute("xmlns","http://www.w3.org/2000/svg"),a},ihaelem=function(i,val){i.innerHTML+=val},styleelem=function(i,prop,val){let a=i.style;a[prop]!==val&&(a[prop]=val)},stylepropelem=function(i,prop,val){i.style.setProperty(prop,val)};class ParkMillerPRNG{constructor(){this.seed=1}next(){return this.gen()/2147483647}gen(){return this.seed=16807*this.seed%2147483647}}const grid=function(x,y,val){let a=[];for(let e=0;e<x;e++){a.push([]);for(var f=0;f<y;f++)a[e][f]=val}return a},getCanvasCtx=function(canvas){return canvas.getContext("2d")},clientRect=function(f,type){return $(f).getBoundingClientRect()[type]},asyncPromise=function(func){return new Promise((res,rej)=>{func(res,rej)})},arrayModifyBatch=function(arr,func){let j=arr;for(let h=0,b=j.length;h<b;h++)func(j[h])};function bezier(t,start,end,initial,p1,p2,final){return start+(end-start)*((1-t)*(1-t)*(1-t)*initial+3*(1-t)*(1-t)*t*p1+3*(1-t)*t*t*p2+t*t*t*final)}function bezier1D(t,s1,s2){const u=1-t;return u*u*u*0+3*u*u*t*s1+3*u*t*t*s2+t*t*t*1}function sortRandomInt(array,randint){for(var i=0;i<array.length-1;i++){var temp=array[i],rand=~~((array.length-i)*randint())+i;array[i]=array[rand],array[rand]=temp}}function step(x,ratio,min){return min+~~(x/(1/ratio))/ratio}function radians(deg){return deg*(Math.PI/180)}function degrees(rad){return rad*(Math.PI/180)}function hexToRGB(hex){return{r:~~(hex%16777216/65536),g:~~(hex%65536/256),b:hex%256}}const blobToBase64=function(blob){return new Promise((call,rej)=>{var reader=new FileReader;reader.readAsDataURL(blob),reader.onloadend=function(){var base64=reader.result;call(base64)}})};class ArrayFunctionIterator{constructor(func){this.arr=[],this.func=func}update(){this.func(this.arr)}addItem(item){this.arr.push(item)}getItem(index){return this.arr[index]}reset(){this.arr=[]}}class ObjectFunctionIterator{constructor(func){this.obj={},this.func=func}update(){this.func(this.obj)}addItem(key,item){this.obj[key]=item}getItem(key){return this.obj[key]}remove(key){delete this.obj[key]}reset(){for(let h in this.obj)delete this.obj[h]}}class NumberChangeFuncExec{constructor(a,func){this.a=a,this.last=a,this.func=(m,arg)=>{func(m,arg)}}add(num,arg){this.a+=num,this.a!==this.last&&(this.last=this.a,this.func(this.a,arg))}assign(val,arg){val!==this.a&&(this.a=val,this.last=this.a,this.func(this.a,arg))}execute(arg){this.func(this.a,arg)}getNumber(){return this.a}}class ChangeFuncExec{constructor(a,func){this.a=a,this.last=a,this.func=(m,arg)=>{func(m,arg)}}assign(val,arg){val!==this.a&&(this.a=val,this.last=this.a,this.func(this.a,arg))}execute(arg){this.func(this.a,arg)}getA(){return this.a}}class MeterBar extends NumberChangeFuncExec{#bar;#meter;constructor(){super(0,a=>{for(let m of this.#bar)styleelem(m,"height",`${Math.max(0,this.height*(1-a))}px`)}),this.cellSize=0,this.isEnable=!1}resize(cellSize,w,h){this.cellSize=cellSize,this.width=this.cellSize*w,this.height=this.cellSize*h;for(let a of[this.#meter])styleelem(a,"width",`${this.width}px`),styleelem(a,"height",`${this.height}px`);for(let m of this.#bar)styleelem(m,"height",`${Math.max(0,this.height*(1-this.a))}px`)}toggle(bool){this.isEnable=bool,styleelem(this.#meter,"opacity",this.isEnable?"100%":"0%")}initialize(meter,bar){this.#meter=meter,this.#bar=bar}}class MultipleMeterBar{#bars;#meter;#ClusteredBar=class{constructor(parent){this.parent=parent,this.bar=document.createElement("GTRIS-NONR"),this.base=new NumberChangeFuncExec(0,a=>{styleelem(this.bar,"height",`${Math.max(0,this.parent.height*(1-a))}px`)})}};constructor(num){this.cellSize=0,this.#bars=[],this.width=1*this.cellSize,this.height=1*this.cellSize,this.isEnable=!1;for(let h=0;h<num;h++)this.#bars[h]=new this.#ClusteredBar(this)}toggle(bool){this.isEnable=bool,styleelem(this.#meter,"opacity",this.isEnable?"100%":"0%")}resize(cellSize,w,h){this.cellSize=cellSize,this.width=this.cellSize*w,this.height=this.cellSize*h;for(let a of[this.#meter])styleelem(a,"width",`${this.width}px`),styleelem(a,"height",`${this.height}px`);for(let m of this.#bars)styleelem(m.bar,"height",`${Math.max(0,this.height*(1-m.base.a))}px`)}initialize(meter,bar){this.#meter=meter;let i=0;for(let h of bar)this.#bars[i].bar=h,i++}assign(am){for(let h=0;h<am.length;h++)this.#bars[h].base.assign(am[h])}}class GIFRenderer{#canvas;#ctx;#target;constructor(width,height,frameWidth,frameHeight,fps,func,updateFunc,isLoop){this.images=[],this.frame={x:0,y:0,w:frameWidth,h:frameHeight},this.dim={w:width,h:height},this.origDim={w:width,h:height},this.frameCount=0,this.actualFrames=0,this.func=func,this.func2=updateFunc,this.fps=fps,this.frameDelay=fps,this.enabled=!1,this.isLoop=isLoop}initialize(target){this.#target=target}loadImages(arr){let len=arr.length;this.dim.h=this.origDim.h*len;for(let e of arr)this.images.push(e)}getCanvas(){return this.#canvas}run(){this.enabled&&(this.actualFrames++,this.frameDelay>0?this.frameDelay--:(this.frameDelay=this.fps,this.func(this.#target,this.images[this.frame.y],this.frame.x,0,this.frame.w,this.frame.h,this.frameCount,this)),void 0!==this.func2&&this.func2(this.actualFrames),this.isLoop&&(this.actualFrames=0))}exec(y,x){this.enabled=!0,this.frame.x=x||0,this.frame.y=y,this.frameDelay=this.fps,this.frameCount=0,this.actualFrames=0}immediateExec(y){this.enabled=!0,this.frame.x=0,this.frame.y=y,this.frameDelay=this.fps,this.frameCount=0,this.actualFrames=0,this.run()}}class FrameRenderer{constructor(initial,max,func,addFunc,loop){this.inititalFrame=initial,this.frame=initial,this.maxFrame=max,this.func=func,this.enabled=!1,this.addFunc=addFunc,this.isLoop=loop||!1}run(){this.enabled&&(this.func(this.frame,this.maxFrame,this),void 0!==this.addFunc&&this.addFunc(),this.frame++,this.frame>=this.maxFrame&&(this.isLoop?this.frame=0:this.enabled=!1))}setFrame(max){this.maxFrame=max}reset(initial){this.frame=void 0!==initial?initial:this.inititalFrame,this.enabled=!0}toggleEnable(bool){this.enabled=bool}}class EndlessFrameRenderer{constructor(initial,max,func,addFunc,loop){this.inititalFrame=initial,this.frame=initial,this.maxFrame=max,this.func=func,this.enabled=!1,this.addFunc=addFunc,this.isLoop=loop||!1}run(){this.enabled&&(this.func(this.frame,this.maxFrame,this),void 0!==this.addFunc&&this.addFunc(),this.frame++,this.frame>=this.maxFrame&&(this.isLoop?this.frame=0:this.enabled=!1))}setFrame(max){this.maxFrame=max}reset(initial){this.frame=void 0!==initial?initial:this.inititalFrame,this.enabled=!0}toggleEnable(bool){this.enabled=bool}}class AnimationFrameRenderer{constructor(element,initial,max,fps,param,addFunc){this.param=param||{};let paramDel="delay"in param?param.delay:0;this.a=new FrameRenderer(initial,max+paramDel,(frame,maxFrame)=>{maxFrame-Math.max(0,frame-paramDel)>=0&&styleelem(this.element,"animation-delay",~~(1e3/-60*Math.min(maxFrame,Math.max(frame+1-paramDel,1)))+"ms")},addFunc,"loop"in param&&param.loop),this.element=element,this.fps=fps,this.max=max,this.isLoop="loop"in param&&param.loop,this.delay=paramDel}play(){this.element.offsetHeight,styleelem(this.element,"animation-name",this.param.name),styleelem(this.element,"animation-duration",~~(this.fps*this.max)+"ms"),styleelem(this.element,"animation-timing-function",this.param.timing),styleelem(this.element,"animation-iteration-count",this.isLoop?"infinite":"1"),styleelem(this.element,"animation-play-state","paused"),this.a.reset()}run(){this.a.run()}setFrame(max){this.max=max,this.a.setFrame(max+this.delay)}reset(){styleelem(this.element,"animation-name","none"),this.a.toggleEnable(!1)}}class FrameRendererSet{constructor(arr,playName,stopName,runName){this.obj={},this.length=0,this.names=[];for(let k=0;k<arr.length;k++){let ref=arr[k];this.length++,this.obj[ref.name]=ref.a,this.names.push(ref.name)}this.function=playName,this.malfunction=stopName,this.runfunction=runName}play(name){this.obj[name][this.function]()}stop(name){this.obj[name][this.malfunction]()}stopAll(){for(let me=0;me<this.length;me++){let name=this.names[me];this.obj[name][this.malfunction]()}}run(){for(let me=0;me<this.length;me++){let name=this.names[me];this.obj[name][this.runfunction]()}}}class TextToHTMLLetterSeparator{constructor(){this.a=[],this.text=""}setSeparatedText(element,text){if(this.text===text)return null;if(!(element instanceof HTMLElement))throw new DOMException("What the heck? Argument 'element' is not an HTMLElement.");this.a.length=0;let a=text.split(""),em=element,b=a.length;ihelem(em,"");for(let i=0;i<b;i++){let m=document.createElement("GTRIS-TS-LETTER");m.innerHTML=" "===a[i]?"&nbsp":a[i],styleelem(m,"display","inline-block");let am=`TTHTMLELEMENT-${btoa(Math.random()*Math.random()*9)}`;m.id=am,this.a.push(m),element.append(m)}}}class DateSynchronizedLoopHandler{constructor(fps,func){this.actualFrames=0,this.isRunning=!1,this.fps=fps,this.startTime=0,this.run=func,this.speed=1,this.c=0,this.isAsynchronous=!1,this.confirmIsAsync=!1,this.raf={startTime:0,addup:0,lagIterationLimit:5}}#asyncRun(_timestamp){if(this.isRunning){for(this.raf.startTime||(this.raf.startTime=_timestamp),this.raf.addup+=_timestamp-this.raf.startTime,this.raf.startTime=_timestamp;this.raf.addup>=1e3/this.fps;)for(this.raf.addup-=1e3/this.fps,this.c+=this.speed;this.c>=1;){try{this.run()}catch(e){console.error(e,e.stack)}this.c--}this.confirmIsAsync!==this.isAsynchronous&&(this.isAsynchronous=this.confirmIsAsync,this.isAsynchronous||(this.startSyncLoop(!0),this.raf.startTime=0)),this.isAsynchronous?window.requestAnimationFrame(timestamp=>{this.#asyncRun(timestamp)}):this.raf.startTime=0}}startSyncLoop(t){this.isRunning&&!t||(this.startTime=performance.now(),this.actualFrames=0,this.interval=setInterval(()=>{let syncFrames=Math.floor(performance.now()-this.startTime)/(1e3/this.fps)-this.actualFrames;for(let i=0;i<syncFrames&&this.isRunning;i++,this.actualFrames++)for(this.confirmIsAsync!==this.isAsynchronous&&(this.isAsynchronous=this.confirmIsAsync,this.isAsynchronous&&(clearInterval(this.interval),window.requestAnimationFrame(timestamp=>{this.raf.startTime=0,this.#asyncRun(timestamp)}))),this.c+=this.speed;this.c>=1;)this.run(),this.c--},1e3/this.fps))}start(){if(!this.isRunning){if(this.isAsynchronous)return this.isRunning=!0,void window.requestAnimationFrame(timestamp=>{this.raf.startTime=0,this.#asyncRun(timestamp)});this.startSyncLoop(),this.isRunning=!0}}stop(){this.isRunning&&(clearInterval(this.interval),this.isRunning=!1)}replaceRun(func){this.run=func}}class RAFLoopHandler{constructor(fps,func){this.actualFrames=0,this.isRunning=!1,this.fps=fps,this.prevTime=0,this.run=func,this.speed=1,this.c=0,this.delta=0,this.lagIterLimit=50,this.confirmIsAsync=!1,this.tdifference=0}#asyncRun(t){if(this.isRunning){{let difference=t-this.prevTime;this.tdifference+=difference,this.prevTime=t;let ms=0;for(;ms<this.lagIterLimit&&this.tdifference>=1e3/this.fps;){for(ms++,this.c+=this.speed,this.tdifference-=1e3/this.fps;this.c>=1;){try{this.run(1==ms)}catch(e){console.error(e+e.stack)}this.c--}difference>3e4&&(this.tdifference=0)}}window.requestAnimationFrame(time=>{this.#asyncRun(time)})}}start(){this.isRunning||(this.isRunning=!0,window.requestAnimationFrame(time=>{this.#asyncRun(time)}))}stop(){this.isRunning&&(this.isRunning=!1)}replaceRun(func){this.run=func}}class FunctionTimer{#NumberFunc=class{constructor(a,func){this.a=a,this.last=a,this.func=(m,arg)=>{func(m,arg)}}add(num,arg){this.a+=num,this.a!==this.last&&(this.last=this.a,this.func(this.a,arg))}assign(val,arg){val!==this.a&&(this.a=val,this.last=this.a,this.func(this.a,arg))}execute(arg){this.func(this.a,arg)}};constructor(parent,func){this.parent=parent,this.time=-9,this.max=600,this.enabled=0,this.func=new this.#NumberFunc(-99,x=>{func(x,this.max)})}set(time){this.time=time,this.enabled&&this.time>=-1&&this.func.assign(time)}setMax(max){this.max=max,this.enabled&&this.time>=-1&&this.func.execute()}increment(add){this.time+=add}update(){this.enabled&&this.time>=-1&&this.func.assign(this.time)}}class DOMTouchInteractivity{constructor(reference,func){this.reference=reference,this.isActive=!0,this.lastTouch=null,this.touchArr={},this.func=event=>{func(event)}}initialize(){var event=e=>{if(("touchstart"==e.type||"touchmove"==e.type||"touchend"==e.type)&&this.isActive){let length=e.touches.length;"touchstart"===e.type&&(this.lastTouch=e.touches[length-1]);let existing={};for(var touches=0;touches<length;touches++){let tX=e.touches[touches].pageX,tY=e.touches[touches].pageY,name=e.touches[touches].identifier;existing[name]=!0,name in this.touchArr||this.func({pageX:tX,pageY:tY,identifier:name,type:e.type})}for(let m in this.touchArr)m in existing?"a"in this.touchArr[m]&&!this.touchArr[m].a.isPressed&&(this.touchArr[m].a.func("touchstart"),this.touchArr[m].a.isPressed=!0):("a"in this.touchArr[m]&&this.touchArr[m].a.isPressed&&(this.touchArr[m].a.func("touchend"),this.touchArr[m].a.isPressed=!1),delete this.touchArr[m])}};for(let p of["start","end"])this.reference.addEventListener(`touch${p}`,e=>event(e),!1)}}class Bitboard{constructor(width,height){this.base=new Uint32Array(1+~~(width*height/32)),this.width=width,this.height=height}findCell(x,y){let index=x*this.height+y;return this.base[~~(index/32)]&1<index%32}setCell(x,y,c){let index=x*this.height+y;1!=c?this.base[~~(index/32)]&=~(1<<index%32):this.base[~~(index/32)]|=1<<index%32}copyThisBB(bitboard){for(let g=0;g<bitboard.base.length;g++)bitboard.base[g]=this.base[g]}}class ModifiedBitboard{constructor(width,height,cluster,T){this.clusterBitCount=cluster,this.base=new T(1+~~(width*height/cluster));for(let g=0;g<this.base.length;g++)this.base[g]=0;this.width=width,this.height=height}findCell(x,y){let index=x*this.height+y;return this.base[~~(index/this.clusterBitCount)]&1<<index%this.clusterBitCount}setCell(x,y,c){let index=x*this.height+y;1!=c?this.base[~~(index/this.clusterBitCount)]&=~(1<<index%this.clusterBitCount):this.base[~~(index/this.clusterBitCount)]|=1<<index%this.clusterBitCount}copyThisBB(bitboard){for(let g=0;g<bitboard.base.length;g++)bitboard.base[g]=this.base[g]}reset(){for(let g=0;g<this.base.length;g++)this.base[g]=0}}const gtcharacter=new class{constructor(){this.characters=[{core:{color:{red:225,green:112,blue:0},name:"misty_firefox>name",description:"misty_firefox>desc",date_featured:"9-17-2024",version:"0.0.1 Alpha",path:"misty_firefox"},versions:[{color:{red:225,green:112,blue:0},path:"main",init:"init.json",lang_path:"misty_firefox>ver>main",description:"desc",select_image:"images/select.png",rpg_card:"images/rpg_card.png",rpg_attr_init:"rpg_attr.json",rpg_init:"rpg_init.json",name:"name"}]},{core:{color:{red:225,green:112,blue:0},name:"rubystudios>name",description:"rubystudios>desc",date_featured:"9-17-2024",version:"0.0.1 Alpha",path:"rubystudios"},versions:[{color:{red:225,green:2,blue:2},path:"main",init:"init.json",lang_path:"rubystudios>ver>main",name:"name",description:"desc",select_image:"images/select.png",rpg_card:"images/rpg_card.png",rpg_attr_init:"rpg_attr.json",rpg_init:"rpg_init.json"}]},{core:{color:{red:225,green:112,blue:0},name:"dominic_zi>name",description:"dominic_zi>desc",date_featured:"9-17-2024",version:"0.0.1 Alpha",path:"dominic_zi"},versions:[{color:{red:225,green:2,blue:2},path:"main",init:"init.json",lang_path:"dominic_zi>ver>main",name:"name",description:"desc",select_image:"images/select.png",rpg_card:"images/rpg_card.png",rpg_attr_init:"rpg_attr.json",rpg_init:"rpg_init.json"}]},{core:{color:{red:225,green:112,blue:0},name:"elisha>name",description:"elisha>desc",date_featured:"9-17-2024",version:"0.0.1 Alpha",path:"elisha"},versions:[{color:{red:225,green:2,blue:2},path:"main",init:"init.json",lang_path:"elisha>ver>main",name:"name",description:"desc",select_image:"images/select.png",rpg_card:"images/rpg_card.png",rpg_attr_init:"rpg_attr.json",rpg_init:"rpg_init.json"}]},{core:{color:{red:225,green:112,blue:0},name:"epicman>name",description:"epicman>desc",date_featured:"9-17-2024",version:"0.0.1 Alpha",path:"epicman"},versions:[{color:{red:225,green:112,blue:2},path:"main",init:"init.json",lang_path:"epicman>ver>main",name:"name",description:"desc",select_image:"images/select.png",rpg_card:"images/rpg_card.png",rpg_attr_init:"rpg_attr.json",rpg_init:"rpg_init.json"}]},{core:{color:{red:3,green:3,blue:122},name:"flotalendy>name",description:"flotalendy>desc",date_featured:"9-17-2024",version:"0.0.1 Alpha",path:"flotalendy"},versions:[{color:{red:3,green:3,blue:122},path:"main",init:"init.json",lang_path:"flotalendy>ver>main",name:"name",description:"desc",select_image:"images/select.png",rpg_card:"images/rpg_card.png",rpg_attr_init:"rpg_attr.json",rpg_init:"rpg_init.json"}]},{core:{color:{red:3,green:3,blue:122},name:"eclipse>name",description:"eclipse>desc",date_featured:"5-25-2025",version:"0.0.2 Alpha",path:"eclipse"},versions:[{color:{red:111,green:3,blue:122},path:"main",init:"init.json",lang_path:"eclipse>ver>main",name:"name",description:"desc",select_image:"images/select.png",rpg_card:"images/rpg_card.png",rpg_attr_init:"rpg_attr.json",rpg_init:"rpg_init.json"}]},{core:{color:{red:20,green:20,blue:122},name:"abcia2>name",description:"abcia2>desc",date_featured:"5-25-2025",version:"0.0.2 Alpha",path:"abcia2"},versions:[{color:{red:20,green:20,blue:122},path:"main",init:"init.json",lang_path:"abcia2>ver>main",name:"name",description:"desc",select_image:"images/select.png",rpg_card:"images/rpg_card.png",rpg_attr_init:"rpg_attr.json",rpg_init:"rpg_init.json"}]},{core:{color:{red:40,green:40,blue:122},name:"izzy>name",description:"izzy>desc",date_featured:"12-02-2025",version:"0.2.0 Alpha",path:"izzy"},versions:[{color:{red:40,green:40,blue:122},path:"main",init:"init.json",lang_path:"izzy>ver>main",name:"name",description:"desc",select_image:"images/select.png",rpg_card:"images/rpg_card.png",rpg_attr_init:"rpg_attr.json",rpg_init:"rpg_init.json"}]},{core:{color:{red:190,green:190,blue:211},name:"skylight>name",description:"skylight>desc",date_featured:"12-02-2025",version:"0.2.0 Alpha",path:"skylight"},versions:[{color:{red:190,green:190,blue:211},path:"main",init:"init.json",lang_path:"skylight>ver>main",name:"name",description:"desc",select_image:"images/select.png",rpg_card:"images/rpg_card.png",rpg_attr_init:"rpg_attr.json",rpg_init:"rpg_init.json"}]},{core:{color:{red:12,green:12,blue:113},name:"emikama>name",description:"emikama>desc",date_featured:"12-02-2025",version:"0.2.0 Alpha",path:"emikama"},versions:[{color:{red:12,green:12,blue:113},path:"main",init:"init.json",lang_path:"emikama>ver>main",name:"name",description:"desc",select_image:"images/select.png",rpg_card:"images/rpg_card.png",rpg_attr_init:"rpg_attr.json",rpg_init:"rpg_init.json"}]},{core:{color:{red:170,green:255,blue:170},name:"rainuff>name",description:"rainuff>desc",date_featured:"12-02-2025",version:"0.2.0 Alpha",path:"rainuff"},versions:[{color:{red:170,green:255,blue:170},path:"main",init:"init.json",lang_path:"rainuff>ver>main",name:"name",description:"desc",select_image:"images/select.png",rpg_card:"images/rpg_card.png",rpg_attr_init:"rpg_attr.json",rpg_init:"rpg_init.json"}]},{core:{color:{red:225,green:112,blue:0},name:"elabbygaile>name",description:"elabbygaile>desc",date_featured:"12-02-2025",version:"0.2.0 Alpha",path:"elabbygaile",phylum:!0},versions:[{color:{red:225,green:225,blue:0},path:"main",init:"init.json",lang_path:"elabbygaile>ver>main",description:"desc",select_image:"images/select.png",rpg_card:"images/rpg_card.png",rpg_attr_init:"rpg_attr.json",rpg_init:"rpg_init.json",name:"name"}]},{core:{color:{red:225,green:112,blue:0},name:"gabbryielle>name",description:"gabbryielle>desc",date_featured:"12-02-2025",version:"0.2.0 Alpha",path:"gabbryielle",phylum:!0},versions:[{color:{red:225,green:225,blue:0},path:"main",init:"init.json",lang_path:"gabbryielle>ver>main",description:"desc",select_image:"images/select.png",rpg_card:"images/rpg_card.png",rpg_attr_init:"rpg_attr.json",rpg_init:"rpg_init.json",name:"name"}]}];for(let h in this.characters){let reference=this.characters[h],ver=Object.keys(reference.versions);reference.core.verlength=ver.length}}},multithread=new class{#importScripts='\nimportScripts("<{IMPORT_URL}>");\n\nonmessage = (d) => {\n let result = _eval(d.data);\n postMessage(result);\n}\n ';#workers={};#$BTOBASE64(blob,call){var reader=new FileReader;reader.readAsDataURL(blob),reader.onloadend=function(){var base64=reader.result;call(base64)}}constructor(){}engageWorker(name,impscrtext,on){this.#workers?.[name]&&this.#workers[name].worker instanceof Worker&&this.#workers[name].worker.terminate(),this.#workers[name]={worker:{postMessage:()=>{}},base64:""};let f=new Blob([impscrtext],{type:"text/plain"});return this.#$BTOBASE64(f,blobA=>{new Blob([blobA],{type:"text/plain"});let blobAURL=URL.createObjectURL(f),blobAText=this.#importScripts.replace("<{IMPORT_URL}>",blobAURL),fw=new Blob([blobAText],{type:"text/plain"}),fwe=URL.createObjectURL(fw);this.#workers[name].base64=blobA,this.#workers[name].worker=new Worker(fwe),this.#workers[name].worker.onerror=e=>{},on(this.#workers[name])}),this.#workers[name]}stopAll(){for(let w in this.#workers)this.#workers[w].worker.terminate()}};function load(entity,type){return __main_params__.appinfo.android?new Promise(async(res,rej)=>{res(__main_params__.fetch(entity,type))}):new Promise(async(res,rej)=>{__main_params__.database.read("assets",entity,async read=>{let result=null;if(void 0===read)try{result=await __main_params__.fetch(entity,type),__main_params__.database.write("assets",entity,result)}catch(e){}else result=read.value;res(result)})})}function loadImage(directory,isImgElem){return __main_params__.appinfo.android?new Promise(async(res,rej)=>{try{let result=await __main_params__.fetch(directory,"blob"),img=new Image;img.src=URL.createObjectURL(result),img.onload=()=>{URL.revokeObjectURL(result),res(img)}}catch(e){}}):new Promise((res,rej)=>{__main_params__.database.read("assets",directory,async read=>{let result={};if(void 0===read){result=await __main_params__.fetch(directory,"blob");try{__main_params__.database.write("assets",directory,result)}catch(e){}}else result=read.value;let bmp=createImageBitmap(result);res(bmp)})})}__main_params__.__private.loadImage=loadImage,__main_params__.__private.load=load;const language=new class{#languages={};#charLanguages={};#settingLanguages={};#images={};#isLoadActive=!0;#imgPathArrStr="";#current="en-US";load(file){this.#current=file;let km=file.toLowerCase().replace(/\-/gm,"_");return new Promise(async(res,rej)=>{this.loadLanguage(await load(`./assets/lang/${km}/main.json`,"text")),this.loadCharLanguage(await load(`./assets/lang/${km}/characters.json`,"text")),this.loadSettingLanguage(await load(`./assets/lang/${km}/settings.json`,"text")),res()})}loadCharLanguage(file){let a=JSON.parse(file);this.#charLanguages[this.#current]={},this.#charLanguages[this.#current]=a}loadLanguage(file){let a=JSON.parse(file);this.#languages[this.#current]={},this.#languages[this.#current]=a}loadSettingLanguage(file){let a=JSON.parse(file);this.#settingLanguages[this.#current]={},this.#settingLanguages[this.#current]=a}getLocalizationPath(file){return`assets/lang/en_us/${file}`}loadLangImage(arr){let isBool=!0,tarr=[];for(let hh of arr){let h=this.getLocalizationPath(hh);h in this.#images?this.#images[h].active||(isBool=!1):(isBool=!1,tarr.push([hh,h]))}if(!isBool){this.#isLoadActive=!1;let count=0;for(let a of tarr)this.#images[a[0]]={a:new Image,active:!1},loadImage(a[1]).then(ue=>{this.#images[a[0]].a=ue,this.#images[a[0]].active=!0,count++,count>=arr.length&&(this.#isLoadActive=!0)})}}getImage(src){return this.#images[src].a}loadImgsByJson(u){this.loadLangImage(JSON.parse(u))}translate(query,input,fallback){let _input="object"==typeof input&&input instanceof Array?input:[input],result=this.#languages[this.#current][query]||fallback||"    ";for(let v=0;v<_input.length;v++){let varInstance=_input[v],regExp=new RegExp(`var=${v}`,"gm");result=result.replace(regExp,varInstance)}return result}settingTranslate(query,fallback){let result=(this.#settingLanguages[this.#current][query.split("||")[0]]||fallback||"    ").split("||");for(;result.length<2;)result.push(fallback||"    ");return result}charTranslate(query,fallback){let querySplit=query.split(">"),base=this.#charLanguages[this.#current][querySplit[0]],language=this.#charLanguages[this.#current];for(let v=0;v<querySplit.length;v++){let langTemp=this.#charLanguages[this.#current];language=0===v?langTemp:base,base=language[querySplit[v]]}return base||fallback||"    "}};__main_params__.__private.language=language;class MobileButton{constructor(event,img,type,func,px,py,lx,ly,len,height,dragTap){this.portraitX=px,this.portraitY=py,this.landscapeX=lx,this.landscapeY=ly,this.sizeX=len,this.sizeY=height,this.src=img,this.actual={sizeX:0,sizeY:0},this.type=type,this.func=func,this.id=`CONTROL-${event.toUpperCase()}`,this.active=!0,this.isControllerActive=!0,this.isWholeActive=!0,this.isNotReplayToShow=!0,this.dragTap=dragTap||!1,this.isPressed=!1}fire(){this.func()}}class MobileButtonSystem{constructor(){this.buttons={},this.isActive=!0,this.lastTouch=null,this.cellSize=0,this.cellSizeX=0,this.cellSizeY=0,this.touchArr={},this.viewportPos={x:0,y:0},this.ratio={width:0,height:0}}toggleControllers(){for(let buttons in this.buttons){let btn=this.buttons[buttons];"controller"==btn.type&&(btn.active=!btn.active)}this.checkButtons()}replayToggleControllers(bool){for(let buttons in this.buttons){let btn=this.buttons[buttons];"controller"==btn.type&&(btn.isNotReplayToShow=bool)}this.checkButtons()}enableControllers(bool){for(let buttons in this.buttons){let btn=this.buttons[buttons];"controller"==btn.type&&(btn.isControllerActive=bool)}this.checkButtons()}enableButtons(bool){for(let buttons in this.buttons){this.buttons[buttons].isWholeActive=bool}this.checkButtons()}resize(o,mw,mh,w,h,cs){switch(this.res={w:mw,h:mh,ow:0,oh:0},style("GTRIS-TOUCH","width",`${w}px`),style("GTRIS-TOUCH","height",`${h}px`),this.orientation=o,this.viewportPos={x:0,y:0},o){case"portrait":this.viewportPos.y=mh/4-h/2,this.cellSize=w/9;break;case"landscape":this.viewportPos.x=mw/2-w/2,this.cellSize=h/9}this.checkButtons()}checkButtons(){for(var e in this.buttons){var o=this.buttons[e];let x=("landscape"==this.orientation?o.landscapeX:o.portraitX)*this.cellSize,y=("landscape"==this.orientation?o.landscapeY:o.portraitY)*this.cellSize;Math.max(game.aspectResolution.w,game.aspectResolution.h),Math.max(this.viewportPos.x,this.viewportPos.y);let padX="portrait"===this.orientation?Math.max((this.res.w*(16/9)-this.res.h)/2/5148,0):0,padY="portrait"===this.orientation?(this.res.h-game.aspectResolution.h)/2:0;var _id=id(o.id);_id.style=`display:${o.active&&o.isWholeActive&&o.isControllerActive&&o.isNotReplayToShow?"block":"none"};opacity:60%;background:#938;top:0px;left:0px;position:absolute;pointer-events:none`;let posY=padY+y-o.sizeY/2,posX=padX+x-o.sizeX/2;_id.style.top=posY+"px",_id.style.left=posX+"px",_id.style.width=this.cellSize*o.sizeX+"px",_id.style.height=this.cellSize*o.sizeY+"px";this.orientation}}createButton(event,img,type,func,px,py,lx,ly,len,height){event in this.buttons||(this.buttons[event]=new MobileButton(event,img,type,func,px,py,lx,ly,len,height),elem("gtris-mobile-button",button=>{button.id=this.buttons[event].id,load(this.buttons[event].src,"blob").then(y=>{let olm=document.createElement("img");olm.src=URL.createObjectURL(y),olm.onload=()=>{URL.revokeObjectURL(olm.src)},button.append(olm),olm.style.width="100%",olm.style.height="100%"}),id("GTRIS-TOUCH").appendChild(button)}),this.checkButtons())}showHide(bool){this.isActive=bool,style("GTRIS-TOUCH","display",bool?"auto":"none")}initiateButtons(){var AY=11.7;let LNX=14.7-.3;this.createButton("harddrop","assets/menu/control_mobile/up.png","controller",type=>{let ls=game.bitFlags.harddrop;if("touchstart"==type&&game.typeInput(ls,1),"touchend"==type&&game.typeInput(ls,0),menu.isMenu){let ja="up";"touchstart"==type&&menu.controlsListen(ja,"down"),"touchend"==type&&menu.controlsListen(ja,"up")}},1.85,11.7,-1.4,4.3,1.3,1.3,!0),this.createButton("softdrop","assets/menu/control_mobile/down.png","controller",type=>{let ls=game.bitFlags.softdrop;if("touchstart"==type&&game.typeInput(ls,1),"touchend"==type&&game.typeInput(ls,0),menu.isMenu){let ja="down";"touchstart"==type&&menu.controlsListen(ja,"down"),"touchend"==type&&menu.controlsListen(ja,"up")}},1.85,2.6+AY,-1.4,6.9,1.3,1.3,!0),this.createButton("left","assets/menu/control_mobile/left.png","controller",type=>{let ls=game.bitFlags.left;if("touchstart"==type&&game.typeInput(ls,1),"touchend"==type&&game.typeInput(ls,0),menu.isMenu){let ja="left";"touchstart"==type&&menu.controlsListen(ja,"down"),"touchend"==type&&menu.controlsListen(ja,"up")}},.55,13,-2.7,5.6,1.3,1.3,!0),this.createButton("right","assets/menu/control_mobile/right.png","controller",type=>{let ls=game.bitFlags.right;if("touchstart"==type&&game.typeInput(ls,1),"touchend"==type&&game.typeInput(ls,0),menu.isMenu){let ja="right";"touchstart"==type&&menu.controlsListen(ja,"down"),"touchend"==type&&menu.controlsListen(ja,"up")}},3.15,13,2.9-3,5.6,1.3,1.3,!0),this.createButton("hold","assets/menu/control_mobile/x.png","controller",type=>{let ls=game.bitFlags.hold;"touchstart"==type&&game.typeInput(ls,1),"touchend"==type&&game.typeInput(ls,0)},7.4-1.55,11.7,LNX- -1.7,4.3,1.3,1.3,!0),this.createButton("ccw","assets/menu/control_mobile/b.png","controller",type=>{let ls=game.bitFlags.ccw;if("touchstart"==type&&game.typeInput(ls,1),"touchend"==type&&game.typeInput(ls,0),menu.isMenu){let ja="b";"touchend"==type&&menu.controlsListen(ja,"down")}},7.4-1.55,2.6+AY,LNX- -1.7,6.9,1.3,1.3,!0),this.createButton("c180w","assets/menu/control_mobile/y.png","controller",type=>{let ls=game.bitFlags.c180w;"touchstart"==type&&game.typeInput(ls,1),"touchend"==type&&game.typeInput(ls,0)},7.4-2.85,13,LNX-(2.6-3),5.6,1.3,1.3,!0),this.createButton("cw","assets/menu/control_mobile/a.png","controller",type=>{let ls=game.bitFlags.cw;if("touchstart"==type&&game.typeInput(ls,1),"touchend"==type&&game.typeInput(ls,0),menu.isMenu){let ja="a";"touchend"==type&&menu.controlsListen(ja,"down")}},7.15,13,17.4,5.6,1.3,1.3,!0),this.createButton("restart","assets/menu/control_mobile/pause.png","button",type=>{"touchstart"==type&&game.pauseGame()},.5,1.3,-10,34,.7,.7),this.createButton("controls","assets/menu/control_mobile/toggle.png","button",type=>{"touchend"==type&&this.toggleControllers()},1.5,1.3,-10,34,.7,.7),this.createButton("skill1","assets/menu/control_mobile/skill1.png","controller",type=>{let ls=game.bitFlags.s1;"touchstart"==type&&game.typeInput(ls,1),"touchend"==type&&game.typeInput(ls,0)},2.5,1.3,-10,34,.7,.7),this.createButton("skill3","assets/menu/control_mobile/skill2.png","controller",type=>{let ls=game.bitFlags.s2;"touchstart"==type&&game.typeInput(ls,1),"touchend"==type&&game.typeInput(ls,0)},3.5,1.3,-10,34,.7,.7),this.createButton("skill13","assets/menu/control_mobile/skill3.png","controller",type=>{let ls=game.bitFlags.s3;"touchstart"==type&&game.typeInput(ls,1),"touchend"==type&&game.typeInput(ls,0)},4.5,1.3,-10,34,.7,.7),this.checkButtons(),this.initialize()}initialize(){var event=e=>{if(("touchstart"==e.type||"touchmove"==e.type||"touchend"==e.type)&&this.isActive){let isPressed=!1,length=e.touches.length;"touchstart"===e.type&&(this.lastTouch=e.touches[length-1]);let existing={};for(var touches=0;touches<length;touches++){let tX=e.touches[touches].pageX,tY=e.touches[touches].pageY,name=e.touches[touches].identifier;if(existing[name]=!0,!(name in this.touchArr))for(var i in this.buttons){id(this.buttons[i].id);var buttonClass=this.buttons[i],buttonOffsetTop=clientRect(this.buttons[i].id,"y"),buttonOffsetLeft=clientRect(this.buttons[i].id,"x"),buttonOffsetHeight=clientRect(this.buttons[i].id,"height"),buttonOffsetWidth=clientRect(this.buttons[i].id,"width");tX>=buttonOffsetLeft&&tX<buttonOffsetWidth+buttonOffsetLeft&&tY>=buttonOffsetTop&&tY<buttonOffsetHeight+buttonOffsetTop&&buttonClass.active&&buttonClass.isWholeActive&&buttonClass.isControllerActive&&buttonClass.isNotReplayToShow&&(this.touchArr[name]={x:tX,y:tY,a:{}},this.touchArr[name].a=buttonClass)}}for(let m in this.touchArr)m in existing?"a"in this.touchArr[m]&&!this.touchArr[m].a.isPressed&&(this.touchArr[m].a.func("touchstart"),this.touchArr[m].a.isPressed=!0,style(this.touchArr[m].a.id,"opacity",1),isPressed=!0):("a"in this.touchArr[m]&&this.touchArr[m].a.isPressed&&(this.touchArr[m].a.func("touchend"),this.touchArr[m].a.isPressed=!1,style(this.touchArr[m].a.id,"opacity",.6)),delete this.touchArr[m]);return isPressed}};for(let p of["start","end"])window.addEventListener(`touch${p}`,e=>{if(fsw.isShown)return;e.preventDefault();let t=e.touches[0],y=event(e);if(menu.interactHardwareType=1,!fsw.isShown&&!menu.characterMenu.isActive&&menu.isControllable&&menu.isMenu){if("start"==p&&(menu.touchSensitivity.direction=y?3:0,menu.touchArea.start.x=t.pageX,menu.touchArea.start.y=t.pageY,menu.touchArea.difference.x=0,menu.touchArea.difference.y=0,menu.touchArea.x=t.pageX,menu.touchArea.y=t.pageY,menu.touchSensitivity.difference.x=t.pageX,menu.touchSensitivity.difference.y=t.pageY,menu.scroll.startY=menu.scroll.currentY,menu.touchArea.isPress=!0,menu.touchArea.isNoMove=!0),"end"==p){menu.touchArea.isPress=!1;let backb=id("GTRIS-MENU-DIV").getBoundingClientRect();backb.y<=menu.touchArea.y&&backb.y+backb.height>menu.touchArea.y&&backb.x<=menu.touchArea.x&&backb.x+backb.width>menu.touchArea.x||(menu.touchArea.isNoMove=!1),menu.touchArea.isNoMove&&menu.selectableClick()}}else menu.characterMenu.isActive&&menu.characterMenu.panelInteractListen(e)},!1);window.addEventListener("touchmove",e=>{e.preventDefault();let t=e.touches[0];if(menu.touchArea.isPress){menu.touchArea.x=t.pageX,menu.touchArea.y=t.pageY,menu.touchArea.difference.x=t.pageX-menu.touchArea.start.x,menu.touchArea.difference.y=t.pageY-menu.touchArea.start.y;let dx=menu.touchArea.x-menu.touchSensitivity.difference.x,dy=menu.touchArea.y-menu.touchSensitivity.difference.y,hs=!0;if(fsw.isShown||menu.characterMenu.isActive)return void(hs=!1);if(1==menu.touchSensitivity.direction||0==menu.touchSensitivity.direction){let l=!1;for(0==menu.touchSensitivity.direction&&(Math.abs(dx)>=2*game.cellSize&&(menu.touchSensitivity.direction=1),Math.abs(dy)>=2*game.cellSize&&(menu.touchSensitivity.direction=2),Math.abs(dx)>=.5*game.cellSize&&(hs=!1),Math.abs(dy)>=.5*game.cellSize&&(hs=!1));1==menu.touchSensitivity.direction&&dx>menu.touchSensitivity.x;)menu.touchSensitivity.difference.x+=menu.touchSensitivity.x,dx-=menu.touchSensitivity.x,menu.moveRight(),l=!0;for(;dx<-menu.touchSensitivity.x;)menu.touchSensitivity.difference.x-=menu.touchSensitivity.x,dx+=menu.touchSensitivity.x,menu.moveLeft(),l=!0;l&&(menu.touchSensitivity.direction=1),hs=l}if(2==menu.touchSensitivity.direction||0==menu.touchSensitivity.direction){let l=!1;for(;dy>menu.touchSensitivity.y;)menu.touchSensitivity.difference.y+=menu.touchSensitivity.y,dy-=menu.touchSensitivity.y,l=!0;for(;dy<-menu.touchSensitivity.y;)menu.touchSensitivity.difference.y-=menu.touchSensitivity.y,dy+=menu.touchSensitivity.y,l=!0;l&&(menu.touchSensitivity.direction=2),hs=l,menu.scroll.currentY=menu.scroll.startY-3*menu.touchArea.difference.y}hs&&(menu.touchArea.isNoMove=!1)}},!1)}}const touchButtons=new MobileButtonSystem,MATRIX=[[[[2,0,0],[2,2,0],[0,2,0]],[[0,0,0],[0,2,2],[2,2,0]],[[0,2,0],[0,2,2],[0,0,2]],[[0,2,2],[2,2,0],[0,0,0]]],[[[0,3,0],[0,3,0],[3,3,0]],[[0,0,0],[3,3,3],[0,0,3]],[[0,3,3],[0,3,0],[0,3,0]],[[3,0,0],[3,3,3],[0,0,0]]],[[[4,4],[4,4]],[[4,4],[4,4]],[[4,4],[4,4]],[[4,4],[4,4]]],[[[0,5,0],[5,5,0],[5,0,0]],[[0,0,0],[5,5,0],[0,5,5]],[[0,0,5],[0,5,5],[0,5,0]],[[5,5,0],[0,5,5],[0,0,0]]],[[[0,6,0,0],[0,6,0,0],[0,6,0,0],[0,6,0,0]],[[0,0,0,0],[0,0,0,0],[6,6,6,6],[0,0,0,0]],[[0,0,6,0],[0,0,6,0],[0,0,6,0],[0,0,6,0]],[[0,0,0,0],[6,6,6,6],[0,0,0,0],[0,0,0,0]]],[[[7,7,0],[0,7,0],[0,7,0]],[[0,0,0],[7,7,7],[7,0,0]],[[0,7,0],[0,7,0],[0,7,7]],[[0,0,7],[7,7,7],[0,0,0]]],[[[0,8,0],[8,8,0],[0,8,0]],[[0,0,0],[8,8,8],[0,8,0]],[[0,8,0],[0,8,8],[0,8,0]],[[0,8,0],[8,8,8],[0,0,0]]]],WK_SRSX={I:{right:[[[0,0],[-2,0],[1,0],[-2,1],[1,-2]],[[0,0],[-1,0],[2,0],[-1,-2],[2,1]],[[0,0],[2,0],[-1,0],[2,-1],[-1,2]],[[0,0],[1,0],[-2,0],[1,2],[-2,-1]]],left:[[[0,0],[-1,0],[2,0],[-1,-2],[2,1]],[[0,0],[2,0],[-1,0],[2,-1],[-1,2]],[[0,0],[1,0],[-2,0],[1,2],[-2,-1]],[[0,0],[-2,0],[1,0],[-2,1],[1,-2]]],double:[[[0,0],[-1,0],[-2,0],[1,0],[2,0],[0,1]],[[0,0],[0,1],[0,2],[0,-1],[0,-2],[-1,0]],[[0,0],[1,0],[2,0],[-1,0],[-2,0],[0,-1]],[[0,0],[0,1],[0,2],[0,-1],[0,-2],[1,0]]]},other:{right:[[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],[[0,0],[1,0],[1,1],[0,-2],[1,-2]],[[0,0],[1,0],[1,-1],[0,2],[1,2]],[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]]],left:[[[0,0],[1,0],[1,-1],[0,2],[1,2]],[[0,0],[1,0],[1,1],[0,-2],[1,-2]],[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]]],double:[[[0,0],[1,0],[2,0],[1,1],[2,1],[-1,0],[-2,0],[-1,1],[-2,1],[0,-1],[3,0],[-3,0],[0,0]],[[0,0],[0,1],[0,2],[-1,1],[-1,2],[0,-1],[0,-2],[-1,-1],[-1,-2],[1,0],[0,3],[0,-3],[0,0]],[[0,0],[-1,0],[-2,0],[-1,-1],[-2,-1],[1,0],[2,0],[1,-1],[2,-1],[0,1],[-3,0],[3,0],[0,0]],[[0,0],[0,1],[0,2],[1,1],[1,2],[0,-1],[0,-2],[1,-1],[1,-2],[-1,0],[0,3],[0,-3],[0,0]]]},O:{right:[[[0,0],[-1,0],[-1,-1],[0,2],[-1,2],[0,3],[-1,3],[0,0]],[[0,0],[1,0],[1,1],[0,-2],[1,-2],[0,-3],[1,-3],[0,0]],[[0,0],[1,0],[1,-1],[0,2],[1,2],[0,3],[1,3],[0,0]],[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2],[0,3],[-1,-3],[0,0]]],left:[[[0,0],[1,0],[1,-1],[0,2],[1,2],[0,3],[1,3],[0,0]],[[0,0],[1,0],[1,1],[0,-2],[1,-2],[0,-3],[1,-3],[0,0]],[[0,0],[-1,0],[-1,-1],[0,2],[-1,2],[0,3],[-1,3],[0,0]],[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2],[0,3],[-1,-3],[0,0]]],double:[[[0,0],[1,0],[2,0],[1,1],[2,1],[-1,0],[-2,0],[-1,1],[-2,1],[0,-1],[3,0],[-3,0],[0,0]],[[0,0],[0,1],[0,2],[-1,1],[-1,2],[0,-1],[0,-2],[-1,-1],[-1,-2],[1,0],[0,3],[0,-3],[0,0]],[[0,0],[-1,0],[-2,0],[-1,-1],[-2,-1],[1,0],[2,0],[1,-1],[2,-1],[0,1],[-3,0],[3,0],[0,0]],[[0,0],[0,1],[0,2],[1,1],[1,2],[0,-1],[0,-2],[1,-1],[1,-2],[-1,0],[0,3],[0,-3],[0,0]]]}},SPIN_DETECTION={I:{highX:[[1,2,2,1],[1,3,1,3],[1,2,2,1],[0,2,0,2]],highY:[[0,2,0,2],[1,2,2,1],[1,3,1,3],[1,2,2,1]],lowX:[[-1,4,-1,4],[2,2,2,2],[-1,4,-1,4],[1,1,1,1]],lowY:[[1,1,1,1],[-1,4,-1,4],[2,2,2,2],[-1,4,-1,4]]},J:{highX:[[1,2],[2,2],[1,0],[0,0]],highY:[[0,0],[1,2],[2,2],[1,0]],lowX:[[0,2],[0,0],[2,0],[2,2]],lowY:[[2,2],[0,2],[0,0],[2,0]]},L:{highX:[[1,0],[2,2],[1,2],[0,0]],highY:[[0,0],[1,0],[2,2],[1,2]],lowX:[[2,0],[0,0],[0,2],[2,2]],lowY:[[2,2],[2,0],[0,0],[0,3]]},O:{highX:[[0,1],[2,2],[1,0],[-1,-1]],highY:[[-1,-1],[0,1],[2,2],[1,0]],lowX:[[1,0],[-1,-1],[0,1],[2,2]],lowY:[[2,2],[1,0],[-1,-1],[0,1]]},S:{highX:[[0,2],[1,2],[2,0],[1,0]],highY:[[0,1],[2,0],[2,1],[0,2]],lowX:[[0,-1],[1,2],[-1,3],[1,0]],lowY:[[0,1],[-1,3],[2,1],[3,-1]]},T:{highX:[[0,2],[2,2],[0,2],[0,0]],highY:[[0,0],[0,2],[2,2],[0,2]],lowX:[[0,2],[0,0],[0,2],[2,2]],lowY:[[2,2],[0,2],[0,0],[0,2]]},Z:{highX:[[2,0],[2,1],[0,2],[0,1]],highY:[[0,1],[2,0],[2,1],[0,2]],lowX:[[-1,3],[2,1],[3,-1],[0,1]],lowY:[[0,1],[-1,3],[2,1],[3,-1]]}},SPAWN_OFFSETS={Z:[3,0],L:[3,0],O:[4,0],S:[3,0],I:[3,0],J:[3,0],T:[3,0]},PREVIEW_OFFSETS={Z:[1,.5],L:[1,.5],O:[1.5,.5],S:[1,.5],I:[.3333,0],J:[1,.5],T:[1,.5]},FLAG_DIRECTIONS=[[1,0],[0,1],[-1,0],[0,-1]],FLAG_CONNECTIONS={color:255,up:256,right:512,down:1024,left:2048},PIECE=function(){var a=[],b=["Z","L","O","S","I","J","T"];for(let i=0;i<7;i++)a.push({index:i,prevx:PREVIEW_OFFSETS[b[i]][0],prevy:PREVIEW_OFFSETS[b[i]][1],x:SPAWN_OFFSETS[b[i]][0],y:SPAWN_OFFSETS[b[i]][1],matrix:MATRIX[i],kickTable:WK_SRSX["I"==b[i]?"I":"O"==b[i]?"O":"other"],spinDetection:SPIN_DETECTION[b[i]]});return a}(),BLOBS=function(){let pp=function(c,d){return[[[0,0,0],[c,d,0],[0,0,0]],[[0,0,0],[0,d,0],[0,c,0]],[[0,0,0],[0,d,c],[0,0,0]],[[0,c,0],[0,d,0],[0,0,0]]]},color1Bag=[],color2Bag=[],color3Bag=[],main=[],index=0;for(let a=1;a<=5;a++)for(let b=1;b<=5;b++){let c=a+0,d=b+0;main.push({index:index,matrix:pp(c,d),cp1:c,cp2:d,x:3,y:0,kickTable:{right:[[[0,0],[-1,0],[0,-1],[-1,-1],[-1,0]],[[0,0],[0,-1],[0,-1],[1,0],[0,-1]],[[0,0],[1,0],[0,-1],[1,-1],[1,0]],[[0,0],[0,-1],[0,-1],[-1,0],[0,-1]]],left:[[[0,0],[1,0],[0,-1],[1,-1],[1,0]],[[0,0],[0,-1],[0,-1],[-1,0],[0,-1]],[[0,0],[-1,0],[0,-1],[-1,-1],[-1,0]],[[0,0],[0,-1],[0,-1],[1,0],[0,-1]]],double:[[[0,0],[0,1]],[[0,0],[0,1]],[[0,0],[0,2]],[[0,0],[0,2]]]}}),color3Bag.push(index),a<=3&&b<=3&&color1Bag.push(index),a<=4&&b<=4&&color2Bag.push(index),index++}return{main:main,c1:color1Bag,c2:color2Bag,c3:color3Bag}}(),COLOR_BONUS=[[0,3,6,12,24,48],[0,2,4,6,8,10]],GROUP_BONUS=[[0,0,0,0,2,3,4,5,6,7,10],[0,0,0,0,1,2,3,4,5,6,8]],TSU_CHAIN_POWER=[0,8,16,32,64,96,128,160,192,224,256,288,320,352,384,416,448,480,512,544,576,608,640,672,699],TSU_CHAIN_SEQUENCE={normal:["init1","init2","spell1","spell2","spell3","spell4","spell5"],old:["init1","spell1","spell2","init5","spell3","spell4","spell5"]},CHAIN_SEQUENCE=[["init1"],["init1","spell1"],["init1","init2","spell1"],["init1","init2","init3","spell2"],["init1","init2","init3","init4","spell2"],["init1","init2","init3","init4","init5","spell2"],["init1","init2","init3","init4","init5","init5","spell3"],["init1","init2","init3","init4","init5","init5","init5","spell3"],["init1","init2","init3","init4","spell2","init5","init5","init5","spell3"],["init1","init2","init3","init4","spell2","init4","init5","init5","init5","spell4"],["init1","init2","init3","init4","spell2","init3","init4","init5","init5","init5","spell4"],["init1","init2","init3","init5","spell2","init3","init4","init5","spell3","init5","init5","spell4"],["init1","init2","init3","init5","spell2","init3","init4","init5","spell3","init5","init5","init5","spell5"],["init1","init2","init3","init5","spell2","init2","init3","init4","init5","spell3","init4","init5","init5","spell5"],["init1","init2","init3","init5","spell2","init2","init3","init4","init5","spell3","init3","init4","init5","init5","spell5"],["init1","init2","init3","init4","init5","spell2","init2","init4","init5","spell3","init2","init3","init4","init5","init5","spell5"],["init1","init2","init3","init4","init5","spell2","init2","init3","init4","init5","spell3","init2","init3","init4","init5","init5","spell5"],["init1","init2","init3","init4","init5","spell2","init2","init3","init4","init5","spell3","init2","init3","init4","init5","init5","init5","spell5"],["init1","init2","init3","init4","init5","spell2","init2","init3","init4","init5","spell3","init2","init3","init4","init3","init4","init5","init5","spell5"],["init1","init2","init3","init4","init5","spell2","init2","init3","init4","init5","spell3","init2","init3","init4","init3","init4","init5","init5","init5","spell5"],["init5","init2","init3","init4","init5","spell2","init2","init3","init4","init5","spell3","init2","init3","init4","init3","init4","init5","init5","init5","spell5"],["init1","init2","init3","init4","init5","spell2","init2","init3","init4","init5","spell3","init2","init3","init4","init3","init4","init5","init5","init5","spell5"]],SCORE_TABLE={pc:{b2b:{spin:[0,2300,3500,5400],mini:[0,1500,2100,2400],line:[0,0,0,0,3200,4200]},nob2b:{spin:[0,1200,2400,3600],mini:[0,1e3,1400,1800],line:[0,800,1200,1800,2e3,2800]}},nopc:{b2b:{spin:[400,1200,1600,2400],mini:[100,300,600,900],line:[0,0,0,0,1200,1900]},nob2b:{spin:[400,800,1200,1600],mini:[100,200,400,600],line:[0,100,300,500,800,1400]}},combo:50},ALL_CLEAR_ANIMATION_PRESETS={1:[!0,[1,1],[0,1],40,{y1:0,y2:.9,y3:1,y4:1,s1:0,s2:.9,s3:1,s4:1}],2:[!1,[0,1],[1,1],40,{y1:0,y2:0,y3:0,y4:1,s1:0,s2:.9,s3:1,s4:1}],3:[!1,[1,1],[.3,1],-1,{y1:0,y2:0,y3:0,y4:1,s1:0,s2:.9,s3:1,s4:1}]};class ObjectParticle{constructor(type,duration,imgRef,spriteRow,spriteCol,startX,startY,endX,endY,size,color,bezier,isOpaqueTrail,trailOptions,rotateOptions){if(this.maintype=type,this.x=startX,this.y=startY,this.startX=startX,this.startY=startY,this.spriteCell=spriteCol,this.spriteRow=spriteRow,this.endX=endX,this.endY=endY,this.duration=duration,this.rotate={speed:0,pos:0,type:"free"},"object"==typeof rotateOptions)for(let y in rotateOptions)y in this.rotate&&(this.rotate[y]=rotateOptions[y]);this.size=size,this.maxDuration=duration,this.elapsed=0,this.type="none",this.color={r:color.r,g:color.g,b:color.b},this.color.isRandom="random"==color,this.bezier=bezier,this.isOpaqueTrail=isOpaqueTrail||!1,"randomEase"===this.type&&(this.random1=2*Math.random(),this.random2=2*Math.random()),this.trailArr=0,this.trailFrame=30,this.trailColor={r:255,g:255,b:255},isOpaqueTrail&&(this.trailArr=[],this.trailFrame="frame"in trailOptions?trailOptions.frame:30,this.trailColor.r="r"in trailOptions?trailOptions.r:255,this.trailColor.g="g"in trailOptions?trailOptions.g:255,this.trailColor.b="b"in trailOptions?trailOptions.b:255),this.imgRef=imgRef}update(){this.duration--,this.elapsed++;let fromX=this.x,fromY=this.y;this.x=this.startX+(this.endX-this.startX)*this.bezierFunc(this.duration/this.maxDuration,this.bezier.x1,this.bezier.x2,this.bezier.x3,this.bezier.x4),this.y=this.startY+(this.endY-this.startY)*this.bezierFunc(this.duration/this.maxDuration,this.bezier.y1,this.bezier.y2,this.bezier.y3,this.bezier.y4);let toX=this.x,toY=this.y;if(this.isOpaqueTrail){let len=this.trailArr.length;for(let h=0;h<len;h++){let ref=this.trailArr[h];ref.frame>0?(ref.frame-=2*particle.refreshRate,ref.frame<=0&&(ref.frame=0)):(this.trailArr.splice(h,1),len--,h--)}this.duration>=0&&this.trailArr.push(new ObjectTrail({x1:fromX+this.size/2,y1:fromY+this.size/2,x2:toX+this.size/2,y2:toY+this.size/2},this.trailFrame))}this.rotate.pos+=this.rotate.speed}getX(){return this.x}getY(){return this.y}opacityFade(){return Math.min(1,2.5*this.duration/this.maxDuration)}basicParticle(ctx){let size=this.size*game.fontSize*.2,color=this.color.isRandom?{r:~~(255*Math.random()),g:~~(255*Math.random()),b:~~(255*Math.random())}:this.color;ctx.fillStyle=`rgba(${color.r},${color.g},${color.b},${Math.floor(Math.min(100,250*this.duration/this.maxDuration))}%`,ctx.fillRect(this.x,this.y,size,size)}bezierFunc(t,initial,p1,p2,final){return(1-t)*(1-t)*(1-t)*initial+3*(1-t)*(1-t)*t*p1+3*(1-t)*t*t*p2+t*t*t*final}}class ObjectTrail{constructor(param,frame){this.x1=param.x1||0,this.y1=param.y1||0,this.x2=param.x2||0,this.y2=param.y2||0,this.distanceX=this.x1-this.x2,this.distanceY=this.y1-this.y2,this.angle=Math.atan(this.distanceY/(this.distanceX||1e-6)),this.frame=frame||30,this.frameMax=this.frame,this.width=param.width/2||3,this.maxWidth=this.width}static changePos(x,y){let x1=this.x2,y1=this.y2;this.x1=x1||0,this.y1=y1||0,this.x2=x||0,this.y2=y||0,this.distanceX=this.x2-this.x1,this.distanceY=this.y2-this.y1,this.angleX=Math.tan(Math.arctan(this.distanceY/(this.distanceX||1e-6))),this.angleY=Math.tan(Math.arctan(this.distanceX/(this.distanceY||1e-6)))}}class ParticleImage{constructor(imgRef,cw,ch){this.a=imgRef,this.cw=cw,this.ch=ch}}Path=class{constructor(){this.waypoints=[],this.lengths=[],this.length=0,this.seek=0,this.timing="linear",this.bez=[1/3,2/3],this.last={x:0,y:0}}setPath(arr){this.waypoints=arr,this.lengths.length=0,this.length=0;for(let g=0;g<this.waypoints.length-1;g++){let ref=this.waypoints[g],ref2=this.waypoints[g+1],dx=ref2.x-ref.x,dy=ref2.y-ref.y,length=Math.sqrt(dx*dx+dy*dy);this.length+=length,this.lengths.push(length),this.last.x=ref2.x,this.last.y=ref2.y}}setEasing(timing,bezier){}positionAt(seek){let ref=this.waypoints,ref2=this.lengths,target=seek*this.length,tr=0;for(let j=0;j<ref2.length;j++){if(tr+ref2[j]>=target){let time=(target-tr)/ref2[j];return{x:ref[j].x+(ref[j+1].x-ref[j].x)*time,y:ref[j].y+(ref[j+1].y-ref[j].y)*time}}tr+=ref2[j]}return ref[ref.length-1]}};const particle=new class{constructor(){this.refreshRate=1,this.canvas=id("PARTICLE-PARTICLE-CANVAS"),this.ctx=this.canvas.getContext("2d"),this.canvas2,this.canvas3,elem("CANVAS",e=>{this.canvas2=e}),elem("CANVAS",e=>{this.canvas3=e}),this.ctx2=this.canvas2.getContext("2d"),this.ctx3=this.canvas3.getContext("2d"),this.intrv=10,this.images={},this.particles=[],this.isClear=!1}refresh(){if(this.intrv<0){this.clear(this.ctx),animatedLayers.run();for(let dh=0;dh<this.refreshRate;dh++){this.intrv=-1;let msd=game.cellSize/20;if(this.particles.length>0)for(let i=0,len=this.particles.length;i<len;i++){if(void 0!==this.particles[i]){this.particles[i].update();let reference=this.particles[i];if(0==this.particles[i].maintype){if(reference.isOpaqueTrail){this.ctx.beginPath();let len=reference.trailArr.length;for(let h=0;h<len;h++){let ref=reference.trailArr[h],quot=Math.min(ref.frame/ref.frameMax*msd*2,msd);0==h?this.ctx.moveTo(ref.x2+Math.sin(ref.angle)*(ref.width*quot),ref.y2+Math.cos(ref.angle)*(-ref.width*quot)):this.ctx.lineTo(ref.x2+Math.sin(ref.angle)*(ref.width*quot),ref.y2+Math.cos(ref.angle)*(-ref.width*quot))}for(let h=len-1;h>=0;h--){let ref=reference.trailArr[h],quot=Math.min(ref.frame/ref.frameMax*msd*2,msd);this.ctx.lineTo(ref.x2+Math.sin(ref.angle)*(-ref.width*quot),ref.y2+Math.cos(ref.angle)*(ref.width*quot))}this.ctx.closePath(),this.ctx.fillStyle=`rgb(${reference.trailColor.r},${reference.trailColor.g},${reference.trailColor.b})`,this.ctx.fill()}this.dynamicDraw(game.cellSize,this.particles[i].imgRef,this.particles[i].getX(),this.particles[i].getY(),this.particles[i].spriteRow,this.particles[i].spriteCell,this.particles[i].duration>0?this.particles[i].size:0,this.particles[i].rotate.pos)}else this.particles[i].basicParticle(this.ctx);this.particles[i].duration<-30&&(this.particles.splice(i,1),len--,i--)}this.isClear=!1}else this.isClear||(this.clear(this.ctx2),this.isClear=!0)}}else this.intrv--}addImage(name,image,w,h){this.images[name]=new ParticleImage(image,w,h)}addParticle(cellSize,imgRef,spriteRow,spriteCell,startX,startY,endX,endY,duration,size,clr,bez,isTrail,trailOptions,rotateOptions){let color=clr||{r:255,g:255,b:255};this.particles.push(new ObjectParticle(0,duration*this.refreshRate,imgRef,spriteRow,spriteCell,endX-size*cellSize/2,endY-size*cellSize/2,startX-size*cellSize/2,startY-size*cellSize/2,size*cellSize,color,bez,isTrail,trailOptions,rotateOptions))}addBasicParticle(cellSize,startX,startY,endX,endY,duration,size,clr,bez,isTrail,trailOptions,rotateOptions){let color=clr||{r:255,g:255,b:255};this.particles.push(new ObjectParticle(1,duration*this.refreshRate,null,0,0,endX-size*cellSize/2,endY-size*cellSize/2,startX-size*cellSize/2,startY-size*cellSize/2,size*cellSize,color,bez,isTrail,trailOptions,rotateOptions))}customDraw(img,sx,sy,sw,sh,x,y,w,h){this.ctx2.drawImage(img,sx,sy,sw,sh,x,y,w,h)}dynamicDraw(cs,_img,x,y,r,cell,size,deg){let row;x=~~x;let img=this.images[_img],type=img.a;type=img.a,row=r,this.ctx.save(),this.ctx.translate(x+size/2,y+size/2),this.ctx.rotate(2*Math.PI*(deg/360)),this.ctx.drawImage(type,cell*img.cw,row*img.ch,img.cw,img.ch,-size/2,-size/2,size,size),this.ctx.restore()}size(w,h){this.canvas.width=w,this.canvas.height=h,this.canvas2.width=w,this.canvas2.height=h,this.canvas3.width=w,this.canvas3.height=h}clear(context){context.clearRect(0,0,context.canvas.width,context.canvas.height)}},animatedLayers=new class{#Image=class{constructor(w,h){this.a=null,this.w=w,this.h=h}load(img){this.a=img}};#ObjectLayer=class{constructor(frame,posX,posY,rot,imgX,imgY,frameW,frameH,boundX,speed,img,centerPos,lp,paused,opacity){this.pos={x:posX,y:posY,rot:rot||0},this.offsetPos={frame:0,frameMax:0,x:posX,y:posY,bez:[1/3,2/3]},this.offsetRot={frame:0,frameMax:0,rot:rot,bez:[1/3,2/3]},this.offsetFlip=[];for(let gsv=0;gsv<2;gsv++)this.offsetFlip.push({frame:0,frameMax:0,val:1,newVal:1,bez:[1/3,2/3]});this.img={w:imgX,h:imgY},this.opacity={fromValue:1,toValue:1,max:-1,time:-1},this.frame={w:frameW,h:frameH,int:frame,bound:boundX,elapsed:0,max:frame,rate:speed},this.a=img,this.sizeMult=1,this.centerPos={y:0,x:0},this.isSizeCustom=!1,this.controllable={on:!1},this.loop={},this.isPaused=paused;let loop=lp||{};this.loop.isOn=loop.isOn||!1,this.loop.targetFrame="targetFrame"in loop?loop.targetFrame:frame,this.loop.resetFrame=loop.resetFrame||0,"object"==typeof centerPos&&(this.centerPos.x=centerPos.x,this.centerPos.y=centerPos.y,this.isSizeCustom="sizecustom"in centerPos?centerPos.sizecustom:1,this.sizeMult="mult"in centerPos?centerPos.mult:1),this.path=new Path,this.pathFrame={int:0,max:0}}setPath(waypoints,frame,bez){this.path.setPath(waypoints),bez&&(this.path.bez=bez),this.pathFrame.int=frame,this.pathFrame.max=frame,this.pos.x=this.path.last.x,this.pos.y=this.path.last.y}scaleXOffset(x,nx,frame,bez){let msd=this.offsetFlip[0];msd.newVal=x,msd.val=nx,bez&&(msd.bez=bez),msd.frame=msd.frameMax=frame||0}scaleYOffset(x,nx,frame,bez){let msd=this.offsetFlip[1];msd.newVal=x,msd.val=nx,bez&&(msd.bez=bez),msd.frame=msd.frameMax=frame||0}moveOffset(x0,y0,x1,y1,frame,bez){this.offsetPos.x=x0,this.offsetPos.y=y0,this.pos.x=x1,this.pos.y=y1,bez&&(this.offsetPos.bez=bez),this.offsetPos.frame=this.offsetPos.frameMax=frame||0}rotateOffset(r0,r1,frame,bez){this.offsetRot.rot=r0,this.pos.rot=r1,bez&&(this.offsetRot.bez=bez),this.offsetRot.frame=this.offsetRot.frameMax=frame||0}setFrame(frame){let el=this,decimal=el.frame.elapsed-~~el.frame.elapsed;el.frame.int=el.frame.max-(frame+decimal),el.frame.elapsed=frame+decimal}};constructor(ctx){this.cellSize=0,this.ctx=ctx,this.images={},this.main=new ObjectFunctionIterator(ob=>{let g=Object.keys(ob),l=g.length;for(let h=0;h<l;h++){let el=ob[g[h]],opacityDifference=0;el.opacity.time<=1+el.opacity.max?(el.opacity.time++,el.opacity.max<el.opacity.time&&(el.opacity.time=el.opacity.max),opacityDifference=(el.opacity.toValue-el.opacity.fromValue)*((el.opacity.max-el.opacity.time)/el.opacity.max)):opacityDifference=0,this.ctx.globalAlpha=el.opacity.toValue-opacityDifference;let mnx=el.pos.x,mny=el.pos.y,mnr=el.pos.rot;if(el.offsetPos.frame>0){let bm=bezier1D(el.offsetPos.frame/el.offsetPos.frameMax,el.offsetPos.bez[0],el.offsetPos.bez[1]);mnx=el.pos.x+(el.offsetPos.x-el.pos.x)*bm,mny=el.pos.y+(el.offsetPos.y-el.pos.y)*bm,el.offsetPos.frame--}if(el.pathFrame.int>0){let bm=bezier1D((el.pathFrame.max-el.pathFrame.int)/el.pathFrame.max,el.path.bez[0],el.path.bez[1]),re=el.path.positionAt(bm);mnx=re.x,mny=re.y,el.pathFrame.int--}if(el.offsetRot.frame>0){let bm=bezier1D(el.offsetRot.frame/el.offsetRot.frameMax,el.offsetRot.bez[0],el.offsetRot.bez[1]);mnr=el.pos.rot+(el.offsetRot.rot-el.pos.rot)*bm,el.offsetRot.frame--}for(let hsm=0;hsm<2;hsm++){let msd=el.offsetFlip[hsm];if(msd.out=msd.val,msd.frame>0){let bm=bezier1D(msd.frame/msd.frameMax,msd.bez[0],msd.bez[1]);msd.out=msd.val+(msd.newVal-msd.val)*bm,msd.frame--}}let sizeMult=el.isSizeCustom?el.sizeMult:this.cellSize*el.sizeMult;if(this.ctx.save(),this.ctx.translate(el.centerPos.x+mnx*sizeMult,el.centerPos.y+mny*sizeMult),this.ctx.rotate(2*Math.PI*(mnr/360)),this.ctx.translate(0-0*sizeMult*(el.img.w/2),0-0*sizeMult*(el.img.h/2)),this.ctx.scale(el.offsetFlip[0].out,el.offsetFlip[1].out),this.ctx.drawImage(this.images[el.a].a,~~(Math.floor(el.frame.elapsed)%el.frame.bound)*el.frame.w,~~(~~el.frame.elapsed/el.frame.bound)*el.frame.h,el.frame.w,el.frame.h,-sizeMult*(el.img.w/2),-sizeMult*(el.img.h/2),sizeMult*el.img.w,sizeMult*el.img.h),this.ctx.restore(),this.ctx.globalAlpha=1,el.isPaused||(el.frame.int-=el.frame.rate,el.frame.elapsed+=el.frame.rate),el.loop.isOn&&(el.loop.targetFrame<=~~el.frame.elapsed||el.frame.int<=0-el.frame.rate)){let decimal=el.frame.elapsed-~~el.frame.elapsed;el.frame.int=el.frame.max-(el.loop.resetFrame+decimal),el.frame.elapsed=el.loop.resetFrame+decimal}el.frame.int<=0-el.frame.rate&&!el.loop.isOn&&!el.isPaused&&(delete ob[g[h]],g.splice(h,1),h--,l--)}})}getObject(name){return this.main.obj[name]}checkObject(boolName){return boolName in this.main.obj}create(id,frame,centerX,centerY,posX,posY,rot,frameW,frameH,w,h,speed,img,boundX,sizeMult,loop,paused,isSizeCustom){return this.main.addItem(id||2147483647*Math.random(),new this.#ObjectLayer(frame,posX-0*this.cellSize*w/2,posY-0*this.cellSize*h/2,rot,w,h,frameW,frameH,boundX||10,speed,img,{x:centerX||0,y:centerY||0,mult:void 0!==sizeMult?sizeMult:1,sizecustom:isSizeCustom},loop,paused,1)),this.main.obj[name]}setOpacity(name,value,time){this.main.obj[name].opacity.fromValue=this.main.obj[name].opacity.toValue,this.main.obj[name].opacity.toValue=value,this.main.obj[name].opacity.max=time||-88,this.main.obj[name].opacity.time=0}remove(id){this.checkObject(id)&&this.main.remove(id)}loadOffline(id,img,w,h){this.images[id]=new this.#Image(w,h),this.images[id].load(img)}loadOfflineArr(arr){for(let a of arr){let m=a.dir;this.images[a.name]=new this.#Image(m.width,m.height),this.images[a.name].load(m)}}load(arr){return new Promise(async res=>{for(let a of arr){let m=await loadImage(a.dir);this.images[a.name]=new this.#Image(m.width,m.height),this.images[a.name].load(m)}res()})}run(){this.main.update()}}(particle.ctx);class NoAI{#core=0;active=!0;constructor(parent,name,text){this.parent=parent,this.active=!1}engageWorker(){}loadFrenzyMovements(file){}run(a){}postToCore(jsobj){}async evaluate(active,hold,isHeld,next,b2b,combo,grid,hx,hy,px,py,prot,temp){}}class BaseAI{controls={1:"A",2:"B",5:"C",6:"D",7:"E",3:"F",4:"G",128:"H"};bitToFlag={A:"left",B:"right",C:"softdrop",D:"harddrop",E:"hold",F:"cw",G:"ccw",H:"c180w"};isThinking=!1}class ArtificialIntelligence extends BaseAI{#core=0;constructor(parent,name,text){super(),this.parent=parent,this.delayReset=10,this.moves=[],this.active=!1,this.pressStr=0,this.pressLast=0,this.pieceDelay=0,this.ai={controlImg:{x:0,y:0,rot:0,hold:0},rotations:[[0],[1,1,1,1],[2,2,2,2]],enableTspin:!0,grid:[],ppsLimit:1,extraMovements:[],x:0,y:0,rot:0,matrix:[],heuristicsWeight:{aggHeight:-510066e-10,bump:-.184483,lines:.1760666,holes:-41.0000300044,blockade:-.0666,failedTspin:-994,failedWide:-990,b2b:.75,possibleSpin:.22202},failedWide:0,tspinDetector:{tslot:[[0,1],[1,1],[2,1],[1,2]],bottom:[[0,2],[2,2]],tuck:[[0,0,[[1,0],[2,0]]],[2,0,[[0,0],[1,0]]]]},tspinHeight:5,flag:{LEFT:1,RIGHT:2,SOFTDROP:4,HARDDROP:8,HOLD:16,CW:32,CCW:64,C180W:128},tspinDetected:{tslot:[],bottom:[],tuck:[],tLines:[],tBlock:[],tSlot:[],tAvoidColumn:[]}},this.name=name,this.text=text,this.isThinking=!1}engageWorker(){multithread.engageWorker(this.name,this.text,a=>{this.#core=a.worker})}loadFrenzyMovements(file){}j={1:"A",2:"B",4:"C",8:"D",16:"E",32:"F",64:"G",128:"H"};run(a){let isTooMuchChain=!1;if(4!==this.moves[0]&&this.pressStr>0)return this.pressStr=0,void this.moves.shift();if(game.forEachPlayer(player=>{player.blob.forecastedChain>5&&(isTooMuchChain=!0)}),this.pieceDelay<0){this.pieceDelay=15*Math.random()+5,this.parent.block.isProfessional&&(this.pieceDelay+=30),isTooMuchChain&&(this.pieceDelay=0);for(let g=0;g<this.moves.length;g++){let h=this.moves[g];if(this.pressStr=game.bitFlags[this.bitToFlag[this.j[h]]],4==h){if(this.parent.block.checkValid(this.parent.block.piece.activeArr,0,1))break;this.pressStr^=game.bitFlags.softdrop,this.pieceDelay=-999,this.moves.shift(),g--}break}}this.pieceDelay--}postToCore(jsobj){try{this.#core.postMessage(jsobj)}catch(e){}return new Promise(res=>{this.#core.addEventListener("message",te=>{res(te.data)},{once:!0})})}async evaluate(active,hold,isHeld,next,b2b,combo,grid,hx,hy,px,py,prot,temp){if(isHeld)return;let obj={grid:JSON.parse(JSON.stringify(grid)),b2b:b2b,preset:this.ai,pieceSet:temp,isWarning:this.parent.isWarning,width:10,height:40,hiddenHeight:20,visibleHeight:20,combo:this.parent.block.combo,isEnable180:!1,piecesCount:1,tFulfill:this.ai.tspinDetected.tFulfill||[],tPrevent:this.ai.tspinDetected.tPrevent||[],tLines:this.ai.tspinDetected.tLines||[],tAvoidColumn:this.ai.tspinDetected.tAvoidColumn||[]};this.moves=[];let args=[active,hold,next,obj,px,py,hx,hy,prot],best=await this.postToCore(args);this.moves=best.move,this.ai.tspinDetected.tLines=best.tl,this.ai.tspinDetected.tAvoidColumn=best.ta,this.ai.tspinDetected.tPrevent=best.tp,this.ai.tspinDetected.tFulfill=best.tf}}class NeoplexArtificialIntelligence extends BaseAI{#core=0;constructor(parent,name,text){super(),this.delRes=5,this.del=0,this.active=!1,this.pressStr=0,this.pressLast="",this.moves=[],this.parent=parent,this.name=name,this.text=text,this.isThinking=!1}engageWorker(){multithread.engageWorker(this.name,this.text,a=>{this.#core=a.worker,this.#core.onerror=e=>{console.warn(e.message,e.colno,e.lineno)}})}postToCore(obj){try{this.#core.postMessage(obj)}catch(e){}return new Promise(res=>{this.#core.addEventListener("message",t=>{res(t.data)},{once:!0})})}run(){if(this.pressStr>0&&5!==this.moves[0])return this.pressStr=0,void this.moves.shift();if(this.del<0){this.del=0*Math.random()+0;for(let g=0;g<this.moves.length;g++){let m=this.controls,h=this.moves[g];if(this.pressStr=game.bitFlags[this.bitToFlag[m[h]]],5==h){if(this.parent.block.checkValid(this.parent.block.piece.activeArr,0,1))break;this.pressStr^=game.bitFlags.softdrop,this.del=-999,this.moves.shift(),g--}break}}this.del--}async evaluate(active,hold,isHeld,next,b2b,combo,grid,hx,hy,px,py,prot,temp,drawMatrix,count){if(isHeld)return;this.isThinking=!0,this.moves.length=0;let args=[10,20,20,40,grid,active,hold,next,this.parent.block.combo,count],g=(await this.postToCore(args)).a;this.moves=g[1],this.isThinking=!1}}class NeoplexBlobArtificialIntelligence extends BaseAI{#core=0;#functions=0;constructor(parent,name,text,funcText){super(),this.delRes=10,this.del=0,this.active=!1,this.pressStr=0,this.pressLast="",this.moves=[],this.previous={x:2,rot:0},this.movePos={x:0,y:0,rot:0},this.parent=parent,this.name=name,this.text=text,this.funcText=funcText,this.isThinking=!1}engageWorker(){multithread.engageWorker(this.name,this.text,a=>{this.#core=a.worker,this.#core.onerror=e=>{alert("AWWW SNAP "+e.message,e.colno,e.lineno)}}),multithread.engageWorker(this.name,this.funcText,a=>{this.#functions=a.worker,this.#functions.onerror=e=>{console.warn("AW SNAP "+e.message,e.colno,e.lineno)}})}postToCore(obj){try{this.#core.postMessage(obj)}catch(e){}return new Promise(res=>{this.#core.addEventListener("message",t=>{res(t.data)},{once:!0})})}postToFunctions(obj){try{this.#functions.postMessage(obj)}catch(e){}return new Promise(res=>{this.#functions.addEventListener("message",t=>{res(t.data)},{once:!0})})}run(){if(this.pressStr>0&&5!==this.moves[0])return this.pressStr=0,void this.moves.shift();if(this.del<0){this.del=0*Math.random()+0;for(let g=0;g<this.moves.length;g++){let m=this.controls,h=this.moves[g];this.parent.flagPresses.softdrop||(this.pressStr=game.bitFlags[this.bitToFlag[m[h]]]),5==h&&(this.parent.blob.checkValid(this.parent.blob.piece.activeArr,0,1)?this.del=-999:(this.pressStr^=game.bitFlags.softdrop,this.del=-999,this.moves.shift(),g--));break}}this.del--}evalNode(arr){return new Promise(res=>{})}async evaluate(stack,preview,w,h,vh,hh){this.moves.length=0;let args=[stack,preview,w,h,hh,vh],best=(await this.postToCore(args)).a,px=1,rot=0;for(this.previous.x=best.x,this.previous.rot=best.rot;rot!==best.rot;)this.moves.push(3),rot++;for(;px!==best.x;)px>best.x&&(px--,this.moves.push(1)),px<best.x&&(px++,this.moves.push(2));this.moves.push(5),this.moves.push(6)}}class Neoplex2BlobArtificialIntelligence extends BaseAI{#core=0;constructor(parent,name,text){super(),this.parent=parent,this.delayReset=10,this.moves=[],this.active=!1,this.pressStr=0,this.pressLast="",this.del=10,this.ai={x:0,y:0,rot:0,enable:0},this.name=name,this.text=text,this.isThinking=!1}engageWorker(){multithread.engageWorker(this.name,this.text,a=>{this.#core=a.worker,this.#core.onerror=e=>{console.warn(e.message,e.colno,e.lineno)}})}m={1:"A",2:"B",5:"C",6:"D",7:"E",3:"G",4:"F",128:"H"};run(a){if(this.pressStr>0&&5!==this.moves[0])return this.pressStr=0,void this.moves.shift();if(1!==this.parent.activeType)return;let isTooMuchChain=this.parent.blob.insane.isOn||this.parent.blob.isWarning;if(game.forEachPlayer(player=>{player.blob.forecastedChain>6&&(isTooMuchChain=!0)}),this.del<0){this.del=0*Math.random()+(isTooMuchChain?0:10);for(let g=0;g<this.moves.length;g++){let h=this.moves[g];this.parent.flagPresses.softdrop||(this.pressStr=game.bitFlags[this.bitToFlag[this.m[h]]]),5==h&&(this.parent.blob.piece.enable&&this.active?(this.del=-999,this.parent.blob.y>=0&&!(this.pressStr&game.bitFlags.softdrop)&&(this.pressStr=game.bitFlags.softdrop)):(this.pressStr^=game.bitFlags.softdrop,this.del=-999,this.moves.shift(),g--));break}}this.del--}postToCore(jsobj){try{this.#core.postMessage(jsobj)}catch(e){}return new Promise(res=>{this.#core.addEventListener("message",te=>{res(te.data)},{once:!0})})}async evaluate(stack,preview,w,h,vh,hh){this.active=!1,this.moves=[5];let colors=[];for(let color=0;color<this.parent.blob.colors;color++)colors.push(this.parent.blob.colorSet[color]);let prev=this.parent.blob.piece.active,arr=[stack,w,hh,vh,this.#blobTranslate(prev.color1,prev.color2,prev.type),this.parent.garbageLength+(this.parent.blob.insane.isOn||this.parent.blob.isWarning?8:0),this.parent.blob.piece.isBig,colors],best=await this.postToCore(arr);best=best.a;let limit=30;this.active=!0,this.ai.x=best.x,this.moves.length=0,this.ai.rot=best.rot;let rot=this.parent.blob.piece.rot;if(this.parent.blob.piece.isBig)for(;rot!==best.rot&&limit>0;)best.rot<rot?(this.moves.push(4),rot--):(this.moves.push(3),rot++),limit--;else for(;rot!==best.rot&&limit>0;)3===best.rot?(this.moves.push(4),rot=3):(this.moves.push(3),rot++),limit--;let px=this.parent.blob.piece.x;for(;px!==best.x&&limit>0;)px>best.x&&(px--,this.moves.push(1)),px<best.x&&(px++,this.moves.push(2)),limit--;this.moves.push(5)}#blobTranslate(c,d,t){return[[[[0,0,0],[c,d,0],[0,0,0]],[[0,0,0],[0,d,0],[0,c,0]],[[0,0,0],[0,d,c],[0,0,0]],[[0,c,0],[0,d,0],[0,0,0]]],[[[0,0,0],[c,d,0],[0,d,0]],[[0,0,0],[0,d,d],[0,c,0]],[[0,d,0],[0,d,c],[0,0,0]],[[0,c,0],[d,d,0],[0,0,0]]],[[[0,0,0],[d,d,0],[0,c,0]],[[0,0,0],[0,d,c],[0,d,0]],[[0,c,0],[0,d,d],[0,0,0]],[[0,d,0],[c,d,0],[0,0,0]]],[[[0,0,0],[c,c,0],[d,d,0]],[[0,0,0],[c,d,0],[c,d,0]],[[0,0,0],[d,d,0],[c,c,0]],[[0,0,0],[d,c,0],[d,c,0]]],[[[0,0,0],[d,d,0],[d,d,0]],[[0,0,0],[d,d,0],[d,d,0]],[[0,0,0],[d,d,0],[d,d,0]],[[0,0,0],[d,d,0],[d,d,0]]]][t]}}class NeoplexStaticFrenzyAI{#core=0;constructor(parent,name,text){this.parent=parent,this.delayReset=10,this.moves=[],this.active=!1,this.pressStr=0,this.pressLast=0,this.pieceDelay=0,this.ai={controlImg:{x:0,y:0,rot:0,hold:0},rotations:[[0],[1,1,1,1],[2,2,2,2]],enableTspin:!1,grid:[],ppsLimit:289,extraMovements:[],x:0,y:0,rot:0,matrix:[],heuristicsWeight:{aggHeight:-510066e-10,bump:-.184483,lines:.1760666,holes:-41.0000300044,blockade:-.0666,failedTspin:-994,failedWide:-0,b2b:.75,possibleSpin:.202},failedWide:0,tspinDetector:{tslot:[[0,1],[1,1],[2,1],[1,2]],bottom:[[0,2],[2,2]],tuck:[[0,0,[[1,0],[2,0]]],[2,0,[[0,0],[1,0]]]]},tspinHeight:5,flag:{LEFT:1,RIGHT:2,SOFTDROP:4,HARDDROP:8,HOLD:16,CW:32,CCW:64,C180W:128},tspinDetected:{tslot:[],bottom:[],tuck:[],tLines:[],tBlock:[],tSlot:[],tAvoidColumn:[]}}}engageWorker(){multithread.engageWorker(this.name,this.text,a=>{this.#core=a.worker,this.#core.onerror=e=>{console.warn(e.message,e.colno,e.lineno)}})}loadFrenzyMovements(file){}run(a){this.pressStr="";let isTooMuchChain=!1;if(game.forEachPlayer(player=>{player.blob.forecastedChain>5&&(isTooMuchChain=!0)}),this.pieceDelay<0)if(this.pieceDelay=10*Math.random()+0,isTooMuchChain&&(this.pieceDelay=0),this.ai.extraMovements.length>0&&this.parent.block.frenzy.isOn){let isSoftDrop=0,j={1:"Aa",2:"Bb",3:"C",4:"Dd",5:"Ee",6:"Gg",7:"Ff",8:"Hh"},h=this.ai.extraMovements[0];this.parent.flagPresses.softdrop||(this.pressStr+=j[h]),4==h&&(this.parent.block.checkValid(this.parent.block.piece.activeArr,0,1)?(this.pieceDelay=-999,isSoftDrop=1):(this.pieceDelay=-999,this.pressStr+="c")),isSoftDrop||this.ai.extraMovements.shift()}else for(let g=0;g<this.moves.length;g++){let j={1:"Aa",2:"Bb",4:"C",8:"Dd",16:"Ee",32:"Gg",64:"Ff",128:"Hh"},h=this.moves[g];if(this.parent.flagPresses.softdrop||(this.pressStr+=j[h]),4==h){if(this.parent.block.checkValid(this.parent.block.piece.activeArr,0,1))break;this.pieceDelay=-999,this.pressStr+="c"}this.moves.shift(),g--;break}this.pieceDelay--}postToCore(jsobj){try{this.#core.postMessage(jsobj)}catch(e){}return new Promise(res=>{this.#core.addEventListener("message",te=>{res(te.data)},{once:!0})})}async evaluate(active,hold,isHeld,next,b2b,combo,grid,hx,hy,px,py,prot,temp){if(isHeld)return;let obj={grid:JSON.parse(JSON.stringify(grid)),b2b:b2b,preset:this.ai,pieceSet:temp,isWarning:!1,width:10,height:40,hiddenHeight:20,visibleHeight:20,combo:this.parent.block.combo,isEnable180:!1,piecesCount:1,tFulfill:this.ai.tspinDetected.tFulfill||[],tPrevent:this.ai.tspinDetected.tPrevent||[],tLines:this.ai.tspinDetected.tLines||[],tAvoidColumn:this.ai.tspinDetected.tAvoidColumn||[]};this.moves=[];let args=[active,hold,next,obj,px,py,hx,hy,prot],best=await this.postToCore(args);this.moves=best.move,this.ai.tspinDetected.tLines=best.tl,this.ai.tspinDetected.tAvoidColumn=best.ta,this.ai.tspinDetected.tPrevent=best.tp,this.ai.tspinDetected.tFulfill=best.tf;for(let v=0,len=this.moves.length;v<len;v++);}}class ArtificialIntelligenceRPG{constructor(par){this.a=par,this.skillTime=0,this.pressStr=0}run(){if(this.pressStr>0)return this.pressStr=0,void this.moves.shift();if(this.a.rpgAttr.isOn&&this.a.rpgAttr.isRPG&&this.a.rpgAttr.isUsableSkills){let a=this.a,b=a.rpgAttr;if(this.skillTime<=0)do{if(this.skillTime=5,b.hp/b.maxHP<.3&&this.useSkill(["immunity","healing"]))break;if(b.hpDamage/b.hp>.3&&this.useSkill(["absorption","defup"]))break;if(0==a.activeType&&(a.block.stackAltitude-a.block.fieldSize.hh)/a.block.fieldSize.vh<.355&&this.useSkill(["avalanche","lineclear"]))break;this.skillTime=50}while(0);else this.skillTime--}}useSkill(desc){let a=this.a.rpgAttr,b=a.deck.characters;for(let x=0;x<3;x++){let r=b[x];if(!(r.skill.mana>a.mana||r.skill.cooldown>0))for(let j of desc)if(-1!==r.skill.rawDesc.indexOf(j))return this.pressStr|=game.bitFlags[`s${x+1}`],!0}return!1}useSkillWithExclusion(excludeDesc){let a=this.a.rpgAttr,b=a.deck.characters;for(let x=0;x<3;x++){let r=b[x];if(!(r.skill.mana>a.mana||r.skill.cooldown>0))for(let j of excludeDesc)if(-1===r.skill.rawDesc.indexOf(j))return this.pressStr|=game.bitFlags[`s${x+1}`],!0}return!1}}const music=new class{Song=class{constructor(parent){this.parent=parent,this.sources={start:null,loop:null,end:null},this.seekTime=0,this.startTime=0,this.continuable=!1,this.isReady=!1,this.isMiddlePlay=!1,this.isPlaying=!1,this.bpmSync={active:!1,timeSignature:1}}load(url,continuable,bpmSync,callback){let count=0,start=new this.parent.SongSource(this),loop=new this.parent.SongSource(this),end=new this.parent.SongSource(this);this.sources.start=start,this.sources.loop=loop,this.sources.end=end;let ls=2,cb=()=>{count++,count>=ls&&(this.isReady=!0,callback())};this.continuable=continuable||!1,memoryManager.asyncLoad(url+"/files.json","text").then(jsontxt=>{let h=JSON.parse(jsontxt);ls=Object.keys(h).length;for(let ms in h)this.sources[ms].loadBuffer(url+"/"+h[ms],"loop"===ms,cb);bpmSync.active&&(this.bpmSync.active=!0,this.bpmSync.timeSignature=bpmSync.timeSignature,this.bpmSync.bpm=bpmSync.bpm)})}getNextMeasureTime(){let now=this.parent.getCtxCurrentTime();if(!this.bpmSync.active)return now;let loopStartTime=this.startTime+this.sources.start.duration,measureDuration=60/this.bpmSync.bpm*(4*this.bpmSync.timeSignature);return now+(measureDuration-(now-loopStartTime)%measureDuration)}play(continuable,time){if(!this.isReady)return;this.sources.loop.stop(),this.sources.start.stop();let seek=0;continuable&&this.continuable&&this.isMiddlePlay&&(seek=Math.max(this.seekTime,0));let now=void 0!==time?time:this.parent.getCtxCurrentTime();this.startTime=now,this.isPlaying=!0,this.isMiddlePlay=!0,seek<this.sources.start.duration&&this.sources.start.play(now,seek),this.sources.loop.play(now+this.sources.start.duration-Math.min(this.sources.start.duration,seek),Math.max(0,seek-this.sources.start.duration)%this.sources.loop.duration)}stop(isForce){if(!this.isReady)return;if(!this.isPlaying)return;let now=this.getNextMeasureTime(),ns=this.parent.getCtxCurrentTime();this.sources.loop.stop(now),this.sources.start.stop(now),this.bpmSync.active&&this.sources.end.play(now),this.isPlaying=!1,this.seekTime+=ns-this.startTime}resetSeek(){let now=this.parent.getCtxCurrentTime();this.seekTime=0,this.startTime=now,this.isMiddlePlay=!1}};SongSource=class{constructor(parent){this.buffer,this.startTime=0,this.duration=0,this.ready=!1,this.parent=parent,this.superparent=parent.parent,this.source=null,this.isPlaying=!1,this.isLoop=!1,this.isStop=!1}async loadBuffer(url,isLoop,callback){this.ready=!1;let arrayBuffer=await memoryManager.asyncLoad(url,"blob"),ab=await arrayBuffer.arrayBuffer();this.buffer=await this.superparent.ctx.decodeAudioData(ab),this.isLoop=isLoop,this.duration=this.buffer.duration,this.ready=!0,callback()}play(now,seek=0){if(this?.source&&this.isPlaying&&this.isStop){let _now=this.superparent.getCtxCurrentTime();this.isPlaying=!1,this?.source.stop(_now)}this.startTime=now,this.source=this.superparent.ctx.createBufferSource(),this.source.buffer=this.buffer,this.source.connect(this.superparent.gain),this.source.loop=this.isLoop,this.isStop=!1,this.source.start(now+0,seek),this.isPlaying=!0}stop(time){let now=this.superparent.getCtxCurrentTime(),n=void 0!==time?time:now;this.source&&this.isPlaying&&!this.isStop&&(this.isPlaying=!1,this.source.stop(n),this.isStop=!0)}};constructor(){this.ctx=audioMaster.ctx,this.gain=this.ctx.createGain(),this.gain.connect(this.ctx.destination),this.songs={},this.references={},this.volume=100,this.active="",this.isReady=!1,this.bpmSyncStopTime=0}getCtxCurrentTime(){return this.ctx.currentTime}volumeSet(volume){this.gain.gain.value=volume/100}load(arr){let notExist=[];for(let g of arr)g.path in this.songs||notExist.push(g);if(notExist.length>0){let count=0;this.isReady=!1;for(let a of notExist){let song=new this.Song(this),url=`/assets/music/${a.path}`;this.songs[a.path]=song,song.load(url,a.continuable,a.bpmSync,()=>{count++,count>=notExist.length&&(this.isReady=!0)})}}for(let g of arr)this.references[g.name]=g.path}play(name,c){let newTime=this.getCtxCurrentTime(),lastActive=this.active;lastActive in this.references&&this.songs[this.references[lastActive]].bpmSync.active&&(newTime=this.songs[this.references[lastActive]].getNextMeasureTime(),this.bpmSyncStopTime=newTime);for(let _a in this.songs){this.songs[_a].stop(!1)}this.active=name;let m=this.songs[this.references[name]];m&&m.play(c,Math.max(newTime,this.bpmSyncStopTime))}stopAll(isForce){let newTime=this.getCtxCurrentTime(),lastActive=this.active;lastActive in this.references&&this.songs[this.references[lastActive]].bpmSync.active&&(newTime=this.songs[this.references[lastActive]].getNextMeasureTime(),this.bpmSyncStopTime=newTime);for(let _a in this.songs){this.songs[_a].stop(isForce)}this.active=""}resetAllSeek(){for(let _a in this.songs){this.songs[_a].resetSeek()}}};__main_params__.__private.music=music;const sound=new class{constructor(){this.sounds={},this.isReady=!0,this.soundNames={},this.volume=100,this.bytes=0}load(filename,required){let direct=`/assets/sounds/game/${filename}/init.json`;return this.isReady=!1,new Promise(async(res,rej)=>{if(direct in this.soundNames)return res(),void(this.isReady=!0);let loaded=0,loadLength=0,a=JSON.parse(await load(direct,"text"));this.soundNames[direct]=a;let sounds=[];for(let b in a.sounds){let mref=a.sounds[b],reference=a.sources.main[mref.src];sounds.push({name:b,src:`/assets/sounds/game/${filename}/${reference}`,loop:mref.loop}),loadLength++}for(let b=1;b<=a.sources.chain.count;b++){let reference=a.sources.chain.src,directory=`/assets/sounds/game/${filename}/${reference}${b}.${a.sources.chain.filetype}`;sounds.push({name:a.sources.chain.name+b,src:directory,loop:!1}),loadLength++}if("swapcombo"in a.sources)for(let b=1;b<=a.sources.swapcombo.count;b++){let reference=a.sources.swapcombo.src,directory=`/assets/sounds/game/${filename}/${reference}${b}.${a.sources.swapcombo.filetype}`;sounds.push({name:a.sources.swapcombo.name+b,src:directory,loop:!1}),loadLength++}for(let b of sounds)this.sounds[b.name]=audioMaster.createAudio({src:b.src,loop:b.loop}),this.sounds[b.name].load().then(sh=>{loaded++,loaded>=loadLength&&(this.isReady=!0,"volumeSet"in this&&this.volumeSet(this.volume),res())})})}stop(str){str in this.sounds&&this.sounds[str].stop()}getSound(str){}play(str){let id=-1;return str in this.sounds&&(id=this.sounds[str].play()),id}rate(str,value){str in this.sounds&&this.sounds[str].rate(void 0!==value?value:1)}volumeSet(value){this.volume=value;for(let str in this.sounds)"volume"in this.sounds[str]&&this.sounds[str].volume(value/100)}};class GTRISSoundObject{constructor(obj){this.doc=document.createElement("audio"),this._volume=obj.volume||0,this._loop=obj.loop||!1,this._src=obj.src||"",this.doc.src=this._src,this.doc.volume=this._volume,this.doc.loop=this._loop,obj.preload&&this.doc.load()}load(){this.doc.load()}play(seek){this.doc.currentTime=seek||0,this.doc.play().catch(e=>{console.error(`GTRISSoundObject object with the source destination "${this._src}" cannot play a non-existent sound file.`)})}stop(){this.doc.pause()}once(evt,func){this.doc.addEventListener(evt,func,{once:!0})}volume(v){this._volume=v,this.doc.volume=v}rate(e){}stereo(){}}class GTRISNoSoundObject{constructor(obj){this.doc=0,this._volume=obj.volume||0,this._loop=obj.loop||!1,this._src=obj.src||"",this.doc.src=this._src,this.doc.volume=this._volume,this.doc.loop=this._loop}load(){}play(seek){}stop(){}once(evt,func){}volume(v){}rate(e){}stereo(){}}__main_params__.__private.sound=sound;class MainPlayerFragment{DEFAULT_CHAIN_POWER_PRESET=JSON.parse(JSON.stringify(TSU_CHAIN_POWER));DEFAULT_CHAIN_FEVER_POWER_PRESET=[0,6,10,16,23,32,44,63,74,97,120,157,176,211,244,281,315,351,416,473,542,604,644,681];DEFAULT_DROPSET=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];DEFAULT_SPELL_SEQUENCE=JSON.stringify(CHAIN_SEQUENCE);static DEFAULT_HENSHIN_SPELL_SEQUENCE=["t_count1","t_count2","t_count3","t_count4","t_count5","t_count6","t_count7","init1","init2","init3","init4","init5","spell1","spell2","spell3","spell4","spell5","t_small","t_small","t_small","t_small"];constructor(player,n){this.player=player;let regex=/PNUMBER/gm;this.assetHTML=manager.assetHTML.replace(regex,"P"+this.player),this.assetStyle=manager.assetStyle.replace(regex,"P"+this.player),this.htmlElements=[],this.soundActive=!0,this.particleGarbageDelay=25,this.team=Math.random(),this.isPhylum=!1,this.name="No name",this.wins=0,this.playerCenterPos={x:0,y:0},this.isVisible=!0,this.score=0,this.addScoreText="",this.scoreText=new NumberChangeFuncExec(0,m=>{this.editIH("STATS-SCORE-TEXT",m)}),this.animationLayerElements=[],this.fieldSize={w:10,h:40,vh:20,hh:22},this.rectanim=new RectangularAnimations(this),this.rpgAttr=new RPGAttributes(this),this.visibleFieldBufferHeight=5,this.visibleFieldHeight=0,this.character={current:0,canvas:void 0,ctx:void 0,active:!1,voices:{},voiceActive:"",voiceID:-1,activeVoiceline:"",load:!1,defaultAttributes:{hp:300,def:100,atk:10,mp:50,lifesteal:0,atktol:13,hpregen:3,hpregentol:1,hpregentime:40},attributes:{hp:300,def:100,atk:10,mp:50,lifesteal:0,atktol:13,hpregen:3,hpregentol:1,hpregentime:40},isUniqueVoicePlay:!1,blob:{chainPower:JSON.parse(JSON.stringify(this.DEFAULT_CHAIN_POWER_PRESET)),feverPower:JSON.parse(JSON.stringify(this.DEFAULT_CHAIN_FEVER_POWER_PRESET)),dropset:JSON.parse(JSON.stringify(this.DEFAULT_DROPSET))},isCounting:!1,char:null,ver:null,jsonString:null,loadable:!1,jsonLoaded:!1,json:{}},elem("CANVAS",canvas=>{canvas.width=3e3,canvas.height=3e3,this.character.canvas=canvas;let ctx=canvas.getContext("2d");this.character.ctx=ctx}),this.meterBar={right:new MeterBar,garbwait:new MultipleMeterBar(3)},this.color={r:0,g:0,b:0},this.seeds={field:new ParkMillerPRNG},this.pressStr="",this.lastPressStr="",this.lastAckedFrame=0,this.cellSize=0,this.fieldCellSize=0,this.clearText={tspin:new GIFRenderer(8640,180,180,180,1,(a,canv,x,y,w,h,frame,that)=>{let b=a.canvas;a.clearRect(0,0,b.width,b.height),a.drawImage(canv,x*w,y*h,w,h,0,0,w,h),that.frame.x++,that.frameCount++,frame>=48&&(that.enabled=!1),42==frame&&this.clearText.tspinLine.assign(0)},frame=>{this.setStyle("CLEARTEXT-CANVTEXT","animation-delay",~~(1e3/-60*frame)+"ms")}),tspinLine:new NumberChangeFuncExec(!1,state=>{let e="CLEARTEXT-TSPIN-LINE",element=this.getAsset(e);this.setStyle(e,"animation","none"),element.offsetHeight,1==state?(this.setStyle(e,"opacity","100%"),this.setStyle(e,"animation","fade-in 200ms 1 linear")):2==state?this.setStyle(e,"opacity","0%"):0==state&&(this.setStyle(e,"animation","fade-out 300ms 1 linear"),this.setStyle(e,"opacity","0%"))}),b2b:new NumberChangeFuncExec(!1,state=>{let e="CLEARTEXT-TEXT-B2B",element=this.getAsset(e);this.setStyle(e,"animation","none"),element.offsetHeight,1==state?(this.setStyle(e,"opacity","100%"),this.setStyle(e,"animation-name","ct-anim-nofadeout"),this.setStyle(e,"animation-duration","2000ms"),this.setStyle(e,"animation-timing-function","ease-out"),this.setStyle(e,"animation-play-state","paused"),this.clearTextRenderers.b2b.reset(0)):2==state?(this.setStyle(e,"opacity","100%"),this.clearTextRenderers.b2b.toggleEnable(!1)):0==state&&(this.clearTextRenderers.b2b.toggleEnable(!1),this.setStyle(e,"opacity","0%"))}),combo:new NumberChangeFuncExec(!1,state=>{let e="CLEARTEXT-TEXT-COMBO";this.getAsset(e);1==state?(this.setStyle(e,"opacity","100%"),this.stopAnimation("ctComboClose"),this.playAnimation("ctComboOpen")):2==state?(this.setStyle(e,"opacity","0%"),this.stopAnimation("ctComboOpen"),this.stopAnimation("ctComboClose")):0==state&&(this.setStyle(e,"opacity","0%"),this.stopAnimation("ctComboOpen"),this.playAnimation("ctComboClose"))}),line:new NumberChangeFuncExec(!1,state=>{let e="CLEARTEXT-TEXT-LINE",element=this.getAsset(e);this.setStyle(e,"animation","none"),element.offsetHeight,1==state?(this.setStyle(e,"opacity","0%"),this.setStyle(e,"animation-name","ct-anim"),this.setStyle(e,"animation-duration","2000ms"),this.setStyle(e,"animation-timing-function","ease-out"),this.setStyle(e,"animation-play-state","paused!important"),this.clearTextRenderers.line.reset(0)):0==state&&(this.clearTextRenderers.line.toggleEnable(!1),this.setStyle(e,"opacity","0%"))}),spin:new NumberChangeFuncExec(!1,state=>{let e="CLEARTEXT-TEXT-SPIN",element=this.getAsset(e);this.setStyle(e,"animation","none"),element.offsetHeight,1==state?(this.setStyle(e,"opacity","0%"),this.setStyle(e,"animation-name","ct-anim"),this.setStyle(e,"animation-duration","2000ms"),this.setStyle(e,"animation-timing-function","ease-out"),this.setStyle(e,"animation-play-state","paused!important"),this.clearTextRenderers.spin.reset(0)):0==state&&(this.clearTextRenderers.spin.toggleEnable(!1),this.setStyle(e,"opacity","0%"))})},this.clearTextRenderers={b2b:new FrameRenderer(0,120,frame=>{this.setStyle("CLEARTEXT-TEXT-B2B","animation-delay",~~(1e3/-60*frame)+"ms")}),line:new FrameRenderer(0,120,frame=>{this.setStyle("CLEARTEXT-TEXT-LINE","animation-delay",~~(1e3/-60*frame)+"ms")}),spin:new FrameRenderer(0,120,frame=>{this.setStyle("CLEARTEXT-TEXT-SPIN","animation-delay",~~(1e3/-60*frame)+"ms")})},this.clearTextAFR={},this.canvasTemplate={character:"FIELD-CHARACTER",insane:"FIELD-INSANE",stack:"FIELD-STACK",piece:"FIELD-PIECE",hold:"HOLD",next:"NEXT",back:"FIELD-BACK",blobNext:"BLOB-NEXT",playchar:"PLAYCHAR",rectanim:"RECTANIM",tspin:"CLEARTEXT-TSPIN",garbageTray:"GARBAGE-TRAY",garbageTrayBehind:"GARBAGE-TRAY-BEHIND",hpmeter:"HP-METER",feverGauge:"FEVER-GAUGE",rpgDeck:"RPG-DECK",team:"TEAM",characterAux:"AUX-FIELD-CHARACTER",backAux:"AUX-FIELD-BACK",insaneAux:"AUX-FIELD-INSANE",stackAux:"AUX-FIELD-STACK",pieceAux:"AUX-FIELD-PIECE"},this.canvasses={},this.canvasCtx={},this.fieldAnimations={},this.playcharExt={active:"insane",animname:[],anim:{},positions:{insane:[0,0],transf:[1,0],transfmic:[2,0],transfmac:[3,0],tfmicspell1:[0,1],tfmicspell2:[1,1],tfmicspell3:[2,1],tfmicspell4:[3,1]}},this.currentAI="",this.ai=new NoAI(this),this.aiBlob=new NoAI(this),this.aiRPG=new ArtificialIntelligenceRPG(this),this.unfreezableFieldAnimations={},this.namesUFA=[],this.isLosePlayed=!1,this.delay=[-9,-5],this.delayKeynamesCount=this.delay.length,this.animationElements={},this.animationExistingElements=[],this.animationTriggerEvents={},this.animationPaths={}}setAI(name){if(this.currentAI!==name){this.currentAI=name;let g,abk=this.ai.active,abb=this.aiBlob.active;switch(name){case"neoplexus":g={block:new NeoplexArtificialIntelligence(this,`PLAYER${this.player}`,manager.misc.ai_original),blob:new Neoplex2BlobArtificialIntelligence(this,`PLAYERBLOB${this.player}`,manager.misc.ai_blob_sapphirus,manager.misc.ai_blob_functions)};break;case"normal":g={blob:new Neoplex2BlobArtificialIntelligence(this,`PLAYERBLOB${this.player}`,manager.misc.ai_blob_sapphirus,manager.misc.ai_blob_functions),block:new ArtificialIntelligence(this,`PLAYER${this.player}`,manager.misc.ai)}}this.ai=g.block,this.aiBlob=g.blob,this.ai.engageWorker(),this.aiBlob.engageWorker(),this.ai.active=abk,this.aiBlob.active=abb}}playSound(str){if(this.soundActive){if(-1!==sound.play(str))return;sound.getSound(str)}}playVoice(a){if(!this.isVisible||!this.soundActive||!(a in this.character.voices))return;if(this.character.isUniqueVoicePlay&&this.character.voices[a].checkPlay())return;if(this.character.voiceActive in this.character.voices){this.character.voices[this.character.voiceActive].getVoice().stop(this.character.voiceID)}this.character.voiceActive=a;let id=this.character.voices[a].playVoice();this.character.voices[a].getVoice()&&(this.character.voiceID=id)}removeVoices(){for(let a in this.character.voices)delete this.character.voices[a]}getVoiceDuration(a){return this.isVisible&&this.soundActive&&a in this.character.voices?this.character.voices[a].duration():0}checkVoicePlaying(a){return!!(this.isVisible&&this.soundActive&&a in this.character.voices)&&this.character.voices[a].checkPlay()}addDelayHandler(requiresVisibility,delay,func,isContinuous){!this.isVisible&&requiresVisibility||(isContinuous?game.addDelayHandler(delay,func,isContinuous):game.addDelayHandler(delay,func))}affixIDName(name){return`P${this.player}-${name}`}editIH(name,value){ihelem(this.getAsset(name),value)}assetRect(name){return this.getAsset(name).getBoundingClientRect()}addParticle(requireVisibility,imgRef,spriteRow,spriteCell,startX,startY,endX,endY,duration,size,clr,bez,trail,topt,rotopt){if(requireVisibility&&!this.isVisible)return!1;particle.addParticle(game.cellSize,imgRef,spriteRow,spriteCell,startX,startY,endX,endY,duration,size,clr,bez,trail,topt,rotopt)}addBasicParticle(requireVisibility,startX,startY,endX,endY,duration,size,clr,bez,trail,topt,rotopt){if(requireVisibility&&!this.isVisible)return!1;particle.addBasicParticle(game.cellSize,startX,startY,endX,endY,duration,size,clr,bez,trail,topt,rotopt)}drawActivePlaycharExt(mx){this.canvasClear("playchar");let x=mx||this.playcharExt.positions[this.playcharExt.active];this.canvasCtx.playchar.drawImage(this.character.canvas,600*x[0],600*(x[1]+1),600,600,0,0,600,600)}setActivePlaycharExt(m){this.playcharExt.active=m,this.isVisible&&this.drawActivePlaycharExt(this.playcharExt.positions[m])}runDelay(){for(let a=0;a<this.delayKeynamesCount;a++)this.delay[a]>=0&&this.delay[a]--;0==this.delay[0]&&(this.playVoice("lose"),this.engagePlaycharExt("result"),this.editIH("PLAYCHAR-TEXT",language.translate("result_lose")),this.isLosePlayed=!0,this.playEmAnimation("lose"))}getAsset(_id){return _id in this.htmlElements?this.htmlElements[this.affixIDName(_id)]:id(this.affixIDName(_id))}setStyle(name,prop,val){styleelem(this.getAsset(name),prop,val)}styleVariable(name,prop,val){stylepropelem(this.getAsset(name),`--${prop}`,val)}storeElementsToMemory(){this.htmlElements={},this.htmlElements[this.affixIDName("AREA")]=id(`P${this.player}-AREA`);for(let y of id(`P${this.player}-AREA`).getElementsByTagName("*")){let{id:id}=y;this.htmlElements[id]=y}for(let canvas in this.canvasTemplate)this.canvasses[canvas]=this.getAsset(`${this.canvasTemplate[canvas]}-CANVAS`),this.canvasCtx[canvas]=this.canvasses[canvas].getContext("2d");this.fieldAnimations={ctComboOpen:new AnimationFrameRenderer(this.getAsset("CLEARTEXT-TEXT-COMBO"),0,25,1e3/60,{name:"cleartext-animation-combo-open",timing:"cubic-bezier(0, 0, 1,1)"}),ctComboClose:new AnimationFrameRenderer(this.getAsset("CLEARTEXT-TEXT-COMBO"),0,25,1e3/60,{name:"cleartext-animation-combo-close",timing:"cubic-bezier(0, 0, 1,1)"}),fieldDown:new AnimationFrameRenderer(this.getAsset("WHOLE"),0,70,1e3/60,{name:"board-fall",timing:"cubic-bezier(0,0,1,0)"}),fieldStomp:new AnimationFrameRenderer(this.getAsset("STOMP-WHOLE"),0,70,1e3/60,{name:"board-stomp",timing:"cubic-bezier(0,0,1,0)"}),fieldDownAux:new AnimationFrameRenderer(this.getAsset("AUX-WHOLE"),0,70,1e3/60,{name:"board-fall",timing:"cubic-bezier(0,0,1,0)"}),fieldDownDelayed:new AnimationFrameRenderer(this.getAsset("WHOLE"),0,70,1e3/60,{name:"board-fall",timing:"cubic-bezier(0,0,1,0)",delay:30}),fieldShake:new AnimationFrameRenderer(this.getAsset("WHOLE"),0,15,1e3/60,{name:"field-shake",timing:"linear",loop:!0}),fieldFinisherFinalBlow1:new AnimationFrameRenderer(this.getAsset("ROTATING-WHOLE"),0,70,1e3/60,{name:"board-fallrot-finisher-chain",timing:"cubic-bezier(0,0,1,1)"}),fieldFinisherFinalBlow2:new AnimationFrameRenderer(this.getAsset("WHOLE"),0,70,1e3/60,{name:"board-fall-finisher-chain",timing:"cubic-bezier(0,-0.3,1,0)"}),fieldHitFinish:new AnimationFrameRenderer(this.getAsset("WHOLE"),0,65,1e3/60,{name:"board-hit-finish",timing:"cubic-bezier(0,1,1,1)"}),fieldWobbleRotate:new AnimationFrameRenderer(this.getAsset("ROTATING-WHOLE"),0,30,1e3/60,{name:"board-rotate-wobble",timing:"cubic-bezier(0,0,1,1)"}),fieldVerticalSpin:new AnimationFrameRenderer(this.getAsset("ROTATING-WHOLE"),0,40,1e3/60,{name:"board-vertical-spin",timing:"linear"}),shakeUponHit:new AnimationFrameRenderer(this.getAsset("WHOLE"),0,65,1e3/60,{name:"shake-upon-hit",timing:"cubic-bezier(0,1,1,1)"}),shakeWMWHit:new AnimationFrameRenderer(this.getAsset("WHOLE"),0,3,1e3/60,{name:"wormhole-shake-hit",timing:"linear"})},this.playcharExt.anim={insaneChar:new AnimationFrameRenderer(this.getAsset("PLAYCHAR-CANVAS-DIV"),0,50,1e3/60,{name:"insane-entrance-character",timing:"cubic-bezier(0,0,1,1)"}),insaneText:new AnimationFrameRenderer(this.getAsset("PLAYCHAR-TEXT-DIV"),0,50,1e3/60,{name:"insane-entrance-text",timing:"cubic-bezier(0,0,1,1)"}),transformChar:new AnimationFrameRenderer(this.getAsset("PLAYCHAR-CANVAS-DIV"),0,100,1e3/60,{name:"insane-entrance-character",timing:"cubic-bezier(0,0,1,1)"}),transformCSpell:new AnimationFrameRenderer(this.getAsset("PLAYCHAR-CANVAS-DIV"),0,90,1e3/60,{name:"transformation-spell-character",timing:"cubic-bezier(0,0,1,1)"}),resultText:new AnimationFrameRenderer(this.getAsset("PLAYCHAR-TEXT-DIV"),0,20,1e3/60,{name:"playchar-text-down",timing:"cubic-bezier(0,0,1,1)"}),windeclare:new AnimationFrameRenderer(this.getAsset("PLAYCHAR-TEXT-DIV"),0,30,1e3/60,{name:"stamp-in",timing:"cubic-bezier(0,1,0,0)"}),losedeclare:new AnimationFrameRenderer(this.getAsset("PLAYCHAR-TEXT-DIV"),0,15,1e3/60,{name:"playchar-text-down",timing:"cubic-bezier(0,1,0,0)"}),fadeout:new AnimationFrameRenderer(this.getAsset("PLAYCHAR-TEXT-DIV"),0,20,1e3/60,{name:"fade-out",timing:"cubic-bezier(0,0,1,1)"})},this.playcharExt.animname=[];for(let mmm in this.playcharExt.anim)this.playcharExt.animname.push(mmm);this.animFieldNames=[];for(let mmm in this.fieldAnimations)this.animFieldNames.push(mmm);this.unfreezableFieldAnimations.swapMain=new AnimationFrameRenderer(this.getAsset("FIELD-DYNAMIC"),0,40,1e3/60,{name:"plain-translate-scale",timing:"cubic-bezier(1,1,0,1)"}),this.unfreezableFieldAnimations.swapAux=new AnimationFrameRenderer(this.getAsset("AUX-FIELD"),0,40,1e3/60,{name:"plain-translate-scale",timing:"cubic-bezier(1,0,0,1)"});for(let mmm in this.unfreezableFieldAnimations)this.namesUFA.push(mmm);this.clearText.tspin.initialize(this.canvasCtx.tspin),this.rectanim.fetchCtx(this.canvasCtx.rectanim),this.rpgAttr.fetchAsset(this.canvasses.hpmeter,this.canvasCtx.hpmeter,this.getAsset("HP-NUM-TEXT")),this.canvasses.team.width=this.canvasses.team.height=500}setCanvasSize(c,w,h){this.canvasses[c].width=w,this.canvasses[c].height=h}loadCharacter(char,ver){this.character.char=char,this.character.ver=ver;let num=`/assets/characters/${char}/${ver}`;if(this.character.current!==num){this.character.current=num,this.character.active=!1,this.character.load=!1,this.character.loadable=!0,this.removeVoices(),this.character.ctx.clearRect(0,0,this.character.canvas.width,this.character.canvas.height);for(let w=0;w<16;w++)this.character.blob.dropset[w]=this.DEFAULT_DROPSET[w];for(let w=0;w<24;w++)this.character.blob.feverPower[w]=this.DEFAULT_CHAIN_FEVER_POWER_PRESET[w];for(let w=0;w<24;w++)this.character.blob.chainPower[w]=this.DEFAULT_CHAIN_POWER_PRESET[w];return this.character.isCounting=!1,this.character.loadedJson=!1,load(`${num}/init.json`).then(jsonString=>{this.character.jsonString=jsonString,this.character.loadedJson=!0,this.character.json=JSON.parse(jsonString)}),!0}return!1}cleanAssets(){}loadAssets(){return new Promise(async(res,rej)=>{if(this.rpgAttr.isRPG)for(let h=0;h<3;h++){let ref=this.rpgAttr.deck.characters[h];ref.character!==ref.characterLast&&(ref.characterLast=ref.character,ref.isOK=!1,this.character.loadable=!0),ref.version!==ref.versionLast&&(ref.versionLast=ref.version,ref.isOK=!1,this.character.loadable=!0)}if(!this.character.load&&this.character.loadable){let json=this.character.json,mainDir=`/assets/characters/${this.character.char}/${this.character.ver}`,storage={},rawstore={};this.character.loadable=!1,this.character.active=!1;let voiceURLs=json.sources.voice,imageURLs=json.sources.image,imageMains=json.init.image;for(let file in imageURLs){let ref=`${mainDir}/${imageURLs[file]}`;storage[file]=ref}for(let file in imageMains)rawstore[`image_${file}`]=await memoryManager.asyncLoad(storage[imageMains[file].src],"image");for(let file in json.init.spellImage)rawstore[`image_spell_${file}`]=await memoryManager.asyncLoad(storage[json.init.spellImage[file]],"image");let ysh=["normal","warning"];for(let flf=0;flf<ysh.length;flf++){let ym=ysh[flf];this.character.ctx.drawImage(rawstore[`image_${ym}`],300*flf,0,300,600)}let hh=Object.keys(this.playcharExt.positions);for(let fll=0;fll<hh.length;fll++)if(hh[fll]in imageMains){let ym=this.playcharExt.positions[hh[fll]];this.character.ctx.drawImage(rawstore[`image_${hh[fll]}`],600*ym[0],600*(1+ym[1]),600,600)}if("main"in json.init){if("ai"in json.init.main?this.setAI(json.init.main.ai):this.setAI("normal"),"uniqueVoicePlay"in json.init.main?this.character.isUniqueVoicePlay=json.init.main.uniqueVoicePlay:this.character.isUniqueVoicePlay=!1,"chainPower"in json.init.main)for(let w=0;w<24;w++)this.character.blob.chainPower[w]=json.init.main.chainPower[w],null===json.init.main.chainPower[w]&&(this.character.blob.chainPower[w]=this.DEFAULT_CHAIN_POWER_PRESET[w]);else for(let w=0;w<24;w++)this.character.blob.chainPower[w]=this.DEFAULT_CHAIN_POWER_PRESET[w];if("feverPower"in json.init.main)for(let w=0;w<24;w++)this.character.blob.feverPower[w]=json.init.main.feverPower[w],null===json.init.main.feverPower[w]&&(this.character.blob.feverPower[w]=this.DEFAULT_CHAIN_FEVER_POWER_PRESET[w]);else for(let w=0;w<24;w++)this.character.blob.feverPower[w]=this.DEFAULT_CHAIN_FEVER_POWER_PRESET[w];if("dropset"in json.init.main)for(let w=0;w<16;w++)this.character.blob.dropset[w]=json.init.main.dropset[w],null===json.init.main.dropset[w]&&(this.character.blob.dropset[w]=this.DEFAULT_DROPSET[w]);else for(let w=0;w<16;w++)this.character.blob.dropset[w]=this.DEFAULT_DROPSET[w];this.character.isHenshinCounting=json.init.main.henshinCanCount,"counting"in json.init.main&&(this.character.isCounting=json.init.main.counting)}if(this.animationLayerElements.length=0,this.animationTriggerEvents={},this.animationPaths={},"animation"in json.init){let anim=json.init.animation;for(let path in anim.paths)this.animationPaths[path]=anim.paths[path];for(let asset in anim.sources){let mm=anim.sources[asset],imagus=await memoryManager.asyncLoad(storage[mm.src],"image");animatedLayers.loadOffline(this.getCanvasAnimationLoadedName(asset),imagus,anim.sources[asset].width,anim.sources[asset].height),this.animationElements[asset]={width:mm.width,height:mm.height,framewidth:mm.framewidth,frameheight:mm.frameheight,aspectwidth:mm.aspectwidth,aspectheight:mm.aspectheight,cellsizemult:mm.cellsizemult,xbound:mm.xbound,src:mm.src},this.animationElements[asset].opacity="opacity"in mm?mm.opacity:1}for(let name in anim.triggers){let mn=anim.triggers[name];this.animationTriggerEvents[name]={};for(let nn in mn){this.animationTriggerEvents[name][nn]=[];for(let no of mn[nn])this.animationTriggerEvents[name][nn].push(no),"createAnimLayer"==no.action&&no.targetid&&this.animationLayerElements.push(no.targetid)}}}{let arr=[],srcArr=[];for(let h in json.init.voice)arr.push(json.init.voice[h]);for(let qi of arr)qi in json.init.voice&&srcArr.push(voiceURLs[json.init.voice[qi]]);Object.keys(json.init.voice).length>0&&await playerVoiceSystem.batchLoad(json.base,json.version,srcArr);for(let hh in json.init.voice)this.character.voices[hh]=new PlayerVoice(json.base,json.version,voiceURLs[json.init.voice[hh]])}if("spellImage"in json.init){let array=[];for(let uuu in json.init.spellImage)`image_spell_${json.init.spellImage[uuu]}`in rawstore&&array.push({a:rawstore[`image_spell_${json.init.spellImage[uuu]}`],s:uuu});this.rectanim.load(array)}if(this.rpgAttr.isRPG)for(let h=0;h<3;h++){let ref=this.rpgAttr.deck.characters[h],character=gtcharacter.characters[ref.character],core=character.core,version=character.versions[ref.version];await this.rpgAttr.loadRPG(h,`assets/characters/${core.path}/${version.path}`,version.rpg_init),ref.isOK=!0}return this.character.active=!0,this.character.load=!0,this.character.loadable=!0,res(),void this.drawCharacterBg(0)}res()})}changeBodyColorRGB(r,g,b){this.color.r=r,this.color.g=g,this.color.b=b;for(let bi of["AUX-BORDER-1","AUX-BORDER-2","BORDER-BLOCK","BORDER-BLOB-1","BORDER-BLOB-2"])this.setStyle(bi,"fill",`rgba(${r-20},${g-20},${b-20},0.5)`),this.setStyle(bi,"stroke",`rgba(${r-10},${g-10},${b-10},0.8)`);for(let bi of["NAMEPLATE-DIV"])this.setStyle(bi,"background",`rgb(${r-80},${g-80},${b-80})`),this.setStyle(bi,"border-color",`rgb(${r-10},${g-10},${b-10})`);for(let gt=1;gt<=2;gt++)this.setStyle(`BLOB-NEXT-BG-${gt}`,"fill",`rgba(${r-10},${g-10},${b-10},0.5)`),this.setStyle(`BLOB-NEXT-BG-${gt}`,"stroke",`rgba(${Math.min(255,r+100)},${Math.min(255,g+100)},${Math.min(255,b+100)},0.8)`);this.setStyle("RPG-DECK","background",`rgba(${r-10},${g-10},${b-10},0.8)`),this.setStyle("RPG-DECK","border",`0.3em solid rgba(${Math.min(255,r+20)},${Math.min(255,g+20)},${Math.min(255,b+20)},0.8)`)}changeBodyColorHex(hex){let a=hexToRGB(~~hex);this.changeBodyColorRGB(a.r,a.g,a.b)}getCanvasAnimationLoadedName(obj){return`ANIM||${this.character.char}||${this.character.ver}||${obj}`}canvasClear(ctx){let a=this.canvasses[ctx];this.canvasCtx[ctx].clearRect(0,0,a.width,a.height)}engageCleartextTSpin(visible,type,line){if((!this.isCompact||!visible)&&(null!==type&&this.clearText.tspin.exec(type),void 0!==line&&this.editIH("CLEARTEXT-TSPIN-LINE-TEXT",line),this.clearText.tspinLine.assign(2),this.clearText.tspinLine.assign(1),visible)){let e="CLEARTEXT-CANVTEXT",element=this.getAsset(e);this.setStyle(e,"animation-name","none"),this.setStyle(e,"animation-duration","1600ms"),this.setStyle(e,"animation-timing-function","linear"),element.offsetHeight,0==type&&this.setStyle(e,"animation-name","tspin-div-glow-regular"),1==type&&this.setStyle(e,"animation-name","tspin-div-glow-mini")}}engageCleartext(type,visible,text,color){if(this.isCompact&&visible)return;let e="",obj="";switch(type){case"b2b":e="CLEARTEXT-TEXT-B2B",obj="b2b";break;case"line":e="CLEARTEXT-TEXT-LINE",obj="line";break;case"spin":e="CLEARTEXT-TEXT-SPIN",obj="spin"}this.editIH(e,text),this.clearText[obj].assign(0),visible&&this.clearText[obj].assign(1)}engageCleartextCombo(visible,toggle,text,color){this.isCompact&&visible||(text&&this.editIH("CLEARTEXT-TEXT-COMBO",text),this.clearText.combo.assign(toggle))}engagePlaycharExt(type,name){for(let h=0,m=this.playcharExt.animname.length;h<m;h++)this.playcharExt.anim[this.playcharExt.animname[h]].reset();switch(this.setStyle("PLAYCHAR-CANVAS-DIV","opacity","0%"),this.setStyle("PLAYCHAR-TEXT-DIV","opacity","0%"),type){case"insane":this.playcharExt.anim.insaneText.play(),this.setActivePlaycharExt(name||"insane");break;case"result":this.playcharExt.anim.resultText.play(),this.setStyle("PLAYCHAR-TEXT-DIV","opacity","100%");break;case"declareWin":this.playcharExt.anim.windeclare.play(),this.setStyle("PLAYCHAR-TEXT-DIV","opacity","100%");break;case"declareLose":this.playcharExt.anim.losedeclare.play(),this.setStyle("PLAYCHAR-TEXT-DIV","opacity","100%");break;case"insaneTransform":this.playcharExt.anim.transformChar.play(),this.playcharExt.anim.insaneText.play(),this.setActivePlaycharExt(name||"transf");break;case"insaneTransformSpell":this.playcharExt.anim.transformCSpell.play(),this.setActivePlaycharExt(name||"tfmicspell1")}}}class InsaneMode{constructor(type,parent){this.time=60,this.maxTime=9e3,this.isUnlimited=!0,this.isCommandedEnd=!1,this.preset={blob:game.presets.blobNormal,microBlob:game.presets.blobMicro,block:game.presets.blockNormal,block2:game.presets.blockJavaScriptus},this.henshinTypes=2,this.status="n",this.initialStart=!1,this.initialStartHenshin=!1,this.insaneType=0,this.requireChain=-3,this.insaneModeCount=0,this.blocks={phase:5,requireLine:-9,seq:0,type:0},this.combo=0,this.isExtra=!0,this.fixedHenshinType=2,this.parent=parent,this.type=type,this.isOn=!1,this.isTime=!1,this.isDelay=!1,this.transEntTime=0,this.memory={preview:[],stack:[[]],combo:0,b2b:0,hold:void 0},this.delay={ready:-30,in:-33,turningOff:-30,out:-30,del:-50,readyHenshin:-48},this.delayOrder=["ready","readyHenshin","in","turningOff","out","del"],this.defaultDelays={},this.chainScore=0,this.customDelays={},this.timeAdditions={minChain:2,timeAddMult:.5,allClear:5,fixedTimeAdd:2},this.rng=new ParkMillerPRNG;for(let h in this.delay)this.defaultDelays[h]=this.delay[h]}setMemory(setload,stack,prev,combo,b2b,hold){let a;switch(setload){case"load":a={preview:this.memory.preview,stack:this.memory.stack,combo:this.memory.combo,b2b:this.memory.b2b,hold:this.memory.hold};break;case"save":this.memory.stack=stack,this.memory.preview=prev,this.memory.combo=combo,this.memory.b2b=b2b,this.memory.hold=hold;break;case"reset":this.memory={preview:[],stack:[[]],combo:0,b2b:0,hold:void 0}}return a}load(){this.background.canvas=this.parent.parent.canvasses.character,this.background.ctx=this.parent.parent.canvasCtx.character}update(){this.isTime&&!this.isUnlimited&&this.time--,this.isOn&&(this.parent.parent.editIH("INSANE-TIMER",this.isUnlimited?"":Math.max(Math.floor(this.time/60),0)),this.time<=5*game.FPS&&this.time>=0&&!this.parent.parent.hasWon&&(this.time%game.FPS==0&&this.time>0&&this.parent.parent.playSound("timer2_1"),0==this.time&&(this.time=-90,this.parent.parent.playSound("timer_zero"))))}draw(){this.isOn&&this.parent.parent.insaneBg.draw()}reset(){for(let h in this.defaultDelays)this.delay[h]=-99;this.toggle(!1),this.isTime=!1,this.insaneModeCount=0,this.time=-1,this.setMemory("reset"),this.transEntTime=-4,this.blocks.requireLine=-9,this.blocks.phase=1,this.blocks.seq=0,this.parent.parent.editIH("INSANE-TIMER","")}updateDelays(){let isDelay=!1;for(let h of this.delayOrder)if(this.delay[h]>=0){this.delay[h]--,isDelay=!0;break}if(0==this.delay.readyHenshin&&(this.parent.parent.editIH("PLAYCHAR-TEXT","Transform!"),this.delay.in=40,this.parent.delay[0]=30,this.insaneType=1+~~(this.rng.next()*this.henshinTypes),this.fixedHenshinType>0&&(this.insaneType=this.fixedHenshinType),this.parent.parent.playAnimation("fieldVerticalSpin"),this.parent.parent.engagePlaycharExt("insaneTransform"),0==this.insaneModeCount&&this.parent.parent.playVoice("daihenshin"),this.insaneModeCount++,this.transEntTime=70),this.transEntTime>=0){this.transEntTime--,this.delay.in<20&&(this.delay.in=3),35==this.transEntTime&&(this.parent.parent.playcharExt.anim.insaneText.play(),this.parent.parent.setActivePlaycharExt(["transfmac","transfmic"][this.insaneType-1]),this.parent.parent.editIH("PLAYCHAR-TEXT",`Enhancement: ${["Macro","Micro"][this.insaneType-1]}`)),this.parent.parent.drawActivePlaycharExt();let cctx=this.parent.parent.canvasCtx.playchar,hm=0;this.transEntTime>=35&&this.transEntTime<=55&&(hm=Math.min(55-this.transEntTime,20)/20),this.transEntTime<35&&this.transEntTime>=15&&(hm=Math.min(this.transEntTime-15,20)/25),cctx.fillStyle=`rgba(255,255,255,${hm}`,cctx.globalCompositeOperation="source-atop",cctx.fillRect(0,0,600,600),cctx.globalCompositeOperation="source-over",cctx.globalAlpha=1,this.transEntTime}if(0==this.delay.ready&&(this.delay.in=40,this.parent.delay[0]=30,this.insaneType=0,this.parent.parent.playAnimation("fieldVerticalSpin"),this.parent.parent.engagePlaycharExt("insane"),0==this.insaneModeCount&&this.parent.parent.playVoice("insane"),this.insaneModeCount++,"blob"==this.type&&this.parent.parent.editIH("PLAYCHAR-TEXT","Enhancement: Fever"),"block"==this.type&&this.parent.parent.editIH("PLAYCHAR-TEXT","Enhancement: Frenzy"),this.parent.parent.engageCleartext("b2b",!1,""),this.parent.parent.engageCleartextCombo(!1,0,"")),20==this.delay.in){if(this.parent.parent.playSound("insane"),this.parent.parent.feverStat.isOn&&(this.parent.parent.feverStat.playColored(!0),this.parent.parent.feverStat.isUseTimer&&(this.maxTime=this.parent.parent.feverStat.time)),this.toggle(!0),this.parent.parent.insaneBg.type=this.insaneType>0?3:0,this.parent.parent.insaneBg.changeColorCustom(66,66,66),"block"==this.type&&(this.parent.parent.insaneBg.type=2),"blob"==this.type){let stack=JSON.parse(JSON.stringify(this.parent.stack)),prev=JSON.parse(JSON.stringify(this.parent.preview.queue)),combo=0,b2b=0,hold=0;this.setMemory("save",stack,prev,combo,b2b,hold),0==this.insaneType&&(this.parent.fieldSize.w=6,this.parent.fieldSize.hh=30,this.parent.fieldSize.vh=12,this.parent.fieldSize.h=this.parent.fieldSize.vh+this.parent.fieldSize.hh,this.parent.blobRequire=4,this.parent.stack=grid(this.parent.fieldSize.w,this.parent.fieldSize.h,0),this.parent.drawStack(this.parent.stack)),1==this.insaneType&&(this.parent.fieldSize.w=3,this.parent.fieldSize.hh=30,this.parent.fieldSize.vh=6,this.parent.fieldSize.h=this.parent.fieldSize.vh+this.parent.fieldSize.hh,this.parent.blobRequire=3,this.parent.stack=grid(this.parent.fieldSize.w,this.parent.fieldSize.h,0),this.parent.drawStack(this.parent.stack)),2==this.insaneType&&(this.parent.fieldSize.w=10,this.parent.fieldSize.hh=30,this.parent.fieldSize.vh=20,this.parent.fieldSize.h=this.parent.fieldSize.vh+this.parent.fieldSize.hh,this.parent.blobRequire=4,this.parent.stack=grid(this.parent.fieldSize.w,this.parent.fieldSize.h,0),this.parent.drawStack(this.parent.stack))}if(this.parent.parent.conclude1v1Overhead(3),this.parent.parent.switchGarbageBehind(!0),this.time=this.maxTime,this.time+=60,"block"==this.type){let stack=JSON.parse(JSON.stringify(this.parent.stack)),prev=JSON.parse(JSON.stringify(this.parent.preview.queue)),combo=this.parent.combo,b2b=this.parent.b2b,hold=this.parent.piece.hold;this.setMemory("save",stack,prev,combo,b2b,hold),0==this.insaneType&&(this.parent.fieldSize.w=10,this.parent.fieldSize.hh=20,this.parent.fieldSize.vh=20,this.parent.piece.holdable=!1,this.parent.holdShow(!1),this.parent.fieldSize.h=this.parent.fieldSize.vh+this.parent.fieldSize.hh,this.parent.stack=grid(this.parent.fieldSize.w,this.parent.fieldSize.h,0),this.parent.drawStack(this.parent.stack))}}if(0==this.delay.in&&(this.isTime=!0,"blob"==this.type&&(0==this.insaneType&&(this.delay.del=10,this.status="start"),2==this.insaneType&&this.microBlobToField(0,!0)),"block"===this.type&&0===this.insaneType&&(this.delay.del=10,this.status="start")),0==this.delay.del){if("success"===this.status){if("blob"==this.type&&(0===this.insaneType&&this.blobToField(Math.max(0,Math.min(this.parent.parent.feverStat.presetChain,13)),this.isExtra),2===this.insaneType)){let sum=Math.min(this.chainScore+2,30);this.microBlobToField(sum-8,!0)}"block"==this.type&&(this.blocks.seq=0,this.parent.parent.insaneBg.moveEye(this.parent.fieldSize.w/2,this.parent.fieldSize.vh/2,!0),0===this.insaneType&&(this.blocks.phase++,this.blockToField(Math.min(13,this.blocks.phase),this.rng.next(),this.rng.next(),this.rng.next())),this.insaneType)}if("fail"===this.status){if("blob"==this.type&&(0===this.insaneType&&this.blobToField(Math.max(0,Math.min(this.parent.parent.feverStat.presetChain,13)),this.isExtra),2===this.insaneType)){let difference=Math.max(8,this.requireChain-Math.min(2,this.requireChain-this.chainScore-2));this.microBlobToField(difference-8,!0)}"block"==this.type&&(this.blocks.seq=0,this.parent.parent.insaneBg.moveEye(this.parent.fieldSize.w/2,this.parent.fieldSize.vh/2,!0),0===this.insaneType&&this.blockToField(Math.min(13,this.blocks.phase),this.rng.next(),this.rng.next(),this.rng.next()),this.insaneType)}"start"===this.status&&("blob"==this.type&&this.blobToField(Math.max(0,Math.min(this.parent.parent.feverStat.presetChain,13)),this.isExtra),"block"==this.type&&(this.blocks.seq=0,0===this.insaneType&&(this.parent.parent.insaneBg.moveEye(this.parent.fieldSize.w/2,this.parent.fieldSize.vh/2,!0),this.blocks.phase=0,this.blockToField(Math.min(13,this.blocks.phase),this.rng.next(),this.rng.next(),this.rng.next())),this.insaneType))}if(0==this.delay.turningOff){for(let h of this.delayOrder)this.delay[h]>=0&&(this.delay[h]=-99);this.delay.out=40,this.parent.delay[0]=30,this.isCommandedEnd=!1,this.parent.parent.playAnimation("fieldVerticalSpin")}if(20==this.delay.out){if(this.parent.parent.playSound("swap_swap"),this.toggle(!1),this.parent.parent.feverStat.isOn&&this.parent.parent.feverStat.reset(),this.parent.parent.canvasClear("insane"),this.parent.parent.switchGarbageBehind(!1),"blob"==this.type){1!=this.insaneType&&2!=this.insaneType||(this.parent.fieldSize.w=6,this.parent.fieldSize.hh=30,this.parent.fieldSize.vh=12,this.parent.fieldSize.h=this.parent.fieldSize.vh+this.parent.fieldSize.hh,this.parent.blobRequire=4);let ma=this.setMemory("load");this.parent.stack=grid(this.parent.fieldSize.w,this.parent.fieldSize.h,0);for(let x=0;x<this.parent.fieldSize.w;x++)for(let y=0;y<this.parent.fieldSize.h;y++)this.parent.stack[x][y]=ma.stack[x][y];this.parent.setDelay(1,this.parent.parent.isInsaneModeOnly?-19:5),this.parent.setDelay(0,this.parent.parent.isInsaneModeOnly?-19:5),this.parent.drawStack(this.parent.stack),this.parent.canFallTrash=!1,this.parent.blobCount=this.parent.checkBlobCount(this.parent.stack)}if("block"==this.type){1!=this.insaneType&&2!=this.insaneType||(this.parent.fieldSize.w=6,this.parent.fieldSize.hh=30,this.parent.fieldSize.vh=12,this.parent.fieldSize.h=this.parent.fieldSize.vh+this.parent.fieldSize.hh,this.parent.blobRequire=4);let ma=this.setMemory("load");this.parent.stack=grid(this.parent.fieldSize.w,this.parent.fieldSize.h,0);for(let x=0;x<this.parent.fieldSize.w;x++)for(let y=0;y<this.parent.fieldSize.h;y++)this.parent.stack[x][y]=ma.stack[x][y];this.parent.previewModify(ma.preview,1),this.parent.setDelay(1,this.parent.parent.isInsaneModeOnly?-19:5),this.parent.setDelay(0,this.parent.parent.isInsaneModeOnly?-19:5),this.parent.drawStack(this.parent.stack),this.parent.holdShow(this.parent.piece.defaultHoldable),this.parent.checkStackAltitude()}this.parent.parent.engageCleartext("b2b",!1,""),this.parent.parent.engageCleartextCombo(!1,0,"")}return 0==this.delay.out&&(this.isTime=!1,this.parent.parent.editIH("INSANE-TIMER",""),"blob"==this.type&&this.parent.canFallTrashAfterFever&&this.parent.dropGarbage()),isDelay}blobToField(phase,isExtra,doesNotRequireChain){let m=~~(6*this.rng.next()),colors=this.parent.colors,colorSet=[];for(let i=0;i<colors;i++)colorSet.push(this.parent.colorSet[i]);for(let i=0;i<colorSet.length-1;i++){var temp=colorSet[i],rand=~~((colorSet.length-i)*this.rng.next())+i;colorSet[i]=colorSet[rand],colorSet[rand]=temp}colorSet.unshift(0);let a=this.preset.blob[phase][colors-3][m],tempGrid=this.#checkInstantDrop(a.grid,a.grid.length,a.grid[0].length),grid=[];for(let x=0,l=tempGrid.length;x<l;x++){grid[x]=[];for(let y=0,w=tempGrid[x].length;y<w;y++){let lm=tempGrid[x][y];lm>15&&isExtra?lm-=16:lm>15&&(lm=0),grid[x][y]=colorSet[lm]}}this.parent.replaceField(grid,this.rng.next()>.5,!this.isOn),doesNotRequireChain||(this.requireChain=a.require)}microBlobToField(phase,isExtra){let m=~~(4*this.rng.next()),colors=this.parent.colors,colorSet=[];for(let i=0;i<colors;i++)colorSet.push(this.parent.colorSet[i]);for(let i=0;i<colorSet.length-1;i++){var temp=colorSet[i],rand=~~((colorSet.length-i)*this.rng.next())+i;colorSet[i]=colorSet[rand],colorSet[rand]=temp}colorSet.unshift(0);let a=this.preset.microBlob[phase][colors-3][m],tempGrid=this.#checkInstantDrop(a.grid,a.grid.length,a.grid[0].length),grid=[];for(let x=0,l=tempGrid.length;x<l;x++){grid[x]=[];for(let y=0,w=tempGrid[x].length;y<w;y++){let lm=tempGrid[x][y];lm>15&&isExtra?lm-=16:lm>15&&(lm=0),grid[x][y]=lm>0?colorSet[lm]:0}}this.parent.replaceField(grid,this.rng.next()>.5,!0),this.requireChain=a.require}blockToField(phase,a,b,c){let base=this.preset.block,aA=Math.floor(7*a),bB=Math.floor(3*b),cC=Math.floor(2*c);1==this.blocks.type&&(base=this.preset.block2,aA=Math.floor(6*a),bB=Math.floor(2*b),cC=Math.floor(2*c));let mPhase=0;phase>=4&&mPhase++,phase>=7&&mPhase++,phase>=10&&mPhase++,phase>=13&&mPhase++;let m=base[mPhase][aA][bB][cC],tempGrid=m.grid,grid=[];for(let x=0,l=tempGrid.length;x<l;x++){grid[x]=[];for(let y=0,w=tempGrid[x].length;y<w;y++){let lm=tempGrid[x][y];grid[x][y]=lm>0?tempGrid[x][y]:0}}this.parent.modifyGrid(this.parent.fieldSize.hh-(1==this.blocks.type?2:0),grid,60==this.blocks.type&&cC<1,!1,!0),this.blocks.requireLine=m.require,this.parent.previewModify(m.preview,30)}#checkInstantDrop(stack,w,h){let width=w,height=h,grid=JSON.parse(JSON.stringify(stack)),testSpace=function(x,y){return x<0||x>=width||(!(y<height)||void 0!==grid[x][y]&&0!==grid[x][y])},checkHoles=function(){let checked=!0;for(let t=0;t<height&&checked;t++)for(var y=height-1;y>=-1;y--)for(var x=0;x<width;x++)checked=!0,testSpace(x,y-1)&&(testSpace(x,y)||(grid[x][y]=grid[x][y-1],grid[x][y-1]=0,checked=!1))};for(;;){checkHoles();break}return grid}toggle(tog){this.isOn=tog}}class InsaneBackground{#Ray=class{constructor(x1,y1,x2,y2,divisions){this.distanceX=x2-x1,this.distanceY=y2-y1,this.x1=x1,this.x2=x2,this.y1=y1,this.y2=y2,this.midpointVertexCount=divisions-1,this.midpointVertexes=[];for(let f=0;f<this.midpointVertexCount;f++)this.midpointVertexes.push({x:0,y:0});this.color="#fff"}moveStart(x,y){this.x1=x,this.y1=y,this.distanceX=this.x2-this.x1,this.distanceY=this.y2-this.y1}moveEnd(x,y){this.x2=x,this.y2=y,this.distanceX=this.x2-this.x1,this.distanceY=this.y2-this.y1}draw(ctx,cellSize){let mx=this.distanceX/this.midpointVertexCount,my=this.distanceY/this.midpointVertexCount;this.x1,this.y1,this.x2,this.y2;ctx.beginPath(),ctx.moveTo(this.x1*cellSize,this.y1*cellSize);for(let g=0,m=this.midpointVertexes.length;g<m;g++){let r=this.midpointVertexes[g];if(ctx.lineTo(((g+1)*mx+r.x+this.x1)*cellSize,((g+1)*my+r.y+this.y1)*cellSize),4==g)break}ctx.lineTo(this.x2*cellSize,this.y2*cellSize),ctx.lineWidth=.3*cellSize,ctx.strokeStyle=this.color,ctx.stroke()}};constructor(parent){this.parent=parent,this.canvas,this.ctx,this.cellSize=40,this.colors={r:250,g:60,b:48},this.colorMult=1,this.eye={x:0,y:0,w:5,h:5,offset:{dx:0,dy:0,frame:0,max:0,state:"set"}},this.origStarts=[],this.rays=[],this.henshinTemp=new OffscreenCanvas(540,540),this.henshinTempCtx=this.henshinTemp.getContext("2d"),this.henshinAnim=new GIFRenderer(5400,5400,540,540,0,(a,canv,x,y,w,h,frame,that)=>{a.canvas;let mm=.3*game.frames%360;this.henshinTempCtx.clearRect(0,0,w,h),this.henshinTempCtx.save(),this.henshinTempCtx.translate(w/2,h/2),this.henshinTempCtx.rotate(Math.PI/180*mm),this.henshinTempCtx.drawImage(canv,x%5*w,~~(x/5)%3*h,w,h,w/-2,h/-2,w,h);for(let yu=0;yu<2;yu++)a.drawImage(this.henshinTemp,0,0,w,h,-7.5*this.parent.cellSize,-2.5*this.parent.cellSize,this.parent.cellSize*(this.parent.fieldSize.vh+5),this.parent.cellSize*(this.parent.fieldSize.vh+5));this.henshinTempCtx.restore(),that.frame.x++,that.frameCount++,15==frame&&(that.actualFrames=0)},frame=>{},!0),this.fever={},this.fever.temp=new OffscreenCanvas(540,540),this.fever.tempCtx=this.fever.temp.getContext("2d"),this.fever.main=new GIFRenderer(1620,2700,540,540,0,(a,canv,x,y,w,h,frame,that)=>{a.canvas;let eyeX=this.eye.x,eyeY=this.eye.y;if(this.eye.offset.frame>=0&&"reset"==this.eye.offset.state){let be=1-bezier(this.eye.offset.frame/this.eye.offset.max,1,0,0,0,0,1);eyeX=this.eye.x+this.eye.offset.dx*be,eyeY=this.eye.y+this.eye.offset.dy*be,this.eye.offset.frame--}this.spinSpeed>.3?this.spinSpeed-=.005:this.spinSpeed=.3;let mm=this.spinFrames%360;this.fever.tempCtx.clearRect(0,0,w,h),this.fever.tempCtx.save(),this.fever.tempCtx.translate(w/2,h/2),this.fever.tempCtx.rotate(Math.PI/180*mm),this.fever.tempCtx.drawImage(canv,~~(x%3)*w,~~(x/3)%5*h,w,h,w/-2,h/-2,w,h);a.drawImage(this.fever.temp,0,0,w,h,this.parent.cellSize*(-25+eyeX),this.parent.cellSize*(-25+eyeY),this.parent.cellSize*(this.parent.fieldSize.vh+30),this.parent.cellSize*(this.parent.fieldSize.vh+30)),this.fever.tempCtx.restore(),that.frame.x-=1,that.frameCount+=1,this.spinFrames+=this.spinSpeed,this.spinFrames%=360,(that.frameCount>=13||that.frame.x<=-1)&&(that.frameCount=0,that.frame.x=13),30==frame&&(that.actualFrames=0)},frame=>{},!0),this.frenzy={},this.frenzy.temp=new OffscreenCanvas(540,540),this.frenzy.tempCtx=this.frenzy.temp.getContext("2d"),this.frenzy.main=new GIFRenderer(1620,4320,540,540,0,(a,canv,x,y,w,h,frame,that)=>{a.canvas;let eyeX=this.eye.x,eyeY=this.eye.y;if(this.eye.offset.frame>=0){let be=1-bezier(this.eye.offset.frame/this.eye.offset.max,1,0,0,0,0,1);eyeX=this.eye.x+this.eye.offset.dx*be,eyeY=this.eye.y+this.eye.offset.dy*be,this.eye.offset.frame--}let mm=this.spinFrames%360;this.frenzy.tempCtx.clearRect(0,0,w,h),this.frenzy.tempCtx.save(),this.frenzy.tempCtx.translate(w/2,h/2),this.frenzy.tempCtx.rotate(Math.PI/180*mm),this.frenzy.tempCtx.drawImage(canv,~~(x%3)*w,~~(x/3)%8*h,w,h,w/-2,h/-2,w,h);for(let yu=0;yu<1;yu++)a.drawImage(this.frenzy.temp,0,0,w,h,this.parent.cellSize*(-25+eyeX),this.parent.cellSize*(-25+eyeY),this.parent.cellSize*(this.parent.fieldSize.vh+30),this.parent.cellSize*(this.parent.fieldSize.vh+30));this.frenzy.tempCtx.restore(),that.frame.x+=1,that.frameCount+=1,this.spinFrames+=.3,this.spinFrames%=360,(that.frameCount>=24||that.frame.x<=-1)&&(that.frameCount=0,that.frame.x=0),30==frame&&(that.actualFrames=0)},frame=>{},!0),this.spinSpeed=0,this.spinFrames=0;for(let f=0;f<12;f++)this.rays.push(new this.#Ray(0,1,0,1,4))}fetchAsset(canvas,ctx){this.canvas=canvas,this.ctx=ctx,this.henshinAnim.initialize(this.ctx),this.henshinAnim.loadImages([game.henshinBg]),this.henshinAnim.exec(0),this.fever.main.initialize(this.ctx),this.fever.main.loadImages([game.feverBg]),this.fever.main.exec(0),this.frenzy.main.initialize(this.ctx),this.frenzy.main.loadImages([game.frenzyBg]),this.frenzy.main.exec(0)}reset(){this.eye.offset.frame=-9,this.spinSpeed=.3,this.moveEye(this.parent.fieldSize.w/2,this.parent.fieldSize.vh/2)}moveEye(x,y,isReset){this.eye.offset.dx=this.eye.x-x,this.eye.offset.dy=this.eye.y-y,this.eye.x=x,this.eye.y=y,this.spinSpeed+=.4,this.eye.offset.state="set",isReset?(this.eye.offset.state="reset",this.eye.offset.frame=180,this.eye.offset.max=180):(this.eye.offset.state="reset",this.eye.offset.frame=5,this.eye.offset.max=5);let w=this.parent.fieldSize.w,vh=this.parent.fieldSize.vh;this.origStarts=[{x:w/3*0,y:vh/3*0},{x:w/3*1,y:vh/3*0},{x:w/3*2,y:vh/3*0},{x:w/3*3,y:vh/3*0},{x:w/3*3,y:vh/3*1},{x:w/3*3,y:vh/3*2},{x:w/3*3,y:vh/3*3},{x:w/3*2,y:vh/3*3},{x:w/3*1,y:vh/3*3},{x:w/3*0,y:vh/3*3},{x:w/3*0,y:vh/3*2},{x:w/3*0,y:vh/3*1}]}changeColor(){let ml=~~(10*Math.random());this.colors.r=2*[130,0,0,130,130,0,130,130,70,0][ml],this.colors.g=2*[0,130,0,0,130,130,0,70,130,70][ml],this.colors.b=2*[0,0,130,130,0,130,70,0,0,130][ml]}changeColorCustom(r,g,b){this.colors.r=r,this.colors.g=g,this.colors.b=b}draw(){this.parent.canvasClear("insane");let w=this.parent.fieldSize.w,vh=this.parent.fieldSize.vh;this.parent.canvasCtx.insane.fillStyle=`rgba(${1*this.colors.r},${1*this.colors.g},${1*this.colors.b}, 0.8)`,this.parent.canvasCtx.insane.fillRect(0,0,this.parent.cellSize*w,this.parent.cellSize*vh),this.parent.canvasCtx.insane.fillStyle=`rgba(${~~(255*Math.random())},${~~(255*Math.random())},${~~(255*Math.random())}, 0.5)`,0==this.type?this.fever.main.run():2===this.type?this.frenzy.main.run():this.henshinAnim.run()}}class RPGAttributes{#ctx;#canvas;#text;#targets={current:this.parent};seed=new ParkMillerPRNG;selectTargets(arg,pickPlayer){if("this"===arg)return this.parent;if("allies"==arg){let arr=[];return game.forEachPlayer(player=>{player.player!==this.parent.player&&this.parent.team==player.team&&arr.push(player)}),arr}if("enemies"==arg){let arr=[];return game.forEachPlayer(player=>{player.player!==this.parent.player&&this.parent.team!==player.team&&arr.push(player)}),arr}}static Skill=class{constructor(parent,number,parameters){this.parent=parent,this.number=number,this.name=parameters.name||"0",this.skillStatusEffects=parameters.statfx||[],this.skillValues=parameters.skillValues||{parameters:{}},this.cooldown=parameters.initcd||0,this.initCD=parameters.initcd||0,this.maxCD=parameters.cd||0,this.skillVoice=parameters?.voice||"skill",this.mana=parameters.mana,this.attributeDesc=""}execute(){if(this.cooldown>0||this.parent.mana<this.mana)return!1;let skillVoice=this.skillVoice;switch(this.name){case"misty1":game.forEachPlayer(player=>{let thisBase=this.parent.selectTargets("this");for(let player of this.parent.selectTargets("enemies")){let baseValue=thisBase.rpgAttr.attributes.attack;player.rpgAttr.addStatusEffect(thisBase.player,"periodicdmg",this.skillValues.pdmgtime,{value:baseValue*(this.skillValues.pdmgpercentage/100),maxf:this.skillValues.pdmginterval,type:"burn"})}});break;case"epicman1":0==this.parent.parent.activeType&&(this.parent.parent.block.stompProps.afterHardDrop=!0),this.parent.parent.activeType;break;case"dominic1":~~(1*this.parent.seed.next());break;case"eclipse1":1==this.parent.parent.activeType?(this.parent.parent.blob.insane.delay.readyHenshin=15,this.parent.parent.blob.insane.delay.fixedHenshinType=2):0==this.parent.parent.activeType&&(this.parent.parent.block.insane.delay.ready=15);break;case"skylight1":0==this.parent.parent.activeType&&this.parent.parent.removeGarbage(8),1==this.parent.parent.activeType&&this.parent.parent.removeGarbage(18);break;case"rainuff1":break;case"phylum1":0==this.parent.parent.activeType&&this.parent.parent.removeGarbage(40),1==this.parent.parent.activeType&&this.parent.parent.removeGarbage(90)}for(let h of this.skillStatusEffects){let value=0;if("string"==typeof h.parameters.value){let split=h.parameters.value.split("%");value="hp"==split[1]?~~(parseFloat(split[0])/100*this.parent.maxHP):parseFloat(split[0])/100*this.parent.attributes[split[1]]}else value=h.parameters.value;let modifiedParameters=JSON.parse(JSON.stringify(h.parameters));modifiedParameters.value=value,this.parent.addStatusEffect(this.parent.parent.player,h.type,h.time,modifiedParameters)}return this.cooldown=this.maxCD,this.parent.playVoice(this.number,skillVoice),!0}reset(){this.cooldown=this.maxCD}change(parameters){}};constructor(parent){this.parent=parent,this.isOn=!1,this.maxHP=184472,this.hp=2e3,this.mana=1e3,this.maxMana=1e3,this.absorb=0,this.hpBehind=0,this.isOn=!1,this.hpDamage=0,this.isWOIHPMode=!1,this.canReceiveGarbage=1,this.isRPG=!1,this.isUsableSkills=!1,this.warningTime=60,this.isZeroHPWarning=!1,this.deck={characters:{},loaded:!0};for(let h=0;h<3;h++)this.deck.characters[h]={skill:new RPGAttributes.Skill(this,h,{}),character:null,version:null,characterLast:null,versionLast:null,jsonstring:"",json:{},card:new Image(2,2),skillUse:new Image(2,2),isOK:!1};this.isRPGOK=!0,this.manaRegen={time:0,max:40,value:1},this.skillUseDisplay={frame:0,max:100,on:!1,using:0,tx1:-400,ty1:-1e3,tx2:-200,ty2:1e3},this.DEFAULT_ATTRIBUTES={attack:10,atkTolerance:10,defense:100,lifesteal:0,lfa:0,deflect:0},this.ATTRIBUTE_NAMES=Object.keys(this.DEFAULT_ATTRIBUTES),this.ATTRIBUTE_LENGTH=this.ATTRIBUTE_NAMES.length,this.attributes=JSON.parse(JSON.stringify(this.DEFAULT_ATTRIBUTES)),this.statusEffectsAttributes=JSON.parse(JSON.stringify(this.DEFAULT_ATTRIBUTES));for(let h in this.statusEffectsAttributes)this.statusEffectsAttributes[h]=0;this.healthBar={active:new NumberChangeFuncExec(null,(val,arg)=>{arg&&(this.healthBar.behind.execute(),this.healthBar.absorb.execute(),this.healthBar.forecastedDmg.execute()),this.drawHealthBar(val,"#0e0"),arg&&this.healthBar.measure.execute()}),behind:new NumberChangeFuncExec(null,(val,arg)=>{this.drawHealthBar(val,"#cc2222",!0),arg&&(this.healthBar.absorb.execute(),this.healthBar.forecastedDmg.execute(),this.healthBar.active.execute(),this.healthBar.measure.execute())}),forecastedDmg:new NumberChangeFuncExec(null,(val,arg)=>{arg&&(this.healthBar.behind.execute(),this.healthBar.absorb.execute()),this.drawHealthBar(val,"#fa0"),arg&&(this.healthBar.active.execute(),this.healthBar.measure.execute())}),text:new NumberChangeFuncExec(null,val=>{this.#text.innerHTML=val}),absorb:new NumberChangeFuncExec(null,(val,arg)=>{arg&&this.healthBar.behind.execute(),this.drawHealthBar(val,"#9a9a9a"),arg&&(this.healthBar.forecastedDmg.execute(),this.healthBar.active.execute(),this.healthBar.measure.execute())}),measure:new NumberChangeFuncExec(null,(val,arg)=>{arg&&(this.healthBar.behind.execute(),this.healthBar.absorb.execute(),this.healthBar.forecastedDmg.execute(),this.healthBar.active.execute());let gap=300/(val/50),ticks=val/50;this.#ctx.fillStyle="#000";for(let gx=0;gx<ticks;gx++)this.#ctx.fillRect(gx*gap,0,3,70*(gx%5==0?.45:.3));this.#ctx.fillRect(this.maxHP/val*300,0,3,49)})},this.statusEffects=[]}drawHealthBar(val,color,isClear){isClear&&this.#ctx.clearRect(0,0,300,70),this.#ctx.fillStyle=color,this.#ctx.fillRect(0,0,300*val,70)}executeSkill(number){if(!(this.isOn&&this.isRPG&&this.isUsableSkills))return;if(void 0===this.deck.characters[number])return;if(!("skill"in this.deck.characters[number]))return;this.deck.characters[number].skill.execute()&&(this.parent.playSound("skill_activate"),this.mana-=this.deck.characters[number].skill.mana,this.executeSkillUse(number))}reset(){this.hp=this.maxHP,this.statusEffects.length=0,this.canReceiveGarbage=1,this.manaRegen.value=1,this.manaRegen.time=0,this.skillUseDisplay.on=!1,this.isZeroHPWarning=!1;for(let eh in this.deck.characters){let h=this.deck.characters[eh];h.skill.cooldown=h.skill.initCD}}resetAttributes(){this.attributes=JSON.parse(JSON.stringify(this.DEFAULT_ATTRIBUTES))}playVoice(deckn,skill){this.parent.playVoice(`deck${deckn}|${skill}`)}loadRPG(number,directory,fileName){return new Promise(async(res,rej)=>{let jsonString=await memoryManager.asyncLoad(directory+"/"+fileName),json=JSON.parse(jsonString),raw={},references={};for(let j in json.sources.image)raw[j]=await memoryManager.asyncLoad(directory+"/"+json.sources.image[j],"image");for(let j in json.init.image)references[j]=raw[j];{let arr=[],srcArr=[];for(let h in json.init.voices)arr.push(json.init.voices[h]);for(let qi of arr)qi in json.init.voices&&srcArr.push(json.sources.voices[json.init.voices[qi]]);Object.keys(json.init.voices).length>0&&await playerVoiceSystem.batchLoad(json.base,json.version,srcArr);for(let hh in json.init.voices)this.parent.character.voices[`deck${number}|${hh}`]=new PlayerVoice(json.base,json.version,json.sources.voices[json.init.voices[hh]])}let character=this.deck.characters[number];character.card=raw.card,character.skillUse=raw.use,res()})}restInPeace(){}update(){if(!this.isOn)return;this.hpBehind>this.hp&&(this.hpBehind-=.003*this.maxHP),this.hpBehind<this.hp&&(this.hpBehind=this.hp),this.isWOIHPMode;let absorb=0,length=this.statusEffects.length;if(this.canReceiveGarbage=1,this.isRPG){this.isUsableSkills&&(this.manaRegen.time--,this.manaRegen.time<=0&&(this.manaRegen.time=this.manaRegen.max,this.addMana(this.manaRegen.value)));for(let l=0;l<this.ATTRIBUTE_LENGTH;l++){let g=this.ATTRIBUTE_NAMES[l];this.statusEffectsAttributes[g]=0}for(let h=0;h<length&&!this.parent.hasWon&&!this.parent.isDead;h++){let gg=this.statusEffects[h];if(gg.isTime){if(!(gg.time>0)){this.statusEffects.splice(h,1),h--,length--;continue}gg.time--}switch(gg.type){case"periodicdmg":gg.parameters.frame>0?gg.parameters.frame--:(gg.parameters.frame=gg.parameters.maxf,this.addHP(-gg.parameters.value,!0),this.checkZeroHP()&&this.parent.checkLose());break;case"regen":gg.parameters.frame>0?gg.parameters.frame--:(gg.parameters.frame=gg.parameters.maxf,this.hp<this.maxHP&&this.hp>0&&this.addHP(gg.parameters.value));break;case"lsbuff":this.statusEffectsAttributes.lifesteal+=gg.parameters.value;break;case"lfabuff":this.statusEffectsAttributes.lfa+=gg.parameters.value;break;case"atkbuff":this.statusEffectsAttributes.attack+=gg.parameters.value;break;case"defbuff":this.statusEffectsAttributes.defense+=gg.parameters.value;break;case"deflect":this.statusEffectsAttributes.deflect+=gg.parameters.value;break;case"immune2garbage":this.canReceiveGarbage--}"absorb"==gg.type&&(absorb+=gg.parameters.value)}}this.absorb=absorb;let max=Math.max(this.maxHP,this.hp+absorb);if(this.healthBar.behind.assign(this.hpBehind/max,!0),this.healthBar.absorb.assign((this.hp+absorb)/max,!0),this.healthBar.forecastedDmg.assign(this.hp/max,!0),this.healthBar.active.assign((this.hp-this.hpDamage)/max,!0),this.healthBar.text.assign(this.hp),this.healthBar.measure.assign(max,!0),this.isRPG){this.parent.canvasClear("rpgDeck");let ctx=this.parent.canvasCtx.rpgDeck,jk=700,km=this.parent.player%2==0,aspect=2.2,x=800-jk*aspect/2;for(let j=0;j<3;j++){let ref=this.deck.characters[j];ctx.save(),ctx.translate(x,j*(jk+5)),ctx.scale(km?1:-1,1),ctx.drawImage(ref.card,0,0,550,250,km?0:-jk*aspect,0,jk*aspect,jk),ctx.restore(),ctx.textBaseline="top",ctx.font="280px josefinsans",ctx.fillStyle="#fff",ctx.strokeStyle="#000";let mk=2*(km?30:770);ctx.textAlign=km?"start":"end",ctx.lineWidth=24,ctx.fillText(ref.skill.mana,mk,20+j*(jk+10)),ctx.strokeText(ref.skill.mana,mk,20+j*(jk+10)),ctx.textBaseline="ideographic",ctx.font="180px default-ttf",ctx.lineWidth=7,ctx.fillText(ref.skill.desc,mk,jk-40+j*(jk+10)),ctx.strokeText(ref.skill.desc,mk,jk-40+j*(jk+10)),ref.skill.cooldown>0&&(ctx.fillStyle="#0008",ctx.fillRect(x,j*(jk+5),jk*aspect,jk),ctx.font="360px josefinsans",ctx.fillStyle="#fff",ctx.textBaseline="middle",ctx.textAlign="center",ctx.lineWidth=24,ctx.fillText((ref.skill.cooldown/60).toFixed(1),400,jk/2+j*(jk+5)),ctx.strokeText((ref.skill.cooldown/60).toFixed(1),400,jk/2+j*(jk+5))),ref.skill.mana>this.mana&&(ctx.fillStyle="#0008",ctx.fillRect(x,j*(jk+5),jk*aspect,jk),ctx.font="360px josefinsans",ctx.fillStyle="#fff"),ref.skill.cooldown>=0&&ref.skill.cooldown--}ctx.fillStyle="#333",ctx.fillRect(0,2440,1600,160),ctx.fillStyle="#aa3",ctx.fillRect(0,2440,2*~~(this.mana/this.maxMana*8*100),160);let mk=2*(km?30:770);if(ctx.fillStyle="#fff",ctx.textBaseline="top",ctx.textAlign=km?"start":"end",ctx.lineWidth=12,ctx.font="230px josefinsans",ctx.fillText("Mana: "+this.mana,mk,40+3*(jk+10)),ctx.strokeText("Mana: "+this.mana,mk,40+3*(jk+10)),this.skillUseDisplay.on&&game1v1.on)do{let add=0;if(add=this.skillUseDisplay.frame>45&&this.skillUseDisplay.frame<=55?.05:8,this.skillUseDisplay.frame+=add,this.skillUseDisplay.frame>=this.skillUseDisplay.max){this.skillUseDisplay.on=!1;break}let sd=this.skillUseDisplay;if(!this.parent.isVisible)break;let w=1265,h=910.8;this.parent.player%2==1?background.drawImage(this.deck.characters[sd.using].skillUse,0,0,1e3,720,1280-w-(sd.tx1+sd.frame/sd.max*(sd.tx2-sd.tx1)),sd.ty1+sd.frame/sd.max*(sd.ty2-sd.ty1),w,h,!0):background.drawImage(this.deck.characters[sd.using].skillUse,0,0,1e3,720,sd.tx1+sd.frame/sd.max*(sd.tx2-sd.tx1),sd.ty1+sd.frame/sd.max*(sd.ty2-sd.ty1),w,h,!1)}while(0);if(this.isZeroHPWarning=!1,this.hp+absorb<=this.hpDamage)this.isZeroHPWarning=!0;else{let ar=0;this.hp/this.maxHP<.4&&(ar+=1),this.hp/this.maxHP<.15&&(ar+=1),this.warningTime-=ar,this.warningTime<0&&!this.parent.isDead&&!this.parent.hasWon&&(this.warningTime=60,this.parent.playSound("rpg_lowhp"))}}}executeSkillUse(number){let sd=this.skillUseDisplay;sd.on=!0,sd.frame=0,sd.using=number}fetchAsset(canvas,ctx,text){this.#canvas=canvas,this.#ctx=ctx,this.#text=text,this.#canvas.width=300,this.#canvas.height=70}addMana(_num){_num<0&&this.mana<0||(this.mana+=_num,this.mana<0&&(this.mana=0),this.mana>this.maxMana&&(this.mana=this.maxMana))}addHP(_num,isBypassAbsorb){if(!this.isOn)return;let num=~~_num,isFull=!1;this.hp>this.maxHP&&(isFull=!0);let absorbed=0,numAttack=0;if(num<0&&!isBypassAbsorb){if(numAttack=-1*num,numAttack>0){let length=this.statusEffects.length;for(let k=0;k<length;k++)if("absorb"==this.statusEffects[k].type){let ma=this.statusEffects[k],ref=ma.parameters,value=Math.min(numAttack,ref.value);ref.value-=value,numAttack-=value,absorbed+=value,ref.value<=0&&(ma.triggerOn("zero"),this.statusEffects.splice(k,1),k--,length--)}}num=-numAttack}else numAttack=-num;if(0!==num&&this.parent.isVisible){let asset=this.#text.getBoundingClientRect(),px=(this.isAux,asset.x),py=asset.y;htmlEffects.add(num,px,py,40,{name:"damage-text-animation",iter:1,timefunc:"cubic-bezier(0,1,1,1)",initdel:0},`color: #${num>0?"0a0":"a00"}; text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black; --__chaintext_size: ${.9*this.parent.fieldFontSize}`)}return this.hp+=num,this.hp>this.maxHP&&(this.hp=this.maxHP),this.hp<0&&(this.hp=0),{hp:Math.max(numAttack,0),absorb:absorbed}}setMaxHP(max){this.maxHP=max||1e3,this.hp=max||1e3}setMaxMana(max){this.maxMana=max||1e3,this.mana=max||1e3}checkZeroHP(){return!!this.isOn&&this.hp<=0}openClose(oc){this.isOn=oc,this.parent.setStyle("GARBAGE-TRAY-DIV","top",-1*this.parent.fieldCellSize*(2.5+(this.isOn?1.5:0))+"px"),this.parent.setStyle("HP-BAR-DIV","display",this.isOn?"flex":"none"),this.parent.setStyle("RPG-DECK","display",this.isOn&&this.isRPG?"flex":"none")}emulateDamage(mpl){if(this.isOn){let removehp=0;for(let kk in mpl){let lifestealOpp=this.addHP(-mpl[kk]);if(removehp=mpl[kk],kk in game.players){let player=game.players[kk],laa=player.rpgAttr.attributes,lab=player.rpgAttr.statusEffectsAttributes;player.rpgAttr.addHP(lifestealOpp.hp*(laa.lifesteal+lab.lifesteal-(this.attributes.deflect+this.statusEffectsAttributes.deflect)),0),player.rpgAttr.addHP(lifestealOpp.absorb*(laa.lfa+lab.lfa),0),player.rpgAttr.checkZeroHP()&&player.checkLose()}}}}static STATUS_EFFECTS={regen:{frame:1,maxf:10,value:1},periodicdmg:{frame:1,maxf:100,value:1},atkbuff:{value:1},atkred:{value:.7},lsbuff:{value:.7},lfabuff:{value:0},defbuff:{value:0},defred:{value:0},absorb:{value:2},purify:{},buffred:{},deflect:{value:0},immune2dmg:{value:100},immune2garbage:{}};addStatusEffect(player,type,time,parameters,on){this.statusEffects.push(new RPGAttributes.AttrDefStatusEffect(this,player,type,time,parameters,on))}static AttrDefStatusEffect=class{constructor(parent,player,type,time,parameters,on){this.isTime="unli"!==time,this.time=this.isTime?time:99,this.player=player,this.maxTime=this.isTime?time:99,this.type=type,this.parameters=JSON.parse(JSON.stringify(RPGAttributes.STATUS_EFFECTS[type])),this.on={...on||{}};for(let h in parameters)h in this.parameters&&(this.parameters[h]=parameters[h])}triggerOn(name){name in this.on&&this.on[name]()}}}const playerVoiceSystem={voices:{},storage:{},storagePaths:{},batchLoad:function(base,version,array){return new Promise(async(res,rej)=>{try{let storage=this.storage,dir=`assets/characters/${base}/${version||"main"}`,isPath=!1,bversion=`${base}/${version||"main"}`;bversion in this.storagePaths?isPath=!0:this.storagePaths[bversion]={};let loaded=0,loadLength=0,needLoad=[];for(let b of array){let kl=`${base}#${version}|${b}`;kl in this.voices||(this.voices[kl]={main:null,length:0,isLoad:!1},needLoad.push([kl,b]),loadLength++)}if(0==loadLength)return void res();for(let o of needLoad){let kl=o[0],b=o[1];try{if(!(kl in storage)){let hm=`${dir}/${b}`;this.voices[kl]={main:audioMaster.createAudio({src:hm,loop:!1}),length:0,isLoad:!1},isPath||(this.storagePaths[bversion][kl]=hm),storage[kl]=0,this.voices[kl].main.load().then(_res=>{loaded++,this.voices[kl].isLoad=!0,this.voices[kl].length=~~(60*this.voices[kl].main.duration),loaded>=loadLength&&res()});for(let nx of["load","loaderror"])this.voices[kl].main.once(nx,()=>{})}}catch(e){}}}catch(e){res()}})},getVoice:function(base,version,name){let a=`${base}#${version}|${name}`;return a in this.voices?this.voices[a].main:null},play:function(base,version,name){let a=`${base}#${version}|${name}`;if(a in this.voices)return this.voices[a].main.volume(game.voiceVolume/100),this.voices[a].main.play()},check:function(base,version,name){let a=`${base}#${version}|${name}`;return a in this.voices&&this.voices[a].main.checkPlaying()},stop:function(base,version,name){let a=`${base}#${version}|${name}`;a in this.voices&&this.voices[a].main.stop()},duration:function(base,version,name){let a=`${base}#${version}|${name}`;return a in this.voices?this.voices[a].length:0},unloadAll:function(exemptions){for(let h in this.storagePaths)if(!(h in exemptions)){for(let b in this.storagePaths[h])delete this.storagePaths[h][b];delete this.storagePaths[h]}},removePlayerVoices:function(){for(let b in this.voices[player])delete this.voices[player][b];delete this.voices[player]}};class RectangularAnimations{#canvas;#testCanv;#ctx;#testCtx;constructor(parent){this.parent=parent,this.#canvas=new OffscreenCanvas(3705,2100),this.#testCanv=new OffscreenCanvas(247,70),this.dim={w:247,h:70},this.#ctx=this.#canvas.getContext("2d"),this.#testCtx=this.#testCanv.getContext("2d"),this.spells={spell1:[0,0],spell2:[1,0],spell3:[2,0],spell4:[0,1],spell5:[1,1],counter:[2,1],damage2:[0,2]},this.mainCtx,this.current="none",this.frame=0,this.maxFrames=50,this.enabled=!0,this.delay=2.5}load(arr){this.#ctx.clearRect(0,0,3705,2100);for(let uw=0;uw<arr.length;uw++){let j=arr[uw],ms=this.spells[j.s];this.#ctx.drawImage(j.a,1235*ms[0],10*this.dim.h*~~ms[1],1235,10*this.dim.h)}this.#testCtx.drawImage(this.#canvas,0,0)}fetchCtx(ctx){this.mainCtx=ctx}play(spell){void 0===this.spell&&(this.current=spell||"none",this.frame=0,this.enabled=!0)}run(){if(this.delay>0&&this.delay--,this.delay<=0&&this.enabled&&"none"!==this.current){this.mainCtx.clearRect(0,0,247,70);let m=this.spells[this.current],l=0;l=this.frame<=5?this.frame/5:this.frame>=45?(50-this.frame)/5:1,this.mainCtx.drawImage(this.#canvas,247*~~(this.frame%5+5*m[0]),70*~~(~~(this.frame/5)+10*m[1]),this.dim.w,this.dim.h,0,this.dim.h*((1-l)/2),this.dim.w,this.dim.h*l),this.frame++,this.delay+=2.5,this.frame>this.maxFrames&&(this.enabled=!1)}}}class PlayerVoice{constructor(base,version,name){this.base=base,this.version=version,this.name=name,this.a=playerVoiceSystem,this.playerTarget=[]}playVoice(){this.a.play(this.base,this.version,this.name)}stopVoice(){this.a.stop(this.base,this.version,this.name)}checkPlay(){return this.a.check(this.base,this.version,this.name)}getVoice(){return this.a.getVoice(this.base,this.version,this.name)}duration(){return this.a.duration(this.base,this.version,this.name)}}class GarbageTrayObject{constructor(){this.x=0,this.gx=0}}class LegacyMode{constructor(parent){this.parent=parent,this.isActive=!1,this.isEnable=!1,this.isControl=!1,this.isWarning=!1,this.canControl=!1,this.isAux=!1,this.isNonLockSafe=!1}}class GachatrisBlock extends LegacyMode{constructor(parent){super(parent),this.garbageLimit=8,this.isInvisible=!1,this.isWarningTopOut=!1,this.isSpawnablePiece=!1,this.attackType="scorebased",this.piece={x:0,y:0,rot:0,template:PIECE,activeArr:[[]],active:0,holdable:!0,defaultHoldable:!0,hold:0,isAir:!1,moved:!1,dirty:!1,held:!1,enable:!1,rotated:!1,isHardDrop:!1,spin:{spin:0,mini:0,x1y2:0},lastDrop:{x:0,y:0},kickTable:null,kickDistance:{x:0,y:0},spinTable:null,last:{x:0,y:0},is180able:!1,count:0},this.stompProps={delayIndex:4,afterHardDrop:!1},this.delay={},this.delayAdd={},this.delayDefault={0:7,1:35,2:5,3:0},this.lcdTimes5=2,this.delayParamsLength=8,this.isProfessional=!1,this.canRaiseGarbage=!0,this.warningTrig=new NumberChangeFuncExec(0,t=>{this.isWarning=t}),this.attackDeviation=0,this.isAllSpin=!1,this.isTSDOnly=!1,this.tsdCount=0,this.level=3,this.fixedGravity=[0,1/60,1/30,.04,.05,1/15,1/12,.1,1/8,1/6,1/6,1/4,1/4,1/3,1/3,1/3,.5,1,1.5,2,3];let lev=[0];for(let h=0;h<29;h++)lev.push(1/((.8-.007*h)**h*60));this.fixedGravity=lev,this.nextVoice={name:"",duration:-2},this.attackSendDelay=-9,this.isDelayEnabled=!0,this.insane=new InsaneMode("block",this),this.blockColors={r:[255,255,255,0,0,0,127],g:[0,127,255,255,255,0,0],b:[0,0,0,0,255,255,255]};for(let h=0;h<this.delayParamsLength;h++)this.delay[h]=0,this.delayAdd[h]=10;this.clear={linesReady:[],linesDelayed:[],blocks:[]},this.b2b=-1,this.combo=-1,this.messiness=.3725,this.currentGarbageHole=0,this.pcSpam={frame:0,count:0},this.rngPreview=new ParkMillerPRNG,this.preview={bag:[0,1,2,3,4,5,6],queue:[]},this.defaultSettings={das:9,arr:1,gravity:this.fixedGravity[Math.min(28,this.level)],lock:30,sft:.5},this.customSettings={das:5,arr:0,gravity:this.fixedGravity[Math.min(28,this.level)],lock:30,sft:9603},this.settings=JSON.parse(JSON.stringify(this.defaultSettings)),this.handling={das:0,arr:0,xFirst:0},this.lock={lowest:0,reset:15,delay:30,delayMax:30},this.stack=[],this.drawableStack=[],this.bitboard=new ModifiedBitboard(40,10,10,Uint16Array),this.stateBitboard=new ModifiedBitboard(40,10,10,Uint16Array),this.canForecastClear=!0,this.fieldSize={w:10,h:40,vh:20,hh:20},this.columnBlocks=[],this.effects={hardDrop:new ArrayFunctionIterator(aray=>{for(let wm=0,lm=aray.length;wm<lm;wm++){let idx=aray[wm];idx.frames--;let sx=this.parent.fieldSize.w/this.fieldSize.w,sy=this.parent.fieldSize.vh/this.fieldSize.vh,x=~~(idx.x*this.parent.cellSize*sx),y=(idx.y+1-(this.fieldSize.hh-this.visibleFieldBufferHeight))*this.parent.cellSize*sy,c=this.parent.canvasCtx.piece,depth=this.parent.cellSize*sy*(idx.dep*(idx.frames/idx.maxf));c.globalAlpha=Math.max(0,idx.frames)/idx.maxf;let grad=c.createLinearGradient(~~x,~~y,~~x,~~y-depth),colorBase=`rgba(${this.blockColors.r[idx.blk]},${this.blockColors.g[idx.blk]},${this.blockColors.b[idx.blk]}, 1)`,colorBaseZero=`rgba(${this.blockColors.r[idx.blk]},${this.blockColors.g[idx.blk]},${this.blockColors.b[idx.blk]}, 0)`;grad.addColorStop(0,colorBaseZero),grad.addColorStop(1-(idx.dep-1)/idx.dep,colorBase),grad.addColorStop(1,colorBaseZero),c.fillStyle=grad,this.parent.isVisible&&c.fillRect(x,y-depth,this.parent.cellSize*sx,depth),c.globalAlpha=1,idx.frames<=0&&(aray.splice(wm,1),wm--,lm--)}}),appearAnim:new ArrayFunctionIterator(aray=>{for(let wm=0,lm=aray.length;wm<lm;wm++){let idx=aray[wm];idx.frames+=.5;let sx=this.parent.fieldSize.w/this.fieldSize.w,sy=this.parent.fieldSize.vh/this.fieldSize.vh,x=~~(idx.x*this.parent.cellSize*sx),y=(idx.y-(this.fieldSize.hh-this.visibleFieldBufferHeight))*this.parent.cellSize*sy,c=this.parent.canvasCtx.piece;if(this.parent.isVisible){idx.frames>10&&c.drawImage(manager.skin.canvas,0*this.parent.cellSize,idx.cell*this.parent.cellSize,this.parent.cellSize,this.parent.cellSize,x,y,this.parent.cellSize,this.parent.cellSize);let size=2;c.drawImage(manager.skinAppear.canvas,70*~~(idx.frames%10),70*~~(idx.frames/10),70,70,x-this.parent.cellSize*(size/4),y-this.parent.cellSize*(size/4),this.parent.cellSize*size,this.parent.cellSize*size),idx.frames>30&&(aray.splice(wm,1),wm--,lm--)}}}),clearAnim:new ArrayFunctionIterator(aray=>{for(let wm=0,lm=aray.length;wm<lm;wm++){let idx=aray[wm];idx.frames+=60/idx.maxf;let sx=this.parent.fieldSize.w/this.fieldSize.w,sy=this.parent.fieldSize.vh/this.fieldSize.vh,x=~~(idx.x*this.parent.cellSize*sx),y=(idx.y-(this.fieldSize.hh-this.visibleFieldBufferHeight))*this.parent.cellSize*sy,c=this.isAux?this.parent.canvasCtx.pieceAux:this.parent.canvasCtx.piece;if(this.parent.isVisible){let size=4;c.drawImage(manager.skinClear.canvas,70*~~(idx.frames%10),70*~~(idx.frames/10),70,70,x-sx*this.parent.cellSize*(size/4)-sx*this.parent.cellSize/2,y-sy*this.parent.cellSize*(size/4)-sy*this.parent.cellSize/2,this.parent.cellSize*size,this.parent.cellSize*size),idx.frames>60&&(aray.splice(wm,1),wm--,lm--)}}})},this.visibleFieldBufferHeight=5,this.visibleFieldHeight=0,this.garbageWait=[],this.meteredGarbageWaitMode=!0,this.BLOB_REQUIRED_TARGETPOINT=30,this.hitSoundReduce=0,this.dasCancellation={on:!0,main:new NumberChangeFuncExec(0,c=>{this.handling.das=0})},this.spellTime=-3,this.spellAnimName="",this.activeVoiceLine="",this.repeatSpellVoice=0,this.appearBlockFrame=-1,this.stackAltitude=this.fieldSize.h}executeStomp(){this.setDelay(this.stompProps.delayIndex,52),this.setDelay(3,35),this.setDelay(0,20),this.parent.fieldAnimations.fieldStomp.play()}stomp(){let board=this.stack,width=this.fieldSize.w,hiddenHeight=this.fieldSize.hh,height=this.fieldSize.h,checked=!0;for(let t=0;t<height&&checked;t++)for(var y=height-1;y>=hiddenHeight-2;y--)for(var x=0;x<width;x++)checked=!0,this.testGridSpace(x,y-1,width,height)&&(this.testGridSpace(x,y,width,height)||(board[x][y]=board[x][y-1],board[x][y-1]=0,checked=!1));this.drawStack(this.stack),this.checkStackAltitude()}checkLines(){this.clear.linesReady.length=0;let lines=0;for(let y=0;y<this.fieldSize.h;y++){let count=0;for(let x=0;x<this.fieldSize.w;x++)this.testGridSpace(x,y)&&count++;count>=this.fieldSize.w&&(this.clear.linesReady.push(y),lines++)}lines&&this.setDelay(2,void 0)}checkStackAltitude(){let alt=this.fieldSize.h;for(let x=0;x<this.fieldSize.w;x++)for(let y=0;y<this.fieldSize.h;y++)if(this.stack[x][y]>0){y<alt&&(alt=y);break}this.stackAltitude=alt}checkWarning(){let isWarning=!this.insane.isOn&&this.stackAltitude-this.parent.garbageLength<=this.fieldSize.hh+5?1:0;this.warningTrig.assign(isWarning)}modifyGrid(cy,gridArr,isFlipped,isDraw,isAppearAnim){if(this.simulateSplashOut(),isFlipped)for(let x=0;x<gridArr.length;x++)for(let y=0;y<gridArr[x].length;y++)this.stack[x][y+cy]=gridArr[gridArr.length-1-x][y],isAppearAnim&&gridArr[gridArr.length-1-x][y]&&this.effects.appearAnim.addItem({frames:-.5,cell:gridArr[gridArr.length-1-x][y],x:x,y:y+this.fieldSize.hh});else for(let x=0;x<gridArr.length;x++)for(let y=0;y<gridArr[x].length;y++)this.stack[x][y+cy]=gridArr[x][y],isAppearAnim&&gridArr[x][y]&&this.effects.appearAnim.addItem({frames:-.5,cell:gridArr[x][y],x:x,y:y+cy});isDraw&&this.drawStack(this.stack),isAppearAnim&&(this.drawStack("reset"),this.appearBlockFrame=60),this.checkStackAltitude()}testGridSpace(x,y){return x<0||x>=this.fieldSize.w||(!(y<this.fieldSize.h)||void 0!==this.stack[x][y]&&0!==this.stack[x][y])}reset(){this.piece.x=0,this.piece.y=-295,this.loseDelay=-399,this.piece.lastDrop.x=0,this.piece.lastDrop.y=-295,this.piece.hold=void 0,this.piece.rot=0,this.piece.active=null,this.piece.count=0,this.piece.activeArr=[[]],this.piece.isAir=!1,this.piece.moved=!0,this.piece.dirty=!1,this.piece.held=!1,this.piece.rotated=!1,this.piece.enable=!1,this.piece.isHardDrop=!1,this.piece.spin.spin=0,this.piece.spin.mini=0,this.piece.holdable=!0,this.b2b=-1,this.combo=-1,this.garbage=[],this.garbageWait.length=0,this.isSpawnablePiece=!0,this.nextVoice.duration=-999,this.repeatSpellVoice=0,this.stompProps.afterHardDrop=!1,this.tsdCount=0,this.pcSpam.frame=0,this.pcSpam.count=0,this.attackSendDelay=-9,this.stackAltitude=this.fieldSize.h,this.hitSoundReduce=0,this.delay={},this.delayAdd={},this.spellTime=-3,this.spellAnimName="",this.currentGarbageHole=~~(this.parent.seeds.field.next()*this.fieldSize.w);for(let h=0;h<this.delayParamsLength;h++)this.delay[h]=-10,this.delayAdd[h]=this.isProfessional?0:this.delayDefault[h];this.lock={move:15,rot:15,delay:30},this.clear.linesReady.length=0,this.clear.linesDelayed.length=0,this.clear.blocks.length=0,this.fieldSize.w=10,this.fieldSize.hh=20,this.fieldSize.vh=20,this.fieldSize.h=this.fieldSize.vh+this.fieldSize.hh,this.stack=grid(this.fieldSize.w,this.fieldSize.h,0),this.bitboard=new ModifiedBitboard(this.fieldSize.h,this.fieldSize.w,this.fieldSize.w,Uint16Array),this.stateBitboard=new ModifiedBitboard(this.fieldSize.h,this.fieldSize.w,this.fieldSize.w,Uint16Array),this.drawableStack=grid(this.fieldSize.w,this.fieldSize.h,0),this.drawStack(this.stack),this.drawActivePiece(),this.previewInitialize(),this.holdDraw(),this.settings=JSON.parse(JSON.stringify(this.isProfessional?this.customSettings:this.defaultSettings)),this.handling={das:0,arr:0,xFirst:0}}getQPosX(x){return(this.isAux?.47:1)*x*(this.parent.fieldSize.w/this.fieldSize.w)}getQPosY(y){return(this.isAux?.47:1)*y*(this.parent.fieldSize.vh/this.fieldSize.vh)}simulateSplashOut(){let asset=this.parent.assetRect(this.isAux?"AUX-FIELD-CHARACTER-CANVAS":"FIELD-CHARACTER-CANVAS"),ax=(this.isAux,asset.width,asset.height,asset.x),ay=asset.y,bez={x1:0,x2:0,x3:1,x4:1,y1:0,y2:.3,y3:1+.2*Math.random(),y4:1};for(let x=0;x<this.fieldSize.w;x++)for(let y=this.fieldSize.hh;y<this.fieldSize.h;y++)if(this.stack[x][y]>0){let mx=ax+this.getQPosX(x)*this.parent.fieldCellSize+this.getQPosX(1)*this.parent.fieldCellSize/2,my=ay+this.getQPosY(y-this.fieldSize.hh)*this.parent.fieldCellSize+this.getQPosY(1)*this.parent.fieldCellSize/2,particleSpeed=71+70*Math.random();bez.y3=1+.2*Math.random(),this.parent.addParticle(!0,"blobblock",1,this.stack[x][y],mx,my,mx+this.getQPosX(50*Math.random()-50*Math.random())*this.parent.fieldCellSize,my+this.getQPosY(4*Math.random()+4)*this.parent.fieldCellSize+game.resolution.h,particleSpeed,this.getQPosX(1)*this.parent.fieldCellSize/game.cellSize,!1,bez,!1)}}updateDelay(){if(!this.isDelayEnabled)return;let delayPrioritize=0;for(let l=this.delayParamsLength;l>=0;l--)if(this.delay[l]>=0){delayPrioritize=l;break}0===delayPrioritize?this.loseDelay>=0?this.isActive&&this.loseDelay--:this.insane.updateDelays()?this.parent.isDelayStoppable=!1:this.delay[delayPrioritize]--:(this.delay[delayPrioritize]--,this.parent.isDelayStoppable=!1),0==this.delay[this.stompProps.delayIndex]&&this.stomp(),0==this.delay[3]&&this.checkLines(),1==this.delay[2]&&this.parent.checkWaitDeterminism(),0==this.delay[2]&&(this.clearLine(),this.spellTime=Math.max(5,Math.min(this.delay[1]-4,30)),this.attackSendDelay=Math.max(5,Math.min(this.delay[1]-4,30))),0==this.delay[1]&&this.stackCollapse(!0),1==this.loseDelay&&this.parent.checkWaitDeterminism(),0==this.loseDelay&&(this.loseDelay,this.checkRespawnOrDie()),1==this.delay[0]&&this.parent.checkWaitDeterminism(),0==this.delay[0]&&(this.stompProps.afterHardDrop?(this.stompProps.afterHardDrop=!1,this.executeStomp()):this.spawnPiece(this.previewNextBag(),!1)),0==this.delay[delayPrioritize]&&(this.delay[delayPrioritize]=-333),this.attackSendDelay>=0&&(this.attackSendDelay--,1===this.attackSendDelay&&this.parent.checkWaitDeterminism(),0===this.attackSendDelay&&(this.emitAttack([{block:this.delayedGarbage,blob:this.delayedGarbageBlobs}]),this.delayedGarbage=0,this.delayedGarbageBlobs=0)),this.isNonLockSafe=this.loseDelay>0||this.delay[2]>0||this.delay[1]>0||this.delay[0]>0||this.attackSendDelay>0}updateContinuousDelay(){if(this.spellTime>=0&&(this.spellTime--,0==this.spellTime)){this.parent.playVoice(this.activeVoiceLine),this.insane.isOn&&this.insane.blocks.requireLine<=0&&(this.nextVoice.duration=this.parent.getVoiceDuration(this.activeVoiceLine));for(let j=1;j<=this.repeatSpellVoice;j++)this.parent.addDelayHandler(!0,9*j,()=>{this.parent.playVoice(this.activeVoiceLine),this.nextVoice.duration=this.parent.getVoiceDuration(this.activeVoiceLine)});this.repeatSpellVoice=0,this.spellAnimName&&this.parent.rectanim.play(this.spellAnimName)}this.nextVoice.duration>=0&&(this.nextVoice.duration--,0===this.nextVoice.duration&&this.parent.playVoice(this.nextVoice.name))}holdShow(showhide){this.parent.setStyle("HOLD","display",!this.parent.isCompact&&showhide?"block":"none"),this.parent.setStyle("HOLD","left",.1*this.parent.fieldCellSize+"px"),this.parent.setStyle("HOLD","top",.1*this.parent.fieldCellSize+"px"),this.piece.holdable=showhide}drawStack(stack){if(!this.isEnable||this.isInvisible)return;let aux=this.isAux?"stackAux":"stack",widthQuotient=this.parent.fieldSize.w/this.fieldSize.w,heightQuotient=this.parent.fieldSize.vh/this.fieldSize.vh;if(void 0!==stack)if("reset"===stack)for(let x=0,len=this.fieldSize.w;x<len;x++)for(let y=0,top=this.fieldSize.h;y<top;y++)this.drawableStack[x][y]=0;else this.drawableStack=JSON.parse(JSON.stringify(stack));if(this.parent.canvasClear(aux),this.canForecastClear)try{for(let y=this.fieldSize.hh-1;y<this.fieldSize.h;y++)for(let x=0;x<this.fieldSize.w;x++)this.stack[x]&&this.bitboard.setCell(y,x,this.stack[x][y]?1:0)}catch(e){}this.parent.drawArray(aux,this.drawableStack,0,-1*(this.fieldSize.hh-this.visibleFieldBufferHeight),void 0,0,widthQuotient,heightQuotient)}drawActivePiece(){if(!this.isEnable)return;let aux=this.isAux?"pieceAux":"piece";if(this.parent.canvasClear(aux),this.piece.y<-10)return;let widthQuotient=this.parent.fieldSize.w/this.fieldSize.w,heightQuotient=this.parent.fieldSize.vh/this.fieldSize.vh;this.parent.drawArray(aux,this.piece.activeArr,this.piece.x,~~this.piece.y-(this.fieldSize.hh-this.visibleFieldBufferHeight),void 0,0,widthQuotient,heightQuotient);let q=this.parent.canvasCtx[aux];if(q.globalAlpha=1,this.isInvisible||this.parent.drawArray(aux,this.piece.activeArr,this.piece.x,~~this.piece.y+this.checkDrop(40)-(this.fieldSize.hh-this.visibleFieldBufferHeight),void 0,3,widthQuotient,heightQuotient),q.globalAlpha=1,this.piece.spin.spin){let b=0;this.lock.delay%8<2?b=1:this.lock.delay%8<6&&(b=2),this.parent.drawArray(aux,this.piece.activeArr,this.piece.x,~~this.piece.y-(this.fieldSize.hh-this.visibleFieldBufferHeight),void 0,b,widthQuotient,heightQuotient)}if(this.piece.spin.mini){let b=0;this.lock.delay%8<4&&(b=1),this.parent.drawArray(aux,this.piece.activeArr,this.piece.x,~~this.piece.y-(this.fieldSize.hh-this.visibleFieldBufferHeight),void 0,b,widthQuotient,heightQuotient)}if(this.isLineToClear=!0,!this.piece.enable)return;let msy=~~this.piece.y+this.checkDrop(99);for(let x=0;x<this.piece.activeArr.length;x++)for(let y=0;y<this.piece.activeArr[x].length;y++)this.piece.activeArr[x][y]&&this.stateBitboard.setCell(msy+y,~~this.piece.x+x,1);let mask=(1<<this.fieldSize.w)-1;this.parent.canvasCtx.piece.globalAlpha=.155+manager.frames%15/15*.3;for(let g=0;g<this.stateBitboard.base.length;g++)this.stateBitboard.base[g]==mask&&(this.parent.canvasCtx.piece.fillStyle="#fff",this.parent.canvasCtx.piece.fillRect(0,this.parent.cellSize*(g-this.fieldSize.hh+this.visibleFieldBufferHeight),this.parent.cellSize*this.fieldSize.w,this.parent.cellSize),this.isLineToClear=!0);this.parent.canvasCtx.piece.globalAlpha=1}checkValid(arr,cx,cy){let px=cx+this.piece.x,py=~~(cy+this.piece.y);for(let x=0;x<arr.length;x++)for(let y=0;y<arr[x].length;y++)if(arr[x][y]&&this.testGridSpace(x+px,y+py))return!1;return!0}checkDrop(dis){let a=0;for(;this.checkValid(this.piece.activeArr,0,a)&&dis>=a;)a++;return a-1}spawnPiece(index,held){if(this.isSpawnablePiece&&(this.isActive||held))if(this.isSpawnablePiece&&this.canSpawnPiece(index,held)){this.piece.spin.spin=0,this.piece.spin.mini=0,this.piece.y+=this.checkDrop(1+~~this.settings.gravity);let temp=this.piece.template;if(this.canRaiseGarbage=!0,this.lock.lowest=0,this.checkManipulatedPiece(),this.parent.ai.active&&!game.replay.isOn){let h=this.piece.hold||0,pieceX=temp[h].x+Math.min(this.fieldSize.w-5,~~((this.fieldSize.w-10)/2)),pieceY=temp[h].y+this.fieldSize.hh-2;this.parent.ai.evaluate(this.piece.active,this.piece.hold,this.piece.held,this.preview.queue[0],-1,-1,this.stack,pieceX,pieceY,this.piece.x,this.piece.y,this.piece.rot,this.piece.template,(fp,fx,fy,frot)=>{this.parent.drawArray("stack",this.piece.template[fp].matrix[frot],fx,~~fy-(this.fieldSize.hh-this.visibleFieldBufferHeight),void 0,0)},this.piece.count)}}else this.checkLose()}checkLose(){this.piece.enable=!1,this.lock.delay=30,this.lock.reset=15,this.lock.lowest=0,this.piece.y=-38,this.piece.x=0,this.loseDelay=30,this.piece.isAir=!0,this.isSpawnablePiece=!1}immediatelyLose(){this.piece.enable=!1,this.lock.delay=30,this.lock.reset=15,this.lock.delay=15,this.piece.y=-38,this.piece.x=0,this.parent.checkLose(),this.piece.isAir=!0,this.isSpawnablePiece=!1;for(let l=this.delayParamsLength;l>=0;l--)this.delay[l]=-99}resetGrid(){for(let x=0;x<this.fieldSize.w;x++)for(let y=0;y<this.fieldSize.h;y++)this.stack[x][y]=0;this.drawStack(this.stack)}checkRespawnOrDie(){let isLose=!1,isWin=!1;if(this.parent.rpgAttr.isOn?this.parent.rpgAttr.checkZeroHP()?isLose=!0:(this.insane.isOn&&this.parent.rpgAttr.isWOIHPMode?(this.insane.delay.del=5,this.insane.status="fail",this.setDelay(0,-9)):this.parent.rpgAttr.addHP(-this.parent.rpgAttr.maxHP/5,!0),this.parent.rpgAttr.addStatusEffect(this.parent.player,"immune2garbage",42,{}),this.parent.garbage.length=0,this.parent.garbageBehind.length=0,this.parent.garbageLength=0,this.parent.garbageBehindLength=0,this.parent.garbageLastForTray.assign(0),this.parent.garbageBehindLastForTray.assign(0),this.parent.rpgAttr.hpDamage=0,this.parent.rpgAttr.checkZeroHP()&&(isLose=!0)):this.isTSDOnly&&this.tsdCount>=20?isWin=!0:isLose=!0,isLose){this.parent.checkLose(),this.delay[0]=-60;for(let l=this.delayParamsLength;l>=0;l--)this.delay[l]=-82,this.isSpawnablePiece=!1}else if(isWin){this.delay[0]=-60;for(let l=this.delayParamsLength;l>=0;l--)this.delay[l]=-82;this.parent.checkWin(),this.isSpawnablePiece=!1}else this.simulateSplashOut(),this.resetGrid(),this.isSpawnablePiece=!0,this.delay[0]=10}canSpawnPiece(index,held){let temp=this.piece.template;return this.piece.active=index,this.piece.rot=0,this.piece.activeArr=temp[index].matrix[0],this.piece.x=temp[index].x+Math.min(this.fieldSize.w-5,~~((this.fieldSize.w-10)/2)),this.piece.y=this.fieldSize.hh-2,this.lock.delay=30,this.lock.reset=15,this.piece.kickTable=temp[index].kickTable,this.piece.spin.spin=!1,this.piece.spin.mini=!1,this.piece.rotated=!1,this.piece.isAir=!1,this.piece.moved=!1,this.piece.dirty=!0,this.piece.enable=!0,this.piece.spinTable=temp[index].spinDetection,!held&&this.canRaiseGarbage&&this.raiseGarbage(),!!this.checkValid(this.piece.activeArr,0,0)}previewGenerateBag(){let pieceList=[];this.preview.bag.forEach(function(a){pieceList.push(a)});for(var i=0;i<pieceList.length-1;i++){var temp=pieceList[i],rand=~~((pieceList.length-i)*this.rngPreview.next())+i;pieceList[i]=pieceList[rand],pieceList[rand]=temp}return pieceList}previewInitialize(){this.preview.queue=[],this.preview.queue.push.apply(this.preview.queue,this.previewGenerateBag()),this.previewDraw()}previewModify(arr,count){this.preview.queue.length=0;for(let m=0;m<count;m++)for(let a of arr)this.preview.queue.push(a);this.previewDraw()}previewNextBag(held){if(!this.isSpawnablePiece&&!held)return;let next=this.preview.queue.shift();return this.preview.queue.push(...this.previewGenerateBag()),this.isActive||this.preview.queue.unshift(next),this.previewDraw(),next}hold(){if(this.piece.enable&&this.piece.holdable&&this.canControl){let tmp=this.piece.hold;this.piece.held||(this.piece.held=!0,null==this.piece.hold?(this.piece.hold=this.piece.active,this.spawnPiece(this.previewNextBag(!0),!0),this.parent.playSound("hold_first")):(this.piece.hold=this.piece.active,this.parent.playSound("hold"),this.spawnPiece(tmp,!0))),this.holdDraw()}}holdDraw(){if(this.isAux||!this.isEnable)return;if(this.parent.isCompact)return void this.prevHoldDraw4P();let t=this.parent,c=t.canvasCtx.hold;if(this.parent.canvasClear("hold"),t.isVisible&&c.drawImage(game.misc.block_hold,0,0,5*t.cellSize,4*t.cellSize),void 0===this.piece.hold)return;let m=this.piece.hold,piece=this.piece.template[m],arr=piece.matrix[0];for(var x=0,len=arr.length;x<len;x++)for(var y=0,wid=arr[x].length;y<wid;y++)if(arr[x][y]){let mc=arr[x][y];t.isVisible&&c.drawImage(manager.skin.canvas,0*t.cellSize,mc*t.cellSize,t.cellSize,t.cellSize,(piece.prevx+x)*t.cellSize*1,(piece.prevy+y+.5)*t.cellSize*1,1*t.cellSize,1*t.cellSize)}this.parent.isCompact&&this.prevHoldDraw4P()}previewDraw(){if(this.isAux||!this.isEnable)return;if(this.parent.isCompact)return void this.prevHoldDraw4P();let t=this.parent;this.parent.canvasClear("next");let c=t.canvasCtx.next,ms=0;for(let i=0;i<5;i++){let m=this.preview.queue[i],piece=this.piece.template[m],arr=piece.matrix[0],my=4,ty=.5,ts=1;i>0&&(ts=.85,ty=0,my=3),this.parent.isVisible&&c.drawImage(0==i?game.misc.block_next:game.misc.block_nextqueue,0*t.cellSize*ts,0*t.cellSize*ts+ms,t.cellSize*ts*5,t.cellSize*ts*my);for(var x=0,len=arr.length;x<len;x++)for(var y=0,wid=arr[x].length;y<wid;y++)if(arr[x][y]){let mc=arr[x][y];t.isVisible&&c.drawImage(manager.skin.canvas,0*t.cellSize,mc*t.cellSize,t.cellSize,t.cellSize,(piece.prevx+x)*t.cellSize*ts,(piece.prevy+y+ty)*t.cellSize*ts+ms,t.cellSize*ts,t.cellSize*ts)}ms+=my*ts*t.cellSize}}prevHoldDraw4P(){if(this.isAux||!this.isEnable)return;let t=this.parent;this.parent.canvasClear("next");let c=t.canvasCtx.next,ms=5.1*t.cellSize,ns=t.cellSize*(1.5*t.fieldSize.w-5.6525),sjs=t.cellSize*(1-.85);for(let i=0;i<5;i++){let m=this.preview.queue[i],piece=this.piece.template[m],arr=piece.matrix[0],my=4,ty=.5,ts=1;i>0&&(ts=.85,ty=0,my=3,sjs=0),this.parent.isVisible&&c.drawImage(0==i?game.misc.block_next:game.misc.block_nextqueue,0*t.cellSize*ts+ns-sjs,0*t.cellSize*ts+ms,t.cellSize*ts*5,t.cellSize*ts*my);for(var x=0,len=arr.length;x<len;x++)for(var y=0,wid=arr[x].length;y<wid;y++)if(arr[x][y]){let mc=arr[x][y];t.isVisible&&c.drawImage(manager.skin.canvas,0*t.cellSize,mc*t.cellSize,t.cellSize,t.cellSize,(piece.prevx+x)*t.cellSize*ts+ns-sjs,(piece.prevy+y+ty)*t.cellSize*ts+ms,t.cellSize*ts,t.cellSize*ts)}0==i?ms-=2.55*t.cellSize:i<2?ms-=my*ts*t.cellSize:ns-=4.25*t.cellSize}if(this.piece.holdable){let gs=5.1*t.cellSize;if(t.isVisible&&c.drawImage(game.misc.block_hold,0,gs,5*t.cellSize,4*t.cellSize),void 0===this.piece.hold)return;let m=this.piece.hold,hold=this.piece.template[m],harr=hold.matrix[0];for(x=0,len=harr.length;x<len;x++)for(y=0,wid=harr[x].length;y<wid;y++)if(harr[x][y]){let mc=harr[x][y];t.isVisible&&c.drawImage(manager.skin.canvas,0*t.cellSize,mc*t.cellSize,t.cellSize,t.cellSize,(hold.prevx+x)*t.cellSize,(hold.prevy+y+.5)*t.cellSize+gs,t.cellSize,t.cellSize)}}}checkManipulatedPiece(){if(!this.piece.enable)return!1;let air=this.checkValid(this.piece.activeArr,0,1),change=!1;if(~~this.piece.y!==~~this.piece.last.y&&(this.piece.last.y=~~this.piece.y,change=!0),this.piece.dirty&&(this.piece.dirty=!1,change=!0),change)for(let x=0;x<this.piece.activeArr.length;x++)for(let y=0;y<this.piece.activeArr[x].length;y++)this.piece.activeArr[x][y]&&~~this.piece.y+y>this.lock.lowest&&(this.lock.lowest=~~this.piece.y+y,this.lock.reset=15);if(air?this.piece.isAir||(this.piece.isAir=!0):this.piece.isAir&&(this.piece.isAir=!1,this.piece.isHardDrop||this.parent.playSound("lock")),air)this.lock.delay=this.settings.lock,this.piece.moved=!0;else if(this.lock.delay<=0||this.lock.reset<=0){this.piece.y=~~this.piece.y,this.piece.lastDrop.x=this.piece.x,this.piece.lastDrop.y=this.piece.y,this.piece.held=!1;let hasDelay=this.setDelay(0,void 0);this.piece.dirty=!0,this.piece.isHardDrop||this.parent.playSound("lock"),this.piece.isHardDrop=!1,this.detectSpin(!this.piece.moved&&this.piece.rotated&&!air),this.addPieceStack(this.piece.activeArr);for(let h=0;h<this.delayParamsLength;h++)this.delay[h]>0&&(hasDelay=!0);hasDelay&&(this.piece.y=-90,this.piece.enable=!1),this.piece.enable&&this.isSpawnablePiece&&(this.stompProps.afterHardDrop?(this.stompProps.afterHardDrop=!1,this.executeStomp()):this.spawnPiece(this.previewNextBag(),!1))}}updatePiece(){if(!this.piece.enable||!this.canControl)return;let gravity=this.settings.gravity;this.piece.isAir&&(gravity<1?this.piece.y+=gravity:1==gravity?this.piece.y+=this.checkDrop(1):gravity>1&&(this.piece.y+=this.checkDrop(gravity)),this.lock.delay=this.settings.lock,this.checkManipulatedPiece()),this.piece.isAir||(this.piece.y=~~this.piece.y,this.lock.delay--,this.checkManipulatedPiece()),this.canForecastClear&&this.bitboard.copyThisBB(this.stateBitboard)}setDelay(type,value){let delayAdd=void 0!==value?value:this.delayAdd[type];return delayAdd<=0&&(delayAdd=-10),this.delay[type]=delayAdd,this.delay[type]>0}rotatePiece(direction){if(!this.canControl||!this.piece.enable||!this.piece.is180able&&2==direction)return;let temp=this.piece.template[this.piece.active].matrix,pos=(this.piece.rot%4+4)%4,nPos=((this.piece.rot+direction)%4+4)%4,rotate=temp[nPos];var dirType="right";switch(direction){case 1:dirType="right";break;case-1:dirType="left";break;case 2:dirType="double"}for(let i=0,len=this.piece.kickTable[dirType][pos].length;i<len;i++)if(this.checkValid(rotate,this.piece.kickTable[dirType][pos][i][0],this.piece.kickTable[dirType][pos][i][1])){this.parent.playSound("rotate");let kickX=this.piece.kickTable[dirType][pos][i][0],kickY=this.piece.kickTable[dirType][pos][i][1];this.piece.x+=kickX,this.piece.y+=kickY,this.piece.kickDistance.x=kickX,this.piece.kickDistance.y=kickY,this.piece.rot=nPos,this.piece.activeArr=rotate,this.lock.delay=this.settings.lock,this.lock.reset--,this.piece.moved=!1,this.piece.rotated=!0,this.checkManipulatedPiece(),this.lock.reset>0&&this.detectSpin(!this.piece.moved&&this.piece.rotated&&!this.piece.isAir),this.piece.spin.spin&&this.parent.playSound("prespin"),this.piece.spin.mini&&this.parent.playSound("prespinmini");break}}detectSpin(isMoveAir){let spin=0,mini=0,x1y2=0,check=0,posX=this.piece.x,posY=~~this.piece.y,rot=this.piece.rot,a=this.piece.spinTable;if(isMoveAir&&(6==this.piece.active||this.isAllSpin)&&2!==this.piece.active){for(let x=0,len1=a.highX[rot].length;x<len1;x++)this.testGridSpace(posX+a.highX[rot][x],posY+a.highY[rot][x])&&(spin++,check++);for(let x=0,len1=a.lowX[rot].length;x<len1;x++)this.testGridSpace(posX+a.lowX[rot][x],posY+a.lowY[rot][x])&&(mini++,check++);this.piece.kickDistance.y>=2&&(this.piece.kickDistance.x>=1||this.piece.kickDistance.x<=-1)&&x1y2++}this.piece.spin.spin=0,this.piece.spin.mini=0,check>=3&&(x1y2>0||spin>1?this.piece.spin.spin=1:mini>1&&(this.piece.spin.mini=1))}moveX(shift){this.piece.enable&&this.canControl&&this.checkValid(this.piece.activeArr,shift,0)&&(this.piece.x+=shift,this.lock.reset--,this.lock.delay=this.settings.lock,this.piece.moved=!0,this.piece.rotated=!1,this.parent.playSound("move"),this.checkManipulatedPiece())}shiftDelay(){if(this.parent.flagPresses.right&&0===this.handling.xFirst&&(this.handling.xFirst=1),this.parent.flagPresses.left&&0===this.handling.xFirst&&(this.handling.xFirst=-1),0!==this.handling.xFirst&&(this.parent.flagPresses.right&&!this.parent.flagPresses.left?this.handling.xFirst=1:this.parent.flagPresses.left&&!this.parent.flagPresses.right&&(this.handling.xFirst=-1)),this.parent.flagPresses.right||this.parent.flagPresses.left||0===this.handling.xFirst||(this.handling.xFirst=0),this.dasCancellation.on){let x=0;this.parent.flagPresses.right&&(x|=2),this.parent.flagPresses.left&&(x|=1),this.dasCancellation.main.assign(x)}if((this.parent.flagPresses.left||this.parent.flagPresses.right)&&(this.handling.das++,this.handling.das>this.settings.das)){this.handling.arr++,this.handling.arr>this.settings.arr&&(this.handling.arr=1);for(let i=0;i<this.fieldSize.w;i++){let dir=0;if(1===this.handling.xFirst&&(dir=this.parent.flagPresses.left?-1:1),-1===this.handling.xFirst&&(dir=this.parent.flagPresses.right?1:-1),0!==dir&&this.moveX(dir),0!==this.settings.arr)break}}}resetDelayAutoshiftRate(){this.handling.das=0}hardDrop(){if(this.piece.enable&&this.canControl){let distance=this.checkDrop(this.fieldSize.h);this.piece.y;this.piece.y+=distance;this.piece.y;distance>0&&(this.piece.moved=!0,this.piece.rotated=!1),this.lock.delay=-1,this.piece.isHardDrop=!0,this.parent.playSound("harddrop");let m=[];this.parent.rpgAttr.isOn,this.parent.score+=2*Math.max(distance-~~this.settings.gravity,0);for(let x=0,km=this.piece.activeArr.length;x<km;x++)for(let y=0,mm=this.piece.activeArr[x].length;y<mm;y++)if(this.piece.activeArr[x][y]){m.push(x+this.piece.x),m.push(y+this.piece.y);break}if(!this.isInvisible){let bez={x1:0,x2:.1,x3:.9,x4:1,y1:0,y2:.1,y3:.1,y4:1},particleSpeed=50+~~(20*Math.random()),asset=this.parent.assetRect(this.isAux?"AUX-FIELD-CHARACTER-CANVAS":"FIELD-CHARACTER-CANVAS"),sizemult=this.isAux?.47:1,ax=(asset.width,asset.height,asset.x),ay=asset.y,cs=(this.parent.fieldSize.w,this.fieldSize.w,this.parent.fieldSize.vh,this.fieldSize.vh,this.parent.fieldCellSize);for(let yo=0;yo<5;yo++)for(let x=0,km=this.piece.activeArr.length;x<km;x++)for(let y=0,mm=this.piece.activeArr[x].length;y<mm;y++)if(this.piece.activeArr[x][y]){let rx=Math.random(),ry=Math.random();this.parent.addBasicParticle(!0,ax+(x+this.piece.x)*cs+cs*rx,ay+(y+this.piece.y-this.fieldSize.hh)*cs+cs*ry,ax+(x+this.piece.x)*cs+cs*rx,ay+(y+this.piece.y-2-12*Math.random()-this.fieldSize.hh)*cs,particleSpeed,.025,!1,bez,!1)}let ln=m.length,ll=Math.max(distance,10);for(let lk=0;lk<ln;lk+=1){let zx=m[2*lk],zy=m[2*lk+1];this.effects.hardDrop.addItem({x:zx,y:zy,frames:40,maxf:40,dep:ll,blk:this.piece.active})}}this.checkManipulatedPiece()}}softDrop(){if(this.piece.enable&&this.canControl&&this.piece.isAir){let gravity=20*this.settings.gravity;this.isProfessional&&(gravity=this.settings.sft);let initial=Math.floor(this.piece.y);gravity<1?this.piece.y+=gravity:1==gravity?this.piece.y+=this.checkDrop(1):gravity>1&&(this.piece.y+=this.checkDrop(gravity));let final=Math.floor(this.piece.y);initial!==final&&(this.piece.moved=!0,this.parent.score+=final-initial),this.checkManipulatedPiece()}}addPieceStack(arr){let lines=0,valid=!1,hasDelay=!1;this.clear.linesReady.length=0,this.piece.count++;for(let x=0;x<arr.length;x++)for(let y=0;y<arr[x].length;y++)if(arr[x][y]){let px=x+this.piece.x,py=~~(y+this.piece.y);this.stack[px][py]=arr[x][y],py>=this.fieldSize.hh&&(valid=!0)}let isPuffOut=!1;for(let y=0;y<this.fieldSize.h;y++){let count=0;for(let x=0;x<this.fieldSize.w;x++)this.testGridSpace(x,y)&&count++;count>=this.fieldSize.w&&(this.clear.linesReady.push(y),lines++)}if(0==lines?(this.combo=-1,this.piece.spin.spin&&(this.parent.playSound("tspin0"),this.parent.score+=400*this.level),this.piece.spin.mini&&(this.parent.playSound("tspinmini0"),this.parent.score+=100*this.level),this.combo<0&&this.parent.engageCleartextCombo(!0,0),this.garbageWait.length>0&&(this.emitAttack(this.garbageWait,!0),console.log(this.garbageWait),this.garbageWait.length=0),"linkblob-full"!==this.parent.garbageBlocking&&"full"===this.parent.garbageBlocking&&(this.canRaiseGarbage=!0),this.insane.isOn&&(this.insane.delay.del=10,this.insane.status="fail",this.nextVoice.name="insane_fail",this.nextVoice.duration=20,this.setDelay(0,50)),this.isAux&&(isPuffOut=!0)):(hasDelay=this.setDelay(2,void 0),"limited"===this.parent.garbageBlocking&&(this.canRaiseGarbage=!0)),isPuffOut)for(let x=0;x<arr.length;x++)for(let y=0;y<arr[x].length;y++)if(arr[x][y]){let px=x+this.piece.x,py=~~(y+this.piece.y);this.stack[px][py]=0,this.effects.clearAnim.addItem({x:px,y:py,frames:0,maxf:25})}if((!this.insane.isUnlimited||this.insane.isCommandedEnd)&&(this.insane.time<=0||this.insane.isCommandedEnd)&&this.insane.isOn&&(this.insane.delay.turningOff=5,this.setDelay(0,5)),hasDelay||this.clearLine(),this.isTSDOnly&&(6!==this.piece.active||!this.piece.spin.spin||2!==lines)&&lines>0&&(valid=!1),this.isActive||(this.canRaiseGarbage=!1),this.drawStack(this.stack),this.checkStackAltitude(),valid||(this.checkLose(),hasDelay=this.setDelay(2,-1)),this.stompProps.afterHardDrop)return this.stompProps.afterHardDrop=!1,void this.executeStomp()}stackCollapse(sound){let hasAbove=!1;for(let j=0,len=this.clear.linesDelayed.length;j<len;j++){for(let full=this.clear.linesDelayed.shift();full>=1;full--)for(let x=0;x<this.fieldSize.w;x++)this.stack[x][full-1]&&(hasAbove=!0),this.stack[x][full]=this.stack[x][full-1]}sound&&hasAbove&&this.parent.playSound("collapse"),this.canRaiseGarbage&&(this.raiseGarbage(),this.canRaiseGarbage=!1),this.drawStack(this.stack),this.checkStackAltitude()}emitAttack(marr,isLaunch){let add=[],neutralized=!1,remaining=0,attack=0,particleSpeed=this.parent.particleGarbageDelay;for(let l=0,os=marr.length;l<os;l++){let remain=0,atkblob=marr[l].blob,atkmax=marr[l].block,j={a:marr[l].blob,surplus:0};1===this.parent.activeType&&(j=this.garbageConversion(marr[l].block));let count=0==this.parent.activeType?marr[l].block:j.a,max=atkblob;for(;this.parent.garbage.length>0&&"none"!==this.parent.garbageBlocking&&count>0;){let reference=this.parent.garbage[0];if(reference.count<=0){this.parent.garbage.shift();continue}neutralized=!0;let min=Math.min(reference.count,count);reference.count-=min,0===reference.count&&this.parent.garbage.shift(),count-=min,atkblob-=min}for(;this.parent.garbageBehind.length>0&&"none"!==this.parent.garbageBlocking&&count>0;){let reference=this.parent.garbageBehind[0];if(reference.count<=0){this.parent.garbageBehind.shift();continue}neutralized=!0;let min=Math.min(reference.count,count);reference.count-=min,0===reference.count&&this.parent.garbageBehind.shift(),count-=min,atkblob-=min}atkblob<0&&(atkblob=0),remain+=atkblob,remaining+=count,attack+=max,remain>0&&add.push({atk:remain,max:max,atkblock:~~Math.max(1,atkmax*(remain/max))})}if(this.parent.garbageLength=this.parent.calculateGarbage(),this.parent.garbageBehindLength=this.parent.calculateGarbageBehind(),neutralized&&(this.parent.rpgAttr.hpDamage=this.parent.calculateHPDamage()),this.parent.isGarbageCollectionMode){neutralized=!0;for(let l=0,os=add.length;l<os;l++)this.parent.woi.add(add[l].atk);add.length=0}let blobatk=0,blockatk=0;for(let l=0,os=add.length;l<os;l++)blobatk+=add[l].atk,blockatk+=add[l].atkblock;let asset=this.parent.assetRect(this.isAux?"AUX-FIELD-CHARACTER-CANVAS":"FIELD-CHARACTER-CANVAS"),sizemult=this.isAux?.47:1,ax=(asset.width,asset.height,asset.x),ay=asset.y,selfTarget=this.parent.assetRect("GARBAGE-TRAY-DIV"),gw=selfTarget.width,gh=selfTarget.height,gx=selfTarget.x,gy=selfTarget.y,cs=this.parent.fieldCellSize,ifllSound=(this.parent.fieldSize.w,this.fieldSize.w,this.parent.fieldSize.vh,this.fieldSize.vh,!0),m=this.hitSoundReduce,bez={x1:0,x2:.9,x3:1,x4:1,y1:0,y2:.9,y3:1,y4:1};if(add.length>0){if(this.meteredGarbageWaitMode&&!isLaunch)for(let l=0,os=add.length;l<os;l++)this.garbageWait.push({block:add[l].atkblock,blob:add[l].atk});else{let z=this.sendGarbage(add,this.parent.activeType);Object.keys(z).length>0&&game.forEachPlayer(e=>{if(e.player in z){let target=e.assetRect("GARBAGE-TRAY-DIV"),tw=target.width,th=target.height,tx=target.x,ty=target.y;e.addDelayHandler(!1,particleSpeed*(neutralized?2:1),()=>{e.playSound(`hit${Math.max(Math.min(5,attack-m-2),1)}`),e.garbageLastForTray.assign(e.garbageLength),e.garbageBehindLastForTray.assign(e.garbageBehindLength),e.isDying||e.isFinishAble||e.isDead||e.engageShakeIntensityHit(Math.max(Math.min(5,attack-m-2),1)),animatedLayers.create(void 0,30,tx+tw/2,ty+th/2,0,0,0,200,200,12,12,.5,"block_hit",10,this.cellSize)}),e.check1v1Overhead(!0,e.garbageLength+e.garbageBehindLength,e.garbageLength+e.garbageBehindLength,!1),neutralized?e.addDelayHandler(!0,particleSpeed,()=>{e.addParticle(!0,"attack",0,0,gx+gw/2,gy+gh/2,tx+tw/2,ty+th/2,particleSpeed,2.5,!1,bez,!0,{frame:particleSpeed*(.3+.1*Math.min(9,attack)),r:255,g:255,b:255})}):e.addParticle(!0,"attack",0,0,ax+this.piece.lastDrop.x*cs,ay+(this.piece.lastDrop.y-this.fieldSize.hh)*cs,tx+tw/2,ty+th/2,particleSpeed,2.5,!1,bez,!0,{frame:particleSpeed*(.3+.1*Math.min(9,attack)),r:255,g:255,b:255})}}),this.hitSoundReduce=0}if(this.meteredGarbageWaitMode&&!isLaunch){let garbageWait=0;for(let qq=0,leng=this.garbageWait.length;qq<leng;qq++)garbageWait+=this.garbageWait[qq].blob;this.parent.playSound("charge"+(garbageWait>13?"_high":"")),this.hitSoundReduce=0,ifllSound=!1}}neutralized&&attack>0&&(this.parent.addParticle(!0,"attack",0,0,ax+this.piece.lastDrop.x*cs,ay+(this.piece.lastDrop.y-this.fieldSize.hh)*cs,gx+gw/2,gy+gh/2,particleSpeed,2.5,!1,bez,!0,{frame:particleSpeed*(.3+.1*Math.min(9,attack)),r:255,g:255,b:255}),this.parent.addDelayHandler(!0,this.parent.particleGarbageDelay,()=>{this.parent.garbageLastForTray.assign(this.parent.garbageLength),this.parent.garbageBehindLastForTray.assign(this.parent.garbageBehindLength),this.parent.playSound(`hit${Math.max(Math.min(5,attack-m-2),1)}`),animatedLayers.create(void 0,30,gx+gw/2,gy+gh/2,0,0,0,200,200,12,12,.5,"block_hit",10,this.cellSize)}))}garbageConversion(mu){let h=0,g=0,q=0;for(;h<mu;)h++,g+=1==h?4:1+~~(q/2.5),q++;return{a:g,surplus:Math.max(0,mu-h)}}sendGarbage(lt,m){this.parent.playerTarget.length=0;let garbageTarget={},hpDamage=this.parent.rpgAttr.attributes.attack+this.parent.rpgAttr.statusEffectsAttributes.attack+this.parent.rpgAttr.attributes.atkTolerance*this.parent.seeds.field.next();manager.forEachPlayer(player=>{player.player!==this.parent.player&&player.team!==this.parent.team&&this.parent.playerTarget.push(player.player)});let add=0,amtBlock=[];for(let b=0,o=lt.length;b<o;b++)add+=lt[b].atk,amtBlock.push(lt[b].atkblock);let amtBlob=0,totalAdd=add,isRandomBlockGarb=!this.isProfessional,h=0,g=0,q=0;if(0===m)for(;h<totalAdd;)h++,g+=1==h?4:1+~~(q/2.5),q++;return amtBlob=[g],manager.forEachPlayer(player=>{(!player.rpgAttr.isOn||player.rpgAttr.canReceiveGarbage>0)&&-1!==this.parent.playerTarget.indexOf(player.player)&&(1===player.activeType&&player.addGarbage(this.parent.player,0==m?amtBlob:amtBlock,false,!1,70,hpDamage*(1/1.8)),0===player.activeType&&player.addGarbage(this.parent.player,amtBlock,false,isRandomBlockGarb,10,hpDamage),add>0&&(garbageTarget[player.player]=add))}),garbageTarget}raiseGarbage(){let a=this.parent.garbage.filter(m=>m.frames<manager.frames&&!m.wait),len=a.length,count=0,mpl={},j=[];if(len>0)for(let s=0,qw=this.parent.garbage;s<qw.length;s++)j.push(qw[s].id);for(;len>0;){let r=a[0],index=j.indexOf(r.id);if(r.count>0){index=j.indexOf(r.id);for(var x=0;x<this.fieldSize.w;x++)for(var y=0;y<this.fieldSize.h;y++)this.stack[x][y]=this.stack[x][y+1];for(x=0;x<this.fieldSize.w;x++)this.stack[x][this.fieldSize.h-1]=9+this.parent.garbageType;if(r.allmess){if(this.parent.seeds.field.next()<this.messiness)for(;;){let la=~~(this.parent.seeds.field.next()*this.fieldSize.w);if(la!==this.currentGarbageHole){this.currentGarbageHole=la;break}}this.stack[this.currentGarbageHole][this.fieldSize.h-1]=0}else this.stack[r.row][this.fieldSize.h-1]=0;count++,r.count--}if(this.parent.garbage[index].count<=0&&(this.parent.garbage.splice(index,1),j.splice(index,1),a.shift(),len--),this.parent.rpgAttr.isOn&&game.forEachPlayer(player=>{r.player===player.player&&(player.player in mpl?mpl[player.player]+=r.hpdmg:mpl[player.player]=r.hpdmg)}),count>=this.garbageLimit&&this.garbageLimit>0)break}if(count>0){this.parent.playSound("garbage"),count>1&&count<4&&this.parent.playVoice("damage1"),count>3&&(this.parent.playVoice(count>9?"damage3":"damage2"),this.parent.rectanim.play("damage2")),this.parent.rpgAttr.emulateDamage(mpl),this.canRaiseGarbage="linkblob-full"==this.parent.garbageBlocking||"full"!==this.parent.garbageBlocking;let isLose=!1;this.parent.rpgAttr.isOn&&this.parent.rpgAttr.checkZeroHP()&&(isLose=!0),isLose&&this.immediatelyLose(),this.parent.garbageLength=this.parent.calculateGarbage(),this.parent.garbageLastForTray.assign(this.parent.garbageLength),this.parent.rpgAttr.hpDamage=this.parent.calculateHPDamage(),this.drawStack(this.stack),this.checkStackAltitude()}}clearLine(){let lines=0,isPC=!this.insane.isOn,hasDelay=!1,isCounter=!1,firstY=0,lengthLines=this.clear.linesReady.length;this.clear.blocks.length=0;for(let m=0,h=this.clear.linesReady.length;m<h;m++){let y=this.clear.linesReady.shift();0==m&&(firstY=y+lengthLines/2),lines++,this.insane.isOn&&this.insane.blocks.requireLine--;for(let x=0;x<this.fieldSize.w;x++)this.clear.blocks.push({x:x,y:y,c:this.stack[x][y]}),this.stack[x][y]=0;this.clear.linesDelayed.push(y)}for(let y=0;y<this.fieldSize.h;y++)for(let x=0;x<this.fieldSize.w;x++)this.testGridSpace(x,y)?isPC=!1:this.stack[x][y]=0;if(lines>0){if(hasDelay=this.setDelay(1,void 0),this.delay[1]+=this.isProfessional?0:5*~~(lines/this.lcdTimes5),hasDelay=this.delay[1]>0,!this.isProfessional&&isPC&&(hasDelay=this.setDelay(1,0)),this.combo++,this.combo>0&&!this.isAux&&(this.insane.isOn||this.parent.engageCleartextCombo(!0,1,`${this.combo} Combo`)),this.piece.spin.spin){if(6!==this.piece.active){let letter=["z","l","o","s","i","j","t"][this.piece.active];this.parent.engageCleartext("spin",!0,language.translate(`${letter}spin`))}else this.parent.engageCleartextTSpin(!0,0,lines);this.insane.isOn||this.b2b++,this.isTSDOnly&&6==this.piece.active&&2==lines?(this.tsdCount++,this.tsdCount<20?this.parent.playSound("tspin_correct"):this.parent.playSound(`tspin${lines}`),20==this.tsdCount&&this.parent.playSound("tspin_complete")):this.parent.playSound(`tspin${Math.min(lines,3)}${this.b2b>0?"_b2b":""}`)}else if(this.piece.spin.mini){if(6!==this.piece.active){let letter=["z","l","o","s","i","j","t"][this.piece.active];this.parent.engageCleartext("spin",!0,language.translate(`${letter}spin`))}else this.parent.engageCleartextTSpin(!0,1,lines);this.insane.isOn||this.b2b++,this.isTSDOnly&&6==this.piece.active&&2==lines?(this.parent.playSound("tspin_correct"),this.tsdCount++):this.parent.playSound(`tspinmini${Math.min(lines,3)}${this.b2b>0?"_b2b":""}`)}else lines>3?(this.insane.isOn||this.b2b++,this.parent.playSound(`line${Math.min(lines,4)}${this.b2b>0?"_b2b":""}`)):(this.b2b=-1,this.parent.playSound(`line${Math.min(lines,4)}`));if(isPC){let asset=this.isAux?this.parent.assetRect("AUX-FIELD"):this.parent.assetRect("FIELD"),plm=this.isAux?.47:1,ax=asset.x,ay=asset.y,px=ax+this.piece.lastDrop.x*this.parent.fieldCellSize*plm,py=ay+(this.piece.lastDrop.y-this.fieldSize.hh)*this.parent.fieldCellSize*plm,tx=ax+this.parent.fieldSize.w/2*this.parent.fieldCellSize*plm,ty=ay+.294*this.parent.fieldSize.hh*this.parent.fieldCellSize*plm;animatedLayers.create(void 0,60,tx,ty,0,0,0,200,200,12,12,1,"perfect_clear",10,1.2*plm);let bez={x1:0,x2:0,x3:1,x4:1,y1:0,y2:.3,y3:1+.2*Math.random(),y4:1};this.pcSpam.frame=1200,this.pcSpam.count++,this.pcSpam.count>=3&&htmlEffects.add(language.translate("pc_spam"),px,py,50,{name:"chain-text-anim",iter:1,timefunc:"cubic-bezier(0,0,1,0)",initdel:0},"text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black; --__chaintext_size: 1.4em; color: #fff7");for(let m=0,h=this.clear.blocks.length;m<h;m++){let n=this.clear.blocks[m],y=n.y,x=n.x,c=this.isInvisible?1:n.c,mx=ax+this.getQPosX(x)*this.parent.fieldCellSize+this.getQPosX(1)*this.parent.fieldCellSize/2,my=ay+this.getQPosY(y-this.fieldSize.hh)*this.parent.fieldCellSize+this.getQPosY(1)*this.parent.fieldCellSize/2,particleSpeed=121+70*Math.random();bez.y3=1+.2*Math.random(),this.parent.addParticle(!0,"blobblock",1,c,mx,my,mx+this.getQPosX(50*Math.random()-50*Math.random())*this.parent.fieldCellSize,my+this.getQPosY(4*Math.random()+4)*this.parent.fieldCellSize+game.resolution.h,particleSpeed,this.getQPosX(1)*this.parent.fieldCellSize/game.cellSize,!1,bez,!1,!1,{speed:180*Math.random()-180*Math.random()})}}if(6!==this.piece.active)if(this.parent.engageCleartext("line",!0,language.translate(`line${lines}`)),this.piece.spin.spin||this.piece.spin.mini){let letter=["z","l","o","s","i","j","t"][this.piece.active];this.parent.engageCleartext("spin",!0,language.translate(`${letter}spin${this.piece.spin.mini?"mini":""}`))}else lines>5&&this.parent.engageCleartext("spin",!0,language.translate("line5"));else this.piece.spin.spin||this.piece.spin.mini||(lines>5&&this.parent.engageCleartext("spin",!0,language.translate("line5")),this.parent.engageCleartext("line",!0,language.translate(`line${lines}`)));if("linkblob-full"!==this.parent.garbageBlocking&&"full"==this.parent.garbageBlocking&&(this.canRaiseGarbage=!1),this.isTSDOnly&&!this.isAux?this.parent.engageCleartext("b2b",this.tsdCount>0,language.translate("tsd_"+(1==this.tsdCount?"singular":"plural"),[this.tsdCount])):this.insane.isOn||this.isAux||this.parent.engageCleartext("b2b",this.b2b>0,language.translate("b2b",[this.b2b])),this.parent.canAttack){this.hitSoundReduce=0;let garbage=this.getAttack(0,lines,this.piece.spin.spin,this.b2b,this.combo,isPC),garbageBlob=this.getAttack(1,lines,this.piece.spin.spin,this.b2b,this.combo,isPC);isPC&&(this.hitSoundReduce+=4),1==this.piece.spin.spin&&(2==lines&&this.hitSoundReduce++,3==lines&&(this.hitSoundReduce+=2)),isCounter=this.parent.garbageLength>0&&garbage>this.parent.garbageLength&&!this.meteredGarbageWaitMode&&!isPC&&lines>2,hasDelay?(this.delayedGarbage=garbage,this.delayedGarbageBlobs=garbageBlob):this.emitAttack([{block:garbage,blob:garbageBlob}])}let lm=this.executeSpellName(lines,this.piece.spin.spin,this.b2b,this.combo,isPC,isCounter);if(this.activeVoiceLine=this.executeVoice(lines,this.piece.spin.spin,this.b2b,this.combo,isPC,isCounter),this.insane.isOn)if(this.setDelay(0,10),this.setDelay(1,25),this.parent.insaneBg.moveEye(this.fieldSize.w/2,firstY-this.fieldSize.hh),this.parent.insaneBg.changeColorCustom(this.blockColors.r[this.piece.active],this.blockColors.g[this.piece.active],this.blockColors.b[this.piece.active]),this.insane.blocks.requireLine<=0){this.insane.delay.del=10,this.insane.status="success";let ji=1;this.insane.blocks.phase>=4&&ji++,this.insane.blocks.phase>=7&&ji++,this.insane.blocks.phase>=10&&ji++,this.insane.blocks.phase>=13&&ji++,this.activeVoiceLine=lm=`spell${ji}`,this.nextVoice.name="insane_success",this.repeatSpellVoice=Math.max(Math.min(this.insane.blocks.seq-4),0),this.setDelay(0,50)}else this.insane.blocks.seq++,this.activeVoiceLine=this.insane.blocks.seq>=5?"init5":`init${this.insane.blocks.seq}`,lm="",this.nextVoice.duration=-1;hasDelay?this.spellAnimName=lm:(this.spellAnimName=lm,this.stackCollapse(!1),this.parent.playVoice(this.activeVoiceLine),""!==this.spellAnimName&&this.parent.rectanim.play(this.spellAnimName));let spinDetected=this.piece.spin.spin,miniDetected=this.piece.spin.mini;if(hasDelay)for(let m=0,h=this.clear.linesDelayed.length;m<h;m++){let y=this.clear.linesDelayed[m];for(let x=0;x<this.fieldSize.w;x++)this.effects.clearAnim.addItem({x:x,y:y,frames:0,maxf:this.delay[1]*((y%2==0?x:this.fieldSize.w-x)/this.fieldSize.w)})}if(lines>4){let score=200*lines;isPC&&(score*=2.5),spinDetected&&(score*=1.5),miniDetected&&(score*=1.2),this.b2b>0&&(score*=1.5+.1*(lines-4)),score*=this.level,this.parent.score+=~~score}else this.parent.score+=this.level*(SCORE_TABLE[isPC?"pc":"nopc"][(this.b2b>0?"":"no")+"b2b"][""+(spinDetected?"spin":miniDetected?"mini":"line")][lines]+SCORE_TABLE.combo*Math.max(0,this.combo));this.parent.swapMode.add("combo"),this.drawStack(this.stack)}}getAttack(type,line,spin,b2b,combo,pc,garbage){let a=0,b=0;if("multiplier"==this.attackType){if(line>3?b=spin?2*line:line:1==line?b=spin?2:0:2==line?b=spin?4:1:3==line&&(b=spin?6:2),b2b>0&&(b+=1),b*=1,a=b+b/4*combo,0==b){let s=0,z=1,lm=4,kp=0;for(;s<combo;)s>=z&&(a++,kp++,z+=2*(kp-1)+kp*lm),s++}pc&&line>0&&(a+=10)}else if("scorebased"==this.attackType){let base=1,c=0,g=this.parent.blob.decreaseTargetPoint;1==type&&(line>3&&(c=base*(spin?2*line:line)),3==line&&(c=base*(spin?4:2)),2==line&&(c=base*(spin?3:1)),1==line&&(c=base*(spin?2:0))),0==type&&(line>3&&(c=base*(spin?2*line:line)),3==line&&(c=base*(spin?6:2)),2==line&&(c=base*(spin?4:1)),1==line&&(c=base*(spin?2:0))),combo<=1?c+=.5*base:combo>1&&combo<=6?c+=1*base:combo>6&&combo<=10?c+=2*base:combo>10&&combo<=14?c+=3*base:combo>14&&combo<=18?c+=4*base:combo>18&&(c+=5*base),b2b>0&&(c+=base),pc&&(1==type&&(c=6*base),0==type&&(c=10*base)),a=~~(c+c/8*((70-(this.parent.blob.targetPoint-g))/2))}else if("scorebasedSwap"==this.attackType){let base=1,c=0;line>3&&(c=base*(spin?2*line:line)),3==line&&(c=base*(spin?6:2)),2==line&&(c=base*(spin?4:1)),1==line&&(c=base*(spin?2:0)),combo<=1?c+=.5*base:combo>1&&combo<=3?c+=1*base:combo>3&&combo<=5?c+=2*base:combo>5&&combo<=7?c+=3*base:combo>7&&combo<=10?c+=4*base:combo>10&&(c+=5*base),b2b>0&&(c+=base),pc&&(c=10*base),c*=1+.2*this.parent.swapMode.a,a=~~(c+c/4*((this.parent.blob.decreaseTargetPoint-1)/this.parent.blob.targetPoint))}else if("scorebasedWMW"==this.attackType){let base=1,c=0;line>3&&(c=base*(spin?2*line:line)),3==line&&(c=base*(spin?4:2)),2==line&&(c=base*(spin?3:1)),1==line&&(c=base*(spin?2:0)),c+=combo<=1?.5*base:combo>1&&combo<=6?1*base:base*(1+~~((combo-6)/4)),b2b>0&&(c+=base),pc&&(c=6*base);let g=this.parent.blob.decreaseTargetPoint;a=~~(c+c/8*((70-(this.parent.blob.targetPoint-g))/2))}else"normal"==this.attackType&&(pc&&line>0?a=10:(line>3?a=spin?2*line:line:1==line?a=spin?2:0:2==line?a=spin?4:1:3==line&&(a=spin?6:2),combo>1&&combo<=3?a+=1:combo>3&&combo<=5?a+=2:combo>5&&combo<=7?a+=3:combo>7&&combo<=10?a+=4:combo>10&&(a+=5),b2b>0&&(a+=1)));return Math.floor(a)}executeVoice(line,spin,b2b,combo,pc,counter){let a=0,str="";return this.isAux?"":("scorebased"===this.attackType?(pc&&line>0?a=10:line>3?a=4:1==line?a=spin?2:0:2==line?a=spin?4:1:3==line&&(a=spin?6:2),combo>1&&combo<=6?a+=1:combo>6&&combo<=10?a+=2:combo>10&&combo<=14?a+=3:combo>14&&combo<=18?a+=4:combo>18&&(a+=5),b2b>0&&(a+=1)):(pc&&line>0?a=10:line>3?a=4:1==line?a=spin?2:0:2==line?a=spin?4:1:3==line&&(a=spin?6:2),combo>1&&combo<=3?a+=1:combo>3&&combo<=5?a+=2:combo>5&&combo<=7?a+=3:combo>7&&combo<=10?a+=4:combo>10&&(a+=5),b2b>0&&(a+=1)),line>4?str="gtrisplus":4==line?str="gtris":0===a?str=`init${Math.min(combo+1,5)}`:a>0&&(str=`spell${Math.min(a,5)}`),counter&&(str="counterattack"),str)}executeSpellName(line,spin,b2b,combo,pc,counter){let a=0,str="";return this.isAux||("scorebased"===this.attackType?(pc&&line>0?a=10:line>3?a=4:1==line?a=spin?2:0:2==line?a=spin?4:1:3==line&&(a=spin?6:2),combo>1&&combo<=6?a+=1:combo>6&&combo<=10?a+=2:combo>10&&combo<=14?a+=3:combo>14&&combo<=18?a+=4:combo>18&&(a+=5),b2b>0&&(a+=1)):(pc&&line>0?a=10:line>3?a=4:1==line?a=spin?2:0:2==line?a=spin?4:1:3==line&&(a=spin?6:2),combo>1&&combo<=3?a+=1:combo>3&&combo<=5?a+=2:combo>5&&combo<=7?a+=3:combo>7&&combo<=10?a+=4:combo>10&&(a+=5),b2b>0&&(a+=1)),a>0&&(str=`spell${Math.min(a,5)}`),counter&&(str="counter")),str}}class NeoBlobIndividual{constructor(type,blob,xOffset,yOffset,disOffset,rotOffset){this.type=type,this.blob=blob,this.offset={x:xOffset||0,y:yOffset||0,distance:disOffset||0,rot:rotOffset||0}}}class NeoBlobGhost{constructor(blob,x,y){this.x=x,this.y=y,this.color=blob}}class NeoplexianBlob extends LegacyMode{constructor(parent){super(parent),this.opponentGarbageBehind={},this.isWarningTopOut=!1,this.isSpawnablePiece=!0,this.isFever=!1,this.warningTrig=new NumberChangeFuncExec(0,t=>{this.isWarning=t}),this.isChainUp=!1,this.isDelayEnabled=!0,this.insane=new InsaneMode("blob",this),this.colors=4,this.colorSet=[1,2,3,4,5],this.isSpecialDropset=!1,this.piece={x:0,y:0,rot:0,delay:0,rotAnim:{timeAnim:0,maxTime:5,rot:0,curRot:0,diffRot:0},activeArr:[[]],active:{parameters:{sx:0,sy:0,matrix:[[]],type:0,color1:0,color2:0},type:0,color1:1,color2:1,colorRot:0},dropset:[],dropsetN:0,isBig:!1,isAir:!1,moved:!1,dirty:!1,held:!1,enable:!1,rotated:!1,isHardDrop:!1,kickTable:null,kickDistance:{x:0,y:0}};for(let i=0;i<16;i++)this.piece.dropset.push(0);this.dropForecast={stack:[[]],blobs:[],poppable:[],PERMANENT_MASK:512},this.lastPiece={x:0,y:0,rot:0},this.delay={},this.delayAdd={},this.delayDefault={0:10,1:40,2:4},this.delayParamsLength=8;for(let h=0;h<this.delayParamsLength;h++)this.delay[h]=-30,this.delayAdd[h]=10;this.decreaseTargetPoint=1,this.fixedAtkHandicap=1,this.targetGarbagePlayer={},this.rngPreview=new ParkMillerPRNG,this.preview={bag:BLOBS.c2,queue:[]},this.settings={das:8,arr:4,gravity:2/60,lock:40,sft:35/60},this.handling={das:0,arr:0,xFirst:0},this.lock={move:15,rot:15,delay:30,delayMax:30,lockSoftdrop:2},this.lockPrevent={rotate:0},this.stack=[],this.drawableStack=[],this.poppedStack=[],this.firstGroupsPop=[],this.fieldSize={w:6,h:32,vh:12,hh:20},this.defaultFieldSize={w:6,hh:30,vh:12,h:42},this.activeBlobDisplay={two:{"1|0":new NeoBlobIndividual(0,0,1,1,1,-1),"1|1":new NeoBlobIndividual(0,0,1,1,0,-1)},three:{"1|0":new NeoBlobIndividual(0,0,1,1,1,-1),"1|1":new NeoBlobIndividual(0,0,1,1,0,-1),"2|1":new NeoBlobIndividual(0,0,1,1,1,0)},four:{}},this.rotateAnimationTimer=0,this.rotateAnimationType=0,this.visibleFieldBufferHeight=3,this.visibleFieldHeight=0,this.chain=0,this.actualChain=0,this.previousChain=0,this.forecastedChain=0,this.requiredChain=-2,this.isChainOffsetting=!1,this.eraseInfo=[],this.erasedBlocks=[],this.holes=0,this.delayDrop=-73,this.blobRequire=2,this.delayedGarbage=0,this.divScoreTrash=0,this.targetPoint=.7,this.NUISANCE=6,this.HARD=7,this.garbageOrder={on:!0,order:[0,3,2,5,1,4],n:0},this.dasCancellation=new NumberChangeFuncExec(0,c=>{this.handling.das=0}),this.dstModulus=0,this.pop={x:0,y:0},this.rotate180Timer=0,this.canFallTrash=!0,this.canFallTrashAfterFever=!0,this.activeVoiceLine="",this.repeatSpellVoice=0,this.nextVoice={name:"",duration:-2},this.effects={drop:new ArrayFunctionIterator(aray=>{let frames=0,c=this.parent.canvasCtx[this.isAux?"pieceAux":"piece"];for(let wm=0,lm=aray.length;wm<lm;wm++){let idx=aray[wm];if("delay"in idx||(idx.delay=-38),"landFrames"in idx||(idx.landFrames=0),"landMax"in idx||(idx.landMax=idx.landFrames),"triggerBoardRot"in idx||(idx.triggerBoardRot=!1),idx.delay>0?idx.delay--:idx.frames>=0?idx.frames--:idx.landFrames>=0&&idx.landFrames--,frames+=Math.max(0,idx.frames)+Math.max(0,idx.landFrames),0===idx.frames&&idx.isLandSound)switch(idx.isLandSound){case 1:this.parent.playSound("blub_drop");break;case 2:this.parent.playSound("blub_garbage1");break;case 3:this.parent.playSound("blub_garbage2")}0==idx.frames&&idx.triggerBoardRot&&this.triggerBoardRotates.garbageLanding.on&&this.parent.executeRotateWobble(this.triggerBoardRotates.garbageLanding.intensity,40,this.isAux)}for(let wm=0,lm=aray.length;wm<lm;wm++){let idx=aray[wm],landing=idx.delay<=0&&idx.frames<0&&idx.landFrames>=0,kf=Math.max(0,idx.frames),sizeBez=1,py=idx.y0+Math.min(idx.y1,(idx.maxf-kf)/idx.maxf*(idx.y1-idx.y0));if(2==idx.fallType){if(py=Math.min(bezier((idx.maxf-idx.frames)/idx.maxf,idx.y0,idx.y1,0,0,0,1),idx.y1),landing&&idx.frames<0){let mm=0;idx.landFrames%5>3&&(mm=.5),py=idx.y1+mm,sizeBez=1-mm}}else if(1==idx.fallType){if(py=idx.y0+Math.min(idx.y1,(idx.maxf-kf)/idx.maxf*(idx.y1-idx.y0)),landing&&idx.frames<0){let mm=0;idx.landFrames%5>3&&(mm=.5),py=idx.y1+mm,sizeBez=1-mm}}else py=idx.y0+Math.min(idx.y1,(idx.maxf-kf)/idx.maxf*(idx.y1-idx.y0)),landing&&idx.frames<0&&(py=Math.max(idx.y1+bezier(idx.landFrames/idx.landMax,0,.5,0,0,0,1),idx.y1),sizeBez=1-Math.min(bezier(idx.landFrames/idx.landMax,0,.5,0,0,0,1),.5));let sx=this.parent.fieldSize.w/this.fieldSize.w,sy=this.parent.fieldSize.vh/this.fieldSize.vh,x=~~(idx.x*this.parent.cellSize*sx),y=(py-this.fieldSize.hh)*this.parent.cellSize*sy;if(this.parent.isVisible&&frames>0){c.drawImage(manager.skinBlob.canvas,(6==idx.cell&&0==this.parent.garbageType?1:0)*this.parent.cellSize,(idx.cell-1)*this.parent.cellSize,this.parent.cellSize,this.parent.cellSize,x,y+this.parent.cellSize*this.parent.visibleFieldBufferHeight,this.parent.cellSize*sx,this.parent.cellSize*sy*sizeBez);let ta=this.parent.canvasses[this.isAux?"pieceAux":"piece"];c.clearRect(0,0,ta.width,this.parent.cellSize*this.parent.visibleFieldBufferHeight)}}frames<=0&&aray.length>0&&(aray.length=0,this.drawStack(this.stack))}),next:{a:new ObjectFunctionIterator(object=>{let frame=this.effects.next.frame,max=this.effects.next.max;for(let j in object){let ref=object[j],x1=ref.px1+ref.sx1,y1=ref.py1+ref.sy1,ox=x1+frame/max*(ref.px2+ref.sx2-x1),oy=y1+frame/max*(ref.py2+ref.sy2-y1),ms=1.5;ref.color1,ref.color2;4==ref.type?this.drawRect("blobNext",ox/2,oy/2,0,ref.color1,2*ms,2*ms,!1):this.drawArray("blobNext",ref.blob,ox,oy,void 0,0,ms,ms,!1,!1)}}),frame:0,max:6}};for(let hb=0;hb<3;hb++)this.effects.next.a.addItem(hb,{blob:[[0]],type:0,color1:0,color2:0,px1:0,px2:0,py1:[-1.5,.5,2.5][hb],py2:[.5,2.5,3.5][hb],sx1:0,sy1:0,sx2:0,sy2:0});this.blobColors={r:[255,255,0,0,255,255,0,127],g:[255,0,255,0,255,0,0,0],b:[255,0,0,255,0,255,255,255]},this.triggerBoardRotates={garbageLanding:{on:!1,intensity:2},a:{intensity:0}},this.allClearText={a:new NumberChangeFuncExec(null,l=>{let a=this.allClearText;a.frame=a.max,a.current=l;let o=a.presets[l];a.bez=o[4],a.on=o[0],a.start[0]=o[1][0],a.start[1]=o[1][1],a.end[0]=o[2][0],a.end[1]=o[2][1],a.max=o[3],a.frame=o[3]}),on:!1,current:0,start:[20,1],end:[0,1],frame:0,max:30,bez:{y1:0,y2:.9,y3:1,y4:1,s1:0,s2:.9,s3:1,s4:1},presets:ALL_CLEAR_ANIMATION_PRESETS},this.isAllClear=!1,this.isAllClearTemp=-9}runAllClearAnim(aux){let isBool=this.allClearText.on;if(this.allClearText.frame>0&&(this.allClearText.frame--,isBool=!0),isBool){let cs=this.parent.cellSize,ga=this.allClearText,s=9,ar=512/440,centerY=cs*s/2,centerX=cs*(ar*s/2),bezY=1,bezS=1;ga.frame>0&&(ga.frame--,bezY=bezier((ga.max-ga.frame)/ga.max,0,1,ga.bez.y1,ga.bez.y2,ga.bez.y3,ga.bez.y4),bezS=bezier((ga.max-ga.frame)/ga.max,0,1,ga.bez.s1,ga.bez.s2,ga.bez.s3,ga.bez.s4));let py=6+this.parent.fieldSize.vh*(ga.start[0]+bezY*(ga.end[0]-ga.start[0]));this.parent.canvasCtx[aux].drawImage(game.misc.zenkeshi,0,0,512,440,cs*(this.parent.fieldSize.w/2)-centerX,cs*py-centerY,cs*ar*s,cs*s)}}playAllClearAnim(toggle){this.allClearText.a.assign(toggle)}dropsetReset(array){this.piece.dropset.length=0;for(let i=0;i<16;i++)array?.[i]?this.piece.dropset.push(array[i]):this.piece.dropset.push(0);this.piece.dropsetN=0}setBlob(type,color1,color2){let c=color1,d=color2,ma=[[[[0,0,0],[c,d,0],[0,0,0]],[[0,0,0],[0,d,0],[0,c,0]],[[0,0,0],[0,d,c],[0,0,0]],[[0,c,0],[0,d,0],[0,0,0]]],[[[0,0,0],[c,d,0],[0,d,0]],[[0,0,0],[0,d,d],[0,c,0]],[[0,d,0],[0,d,c],[0,0,0]],[[0,c,0],[d,d,0],[0,0,0]]],[[[0,0,0],[d,d,0],[0,c,0]],[[0,0,0],[0,d,c],[0,d,0]],[[0,c,0],[0,d,d],[0,0,0]],[[0,d,0],[c,d,0],[0,0,0]]],[[[0,0,0],[c,c,0],[d,d,0]],[[0,0,0],[c,d,0],[c,d,0]],[[0,0,0],[d,d,0],[c,c,0]],[[0,0,0],[d,c,0],[d,c,0]]],[[[0,0,0],[d,d,0],[d,d,0]],[[0,0,0],[d,d,0],[d,d,0]],[[0,0,0],[d,d,0],[d,d,0]],[[0,0,0],[d,d,0],[d,d,0]]]][type],t=0;(this.isFever||this.insane.isOn)&&(t=2),1==type&&2==type&&(t=1);let centerX=0,centerY=0;return type<3&&(centerX=1,centerY=1),{index:"",matrix:ma,color1:c,color2:d,rot:c,type:type,sx:3,sy:0,blobCenterX:centerX,blobCenterY:centerY,kickTable:{2:{right:[[[0,0],[0,-1],[-1,0],[0,-1],[-1,-1],[-1,0]],[[0,0],[0,-1],[0,-1],[1,0],[0,-1]],[[0,0],[0,-1],[1,0],[0,-1],[1,-1],[1,0]],[[0,0],[0,-1],[0,-1],[-1,0],[0,-1]]],left:[[[0,0],[0,-1],[1,0],[0,-1],[1,-1],[1,0]],[[0,0],[0,-1],[0,-1],[-1,0],[0,-1]],[[0,0],[0,-1],[-1,0],[0,-1],[-1,-1],[-1,0]],[[0,0],[0,-1],[0,-1],[1,0],[0,-1]]],double:[[[0,0],[0,-1]],[[0,0],[0,1]],[[0,0],[0,-2]],[[0,0],[0,2]]]},0:{right:[[[0,0],[-1,0],[0,-1],[-1,-1],[-1,0]],[[0,0],[0,-1],[0,-1],[1,0],[0,-1]],[[0,0],[1,0],[0,-1],[1,-1],[1,0]],[[0,0],[0,-1],[0,-1],[-1,0],[0,-1]]],left:[[[0,0],[1,0],[0,-1],[1,-1],[1,0]],[[0,0],[0,-1],[0,-1],[-1,0],[0,-1]],[[0,0],[-1,0],[0,-1],[-1,-1],[-1,0]],[[0,0],[0,-1],[0,-1],[1,0],[0,-1]]],double:[[[0,0],[0,-1]],[[0,0],[0,1]],[[0,0],[0,-2]],[[0,0],[0,2]]]},1:{right:[[[0,0],[-1,0],[0,-1],[-1,-1],[1,-1]],[[0,0],[0,-1],[0,-1],[1,0],[-1,-1]],[[0,0],[1,0],[0,-1],[1,-1],[-1,-1]],[[0,0],[0,-1],[0,-1],[-1,0],[1,-1]]],left:[[[0,0],[1,0],[0,-1],[1,-1],[-1,-1]],[[0,0],[0,-1],[0,-1],[-1,0],[1,-1]],[[0,0],[-1,0],[0,-1],[-1,-1],[1,-1]],[[0,0],[0,-1],[0,-1],[1,0],[-1,-1]]],double:[[[0,0],[0,-1]],[[0,0],[0,1]],[[0,0],[0,-2]],[[0,0],[0,2]]]}}[t]}}replaceField(gridArr,isFlipped,isInsane){let cy=this.fieldSize.hh-gridArr[0].length-1,lm=gridArr[0].length;this.simulateSplashOut(),this.stack=grid(this.fieldSize.w,this.fieldSize.h,0);let blobs=[],highest=0,highestCol=0;this.drawStack(this.stack);for(let mx=0,x=isFlipped?gridArr.length-1:0;isFlipped?x>=0:x<gridArr.length;x+=isFlipped?-1:1,mx++){let de=0,emptyY=0,occupyY=0,ry=0;for(let y=gridArr[x].length-1;y>0;y--)if(this.stack[mx][y+cy]=gridArr[x][y],occupyY=ry,gridArr[x][y]){this.fieldSize.h;highestCol=mx,blobs.push({x:mx,y0:y+cy,y1:this.fieldSize.h-lm+y+emptyY,h:this.fieldSize.h-lm+y+emptyY-(y+cy),del:de,cell:gridArr[x][y]}),de+=3}else emptyY++,ry=emptyY}let speed=isInsane?2.1:1.4;for(let blob of blobs){let timeFall=Math.floor(Math.max(0,blob.h*speed));speed*blob.h+blob.del>highest&&(highest=speed*blob.h+blob.del),this.effects.drop.addItem({x:blob.x,y0:blob.y0,y1:blob.y1,cell:blob.cell,delay:blob.del,frames:timeFall,maxf:timeFall,isLandSound:blob.x==highestCol?1:0,fallType:0,landFrames:15})}this.setDelay(0,20+Math.floor(Math.max(0,highest))),this.checkInstantDrop(),this.blobCount=this.checkBlobCount(this.stack)}simulateSplashOut(){let asset=this.parent.assetRect(this.isAux?"AUX-FIELD-CHARACTER-CANVAS":"FIELD-CHARACTER-CANVAS"),ax=(this.isAux,asset.width,asset.height,asset.x),ay=asset.y,bez={x1:0,x2:0,x3:1,x4:1,y1:0,y2:.3,y3:1+.3*Math.random(),y4:1};for(let x=0;x<this.fieldSize.w;x++)for(let y=this.fieldSize.hh-2;y<this.fieldSize.h;y++)if(this.stack[x][y]>0){let mx=ax+this.getQPosX(x)*this.parent.fieldCellSize+this.getQPosX(1)*this.parent.fieldCellSize/2,my=ay+this.getQPosY(y-this.fieldSize.hh)*this.parent.fieldCellSize+this.getQPosY(1)*this.parent.fieldCellSize/2,particleSpeed=71+30*Math.random();bez.y3=1+.3*Math.random();6==this.stack[x][y]&&this.parent.garbageType;this.parent.addParticle(!0,"blobblock",0,this.stack[x][y]-1,mx,my,mx+this.getQPosX(30*Math.random()-30*Math.random())*this.parent.fieldCellSize,my+this.getQPosY(4*Math.random()+4)*this.parent.fieldCellSize+game.resolution.h,particleSpeed,this.getQPosX(1)*this.parent.fieldCellSize/game.cellSize,!1,bez,!1)}}testGridSpace(x,y){return x<0||x>=this.fieldSize.w||(!(y<this.fieldSize.h)||void 0!==this.stack[x][y]&&0!==this.stack[x][y])}reset(){this.activeVoiceLine="",this.nextVoice.duration=-1,this.repeatSpellVoice=0,this.nextVoice.name="",this.opponentGarbageBehind={},this.piece.x=0,this.voiceDelay=0,this.piece.y=-295,this.piece.isBig=!1,this.garbageOrder.n=0,this.playAllClearAnim(3),this.isAllClear=!1,this.isAllClearTemp=-9,this.pop={x:0,y:0},this.piece.rot=0,this.piece.active.color1=0,this.piece.active.color2=0,this.piece.active.colorRot=0,this.piece.activeArr=[[]],this.piece.isAir=!1,this.piece.moved=!0,this.piece.dirty=!1,this.piece.held=!1,this.piece.rotated=!1,this.piece.enable=!1,this.piece.dropsetN=0,this.firstGroupsPop.length=0,this.isChainUp=!1,this.piece.isHardDrop=!1,this.isSpawnablePiece=!0,this.targetGarbagePlayer={},this.effects.drop.reset(),this.delayDrop=-3,this.dstModulus=0,this.rotate180Timer=0,this.canFallTrash=!0,this.canFallTrashAfterFever=!0,this.chain=0,this.actualChain=0,this.previousChain=0,this.forecastedChain=0,this.eraseInfo=[],this.erasedBlocks=[],this.holes=0,this.delayDrop=-73,this.delayedGarbage=0,this.divScoreTrash=0,this.divScoreAttackingTrash=0,this.delay={},this.delayAdd={};for(let h=0;h<this.delayParamsLength;h++)this.delay[h]=-100,this.delayAdd[h]=this.isProfessional?0:this.delayDefault[h];this.lock={move:15,rot:15,delay:30,lockSoftdrop:2},this.lockPrevent.rotate=0,this.piece.rotAnim.rot=0,this.piece.rotAnim.timeAnim=0,this.piece.rotAnim.curRot=0,this.piece.rotAnim.diffRot=0,this.defaultFieldSize.w=6,this.defaultFieldSize.hh=3,this.defaultFieldSize.vh=12,this.fieldSize.w=6,this.fieldSize.hh=30,this.fieldSize.vh=12,this.blobRequire=4,this.fieldSize.h=this.fieldSize.vh+this.fieldSize.hh,this.stack=grid(this.fieldSize.w,this.fieldSize.h,0),this.drawableStack=grid(3*this.fieldSize.w,3*this.fieldSize.h,0),this.poppedStack=grid(3*this.fieldSize.w,3*this.fieldSize.h,0),this.dropForecast.stack=grid(3*this.fieldSize.w,3*this.fieldSize.vh,0),this.drawStack(this.stack),this.drawActivePiece(),this.previewReset(),this.handling={das:0,arr:0,xFirst:0},this.blobCount=0,this.warningTrig.assign(0)}drawRect(ctx,x,y,row,column,sx,sy,isBuffer,isEraseTop){x=~~(x*this.parent.cellSize*sx),y=y*this.parent.cellSize*sy;let c=this.parent.canvasCtx[ctx],cs=this.parent.cellSize;if(this.parent.isVisible&&c.drawImage(manager.skinBlob.canvas,~~(row*cs),~~(column*cs),cs,~~cs,x,y+(isBuffer?this.visibleFieldBufferHeight*cs*(this.parent.fieldSize.vh/this.defaultFieldSize.vh):0),~~(cs*sx),~~(cs*sy)),isEraseTop){let a=this.parent.canvasses[ctx];this.parent.canvasCtx[ctx].clearRect(0,0,a.width,this.parent.cellSize*this.parent.visibleFieldBufferHeight)}}drawArray(ctx,arr,cx,cy,color,rr,sx,sy,isEraseTop,isBuffer){for(var x=0,len=arr.length;x<len;x++)for(var y=0,wid=arr[x].length;y<wid;y++)if(arr[x][y])if(arr[x][y]%256>=6){let c=arr[x][y];c%=256;let row=rr||0;this.drawRect(ctx,x+cx,~~y+cy,void 0!==rr?rr:row+(6==c&&0==this.parent.garbageType?1:0),void 0!==color?color-1:c-1,sx||1,sy||1,isBuffer)}else{let c=arr[x][y],row=0;c&FLAG_CONNECTIONS.up&&(row+=1),c&FLAG_CONNECTIONS.down&&(row+=2),c&FLAG_CONNECTIONS.right&&(row+=4),c&FLAG_CONNECTIONS.left&&(row+=8),c%=256,this.drawRect(ctx,x+cx,~~y+cy,void 0!==rr?rr:row,void 0!==color?color-1:c-1,sx||1,sy||1,isBuffer)}if(isEraseTop){let a=this.parent.canvasses[ctx];this.parent.canvasCtx[ctx].clearRect(0,0,a.width,this.parent.cellSize*this.parent.visibleFieldBufferHeight)}}getQPosX(x){return(this.isAux?.47:1)*x*(this.parent.fieldSize.w/this.fieldSize.w)}getQPosY(y){return(this.isAux?.47:1)*y*(this.parent.fieldSize.vh/this.fieldSize.vh)}emitAttack(marr){let neutralized=!1,playerNeutGarb={},particleSpeed=this.insane.isOn&&1!==this.insane.insaneType?18:this.parent.particleGarbageDelay;this.divScoreAttackingTrash+=marr;let attack=Math.floor(this.divScoreAttackingTrash/this.targetPoint),modulus=marr%this.targetPoint;this.divScoreAttackingTrash%=this.targetPoint;let remain=0,count=attack,neutralCount=0,hasAddFev=0,garbLength=this.parent.calculateGarbage()+this.parent.calculateGarbageBehind();(this.parent.feverStat.isOn&&this.isFever||this.insane.isOn||this.isChainOffsetting)&&garbLength>0&&0==count&&(count+=1),attack*=this.requiredChain>this.chain||game.isSolo?0:1,count*=this.requiredChain>this.chain||game.isSolo?0:1;let gCount=0;if(0===this.parent.activeType){let mc=this.garbageConversion(count,garbLength),min=Math.min(mc.converted,garbLength);count-=Math.max(0,mc.cost),gCount+=min}else gCount=Math.max(count,0);for(;this.parent.garbage.length>0&&"none"!==this.parent.garbageBlocking&&gCount>0;){let reference=this.parent.garbage[0];if(reference.count<=0){this.parent.garbage.shift();continue}neutralized=!0;let min=Math.min(reference.count,gCount);reference.count-=min,neutralCount+=min,reference.count<=0&&this.parent.garbage.shift(),gCount-=min,1==this.parent.activeType&&(count-=min),playerNeutGarb[reference.player]=min}for(;this.parent.garbageBehind.length>0&&"none"!==this.parent.garbageBlocking&&gCount>0;){let reference=this.parent.garbageBehind[0];if(reference.count<=0){this.parent.garbageBehind.shift();continue}neutralized=!0;let min=Math.min(reference.count,gCount);reference.count-=min,neutralCount+=min,reference.count<=0&&this.parent.garbageBehind.shift(),1==this.parent.activeType&&(count-=min),gCount-=min,playerNeutGarb[reference.player]=min}remain+=count+0,this.parent.isGarbageCollectionMode&&(this.parent.woi.add(remain),remain=0,modulus=0),neutralized&&garbLength>0&&!(garbLength<=count)&&(modulus=0);let total=this.targetPoint*remain;if((garbLength>0||neutralized)&&neutralCount<garbLength&&(total=0),this.parent.garbageLength=this.parent.calculateGarbage(),this.parent.garbageBehindLength=this.parent.calculateGarbageBehind(),neutralized){this.parent.rpgAttr.hpDamage=this.parent.calculateHPDamage();for(let h in playerNeutGarb)if(h in game.players){let player=game.players[h];player.feverStat.isOn&&player.blob.isFever&&!player.blob.insane.isOn&&!player.block.insane.isOn&&player.feverStat.addTime(1)}this.parent.feverStat.isOn&&this.isFever&&(this.insane.isOn||this.parent.feverStat.add()&&(hasAddFev=1),!this.insane.isOn&&this.parent.feverStat.gaugeValue>=this.parent.feverStat.maxGauge&&(this.insane.delay.ready=10)),(this.parent.feverStat.isOn&&this.isFever||this.insane.isOn||this.isChainOffsetting)&&(this.canFallTrash=!1,this.canFallTrashAfterFever=!1)}game.forEachPlayer(player=>{if(this.parent.player===player.player||this.parent.team===player.team)return;if(!(player.player in this.targetGarbagePlayer))return void(this.targetGarbagePlayer[player.player]={score:total,trash:~~(total/player.blob.targetPoint)});let qm=this.targetGarbagePlayer[player.player];qm.score+=total,qm.trash=~~(qm.score/player.blob.targetPoint)});let bez={x1:0,x2:1,x3:1,x4:1,y1:0,y2:1,y3:1,y4:1},asset=this.parent.assetRect(this.isAux?"AUX-FIELD-CHARACTER-CANVAS":"FIELD-CHARACTER-CANVAS"),sizemult=this.isAux?.47:1,ax=(asset.width,asset.height,asset.x),ay=asset.y,selfTarget=this.parent.assetRect("GARBAGE-TRAY-DIV"),gw=selfTarget.width,gh=selfTarget.height,gx=selfTarget.x,gy=selfTarget.y,cs=this.parent.fieldCellSize,qw=((this.erasedBlocks[0]||{x:this.piece.x}).x,(this.erasedBlocks[0]||{y:this.piece.y}).y,sizemult*(this.parent.fieldSize.w/this.fieldSize.w)),qh=sizemult*(this.parent.fieldSize.vh/this.fieldSize.vh),um=(this.erasedBlocks[0]||{cell:0}).cell,yu=[0,2,5,7,4,8],z=this.sendGarbage(),isAttack=Object.keys(z).length>0,y=Math.max(1,this.chain-(this.insane.isOn||this.isFever?2:0)),isCounter=attack>garbLength&&garbLength>0,isChain=this.chain<this.forecastedChain,isTargetCount=Object.keys(z).length>0,hitInt=this.parent.fieldCellSize*(.1*Math.min(this.chain,7));if(isTargetCount&&game.forEachPlayer(m=>{if(m.player in z){let target=m.assetRect("GARBAGE-TRAY-DIV"),tw=target.width,th=target.height,tx=target.x,ty=target.y;if(m.blob.insane.isOn||m.check1v1Overhead(!0,m.garbageLength+m.garbageBehindLength,m.garbageLength+m.garbageBehindLength,!1),m.isVisible&&m.addDelayHandler(!0,particleSpeed*(neutralized?2:1),()=>{m.garbageLastForTray.assign(m.garbageLength),m.garbageBehindLastForTray.assign(m.garbageBehindLength),m.playSound(`hit${Math.min(5,y)}`),animatedLayers.create(void 0,30,tx+tw/2,ty+th/2,0,0,0,200,200,12,12,.75,"blob_hit",10,this.cellSize),m.isDying||m.isFinishAble||m.isDead||m.engageShakeIntensityHit(hitInt)}),neutralized)m.addDelayHandler(!0,particleSpeed,()=>{m.isVisible&&m.addParticle(!0,"attack",0,yu[um],gx+gw/2,gy+gh/2,tx+tw/2,ty+th/2,particleSpeed,2.5,!1,bez,!0,{frame:particleSpeed*(.3+.2*Math.min(9,this.chain)),r:this.blobColors.r[um],g:this.blobColors.g[um],b:this.blobColors.b[um]})});else if(m.isVisible)for(let j of this.firstGroupsPop)m.addParticle(!0,"attack",0,yu[j.cell],ax+j.x*cs*qw,ay+(j.y-this.fieldSize.hh)*cs*qh,tx+tw/2,ty+th/2,particleSpeed,2.5,!1,bez,!0,{frame:particleSpeed*(.3+.2*Math.min(9,this.chain)),r:this.blobColors.r[j.cell],g:this.blobColors.g[j.cell],b:this.blobColors.b[j.cell]})}}),this.parent.addDelayHandler(!0,particleSpeed*(isCounter?2:1),()=>{game.forEachPlayer(player=>{isTargetCount&&player.isDying&&player.isFinishAble?player.player in z&&(isChain?(player.playSound("blub_garbage2"),player.executeRotateWobble(15,65)):player.phaseLose(!0)):!isChain&&player.isDying&&player.isFinishAble&&player.phaseLose(!1)})}),neutralized&&garbLength>0||this.parent.isGarbageCollectionMode){for(let j of this.firstGroupsPop)this.parent.addParticle(!0,"attack",0,yu[j.cell],ax+j.x*cs*qw,ay+(j.y-this.fieldSize.hh)*cs*qh,gx+gw/2,gy+gh/2,particleSpeed,1.5,!1,bez,!0,{frame:particleSpeed*(.3+.2*Math.min(9,this.chain)),r:this.blobColors.r[j.cell],g:this.blobColors.g[j.cell],b:this.blobColors.b[j.cell]});this.parent.addDelayHandler(!1,particleSpeed,()=>{this.parent.garbageLastForTray.assign(this.parent.garbageLength),this.parent.garbageBehindLastForTray.assign(this.parent.garbageBehindLength),this.parent.playSound(`hit${Math.min(5,y)}`)}),this.parent.addDelayHandler(!0,particleSpeed,()=>{if(this.parent.feverStat.isOn&&this.isFever&&hasAddFev){let fev=this.parent.feverStat,feverTarget=this.parent.assetRect("FEVER-GAUGE"),mx=feverTarget.x,my=feverTarget.y,mw=feverTarget.width,mh=feverTarget.height,fevOrb=fev.orbs[fev.gaugeValue-1],fx=fevOrb.x*mw,fy=fevOrb.y*mh-fevOrb.cs*cs/2;fev.reversed&&(fx=(1-fevOrb.x)*mw,fy=fevOrb.y*mh-fevOrb.cs*cs/2),this.parent.addParticle(!0,"attack",0,0,gx+gw/2,gy+gh/2,mx+fx,my+fy,particleSpeed,1.5,!1,bez,!0,{frame:.2*particleSpeed,r:255,g:255,b:255}),this.parent.addDelayHandler(!0,particleSpeed,()=>{fev.refresh(),this.parent.playSound("garbage")})}animatedLayers.create(void 0,30,gx+gw/2,gy+gh/2,0,0,0,200,200,12,12,.75,"blob_hit",10,this.cellSize)}),this.insane.isOn||this.isAux||this.parent.isGarbageCollectionMode||this.parent.check1v1Overhead(!1,garbLength,this.parent.garbageLength+this.parent.garbageBehindLength,isAttack)}}garbageConversion(count,limit){let h=0,g=0,l=4,q=1,last=0,isLimit=void 0!==limit;for(;h<count&&(h++,h>=l&&(l+=~~(4.5*q),q++,g++),!(isLimit&&limit<=g));)last=h;return{converted:g,cost:h,shortage:h-count,surplus:Math.max(count-last,0)}}sendGarbage(){this.parent.playerTarget=[];let playerTrashSent={};manager.forEachPlayer(player=>{player.player!==this.parent.player&&player.team!==this.parent.team&&this.parent.playerTarget.push(player.player)});let attackHp=this.parent.rpgAttr.attributes.attack+this.parent.rpgAttr.statusEffectsAttributes.attack+this.parent.rpgAttr.attributes.atkTolerance*this.parent.seeds.field.next();manager.forEachPlayer(player=>{if(-1!==this.parent.playerTarget.indexOf(player.player)){let qm=this.targetGarbagePlayer[player.player];if(!player.rpgAttr.isOn||player.rpgAttr.canReceiveGarbage>0){if(1===player.activeType&&(player.player in this.opponentGarbageBehind&&player.isGarbageBehindActive?player.addGarbageBehind(this.parent.player,[qm.trash],!0,!1,0,attackHp):player.addGarbage(this.parent.player,[qm.trash],!0,!1,0,attackHp),qm.trash>0&&(playerTrashSent[player.player]=qm.trash,qm.score%=player.blob.targetPoint)),0===player.activeType){let h=0,g=0,l=4,q=1;for(;h<qm.trash;)h++,h>=l&&(l+=~~(2.75*q),q++,g++);g>0&&(playerTrashSent[player.player]=g,player.player in this.opponentGarbageBehind&&player.isGarbageBehindActive?player.addGarbageBehind(this.parent.player,[g],!0,!0,0,1.8*attackHp):player.addGarbage(this.parent.player,[g],!0,!0,0,1.8*attackHp),qm.score%=player.blob.targetPoint,qm.trash=0)}}else qm.score%=player.blob.targetPoint,qm.trash=0}});for(let h of this.parent.playerTarget);return playerTrashSent}updateDelay(){if(!this.isDelayEnabled)return;let delayPrioritize=0;for(let l=this.delayParamsLength-1;l>=0;l--)if(this.delay[l]>=0){delayPrioritize=l;break}if(0===delayPrioritize?this.insane.updateDelays()?this.parent.isDelayStoppable=!1:this.delay[delayPrioritize]--:(this.delay[delayPrioritize]--,this.parent.isDelayStoppable=!1),this.dropDelay>=0&&(this.dropDelay--,0===this.dropDelay&&(this.checkDropBlock(),this.setDelay(1,24))),1==this.delay[3]&&this.parent.checkWaitDeterminism(),0==this.delay[3]){let activeSpellline="";this.voiceDelay=5,this.parent.playSound(`chain${Math.min(7,this.chain)}`),this.parent.playSound("shoosh_chain");let asset=this.parent.assetRect(this.isAux?"AUX-FIELD-CHARACTER-CANVAS":"FIELD-CHARACTER-CANVAS"),sizemult=(this.isAux?.47:1)*this.getQPosX(1),ax=(asset.width,asset.height,asset.x),ay=asset.y,px=ax+this.parent.fieldCellSize*this.getQPosX(this.eraseInfo[0].x),py=ay+this.parent.fieldCellSize*this.getQPosY(this.eraseInfo[0].y-this.fieldSize.hh),delayed=this.delayedGarbage,lem=this.parent.garbageLength+this.parent.garbageBehindLength;if(this.chain>0){this.emitAttack(delayed,this.dstModulus);let blobCenterX=sizemult*this.parent.fieldCellSize/2,blobCenterY=sizemult*this.parent.fieldCellSize/2,popSize=4,len=this.eraseInfo.length;for(let i=0;i<len;i++){let p=this.eraseInfo[i],apx=ax+this.parent.fieldCellSize*this.getQPosX(p.x),apy=ay+this.parent.fieldCellSize*this.getQPosY(p.y-this.fieldSize.hh);animatedLayers.create(void 0,25,apx+blobCenterX,apy+blobCenterY,0,0,0,200,200,popSize,popSize,.65+.8*Math.random(),`blob_pop${p.cell}`,10,this.parent.fieldCellSize*sizemult,!1,!1,!0)}}this.chain>1&&htmlEffects.add(this.chain+`<gtp style="font-size: ${2.3*this.parent.fieldFontSize}px">-${1==this.insane.insaneType?"combo":"chain"}</gtp>`,px,py,50,{name:"chain-text-anim",iter:1,timefunc:"cubic-bezier(0,0,1,0)",initdel:0},`font-size: ${~~(3.733*this.parent.fieldFontSize)}px; text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black; --__chaintext_size: 1.4em; color: #${["fff","ff0","f00","70f"][Math.min(4,~~(this.chain/5))]}`);let isCounter=~~(delayed/this.targetPoint-lem)>0&&lem>0;if(this.parent.character.isCounting)7==this.chain||8==this.chain||this.chain>9?this.repeatSpellVoice++:this.repeatSpellVoice=0,this.forecastedChain>this.chain||this.chain<3?this.activeVoiceLine=`count${this.chain}`:(3==this.chain&&(this.activeVoiceLine="spell1"),4==this.chain&&(this.activeVoiceLine="spell2"),5==this.chain&&(this.activeVoiceLine="spell3"),this.chain>=6&&this.chain<9&&(this.activeVoiceLine="spell4"),this.chain>=9&&(this.activeVoiceLine="spell5"));else if(this.insane.isOn||this.isFever){try{let o="init1";this.forecastedChain>20?(o=CHAIN_SEQUENCE[19][(this.chain-1)%20],this.chain>20&&(o=o=CHAIN_SEQUENCE[19][this.chain%20]),this.chain==this.forecastedChain&&(o="spell5")):o=CHAIN_SEQUENCE[this.forecastedChain-1][this.chain-1],"init5"===o?this.repeatSpellVoice++:o.includes("spell")||(this.repeatSpellVoice=0),this.activeVoiceLine=o,o.includes("spell")&&(activeSpellline=o)}catch(e){this.activeVoiceLine="damage2"}if(this.chain>0&&0!==this.insane.insaneType&&this.parent.character.isHenshinCounting){let spell="";spell=this.chain>MainPlayerFragment.DEFAULT_HENSHIN_SPELL_SEQUENCE.length?"t_large":MainPlayerFragment.DEFAULT_HENSHIN_SPELL_SEQUENCE[this.chain-1],this.activeVoiceLine=spell}if(this.chain>1&&2===this.insane.insaneType){let h=0;7==this.chain&&(h=1),12==this.chain&&(h=2),18==this.chain&&(h=3),22==this.chain&&(h=4),this.forecastedChain===this.chain&&(this.chain<=11?h=1:this.chain<=17?h=2:this.chain<=21?h=3:this.chain>=22&&(h=4)),h>0&&this.parent.engagePlaycharExt("insaneTransformSpell",`tfmicspell${h}`)}}else if(this.isFever)this.activeVoiceLine=`init${Math.min(5,this.chain)}`;else{let spell=TSU_CHAIN_SEQUENCE.normal[Math.min(6,this.chain-1)];this.activeVoiceLine=spell,-1!=spell.indexOf("spell")&&(activeSpellline=spell)}isCounter&&this.chain>(this.forecastedChain>3?3:2)&&(this.activeVoiceLine="counterattack",activeSpellline="counter"),this.isAux&&(this.activeVoiceLine="",activeSpellline=""),""!==activeSpellline&&this.parent.rectanim.play(activeSpellline)}if(this.delay[3]>0)if(this.delay[3]%2==0){let aux=this.isAux?"stackAux":"stack",widthQuotient=this.parent.fieldSize.w/this.fieldSize.w,heightQuotient=this.parent.fieldSize.vh/this.fieldSize.vh;this.drawArray(aux,this.poppedStack,0,-1*this.fieldSize.hh,void 0,0,widthQuotient,heightQuotient,!0,!0)}else this.drawStack();if(0==this.delay[2])if(this.insane.isOn||this.isFever){let speed=this.insane.isOn?1:1.2,blobs=[],isExist=!1,highestY=this.fieldSize.h,longest=0,lowestY=this.fieldSize.h;for(let x=0;x<this.fieldSize.w;x++){let firstY=0,emptyY=0,isFirst=!0,isEmpty=!1,delayDrop=0;for(let y=this.fieldSize.h-1;y>=this.fieldSize.hh-2;y--){let bl=this.stack[x][y];isEmpty||0!==bl||(isEmpty=!0),isFirst&&isEmpty&&bl>0&&(isFirst=!1,firstY+=emptyY,emptyY=0,y<lowestY&&(lowestY=y)),isEmpty&&0===bl&&(emptyY++,isFirst=!0),!isFirst&&isEmpty&&bl>0&&(isExist=!0,blobs.push({cell:bl,x:x,y0:y,y1:firstY+y,h:firstY+1,del:delayDrop}),bl>0&&highestY>y&&(highestY=y),longest<delayDrop+firstY*speed&&bl>0&&(longest=delayDrop+firstY*speed),delayDrop+=this.insane.isOn?2:1)}}for(let blob of blobs){let timeFall=Math.floor(Math.max(0,blob.h*speed));this.drawableStack[blob.x][blob.y0]=0,this.effects.drop.addItem({x:blob.x,y0:blob.y0,y1:blob.y1,cell:blob.cell,delay:blob.del,frames:timeFall,maxf:Math.floor(Math.max(0,blob.h*speed)),isLandSound:1,fallType:0,landFrames:15})}this.setDelay(1,7+(isExist?15:0)+Math.floor(Math.max(0,longest))),this.drawStack(),this.checkInstantDrop()}else{let speed=1.25,blobs=[],isExist=!1,highestY=this.fieldSize.h,longest=0,lowestY=this.fieldSize.h;for(let x=0;x<this.fieldSize.w;x++){let firstY=0,emptyY=0,isFirst=!0,isEmpty=!1,delayDrop=0,isLand=!1;for(let y=this.fieldSize.h-1;y>=this.fieldSize.hh-2;y--){let bl=this.stack[x][y];isEmpty||0!==bl||(isEmpty=!0),isFirst&&isEmpty&&bl>0?(isFirst=!1,firstY+=emptyY,emptyY=0,isLand=!0,y<lowestY&&(lowestY=y)):isLand=!1,isEmpty&&0===bl&&(emptyY++,isFirst=!0),!isFirst&&isEmpty&&bl>0&&(bl!==this.NUISANCE&&(isExist=!0),this.NUISANCE,blobs.push({cell:bl,x:x,y0:y,y1:firstY+y,h:firstY+1,del:delayDrop,isLand:isLand,landFrames:bl===this.NUISANCE?0:22}),bl>0&&highestY>y&&(highestY=y),longest<delayDrop+firstY*speed&&bl>0&&(longest=delayDrop+firstY*speed),delayDrop+=(this.insane.isOn,0))}}for(let blob of blobs){let timeFall=Math.floor(Math.max(0,blob.h*speed));this.drawableStack[blob.x][blob.y0]=0,this.effects.drop.addItem({x:blob.x,y0:blob.y0,y1:blob.y1,cell:blob.cell,delay:blob.del,frames:timeFall,maxf:Math.floor(Math.max(0,blob.h*speed)),isLandSound:blob.isLand?1:0,fallType:1,landFrames:blob.landFrames})}this.setDelay(1,2+(isExist?25:0)+Math.floor(Math.max(0,longest))),this.drawStack(),this.checkInstantDrop()}this.delay[2],1==this.delay[1]&&this.parent.checkWaitDeterminism(),0==this.delay[1]&&(this.isEnable&&this.checkChain(this.stack),0==this.erasedBlocks.length&&(this.insane.isOn&&1===this.insane.insaneType||(this.chain=0),manager.forEachPlayer(player=>{player.player!==this.parent.player&&(arrayModifyBatch(player.garbage,dl=>{dl.player===this.parent.player&&(dl.wait=!1,dl.frames=-9999)}),arrayModifyBatch(player.garbageBehind,dl=>{dl.player===this.parent.player&&(dl.wait=!1,dl.frames=-9999)}))}),this.canFallTrash&&this.dropGarbage())),1==this.delay[0]&&this.parent.checkWaitDeterminism(),0==this.delay[0]&&this.previewNextBlob(),0===this.delay[delayPrioritize]&&(this.delay[delayPrioritize]=-1),this.warningTrig.assign(this.blobCount+this.parent.garbageLength>this.fieldSize.w*this.fieldSize.vh*.75&&!this.insane.isOn?1:0),this.isNonLockSafe=this.delay[3]>0||this.delay[1]>0||this.delay[0]>0}updateContinuousDelay(){if(0===this.voiceDelay){if(this.voiceDelay--,""!==this.parent.activeVoiceline){this.parent.playVoice(this.activeVoiceLine);let ll=this.insane.isOn?this.parent.getVoiceDuration(this.activeVoiceLine):-4;if(this.actualChain>=this.forecastedChain&&(this.nextVoice.duration=ll),this.activeVoiceLine.includes("spell")){for(let j=1;j<=this.repeatSpellVoice;j++)this.parent.addDelayHandler(!0,9*j,()=>{this.parent.playVoice(this.activeVoiceLine),this.actualChain>=this.forecastedChain&&(this.nextVoice.duration=ll)},!0);this.repeatSpellVoice=0}}}else this.voiceDelay>=0&&this.voiceDelay--;this.nextVoice.duration>=0&&(this.nextVoice.duration--,0===this.nextVoice.duration&&this.parent.playVoice(this.nextVoice.name)),this.isAllClearTemp>0&&(this.isAllClearTemp--,0==this.isAllClearTemp&&(this.isAllClearTemp=-9,this.playAllClearAnim(2)))}dropGarbage(){let a=JSON.parse(JSON.stringify(this.parent.garbage.filter(m=>m.frames<manager.frames&&m.count>0&&!m.wait))),len=a.length,count=0;if(0==len)return;let m=[],blobs=[],b=0,q=0,height=0,mpl={},spawnStartY=this.fieldSize.hh-3,deepest=spawnStartY,depth=0;if(this.garbageOrder.on&&6==this.fieldSize.w){this.garbageOrder.n;for(let hm=0;hm<6;hm++)m.push(this.garbageOrder.order[(this.garbageOrder.n+hm)%6])}else{for(let h=0;h<this.fieldSize.w;h++)m.push(h);m.sort(()=>.5-this.parent.seeds.field.next())}let j=[];if(len>0)for(let s=0,qw=this.parent.garbage;s<qw.length;s++)j.push(qw[s].id);let fallRows={};for(let kx=0;kx<this.fieldSize.w;kx++)for(let i=this.fieldSize.h-1;i>=0;i--)if(fallRows[kx]=i,!this.testGridSpace(kx,i)){deepest<i&&(deepest=i);break}for(;len>0;){let r=a[0],rx=m[b],startY=fallRows[rx],index=j.indexOf(r.id);if(this.parent.rpgAttr.isOn&&game.forEachPlayer(player=>{r.player===player.player&&(player.player in mpl?mpl[player.player]+=r.hpdmg:mpl[player.player]=r.hpdmg)}),this.stack[rx][startY-height]=this.NUISANCE,b++,blobs.push({cell:this.NUISANCE,x:rx,y:startY-height,h:height,ih:0==height}),b>=this.fieldSize.w&&(height++,b=0,count++),r.count--,this.parent.garbage[index].count--,this.parent.garbage[index].count<=0&&(this.parent.garbage.splice(index,1),j.splice(index,1),a.shift(),len--),q++,this.canFallTrash=!1,count>4)break}if(q>0){q>5&&q<18&&this.parent.playVoice("damage1"),q>17&&(this.parent.playVoice("damage2"),this.parent.rectanim.play("damage2")),this.blobCount=this.checkBlobCount(this.stack),this.parent.rpgAttr.emulateDamage(mpl);let isLose=!1;this.parent.rpgAttr.isOn&&this.parent.rpgAttr.checkZeroHP()&&(isLose=!0),isLose&&this.checkLose(),this.parent.conclude1v1Overhead(2),this.parent.rpgAttr.hpDamage=this.parent.calculateHPDamage(),this.parent.garbageLastForTray.assign(this.parent.garbageLength),depth=deepest-spawnStartY;let speed=this.isFever?this.insane.isOn?1:2.5:3;q>13&&(this.triggerBoardRotates.garbageLanding.on=!0);for(let blob of blobs){let timeFall=Math.floor(Math.max(0,fallRows[blob.x]-spawnStartY)*speed);fallRows[blob.x]>=1&&this.effects.drop.addItem({x:blob.x,y0:spawnStartY-blob.h,y1:blob.y,cell:blob.cell,frames:timeFall,maxf:timeFall,delay:15,isLandSound:blob.ih?q>5?3:2:0,triggerBoardRot:q>13,fallType:0,landFrames:15})}depth>0&&this.setDelay(1,15+(this.isFever?5:7)+Math.floor(Math.max(depth*speed,0))),this.drawStack(),this.parent.garbageLength=this.parent.calculateGarbage(),this.parent.garbageLastForTray.assign(this.parent.garbageLength),this.garbageOrder.on&&6==this.fieldSize.w&&(this.garbageOrder.n+=q,this.garbageOrder.n%=6)}this.checkHoles()}#checkConn(s,xd,yd){let sta=JSON.parse(JSON.stringify(s));return((stack,x,y)=>{if(x>=this.fieldSize.w||y>=this.fieldSize.h||y<0||x<0)return;let origin=stack[x][y];for(let d=0;d<FLAG_DIRECTIONS.length;d++){let dir=FLAG_DIRECTIONS[d],dx=dir[0],dy=dir[1];if(y+dy<0||x+dx<0||x+dx>=this.fieldSize.w||y+dy>=this.fieldSize.h)continue;let ev=stack[x+dx][y+dy];y+dy<this.fieldSize.hh||y<this.fieldSize.hh||ev!==origin||origin!==this.NUISANCE||(1==dx&&(stack[x][y]|=FLAG_CONNECTIONS.right),-1==dx&&(stack[x][y]|=FLAG_CONNECTIONS.left),1==dy&&(stack[x][y]|=FLAG_CONNECTIONS.down),-1==dy&&(stack[x][y]|=FLAG_CONNECTIONS.up))}})(sta,xd,yd),sta}drawStack(newStack){let aux=this.isAux?"stackAux":"stack",widthQuotient=this.parent.fieldSize.w/this.fieldSize.w,heightQuotient=this.parent.fieldSize.vh/this.fieldSize.vh;if(void 0!==newStack)if("reset"===newStack)for(let x=0,len=newStack.length;x<len;x++)for(let y=0,top=newStack[x].length;y<top;y++)this.drawableStack[x][y]=0;else{for(let x=0,len=newStack.length;x<len;x++)for(let y=this.fieldSize.hh-2,top=newStack[x].length;y<top;y++)this.drawableStack[x][y]=newStack[x][y];for(let x=0,len=this.fieldSize.w;x<len;x++)for(let y=this.fieldSize.hh-2,top=this.fieldSize.h;y<top;y++)if(y>this.fieldSize.hh-1&&this.drawableStack[x][y]!==this.NUISANCE)for(let d=0;d<FLAG_DIRECTIONS.length;d++){let dir=FLAG_DIRECTIONS[d],dx=dir[0],dy=dir[1];if(y+dy<0||x+dx<0||x+dx>=this.fieldSize.w||y+dy>=this.fieldSize.h)continue;let ev=this.drawableStack[x+dx][y+dy]%256,origin=this.drawableStack[x][y]%256;y+dy<this.fieldSize.hh||y<this.fieldSize.hh||ev!==origin||ev===this.NUISANCE||(1==dx&&(this.drawableStack[x][y]|=FLAG_CONNECTIONS.right),-1==dx&&(this.drawableStack[x][y]|=FLAG_CONNECTIONS.left),1==dy&&(this.drawableStack[x][y]|=FLAG_CONNECTIONS.down),-1==dy&&(this.drawableStack[x][y]|=FLAG_CONNECTIONS.up))}}this.parent.canvasClear(aux),this.drawArray(aux,this.drawableStack,0,-1*this.fieldSize.hh,void 0,void 0,widthQuotient,heightQuotient,!0,!0)}drawActive(){let aux=this.isAux?"pieceAux":"piece",aux2=this.isAux?"backAux":"back";this.parent.canvasClear(aux),this.parent.canvasClear(aux2),this.runAllClearAnim(aux2),this.makeGhostPiece(),this.drawActivePiece(),this.effects.drop.update()}drawActivePiece(){if(!this.isEnable)return;let aux=this.isAux?"pieceAux":"piece",widthQuotient=this.parent.fieldSize.w/this.fieldSize.w,heightQuotient=this.parent.fieldSize.vh/this.fieldSize.vh,vertical=this.piece.y-this.fieldSize.hh;if(!this.isFever&&!this.insane.isOn){let hh=step(this.piece.y%1,3,0);vertical=Math.floor(this.piece.y-this.fieldSize.hh),vertical+=hh}if(this.piece.rotAnim.rot=this.piece.rotAnim.curRot-this.piece.rotAnim.diffRot*(this.piece.rotAnim.timeAnim/this.piece.rotAnim.maxTime),this.piece.isBig)this.drawRect(aux,(1+this.piece.x)/2,vertical/2,0,this.colorSet[this.piece.rot]-1,2*widthQuotient,2*heightQuotient,!0,!0);else{let maxDir=4;if(0===this.piece.active.type)for(let i=0;i<2;i++){let reference=this.activeBlobDisplay.two[`1|${i}`],angleNumber=((this.piece.rotAnim.rot+reference.offset.rot)%maxDir+maxDir)%maxDir,ax=reference.offset.distance*Math.cos(radians(90*angleNumber)),ay=reference.offset.distance*Math.sin(radians(90*angleNumber));this.drawArray(aux,[[1]],this.piece.x+ax+reference.offset.x,vertical+ay+reference.offset.y,reference.blob,void 0,widthQuotient,heightQuotient,!0,!0)}else if(this.piece.active.type<3){for(let li=1;li<3;li++)for(let i=0;i<2;i++)if(`${li}|${i}`in this.activeBlobDisplay.three){let reference=this.activeBlobDisplay.three[`${li}|${i}`],angleNumber=((this.piece.rotAnim.rot+reference.offset.rot)%maxDir+maxDir)%maxDir,ax=reference.offset.distance*Math.cos(radians(90*angleNumber)),ay=reference.offset.distance*Math.sin(radians(90*angleNumber));this.drawArray(aux,[[1]],this.piece.x+ax+reference.offset.x,vertical+ay+reference.offset.y,reference.blob,void 0,widthQuotient,heightQuotient,!0,!0)}}else this.drawArray(aux,this.piece.activeArr,this.piece.x,vertical,void 0,void 0,widthQuotient,heightQuotient,!0,!0)}this.piece.rotAnim.timeAnim>0&&this.piece.rotAnim.timeAnim--}makeGhostPiece(){if(this.piece.y<-10)return;let aux=this.isAux?"pieceAux":"piece",widthQuotient=this.parent.fieldSize.w/this.fieldSize.w,heightQuotient=this.parent.fieldSize.vh/this.fieldSize.vh;for(let gx=0,win=this.piece.activeArr.length;gx<win;gx++)for(let raiseY=0,gy=this.piece.activeArr[gx].length-1;gy>=0;gy--){let lc=this.piece.isBig?this.colorSet[this.piece.rot]:this.piece.activeArr[gx][gy],lx=this.piece.x+gx,ly=~~this.piece.y+gy+this.checkDropSpecific(40,this.piece.x+gx,~~this.piece.y+gy)-raiseY-this.fieldSize.hh;this.piece.activeArr[gx][gy]&&(this.drawArray(aux,[[1]],lx,ly,7,lc-1,widthQuotient,heightQuotient,!0,!0),raiseY++)}let lem=this.dropForecast.poppable.length;for(let u=0;u<lem;u++){let g=this.dropForecast.poppable[u];this.parent.canvasCtx[aux].drawImage(game.misc.blob_target,this.parent.cellSize*widthQuotient*g[0],this.parent.cellSize*heightQuotient*g[1]+this.visibleFieldBufferHeight*this.parent.cellSize*(this.parent.fieldSize.vh/this.defaultFieldSize.vh),this.parent.cellSize*widthQuotient,this.parent.cellSize*heightQuotient)}}updateGhostPiece(){let int=0,blobLen=0;for(let j=0;j<this.dropForecast.blobs.length;j++){let ref=this.dropForecast.blobs[j];ref[2]>0&&this.dropForecast.stack[ref[0]][ref[1]]<this.dropForecast.PERMANENT_MASK&&this.dropForecast.stack[ref[0]][ref[1]]>0&&(this.dropForecast.stack[ref[0]][ref[1]]=0)}let blobs=[];this.dropForecast.blobs.length=0;for(let gx=0,win=this.piece.activeArr.length;gx<win;gx++)for(let raiseY=0,gy=this.piece.activeArr[gx].length-1;gy>=0;gy--){let lc=this.piece.isBig?this.colorSet[this.piece.rot]:this.piece.activeArr[gx][gy],lx=this.piece.x+gx,ly=~~(Math.floor(this.piece.y)+gy+this.checkDropSpecific(40,this.piece.x+gx,~~this.piece.y+gy)-raiseY-this.fieldSize.hh);this.piece.activeArr[gx][gy]&&(blobLen++,raiseY++,lx<this.fieldSize.w&&lx>=0&&blobs.push([lx,ly,lc]))}for(let j=0;j<blobs.length;j++){let ref=blobs[j];if(ref[2]>0){let len=this.dropForecast.blobs.length,hx=j<blobLen?ref[0]:0,hy=j<blobLen?ref[1]:0,hc=j<blobLen?ref[2]:0;j>=len?this.dropForecast.blobs.push([hx,hy,hc]):(this.dropForecast.blobs[int][0]=hx,this.dropForecast.blobs[int][1]=hy,this.dropForecast.blobs[int][2]=hc),int++}}this.checkForecastedConns()}checkForecastedConns(){for(let j=0;j<this.dropForecast.blobs.length;j++){let ref=this.dropForecast.blobs[j];ref[2]>0&&(this.dropForecast.stack[ref[0]][ref[1]]=ref[2])}let detected={};this.dropForecast.poppable.length=0;for(let j=0;j<this.dropForecast.blobs.length;j++){let ref=this.dropForecast.blobs[j];if(ref[2]>0&&!(`${ref[0]}|${ref[1]}`in detected)){let o={};blobChainDetector.bfs(o,this.dropForecast.stack,ref[0],ref[1],this.fieldSize.w,0,this.fieldSize.vh,this.dropForecast.PERMANENT_MASK);let count=Object.keys(o).length;for(let h in o){let m=o[h];detected[h]=1,count>=this.blobRequire&&this.stack[m.x][m.y+this.fieldSize.hh]>0&&this.dropForecast.poppable.push([m.x,m.y,m.color])}}}}checkValid(arr,cx,cy,ox,oy,isCeil){let px=cx+((void 0!==ox?ox:0)+this.piece.x),py=~~(cy+((void 0!==oy?oy:0)+this.piece.y));isCeil&&(py=Math.ceil(cy+((void 0!==oy?oy:0)+this.piece.y)));for(let x=0;x<arr.length;x++)for(let y=0;y<arr[x].length;y++)if(arr[x][y]&&this.testGridSpace(x+px,y+py))return!1;return!0}checkDrop(dis){let a=0;for(;this.checkValid(this.piece.activeArr,0,a)&&dis>=a;)a++;return a-1}checkDropSpecific(dis,x,y){let a=0;for(;!this.testGridSpace(x,y+a)&&dis>=a;)a++;return a-1}checkLose(){let isLose=!1;this.piece.enabled=!1,this.parent.rpgAttr.isOn?this.parent.rpgAttr.checkZeroHP()?isLose=!0:(this.insane.isOn&&this.parent.rpgAttr.isWOIHPMode?(this.preview.queue.unshift({type:this.piece.active.type,color1:this.piece.active.color1,color2:this.piece.active.color2}),this.insane.delay.del=5,this.insane.chainScore=-1,this.insane.requireChain-=2,this.insane.status="fail",this.piece.enable=!1,this.piece.y=-99,this.nextVoice.name="insane_fail",this.nextVoice.duration=20,this.setDelay(0,-9)):(this.parent.rpgAttr.addHP(-this.parent.rpgAttr.maxHP/5,!0),this.simulateSplashOut(),this.parent.rpgAttr.addStatusEffect(this.parent.player,"immune2garbage",50,{}),this.parent.garbage.length=0,this.parent.garbageBehind.length=0,this.parent.garbageLength=0,this.parent.garbageBehindLength=0,this.parent.garbageLastForTray.assign(0),this.parent.garbageBehindLastForTray.assign(0),this.parent.rpgAttr.hpDamage=0),this.parent.rpgAttr.checkZeroHP()&&(isLose=!0)):isLose=!0,isLose?(this.parent.checkLose(),this.isSpawnablePiece=!1):(this.resetGrid(),this.delay[0]=10)}resetGrid(){for(let x=0;x<this.fieldSize.w;x++)for(let y=0;y<this.fieldSize.h;y++)this.stack[x][y]&&(this.stack[x][y]=0);this.drawStack(this.stack);let aux=this.isAux?"pieceAux":"piece";this.parent.canvasClear(aux)}checkRespawnOrDie(){}spawnPiece(type,color1,color2,matrix,sx,sy,kickTable){if(this.isSpawnablePiece&&this.isActive&&this.canSpawnPiece(type,color1,color2,matrix,sx,sy,kickTable)){if(this.rotate180Timer=-1,this.canFallTrash=!0,this.canFallTrashAfterFever=!0,4===type)this.piece.rot=color1,this.piece.isBig=!0;else if(this.piece.isBig=!1,this.piece.rot=0,this.piece.rotAnim.rot=0,this.piece.rotAnim.curRot=0,this.piece.rotAnim.timeAnim=0,type<3)for(let px=0;px<3;px++)for(let py=0;py<3;py++)matrix[0][px][py]&&(0==type?`${px}|${py}`in this.activeBlobDisplay.two&&(this.activeBlobDisplay.two[`${px}|${py}`].blob=matrix[0][px][py]):type<3&&`${px}|${py}`in this.activeBlobDisplay.three&&(this.activeBlobDisplay.three[`${px}|${py}`].blob=matrix[0][px][py]));this.piece.dirty=!0,this.piece.delay=7,this.piece.y+=.04;for(let x=0;x<this.fieldSize.w;x++)for(let y=0;y<this.fieldSize.vh;y++)this.dropForecast.stack[x][y]=this.stack[x][y+this.fieldSize.hh]+this.dropForecast.PERMANENT_MASK;if(this.checkManipulatedPiece(),this.piece.active.parameters.type=type,this.piece.active.parameters.color1=color1,this.piece.active.parameters.color2=color2,this.piece.active.parameters.matrix=matrix,this.piece.active.parameters.sx=sx,this.piece.active.parameters.sy=sy,this.parent.ai.active&&!game.replay.isOn){this.piece.hold,Math.min(this.fieldSize.w-5,~~((this.fieldSize.w-10)/2)),this.fieldSize.hh;this.parent.aiBlob.evaluate(this.stack,this.preview.queue,this.fieldSize.w,this.fieldSize.h,this.fieldSize.hh,this.fieldSize.vh)}}}canSpawnPiece(type,color1,color2,matrix,sx,sy,kickTable){this.piece.template=matrix;this.piece.template;return this.piece.active.color1=color1,this.piece.rot=0,this.piece.activeArr=matrix[0],this.piece.x=sx+Math.min(this.fieldSize.w-5,~~((this.fieldSize.w-10)/2)),this.piece.y=this.fieldSize.hh-2,this.piece.active.color2=color2,this.piece.active.type=type,this.lock.delay=30,this.lock.rot=15,this.lock.move=15,this.piece.kickTable=kickTable,this.piece.rotated=!1,this.piece.isAir=!1,this.piece.moved=!1,this.piece.dirty=!0,this.piece.enable=!0,!0}checkBlockedSpawnPoint(){return!!this.testGridSpace(4+Math.min(this.fieldSize.w-5,~~((this.fieldSize.w-10)/2)),this.fieldSize.hh)||!(!(1!==this.insane.insaneType&&this.insane.isOn||this.isFever)||!this.testGridSpace(5+Math.min(this.fieldSize.w-5,~~((this.fieldSize.w-10)/2)),this.fieldSize.hh))}previewReset(seed){void 0!==seed&&(this.rngPreview.seed=seed),this.piece.dropsetN=0,this.previewInitialize()}previewNextBlob(){if(this.isSpawnablePiece&&this.isActive)if(this.checkBlockedSpawnPoint())this.checkLose();else{let r=this.previewNextBag(),a=this.setBlob(r.type,r.color1,r.color2);this.spawnPiece(r.type,a.color1,a.color2,a.matrix,a.sx,a.sy,a.kickTable),this.previewDraw()}}previewRefresh(seed){this.rngPreview.seed=seed,this.previ}previewGenerateBag(){let color1=this.colorSet[~~(this.rngPreview.next()*this.colors)],color2=this.colorSet[~~(this.rngPreview.next()*this.colors)],dropset=this.piece.dropset[this.piece.dropsetN%16];this.isSpecialDropset||(dropset=0);let seed=this.rngPreview.seed;for(4===dropset&&(color1=~~(this.rngPreview.next()*this.colors));color1==color2&&3==dropset;)color2=this.colorSet[~~(this.rngPreview.next()*this.colors)];0!==dropset&&(this.rngPreview.seed=seed);let pieceList={type:dropset,color1:color1,color2:color2,rot:color1};return this.piece.dropsetN++,pieceList}previewInitialize(){for(this.piece.dropsetN=0;;){this.preview.queue=[];for(let g=0;g<10;g++)this.preview.queue.push(this.previewGenerateBag());break}this.previewDraw()}previewNextBag(){let next=this.isActive?this.preview.queue.shift():this.preview.queue[0];for(;this.preview.queue.length<10;)this.preview.queue.push(this.previewGenerateBag());return next}previewDraw(){if(this.isAux||!this.isEnable)return;this.parent.canvasClear("blobNext");let m=this.preview.queue[0];if(!this.preview.queue?.[0])return;let active=this.piece.active.parameters,piece=this.setBlob(m.type,m.color1,m.color2),m2=this.preview.queue[1],piece2=this.setBlob(m2.type,m2.color1,m2.color2),mx1=this.parent.player%2==1?1:0,mx2=this.parent.player%2==0?1:0;this.parent.isCompact&&(mx1=0,mx2=1);let x=[active.sx+mx1-(4==active.type?1:2)-1.5-(0!==active.type?.5:0),piece.sx+mx1-(4==piece.type?1:2)-1.5-(0!==piece.type?.5:0),piece2.sx+mx2-(4==piece2.type?1:2)-1.5-(0!==piece2.type?.5:0),piece2.sx+mx2-(4==piece2.type?1:2)-1.5-(0!==piece2.type?.5:0)],y=[-2,piece.sy,piece2.sy,piece2.sy+2],nexts=[active,piece,piece2];for(let h=0;h<3;h++){let queue=this.effects.next.a.getItem(h),next=h+1;queue.blob=nexts[h].matrix[0];let msx=x[next],msy=y[next];if(next<3){let queue2=this.effects.next.a.getItem(next);msx=queue2.sx1,msy=queue2.sy1}queue.sx1=x[h],queue.sx2=msx,queue.sy1=y[h],queue.sy2=msy,queue.type=nexts[h].type,queue.color1=nexts[h].color1,queue.color2=nexts[h].color2}this.effects.next.frame=this.effects.next.max}previewDrawUpdate(){this.parent.canvasClear("blobNext"),this.effects.next.frame>0&&this.effects.next.frame--,this.effects.next.a.update()}checkManipulatedPiece(){if(!this.piece.enable)return!1;if(this.checkValid(this.piece.activeArr,0,1)?this.piece.isAir||(this.piece.isAir=!0):this.piece.isAir&&(this.piece.isAir=!1,this.piece.isHardDrop),this.piece.isAir)this.lock.delay=this.settings.lock,this.piece.moved=!0,this.lock.lockSoftdrop=4;else if(this.lockPrevent.rotate<=0&&(this.lock.delay<=0||this.lock.move<=0||this.lock.rot<=0||this.lock.lockSoftdrop<=0)){this.piece.held=!1;let hasDelay=this.setDelay(0,void 0);this.piece.dirty=!0,this.piece.isHardDrop||this.parent.playSound("blub_drop"),this.piece.y=Math.floor(this.piece.y),this.piece.isHardDrop=!1,this.addPieceStack(this.piece.activeArr);for(let h=0;h<this.delayParamsLength;h++)this.delay[h]>0&&(hasDelay=!0);hasDelay&&(this.piece.y=-90,this.piece.enable=!1)}}updatePiece(){if(!this.piece.enable||!this.canControl)return;let gravity=this.settings.gravity;this.piece.isAir&&(this.piece.delay<=0&&(gravity<1?this.piece.y+=gravity:1==gravity?this.piece.y+=this.checkDrop(1):gravity>1&&(this.piece.y+=this.checkDrop(gravity))),this.lock.delay=this.settings.lock,this.checkManipulatedPiece()),this.piece.delay>0&&this.piece.delay--,this.piece.isAir||(this.piece.y=~~this.piece.y,this.lock.delay--,this.checkManipulatedPiece()),this.lockPrevent.rotate>=0&&this.lockPrevent.rotate--,(this.lastPiece.x!==this.piece.x||this.lastPiece.rot!==this.piece.rot||this.piece.dirty)&&(this.lastPiece.x=this.piece.x,this.lastPiece.rot=this.piece.rot,this.piece.dirty=!1,this.updateGhostPiece()),this.rotate180Timer--}setDelay(type,value){let delayAdd=void 0!==value?value:this.delayAdd[type];return delayAdd<=0&&(delayAdd=-10),this.delay[type]=delayAdd,this.delay[type]>0}rotatePiece(_direction){if(!this.canControl||!this.piece.enable)return;let direction=_direction;this.rotate180Timer>0&&(direction=2);let temp=this.piece.template,maxDir=4;if(this.piece.isBig){maxDir=this.colors;this.piece.rot;let nPos=((this.piece.rot+direction)%maxDir+maxDir)%maxDir;return void(this.piece.rot=nPos)}let pos=(this.piece.rot%maxDir+maxDir)%maxDir,nPos=((this.piece.rot+direction)%maxDir+maxDir)%maxDir,rotate=temp[nPos];var dirType="right";let dirInt=0;switch(direction){case 1:dirType="right",dirInt=1;break;case-1:dirType="left",dirInt=-1;break;case 2:dirType="double",dirInt=2}let isRotate=!1;for(let i=0,len=this.piece.kickTable[dirType][nPos].length;i<len;i++)if(this.checkValid(rotate,this.piece.kickTable[dirType][pos][i][0],this.piece.kickTable[dirType][pos][i][1],0,0,2!==direction)){this.parent.playSound("blub_rotate");let kickX=this.piece.kickTable[dirType][pos][i][0],kickY=this.piece.kickTable[dirType][pos][i][1];this.piece.x+=kickX,this.piece.y+=kickY,this.piece.rot=nPos,this.piece.activeArr=rotate,this.lock.delay=this.settings.lock,this.lock.lockSoftdrop=4,this.lockPrevent.rotate=9,this.piece.rotAnim.curRot+=dirInt,this.piece.rotAnim.diffRot=this.piece.rotAnim.curRot-this.piece.rotAnim.rot,this.piece.rotAnim.timeAnim=this.piece.rotAnim.maxTime,this.checkValid(this.piece.activeArr,0,1)||this.lock.rot--,this.piece.moved=!1,this.piece.rotated=!0,this.checkManipulatedPiece(),isRotate=!0,this.rotate180Timer=-4;break}isRotate||(this.rotate180Timer=20)}moveX(shift){this.piece.enable&&this.canControl&&this.checkValid(this.piece.activeArr,shift,0,0,0,!0)&&(this.piece.x+=shift,this.checkValid(this.piece.activeArr,0,1,0,0,!0)||this.lock.move--,this.lock.delay=this.settings.lock,this.piece.moved=!0,this.piece.rotated=!1,this.parent.playSound("blub_move"),this.checkManipulatedPiece())}shiftDelay(){this.parent.flagPresses.right&&0===this.handling.xFirst&&(this.handling.xFirst=1),this.parent.flagPresses.left&&0===this.handling.xFirst&&(this.handling.xFirst=-1),0!==this.handling.xFirst&&(this.parent.flagPresses.right&&!this.parent.flagPresses.left?this.handling.xFirst=1:this.parent.flagPresses.left&&!this.parent.flagPresses.right&&(this.handling.xFirst=-1)),this.parent.flagPresses.right||this.parent.flagPresses.left||0===this.handling.xFirst||(this.handling.xFirst=0);{let x=0;this.parent.flagPresses.right&&(x|=2),this.parent.flagPresses.left&&(x|=1),this.dasCancellation.assign(x)}if((this.parent.flagPresses.left||this.parent.flagPresses.right)&&(this.handling.das++,this.handling.das>=this.settings.das)){this.handling.arr++;for(let i=0;i<this.fieldSize.w;i++){let dir=0;if(1===this.handling.xFirst&&(dir=this.parent.flagPresses.left?-1:1),-1===this.handling.xFirst&&(dir=this.parent.flagPresses.right?1:-1),0!==dir&&this.moveX(dir),0!==this.settings.arr)break}}}hardDrop(){if(this.piece.enable&&this.canControl){let distance=this.checkDrop(this.fieldSize.h);this.piece.y+=distance,distance>0&&(this.piece.moved=!0,this.piece.rotated=!1),this.lock.delay=-1,this.lockPrevent.rotate=-1,this.piece.isHardDrop=!0,this.parent.playSound("blub_drop"),this.checkManipulatedPiece()}}softDrop(){if(this.piece.enable&&this.piece.delay<=0&&this.canControl&&this.piece.isAir){let gravity=this.settings.sft,initial=Math.floor(this.piece.y);gravity<1?this.piece.y+=gravity:1==gravity?this.piece.y+=this.checkDrop(1):gravity>1&&(this.piece.y+=this.checkDrop(gravity));let final=Math.floor(this.piece.y);initial!==final&&(this.piece.moved=!0,this.divScoreAttackingTrash+=1.25*(final-initial),this.parent.score+=final-initial),this.checkManipulatedPiece()}}addPieceStack(arr){let hasDelay=!1,blobs=[];for(let x=0;x<arr.length;x++){let diffY=0;for(let y=arr[x].length-1;y>=0;y--)if(arr[x][y]){let px=x+this.piece.x,py=~~(y+this.piece.y);this.stack[px][py]=this.piece.isBig?this.colorSet[this.piece.rot]:arr[x][y],blobs.push({cell:this.piece.isBig?this.colorSet[this.piece.rot]:arr[x][y],x:px,y:py,ih:0===diffY?1:0}),diffY++}}hasDelay=this.setDelay(2,-9);let holesObj=this.checkHolesByRow();this.checkForecast();let isPuffOut=!1;if(this.isAux&&this.forecastedChain<=0&&(isPuffOut=!0),isPuffOut){for(let blob of blobs)this.stack[blob.x][blob.y]=0;this.drawStack(this.stack)}else{let delayed=0;for(let blob of blobs){let initialY=blob.y,finalY=blob.y+holesObj.row[blob.x],difference=finalY-initialY,del=this.isFever||this.insane.isOn?7:10,timeFall=Math.ceil(2*holesObj.row[blob.x]*2)+(difference>0?del:0);this.effects.drop.addItem({x:blob.x,y0:initialY,y1:finalY,cell:blob.cell,frames:timeFall,maxf:timeFall+1,isLandSound:blob.ih,fallType:2,landFrames:15}),difference>0&&(delayed=del)}0!==holesObj.most||this.isFever||this.insane.isOn||this.drawStack(this.stack),this.checkInstantDrop(),this.setDelay(1,14),holesObj.most>0&&this.setDelay(1,17+Math.ceil(2*holesObj.most*2)+delayed)}this.isChainUp=this.forecastedChain>0,1==this.insane.insaneType&&this.insane.isOn&&(this.forecastedChain+=this.chain),this.forecastedChain>8&&this.insane.isOn,this.canFallTrash=this.isActive,this.canFallTrashAfterFever=this.isActive}checkHolesByRow(){let checked=!0,out={most:0,row:[]};for(var x=0;x<this.fieldSize.w;x++){out.row[x]=0,checked=!1;for(var y=0;y<this.fieldSize.h;y++)!checked||this.testGridSpace(x,y)?this.testGridSpace(x,y)&&(checked=!0):out.row[x]++;out.row[x]>out.most&&(out.most=out.row[x])}return out}checkInstantDrop(){let isHole=(()=>{this.holes=0;for(var x=0;x<this.fieldSize.w;x++)for(var block=!1,y=0;y<this.fieldSize.h;y++)this.stack[x][y]?block=!0:0==this.stack[x][y]&&block&&this.holes++})();return(()=>{if(this.holes>0){let checked=!0;for(let m=0;m<this.fieldSize.h&&checked;m++){checked=!1;for(var x=0;x<this.fieldSize.w;x++){let isPauseDrop=!1,isLand=!1,isFront=!1;for(var y=this.fieldSize.h;y>=-1;y--)this.testGridSpace(x,y-1)?this.testGridSpace(x,y)||isPauseDrop||(this.stack[x][y]=this.stack[x][y-1],this.stack[x][y-1]=0,this.testGridSpace(x,y+1)&&!isFront&&(isLand=!0),checked=!0,isFront=!0):isPauseDrop=!1}if(!checked)break}}})(),isHole}checkChain(stack){let isAllClear=!0,isExistForChain=!1;this.eraseInfo.length=0,this.erasedBlocks.length=0;let highestBlobGroup=0,groupsFirstBlob=[],blobEval={};const eraseColor={},sequenceBlobInfo=[],sequenceNuisanceInfo=[],erasedGarbage=[],existingBlobList=[],checkBlobOrigin=(x,y)=>{const origin=stack[x][y];if(0===origin||null==origin||origin===this.NUISANCE||y<this.fieldSize.hh)return;sequenceBlobInfo.push({x:x,y:y,cell:stack[x][y]}),stack[x][y]=0;const direction=[[0,1],[1,0],[0,-1],[-1,0]];for(let iteration=0;iteration<direction.length;iteration++){const dX=x+direction[iteration][0],dY=y+direction[iteration][1];if(dX<0||dY<this.fieldSize.hh||dX>=this.fieldSize.w||dY>=this.fieldSize.h)continue;if(dY<this.fieldSize.hh)continue;const dCell=stack[dX][dY];0!==dCell&&null!=dCell&&dCell!==this.NUISANCE&&dCell===origin&&checkBlobOrigin(dX,dY)}},checkNuisanceOrigin=(x,y)=>{stack[x][y];const direction=[[0,1],[1,0],[0,-1],[-1,0]];for(let iteration=0;iteration<direction.length;iteration++){const dX=x+direction[iteration][0],dY=y+direction[iteration][1];if(dX<0||dY<this.fieldSize.hh||dX>=this.fieldSize.w||dY>=this.fieldSize.h)continue;if(dY<this.fieldSize.hh)continue;const dCell=stack[dX][dY];(0!==dCell&&null!=dCell||dCell!==this.HARD)&&(stack[dX][dY]==this.NUISANCE&&sequenceNuisanceInfo.push({x:dX,y:dY,cell:stack[x][y]}))}};for(var x=0;x<this.fieldSize.w;x++)for(var y=0;y<this.fieldSize.h;y++)if(y>=this.fieldSize.hh-1&&stack[x][y]>0){let blobGroup=0;stack[x][y]>0&&(isAllClear=!1),sequenceBlobInfo.length=0,sequenceNuisanceInfo.length=0;const blobCol=stack[x][y];checkBlobOrigin(x,y);let seqLen=sequenceBlobInfo.length;if(blobGroup=seqLen,0==seqLen||seqLen<this.blobRequire)seqLen>0&&existingBlobList.push(...sequenceBlobInfo);else{eraseColor[blobCol]=!0,this.eraseInfo.push(...sequenceBlobInfo);for(let g=0;g<sequenceBlobInfo.length;g++){let wq=sequenceBlobInfo[g];`${wq.x}|${wq.y}`in blobEval||(blobEval[`${wq.x}|${wq.y}`]=wq.cell,0==g&&groupsFirstBlob.push({x:wq.x,y:wq.y,cell:wq.cell}))}}for(const e of existingBlobList)stack[e.x][e.y]=e.cell;if(this.eraseInfo.length>0){this.drawStack(this.stack),blobGroup>highestBlobGroup&&(highestBlobGroup=blobGroup),isExistForChain=!0;for(const isNuisance of this.eraseInfo)checkNuisanceOrigin(isNuisance.x,isNuisance.y);for(const e of sequenceNuisanceInfo)stack[e.x][e.y]=0,erasedGarbage.push({x:e.x,y:e.y,cell:e.cell});this.erasedBlocks.push({x:x,y:y,cell:blobCol});continue}}else stack[x][y]>0&&(stack[x][y]=0);for(let o of this.eraseInfo)this.erasedBlocks.push(o);if(isExistForChain){this.chain+=1,this.actualChain+=1,this.pop.x=this.eraseInfo[0].x,this.pop.y=this.eraseInfo[0].y,this.canFallTrash=this.canFallTrashAfterFever=this.isActive||this.requiredChain>0&&this.chain<this.requiredChain||"linkblob-full"!==this.parent.garbageBlocking&&"full"!==this.parent.garbageBlocking,this.firstGroupsPop.length=0;for(let h of groupsFirstBlob)this.firstGroupsPop.push(h);for(let x=0,len=this.fieldSize.w;x<len;x++)for(let y=0,top=this.fieldSize.h;y<top;y++)0!==this.poppedStack[x][y]&&(this.poppedStack[x][y]=0);for(let o of this.eraseInfo)this.poppedStack[o.x][o.y]=o.cell;for(let o of erasedGarbage)this.poppedStack[o.x][o.y]=o.cell;this.setDelay(3,this.insane.isOn?[17,25,10][this.insane.insaneType]:25),this.setDelay(2,this.insane.isOn?[15,25,10][this.insane.insaneType]:this.isFever?20:25),this.setDelay(1,2),this.setDelay(0,3),this.parent.swapMode.add("chain");let ll=this.isFever?1:0,attackPreset=this.isFever?this.insane.isOn?this.parent.character.blob.feverPower:this.parent.character.blob.chainPower:TSU_CHAIN_POWER,blobsErased=this.eraseInfo.length+0*erasedGarbage.length,colorBonus=COLOR_BONUS[ll][Math.min(Object.keys(eraseColor).length-1,5)],groupBonus=GROUP_BONUS[ll][Math.min(highestBlobGroup-1,10)],chainPower=Math.min(attackPreset[Math.min(this.chain-1,24)],1/0);if(this.insane.isOn&&2===this.insane.insaneType){let h=0,g=0,q=0;for(;h<this.chain;)h++,g+=1,g+=Math.floor(q/3),q++;chainPower=g}if(this.insane.isOn&&1===this.insane.insaneType){let h=0,g=0,q=0;for(;h<this.chain;)h++,g+=1,g+=Math.floor(q/3),q++;chainPower=g}let addScore=10*blobsErased*Math.max(chainPower+groupBonus+colorBonus,1),addGarbage=(this.insane.isOn?[1,1,1][this.insane.insaneType]:1)*addScore*(1+.4*this.parent.swapMode.a);this.parent.addScoreText=`${10*blobsErased} x ${Math.max(chainPower+groupBonus+colorBonus,1)}`,this.parent.score+=addScore,this.divScoreTrash+=addGarbage*this.decreaseTargetPoint*this.fixedAtkHandicap,this.divScoreTrash%=this.targetPoint,this.requiredChain<=this.chain&&(this.delayedGarbage=addGarbage*this.decreaseTargetPoint*this.fixedAtkHandicap,this.dstModulus=this.divScoreTrash),this.divScoreTrash=0,this.nextVoice.duration=-1,this.nextVoice.name="",this.drawStack(this.stack),this.isAllClear&&(this.isAllClear=!1,this.playAllClearAnim(2),this.divScoreAttackingTrash+=2100*this.fixedAtkHandicap*this.decreaseTargetPoint),this.insane.isOn&&(0==this.insane.insaneType&&this.forecastedChain==this.actualChain&&(this.insane.chainScore=this.actualChain,this.insane.requireChain<=this.insane.chainScore&&(this.nextVoice.name="insane_success"),this.insane.requireChain>this.insane.chainScore&&(this.nextVoice.name="insane_fail")),this.parent.insaneBg.moveEye(this.getQPosX(this.pop.x),this.getQPosY(this.pop.y-this.fieldSize.hh),!1),this.parent.insaneBg.changeColor()),1==this.chain&&game.forEachPlayer(player=>{delete this.opponentGarbageBehind[player.player],this.parent.player===player.player||player.isGarbageBehindActive||(this.opponentGarbageBehind[player.player]=1)})}else{this.firstGroupsPop.length=0,this.previousChain=this.chain;let feverAC=!1;if(this.insane.isOn)if(this.insane.time<=0||this.insane.isCommandedEnd){if(this.chain>0&&(0==this.insane.insaneType||2===this.insane.insaneType)){this.insane.chainScore=this.chain+(isAllClear?2:0);let sum=Math.min(this.insane.chainScore+1,15)-3;Math.max(3,this.insane.requireChain-Math.min(2,this.insane.requireChain-this.insane.chainScore-1));this.insane.requireChain<=this.insane.chainScore&&(this.parent.feverStat.presetChain=sum),this.insane.requireChain>this.insane.chainScore&&(this.insane.status="fail")}this.parent.insaneBg.moveEye(this.parent.fieldSize.w/2,this.parent.fieldSize.vh/2,!0),this.insane.delay.turningOff=3}else if(this.actualChain>0){if(this.canFallTrash=!1,this.insane.time>1&&1!==this.insane.insaneType&&(this.insane.time+=60*this.insane.timeAdditions.fixedTimeAdd,this.insane.time+=this.insane.timeAdditions.timeAddMult*Math.max(0,this.actualChain-this.insane.timeAdditions.minChain)*game.FPS),0==this.insane.insaneType||2===this.insane.insaneType){this.insane.delay.del=5,this.insane.chainScore=this.chain+(isAllClear?2:0);let sum=Math.min(this.insane.chainScore+1,15)-3,difference=Math.max(3,this.insane.requireChain-Math.min(2,this.insane.requireChain-this.insane.chainScore-1))-3;this.insane.requireChain<=this.insane.chainScore&&(this.parent.feverStat.presetChain=sum,this.insane.status="success"),this.insane.requireChain>this.insane.chainScore&&(this.insane.status="fail",this.parent.feverStat.presetChain=difference)}"success"==this.insane.status&&(this.nextVoice.name="insane_success"),"fail"==this.insane.status&&(this.nextVoice.name="insane_fail"),this.parent.insaneBg.moveEye(this.parent.fieldSize.w/2,this.parent.fieldSize.vh/2,!0)}if(isAllClear&&this.chain>0){this.insane.isOn?(this.insane.time>1&&this.parent.feverStat.isUseTimer&&(this.insane.time+=this.insane.timeAdditions.allClear*game.FPS,this.insane.time>30*game.FPS&&(this.insane.time=30*game.FPS)),this.isAllClearTemp<0&&(this.isAllClearTemp=40,this.playAllClearAnim(1)),this.insane.isUnlimited&&1==this.insane.insaneType&&(this.chain+=this.actualChain)):(this.isFever?(this.parent.feverStat.addTime(5),this.setDelay(0,20),this.isAllClearTemp<1&&(this.isAllClearTemp=40,this.playAllClearAnim(1)),this.parent.feverStat.maxGauge<=this.parent.feverStat.gaugeValue&&0==this.insane.insaneType?(this.parent.feverStat.presetChain+=2,this.parent.feverStat.presetChain>12&&(this.parent.feverStat.presetChain=12)):this.insane.blobToField(1,!0,!0),feverAC=!0):(this.playAllClearAnim(1),this.isAllClear=!0,this.parent.score+=2100),this.parent.playVoice("zenkeshi")),this.insane.isOn,this.parent.playSound("allclear");this.parent.assetRect("FIELD").x,this.parent.fieldCellSize,this.getQPosX(this.pop.x),this.parent.assetRect("FIELD").y,this.parent.fieldCellSize,this.getQPosY(this.pop.y-this.fieldSize.hh)}feverAC||this.setDelay(0,3),this.actualChain=0,this.isChainUp=!1}}checkForecast(){let width=this.fieldSize.w,height=this.fieldSize.h,hiddenHeight=this.fieldSize.hh,grid=JSON.parse(JSON.stringify(this.stack)),a=blobChainDetector.forecast(grid,width,hiddenHeight,height,this.blobRequire);this.forecastedChain=a.chain,this.blobCount=a.remaining}checkHoles(){this.holes=0;for(var x=0;x<this.fieldSize.w;x++)for(var block=!1,y=0;y<this.fieldSize.h;y++)this.stack[x][y]?block=!0:0==this.stack[x][y]&&block&&(this.holes++,this.dropDelay=2,this.setDelay(1,10),this.setDelay(0,10))}checkDropBlock(){if(this.holes>0){for(var x=0;x<this.fieldSize.w;x++){let isPauseDrop=!1,isLand=!1,isFront=!1;for(var y=this.fieldSize.h;y>=-1;y--)this.testGridSpace(x,y-1)?this.testGridSpace(x,y)||isPauseDrop||(this.stack[x][y]=this.stack[x][y-1],this.stack[x][y-1]=0,this.testGridSpace(x,y+1)&&!isFront&&(isLand=!0),isFront=!0,this.insane.isOn&&(isPauseDrop=!0)):isPauseDrop=!1;isLand&&this.parent.playSound("blub_drop")}this.checkHoles(),this.drawStack(this.stack)}}checkBlobCount(stack){let count=0;if(!this.insane.isOn&&this.isActive&&this.isEnable)for(let x=0;x<this.fieldSize.w;x++)for(let y=this.fieldSize.hh-1;y<this.fieldSize.h;y++)stack[x][y]>0&&count++;return count}}const blobChainDetector=new class{#NUISANCE=6;#DIRECTIONS=[[0,1],[0,-1],[1,0],[-1,0]];constructor(){}fetchConnections(board,width,hiddenHeight,height){let connectionGroups={},detected={},colors={},longestGroup=0;for(let x=0;x<width;x++)for(let y=hiddenHeight;y<height;y++)if(!(`${x}|${y}`in detected)&&board[x][y]>0&&board[x][y]!==this.#NUISANCE){let obj={},length=0;this.bfs(obj,board,x,y,width,hiddenHeight,height),connectionGroups[`${x}|${y}`]={};let cm=connectionGroups[`${x}|${y}`];detected[`${x}|${y}`]=board[x][y];let c=cm;for(let shot in obj){let mx=obj[shot].x,my=obj[shot].y;c[shot]={color:obj[shot].color,x:mx,y:my},obj[shot].color in colors?colors[obj[shot].color]++:colors[obj[shot].color]=1,detected[`${mx}|${my}`]=obj[shot].color,length++}length>longestGroup&&(longestGroup=length)}return{connections:connectionGroups,colors:colors,longest:longestGroup}}removeAdjacentNuisance(board,x,y,width,hiddenHeight,height){let popped=0;for(let i=0;i<4;i++){const dir=this.#DIRECTIONS[i];let dx=x+dir[0],dy=y+dir[1];if(dx>=width||dx<0||dy>=height||dy<hiddenHeight)continue;board[dx][dy]!=this.#NUISANCE||dx>width||dx<0||dy>height||dy<hiddenHeight||(board[dx][dy]=0,popped++)}return popped}forecast(board,width,hiddenHeight,height,requirePop){let chain=0,testBoard=JSON.parse(JSON.stringify(board)),isAllClear=!1,popped=0,remaining=0;for(;;){this.checkHoles(testBoard,width,hiddenHeight,height);let obj=this.fetchConnections(testBoard,width,hiddenHeight,height),isChain=!1;if(0===obj.longest)break;if(obj.longest<(requirePop||4))break;for(let j in obj.connections){if(Object.keys(obj.connections[j]).length>=requirePop){isChain=!0;for(let jh in obj.connections[j]){let popRef=obj.connections[j][jh];popped+=this.removeAdjacentNuisance(testBoard,popRef.x,popRef.y,width,hiddenHeight,height),testBoard[popRef.x][popRef.y]=0,popped++}}}if(!isChain)break;chain++}for(let x=0;x<width;x++)for(let y=hiddenHeight-1;y<height;y++)testBoard[x][y]>0&&remaining++;return 0===remaining&&(isAllClear=!0),{chain:chain,allClear:isAllClear,popped:popped,remaining:remaining}}testSpace(board,x,y,width,height){return x<0||x>=width||(!(y<height)||void 0!==board[x][y]&&0!==board[x][y])}checkHoles(board,width,hiddenHeight,height){let checked=!0;for(let t=0;t<height&&checked;t++)for(var y=height-1;y>=hiddenHeight-2;y--)for(var x=0;x<width;x++)checked=!0,this.testSpace(board,x,y-1,width,height)&&(this.testSpace(board,x,y,width,height)||(board[x][y]=board[x][y-1],board[x][y-1]=0,checked=!1))}bfs(referenceObject,board,x,y,width,hiddenHeight,height,modulo){let a=referenceObject||{},mod=modulo||0;if(!(x>width||y>=height||y<hiddenHeight||`${x}|${y}`in a)){let origin=board[x][y];if(mod&&(origin%=mod),origin>0&&origin!==this.#NUISANCE){a[`${x}|${y}`]={color:origin,x:x,y:y};for(let i=0;i<4;i++){const dir=this.#DIRECTIONS[i];if(x+dir[0]<0||x+dir[0]>=width||y+dir[1]>=height||y+dir[1]<hiddenHeight)continue;let adjacent=board[x+dir[0]][y+dir[1]];mod&&(adjacent%=mod),adjacent===origin&&this.bfs(a,board,x+dir[0],y+dir[1],width,hiddenHeight,height,mod)}}}}};class SwapModeParameters{constructor(parent){this.parent=parent,this.isOn=!1,this.time=-9,this.a=0,this.isOK={chain:0,combo:0}}reset(){this.time=-9,this.a=0,this.isOK.chain=0,this.isOK.combo=0}run(){this.isOn&&this.time>=0&&(this.time--,0==this.time&&(this.a=0))}add(type){this.isOn&&(this.a<=0?this.time>0&&("chain"==type&&(this.isOK.chain=1),"combo"==type&&(this.isOK.combo=1),this.isOK.chain&&this.isOK.combo&&(this.a++,this.parent.playSound(`swapcombo${Math.min(7,this.a)}`),this.time=10*game.FPS)):this.time>0&&(this.a++,this.parent.playSound(`swapcombo${Math.min(7,this.a)}`)))}playSwapAnim(){let ma=this.parent,mainElem=ma.getAsset("FIELD-DYNAMIC"),auxElem=ma.getAsset("AUX-FIELD");mainElem.offsetHeight,auxElem.offsetHeight;ma.fieldSize.vh,ma.visibleFieldBufferHeight;let fieldHeight=ma.fieldSize.vh+ma.visibleFieldHeight,width=ma.fieldSize.w,main=ma.assetRect("FIELD-INSANE"),aux=ma.assetRect("AUX-FIELD-INSANE"),distanceMainX=aux.x-main.x,distanceMainY=aux.y+ma.fieldCellSize*(.47*ma.visibleFieldBufferHeight)-main.y,scaleDifferenceMain=ma.fieldCellSize*width*.47*(ma.fieldCellSize*fieldHeight)/(ma.fieldCellSize*width*(ma.fieldCellSize*fieldHeight)),distanceAuxX=main.x-aux.x,distanceAuxY=main.y-aux.y,scaleDifferenceAux=ma.fieldCellSize*width*(ma.fieldCellSize*fieldHeight)/(ma.fieldCellSize*width*.47*(ma.fieldCellSize*fieldHeight));mainElem.style.setProperty("--transX",`${distanceMainX}px`),mainElem.style.setProperty("--transY",`${distanceMainY}px`),mainElem.style.setProperty("--transSize",`${scaleDifferenceMain}`),mainElem.style.setProperty("--zIndex","1"),auxElem.style.setProperty("--transX",`${distanceAuxX}px`),auxElem.style.setProperty("--transY",`${distanceAuxY}px`),auxElem.style.setProperty("--transSize",`${scaleDifferenceAux}`),auxElem.style.setProperty("--zIndex","2"),ma.playUnfreezableAnimation("swapMain"),ma.playUnfreezableAnimation("swapAux")}}class WarOfInsanityParameters{constructor(parent){this.parent=parent,this.isOn=!1,this.a=0,this.damageSent=0,this.damageSentPerHit=4,this.damageReceived=0,this.damageInflicted=0}reset(){this.damageInflicted=0,this.a=0,this.damageReceived=0,this.damageSentPerHit=1}add(add){this.isOn&&(this.a+=add)}}class WMWWormhole{constructor(parent){this.parent=parent,this.phase=0,this.canvas,this.ctx,this.cellSize=40,this.colors={r:250,g:60,b:48},this.enable=!1,this.wormhole=new FrameRenderer(0,124,(frame,max,that)=>{if(animatedLayers.checkObject(this.parent.getCanvasAnimationPlainName("wormhole"))){let a=animatedLayers.getObject(this.parent.getCanvasAnimationPlainName("wormhole"));0==this.phase&&that.frame>=30&&(this.phase=1),1==this.phase&&that.frame>=90&&(that.frame=30,frame=30),2==this.phase&&that.frame<90&&(that.frame=90,frame=90),2==this.phase&&that.frame>120&&(this.enable=!1,animatedLayers.remove(this.parent.getCanvasAnimationPlainName("wormhole"))),3==this.phase&&that.frame>0&&(this.enable=!1,animatedLayers.remove(this.parent.getCanvasAnimationPlainName("wormhole"))),a.centerPos.x=this.parent.playerCenterPos.x,a.centerPos.y=this.parent.playerCenterPos.y,a.sizeMult=6*this.parent.fieldCellSize,a.frame.elapsed=frame/2,a.frame.int=60-frame/2}})}fetchAsset(name){}reset(){this.enable=!0,this.phase=3}changeColorCustom(r,g,b){this.colors.r=r,this.colors.g=g,this.colors.b=b}engage(type){this.enable=!0,this.phase=type,animatedLayers.remove(this.parent.getCanvasAnimationPlainName("wormhole")),animatedLayers.create(this.parent.getCanvasAnimationPlainName("wormhole"),60,this.parent.playerCenterPos.x,this.parent.playerCenterPos.y,0,0,0,200,200,5,5,1,"wormhole",10,6*this.parent.fieldCellSize,{on:!1},!0,!0),this.wormhole.reset(type)}draw(){if(!this.enable)return;this.parent.fieldSize.w,this.parent.fieldSize.vh;this.wormhole.run()}}const feverGaugeStorage=new class{constructor(){this.image=new Image,this.canvas=new Image,this.ctx,this.Main=class{constructor(x,y,size){this.status=0,this.x=x,this.y=y,this.size=size}}}load(f,l){return new Promise(async res=>{let n=await loadImage(f),m=await loadImage(l);this.canvas=new OffscreenCanvas(2e3,340),this.ctx=this.canvas.getContext("2d"),this.ctx.drawImage(n,0,0),this.ctx.drawImage(m,0,0,700,140,0,200,700,140),res()})}};class FeverGaugeStat{constructor(parent){this.parent=parent,this.isOn=!1,this.initialGauge=0,this.gaugeValue=1,this.refGaugeValue={a:new NumberChangeFuncExec(0,n=>{this.refGaugeValue.m=n}),m:0},this.maxGauge=7,this.addGauge=1,this.time=900,this.presetChain=2,this.canvas,this.ctx,this.div,this.dim={w:0,h:0},this.cellSize=0,this.reversed=!1,this.frame={int:10,dark:10},this.isUseTimer=!1,this.colored={on:!1,frame:0};let orb=[{x:.218,y:.92,cs:1.3},{x:.215,y:.795,cs:1.3},{x:.313,y:.678,cs:1.5},{x:.48,y:.566,cs:1.7},{x:.621,y:.436,cs:1.9},{x:.566,y:.277,cs:2.1},{x:.303,y:.117,cs:3}];this.orbs=orb,this.main=new ObjectFunctionIterator(main=>{let g=Object.keys(main),l=g.length;this.ctx.clearRect(0,0,this.dim.s,this.dim.h);let lt=!0;for(let h=0;h<l;h++){let el=main[g[h]],mm=this.refGaugeValue.m>h?1:0;if(this.colored.on&&(mm=(h+8-~~(this.colored.frame/8))%8+2,lt&&this.colored.frame%8==0&&~~(this.colored.frame/8)%8!=7)){let mt=this.parent.assetRect("FEVER-GAUGE"),tx=mt.x,ty=mt.y,dw=mt.width,dh=mt.height,ml=(this.parent.fieldCellSize,main[g[~~(this.colored.frame/8)%8]]);lt=!1,this.parent.isVisible&&animatedLayers.create(void 0,34,tx+dw*(this.reversed?1-ml.x:ml.x),ty+dh*ml.y-0*this.parent.fieldCellSize,0,0,0,200,200,5,5,1,"fever_shine",10,2)}if(this.ctx.drawImage(feverGaugeStorage.canvas,200*mm,0,200,200,this.dim.w*(this.reversed?1-el.x:el.x)-this.cellSize*el.size/2,this.dim.h*el.y-this.cellSize*el.size/2,this.cellSize*el.size,this.cellSize*el.size),h==this.frame.dark&&!this.colored.on){let cctx=this.ctx;this.frame.int<6?cctx.fillStyle="rgba(0,0,0,0.7)":cctx.fillStyle="rgba(0,0,0,0.5)",cctx.globalCompositeOperation="source-atop",cctx.fillRect(this.dim.w*(this.reversed?1-el.x:el.x)-this.cellSize*el.size/2,this.dim.h*el.y-this.cellSize*el.size/2,this.cellSize*el.size,this.cellSize*el.size),cctx.globalCompositeOperation="source-over"}}});for(let h=0;h<7;h++){let ob=orb[h];this.main.addItem(`a${h}`,new feverGaugeStorage.Main(ob.x,ob.y,ob.cs))}}add(){return this.gaugeValue<this.maxGauge&&(this.gaugeValue+=this.addGauge,this.gaugeValue>this.maxGauge&&(this.gaugeValue=this.maxGauge),!0)}reset(){this.gaugeValue=this.initialGauge,this.time=900,this.playColored(!1),this.refresh(),this.colored.frame=0}resetRound(){this.reset(),this.presetChain=2}resize(w,h,cs,r){this.dim.w=w,this.dim.h=h,this.cellSize=cs,this.reversed=r}fetchAsset(canvas,ctx,div){this.canvas=canvas,this.ctx=ctx,this.div=div}playColored(bool){this.colored.on=bool,this.colored.on}run(){this.isOn}draw(){if(this.isOn){this.parent.canvasClear("feverGauge"),this.main.update(),this.frame.int--,this.frame.int<=0&&(this.frame.int=10,this.frame.dark++,this.frame.dark>7&&(this.frame.dark=-10)),this.colored.on&&(this.colored.frame++,this.colored.frame>=64&&(this.colored.frame=0));{let time=Math.max(0,Math.floor((this.colored.on?this.parent.blob.insane.time:this.time)/game.FPS)),ones=time%10,tens=~~(time/10),mx=.3,my=.4,ms=2.6,warning=time<6&&this.colored.frame%16>8;this.ctx.drawImage(feverGaugeStorage.canvas,70*ones,200+(warning?70:0),70,70,this.dim.w*(this.reversed?1-mx:mx)-this.cellSize*(ms+(this.reversed?-ms:0))/2,this.dim.h*my-this.cellSize*ms/2,this.cellSize*ms,this.cellSize*ms),this.ctx.drawImage(feverGaugeStorage.canvas,70*tens,200+(warning?70:0),70,70,this.dim.w*(this.reversed?1-mx:mx)-this.cellSize*(ms+(this.reversed?0:ms))/2,this.dim.h*my-this.cellSize*ms/2,this.cellSize*ms,this.cellSize*ms)}}}enable(bool){this.isOn=bool,styleelem(this.div,"display",this.isOn?"flex":"none")}refresh(){this.refGaugeValue.a.assign(this.gaugeValue)}addTime(int){{this.time+=int*game.FPS,this.time>30*game.FPS&&(this.time=30*game.FPS);let m=this.parent.assetRect("FEVER-GAUGE"),px=m.x+(this.reversed?.3*m.width:.7*m.width),py=m.y+.3*m.height;return htmlEffects.add(`+${int}s`,px,py,50,{name:"chain-text-anim",iter:1,timefunc:"cubic-bezier(0,0,1,0)",initdel:0},"text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black; --__chaintext_size: 1.2em"),!0}}}class Player extends MainPlayerFragment{constructor(player,n){super(player,n),this.lastCapturedInputFrame=0,this.shouldWaitForOpponent=!1,this.swapMode=new SwapModeParameters(this),this.auxEnabled=!1,this.isCompact=!1,this.isDead=!1,this.isDying=!1,this.halt={names:[],delays:{manipulation:0,delay:0}},this.halt.names=Object.keys(this.halt.delays),this.lastPressStr=null,this.isWarning=!1,this.warningTrig=new NumberChangeFuncExec(0,t=>{this.isWarning=t,this.drawCharacterBg(t)}),this.isFinishAble=!1,this.isLosePlayed=!1,this.isWin=!1,this.hasWon=!1,this.block=new GachatrisBlock(this),this.blob=new NeoplexianBlob(this),this.insaneBg=new InsaneBackground(this),this.woi=new WarOfInsanityParameters(this),this.woiWormhole=new WMWWormhole(this),this.feverStat=new FeverGaugeStat(this),this.isGarbageCollectionMode=!1,this.isInsaneModeOnly=!1,this.canAttack=!0,this.canReceiveGarbage=1,this.garbage=[],this.garbageBehind=[],this.isGarbageBehindActive=!1,this.delayedGarbage=0,this.garbageLength=0,this.garbageBehindLength=0,this.garbageBlocking="full",this.garbageDelay=30,this.garbageType=0,this.stats={line1:0,line2:0,line3:0,line4:0,line5:0,pc:0,tspin0:0,tspin1:0,tspin2:0,tspin3:0,tspinmini0:0,tspinmini1:0,tspinmini2:0,tspinmini3:0,allspin0:0,allspin1:0,allspin2:0,allspin3:0,allspinmini0:0,allspinmini1:0,allspinmini2:0,allspinmini3:0,highestCombo:0},this.dividedBlobScoreGarbage=0,this.blobGarbage=0,this.isGarbageTrayMode=!1,this.garbageTrayObjects=[],this.garbageTrayBehindObjects=[],this.garbageLastForTray=new NumberChangeFuncExec(-1,m=>{let q=m;for(let b=0;b<6;b++){let index=0;q>=1440?(q-=1440,index=7):q>=720?(q-=720,index=6):q>=360?(q-=360,index=5):q>=180?(q-=180,index=4):q>=30?(q-=30,index=3):q>=6?(q-=6,index=2):q>=1&&(q-=1,index=1),this.garbageTrayObjects[b].x=index}this.garbageTrayAnimDelay=20,this.drawGarbageTray()}),this.garbageBehindLastForTray=new NumberChangeFuncExec(-1,m=>{let q=m;for(let b=0;b<6;b++){let index=0;q>=1440?(q-=1440,index=7):q>=720?(q-=720,index=6):q>=360?(q-=360,index=5):q>=180?(q-=180,index=4):q>=30?(q-=30,index=3):q>=6?(q-=6,index=2):q>=1&&(q-=1,index=1),this.garbageTrayBehindObjects[b].x=index}this.garbageTrayBehindAnimDelay=20,this.drawGarbageTrayBehind()});for(let w=0;w<6;w++)this.garbageTrayObjects.push(new GarbageTrayObject);for(let w=0;w<6;w++)this.garbageTrayBehindObjects.push(new GarbageTrayObject);this.garbageTrayAnimDelay=20,this.garbageTrayBehindAnimDelay=20,this.activeType=0,this.fieldAnimations={},this.playerTarget=[],this.emAnimationSetting={on:!1,time:-9,name:""},this.simulPresses={events:{},enabled:!1},this.flagPresses={},this.flagNamesByChar={a:"left",b:"right",d:"harddrop",c:"softdrop",g:"cw",f:"ccw",h:"c180w",e:"hold"},this.flagsLowerToUpper={};for(let q in this.flagNamesByChar)this.flagsLowerToUpper[q.toUpperCase()]=1,this.simulPresses.events[this.flagNamesByChar[q]]=0;this.flagNames=["left","right","softdrop","harddrop","hold","ccw","cw","c180w"];for(let u=0;u<game.flagNames.length;u++){let ref=game.flagNames[u];this.flagPresses[ref]=!1}this.lastFlagPresses={};for(let a in this.flagPresses)this.lastFlagPresses[a]=!1;this.inputFrames=0,this.framePackets=Object.create(null),this.recordedFramePackets=Object.create(null)}updateTeam(){this.canvasClear("team");let g=0;this.actualTeam>-1&&(g=this.actualTeam),this.canvasCtx.team.drawImage(game.misc.team_colors,256*g,0,256,256,0,0,500,500)}checkHalt(man,del){return man&&this.halt.delays.manipulation||del&&this.halt.delays.delay}runAnimations(){for(let h=0,m=this.animFieldNames.length;h<m;h++)this.fieldAnimations[this.animFieldNames[h]].run();for(let h=0,m=this.playcharExt.animname.length;h<m;h++)this.playcharExt.anim[this.playcharExt.animname[h]].run();if(this.garbageTrayAnimDelay>0){this.garbageTrayAnimDelay--;let center=500,l=Math.min(this.garbageTrayAnimDelay,20);for(let g=0,lm=this.garbageTrayObjects.length;g<lm;g++){let distance=center-200*g;this.garbageTrayObjects[g].gx=distance*bezier(l/20,0,1,0,0,0,1)}this.drawGarbageTray()}if(this.garbageTrayBehindAnimDelay>0){this.garbageTrayBehindAnimDelay--;let center=500,l=Math.min(this.garbageTrayBehindAnimDelay,20);for(let g=0,lm=this.garbageTrayBehindObjects.length;g<lm;g++){let distance=center-200*g;this.garbageTrayBehindObjects[g].gx=distance*bezier(l/20,0,1,0,0,0,1)}this.drawGarbageTrayBehind()}if(this.emAnimationSetting.on&&this.emAnimationSetting.name in this.animationTriggerEvents){this.emAnimationSetting.time++;let again=!1;do{if(this.emAnimationSetting.time in this.animationTriggerEvents[this.emAnimationSetting.name]){again=!1;let ind=this.animationTriggerEvents[this.emAnimationSetting.name][this.emAnimationSetting.time],origin=this.assetRect("OVERLAY-LAYER"),originX=origin.x+origin.width/2,originY=origin.y+origin.height/2;for(let ma of ind){if("createAnimLayer"===ma.action){let srcRef=this.animationElements[ma.targetsrc],mid=this.getCanvasAnimationName(ma.targetid);animatedLayers.create(mid,ma.framemax||0,originX,originY,0,0,0,srcRef.framewidth,srcRef.frameheight,srcRef.aspectwidth*srcRef.cellsizemult,srcRef.aspectheight*srcRef.cellsizemult,1/ma.framedel,this.getCanvasAnimationLoadedName(ma.targetsrc),srcRef.xbound,this.fieldCellSize,{isOn:ma.loop||!1,resetFrame:ma.resetframe||0},ma.paused,!0),animatedLayers.setOpacity(mid,"opacity"in ma?ma.opacity:1,-99)}if("configureAnimLayer"==ma.action){let target=animatedLayers.getObject(this.getCanvasAnimationName(ma.targetid));"framemax"in ma&&(target.frame.max=ma.framemax,target.loop.targetFrame=ma.framemax),"framepos"in ma&&(target.frame.int=target.frame.max-ma.framepos,target.frame.elapsed=ma.framepos),"framedel"in ma&&(target.frame.rate=1/ma.framedel),"loop"in ma&&(target.loop.isOn=ma.loop),"resetframe"in ma&&(target.loop.resetFrame=ma.resetframe),"paused"in ma&&(target.isPaused=ma.paused)}if("time"==ma.action&&(this.emAnimationSetting.time=ma.time-1,again=!1),"move"==ma.action){let bez=[1/3,2/3];"bezier"==ma.timing&&("bez_s1"in ma&&(bez[0]=ma.bez_s1),"bez_s2"in ma&&(bez[1]=ma.bez_s2)),animatedLayers.getObject(this.getCanvasAnimationName(ma.targetid)).moveOffset(ma.x0,ma.y0,ma.x1,ma.y1,ma.duration,bez)}if("rotate"==ma.action){let bez=[1/3,2/3];"bezier"==ma.timing&&("bez_s1"in ma&&(bez[0]=ma.bez_s1),"bez_s2"in ma&&(bez[1]=ma.bez_s2)),animatedLayers.getObject(this.getCanvasAnimationName(ma.targetid)).rotateOffset(ma.start,ma.end,ma.duration,bez)}if("path"==ma.action){let bez=[1/3,2/3];"bezier"==ma.timing&&("bez_s1"in ma&&(bez[0]=ma.bez_s1),"bez_s2"in ma&&(bez[1]=ma.bez_s2)),animatedLayers.getObject(this.getCanvasAnimationName(ma.targetid)).setPath(this.animationPaths[ma.path],ma.duration,bez)}if("opacity"==ma.action&&animatedLayers.setOpacity(this.getCanvasAnimationName(ma.targetid),"opacity"in ma?ma.opacity:1,ma.duration),"scale"==ma.action){let target=animatedLayers.getObject(this.getCanvasAnimationName(ma.targetid)),bez=[1/3,2/3];"bezier"==ma.timing&&("bez_s1"in ma&&(bez[0]=ma.bez_s1),"bez_s2"in ma&&(bez[1]=ma.bez_s2)),ma.x0!==ma.x1&&target.scaleXOffset(ma.x0,ma.x1,ma.duration,bez),ma.y0!==ma.y1&&target.scaleYOffset(ma.y0,ma.y1,ma.duration,bez)}}}}while(again)}}playEmAnimation(name){this.emAnimationSetting.name=name,this.emAnimationSetting.time=-1,this.emAnimationSetting.on=!0}resetEmAnimation(){this.emAnimationSetting.name="",this.emAnimationSetting.time=-1,this.emAnimationSetting.on=!1;for(let n of this.animationLayerElements)animatedLayers.remove(this.getCanvasAnimationName(n))}getCanvasAnimationName(obj){return`P${this.player}-${this.character.current}||LAYER||${obj}`}getCanvasAnimationPlainName(obj){return`P${this.player}||LAYER||${obj}`}setPlayerName(name){this.name=name,this.editIH("NAMEPLATE",name)}playAnimation(name,stop){this.fieldAnimations[name].play()}stopAnimation(name){this.fieldAnimations[name].reset()}playUnfreezableAnimation(name,stop){this.unfreezableFieldAnimations[name].play()}resetAnimations(){for(let h=0,m=this.animFieldNames.length;h<m;h++)this.fieldAnimations[this.animFieldNames[h]].reset();this.setStyle("WHOLE","opacity","100%"),this.setStyle("AUX-WHOLE","opacity","100%")}resetUFA(){for(let h=0,m=this.namesUFA.length;h<m;h++)this.unfreezableFieldAnimations[this.namesUFA[h]].reset()}checkWaitDeterminism(){this.shouldWaitForOpponent=this.canWaitForOpponent}executeRotateWobble(intensity,frames,aux){this.fieldAnimations.fieldWobbleRotate.reset(),0!==intensity&&(this.fieldAnimations.fieldWobbleRotate.setFrame(frames),this.styleVariable(aux?"AUX-WHOLE":"ROTATING-WHOLE","board-rot-wob-int",`${intensity||20}`),this.fieldAnimations.fieldWobbleRotate.play())}runUnfreezableAnims(){for(let h=0,m=this.namesUFA.length;h<m;h++)this.unfreezableFieldAnimations[this.namesUFA[h]].run()}removeGarbage(amount,isBehindTrayOnly){let garbLength=this.calculateGarbage()+this.calculateGarbageBehind(),gCount=amount,neutralCount=0;for(;!isBehindTrayOnly&&this.garbage.length>0&&gCount>0;){let reference=this.garbage[0];if(reference.count<=0){this.garbage.shift();continue}let min=Math.min(reference.count,gCount);reference.count-=min,neutralCount+=min,reference.count<=0&&this.garbage.shift(),gCount-=min}for(;this.garbageBehind.length>0&&gCount>0;){let reference=this.garbageBehind[0];if(reference.count<=0){this.garbageBehind.shift();continue}let min=Math.min(reference.count,gCount);reference.count-=min,neutralCount+=min,reference.count<=0&&this.garbageBehind.shift(),gCount-=min}this.garbageLength=this.calculateGarbage(),this.garbageBehindLength=this.calculateGarbageBehind(),this.rpgAttr.hpDamage=this.calculateHPDamage(),this.garbageLastForTray.assign(this.garbageLength),this.garbageBehindLastForTray.assign(this.garbageBehindLength),this.block.insane.isOn||this.blob.insane.isOm||this.block.isAux||!this.blob.isAux||this.isGarbageCollectionMode||this.check1v1Overhead(!1,garbLength,this.garbageLength+this.garbageBehindLength,!1)}enableAuxField(h){this.auxEnabled=h,this.setStyle("AUX-WHOLE","display",this.auxEnabled?"block":"none")}switchModeType(type){this.activeType=type,this.blob.isControl=1==type,this.blob.isEnable=1==type,this.blob.isActive=1==type,this.block.isControl=0==type,this.block.isEnable=0==type,this.block.isActive=0==type,this.changeBorder(),this.adjustBlobBlockNexts(),this.block.holdShow(0==type),this.setStyle("AUX-BORDER-1","display",this.player%2==0?"block":"none"),this.setStyle("AUX-BORDER-2","display",this.player%2==1?"block":"none"),this.swapMode.isOn&&(this.drawGarbageTray(),this.drawGarbageTrayBehind())}refreshBorderField(type){if(this.changeBorder(type),this.adjustBlobBlockNexts(type),this.block.holdShow(0==type),this.block.drawActivePiece(),this.blob.drawActivePiece(),this.block.drawStack(),this.blob.drawStack(),0==type){let a=this.block;a.previewDraw(),a.holdDraw()}if(1==type){this.blob.previewDraw()}}convertGarbageBlockToGarbageBlob(type,isChain){let count={system:{count:0,hpdmg:0,wait:!1,t:"system"}};for(let h=0;h<this.garbage.length;h++){let ma=this.garbage[h];ma.wait?ma.player in count?(count[ma.player].count+=ma.count,count[ma.player].hpdmg+=ma.hpdmg):count[ma.player]={count:ma.count,hpdmg:ma.hpdmg,wait:ma.wait,t:ma.player}:(count.system.count+=ma.count,count.system.hpdmg+=ma.hpdmg)}for(let h=0;h<this.garbageBehind.length;h++){let ma=this.garbageBehind[h];ma.wait?ma.player in count?(count[ma.player].count+=ma.count,count[ma.player].hpdmg+=ma.hpdmg):count[ma.player]={count:ma.count,hpdmg:ma.hpdmg,wait:ma.wait,t:ma.player}:(count.system.count+=ma.count,count.system.hpdmg+=ma.hpdmg)}if(this.garbage.length=0,this.garbageBehind.length=0,0==type)for(let cmo in count){let co=count[cmo],h=4,total=0,l=0,q=0;for(;h<co.count&&co.count>0&&(h+=l,l+=1,!(h>=co.count));)q++,total++;total>0&&this.addGarbage(co.t,[total],co.wait,!0,2-this.garbageDelay,co.hpdmg,!0)}if(1==type)for(let cmo in count){let co=count[cmo],h=0,total=0,q=0;for(;h<co.count&&co.count>0;)h++,total+=1==h?4:1+~~(q/1),q++;total>0&&this.addGarbage(co.t,[total],co.wait,!0,2-this.garbageDelay,co.hpdmg,!0)}this.garbageLength=this.calculateGarbage(),this.garbageBehindLength=this.calculateGarbageBehind(),this.garbageLastForTray.assign(this.garbageLength),this.garbageBehindLastForTray.assign(this.garbageBehindLength),this.rpgAttr.hpDamage=this.calculateHPDamage()}switchAuxToMain(type){if(this.activeType=type,this.blob.isControl=1==type,this.blob.isAux=0==type,this.blob.isEnable=!0,this.blob.isActive=1==type,this.block.isControl=0==type,this.block.isAux=1==type,this.block.isEnable=!0,this.block.isActive=0==type,this.changeBorder(),this.adjustBlobBlockNexts(),this.adjustBlobBlockBG(type),this.block.holdShow(0==type),this.block.drawActivePiece(),this.blob.drawActivePiece(),this.block.drawStack(),this.blob.drawStack(),0==type){let a=this.block;a.previewDraw(),a.holdDraw()}if(1==type){this.blob.previewDraw()}this.swapMode.isOn&&(this.garbageType=this.activeType,this.drawGarbageTray(),this.drawGarbageTrayBehind())}clearLayerAnims(){for(let h of this.animationLayerElements)animatedLayers.remove(this.getCanvasAnimationName(h))}changeBorder(u){let activeType=void 0!==u?u:this.activeType;this.setStyle("BORDER-BLOCK","display",0==activeType?"block":"none"),this.setStyle("BORDER-BLOB-1","display",1==activeType&&this.player%2==0?"block":"none"),this.setStyle("BORDER-BLOB-2","display",1==activeType&&this.player%2==1?"block":"none")}check1v1Overhead(isAttacking,garbLength,newGarb,atk){game1v1.on&&(game1v1.overhead.on?!atk||isAttacking?(game1v1.overhead.checkGarbage(this.player,newGarb),0==newGarb&&this.conclude1v1Overhead(3)):atk&&this.conclude1v1Overhead(1):!atk&&!isAttacking&&garbLength>0&&newGarb>0&&game1v1.overhead.openClose(1,this.player,newGarb,garbLength))}conclude1v1Overhead(n){game1v1.on&&(0==n&&game1v1.overhead.openClose(5),1==n&&game1v1.overhead.openClose(2),2==n&&game1v1.overhead.openClose(3),3==n&&game1v1.overhead.openClose(4))}resize(cellSize,fontSize,sizeMult,isEv){this.cellSize=~~(cellSize*game.resQualityMult),this.fieldCellSize=~~(cellSize*sizeMult),this.fieldFontSize=~~(fontSize*sizeMult),this.isCompact=isEv;let block=this.block,paddingY=(this.blob,0),height=this.fieldSize.vh+this.visibleFieldBufferHeight,fieldHeight=this.fieldSize.vh+this.visibleFieldHeight,width=this.fieldSize.w,handWidth=5,plm=6;this.isCompact&&(plm=1,handWidth=0,paddingY=4*this.fieldCellSize),this.setStyle("AREA","transform",`translateY(${paddingY}px)`),this.meterBar.right.resize(this.fieldCellSize,.6,fieldHeight),this.meterBar.garbwait.resize(this.fieldCellSize,.6,fieldHeight),this.setStyle("AREA","fontSize",`${this.fieldFontSize}px`);for(let body of["BORDER","AREA","WHOLE","ROTATING-WHOLE","STOMP-WHOLE","PLAYER-CHARACTER-LAYER"])this.setStyle(body,"width",this.fieldCellSize*(2*handWidth+width+2+2+plm)+"px"),this.setStyle(body,"height",this.fieldCellSize*(fieldHeight+2+2)+"px");for(let body of["BODY","OVERLAY-LAYER"])this.setStyle(body,"width",this.fieldCellSize*(2*handWidth+width+2+plm)+"px"),this.setStyle(body,"height",this.fieldCellSize*fieldHeight+"px");let clearTextSizeTotal=0;for(let txt of[{name:"SPIN",size:1.12},{name:"LINE",size:1.9},{name:"B2B",size:1.07},{name:"COMBO",size:1.3},{name:"SPIKE",size:1}])this.setStyle(`CLEARTEXT-TEXT-${txt.name}`,"font-size",this.fieldFontSize*txt.size+"px"),this.setStyle(`CLEARTEXT-TEXT-${txt.name}`,"width","100%"),this.setStyle(`CLEARTEXT-TEXT-${txt.name}`,"text-align","right"),this.setStyle(`CLEARTEXT-TEXT-${txt.name}`,"opacity","0%"),clearTextSizeTotal+=txt.size;this.setStyle("BORDER","right",-1*this.fieldCellSize+"px"),this.setStyle("DIV-CLEARTEXT","width",5*this.fieldCellSize*2+"px"),this.setStyle("DIV-CLEARTEXT","height",this.fieldCellSize*clearTextSizeTotal+"px"),this.setStyle("DIV-CLEARTEXT","margin-left",5*this.fieldCellSize*-1+"px"),this.setStyle("CLEARTEXT-TEXTS","width",5*this.fieldCellSize*2+"px"),this.setStyle("CLEARTEXT-TEXTS","height",this.fieldCellSize*clearTextSizeTotal+"px"),this.setStyle("CLEARTEXT-CANVTEXT","width",5*this.fieldCellSize+"px"),this.setStyle("CLEARTEXT-CANVTEXT","height",3*this.fieldCellSize+"px"),this.setStyle("CLEARTEXT-TSPIN-CANVAS","width",3*this.fieldCellSize+"px"),this.setStyle("CLEARTEXT-TSPIN-CANVAS","height",3*this.fieldCellSize+"px"),this.setStyle("CLEARTEXT-TSPIN-LINE","width",2*this.fieldCellSize+"px"),this.setStyle("CLEARTEXT-TSPIN-LINE","height",3*this.fieldCellSize+"px"),this.setCanvasSize("tspin",180,180);for(let hand of["LEFT","RIGHT"])this.setStyle(`${hand}-HAND`,"width",this.fieldCellSize*handWidth+"px"),this.setStyle(`${hand}-HAND`,"height",this.fieldCellSize*height+"px");for(let field of["-CHARACTER-CANVAS","-PIECE-CANVAS","-STACK-CANVAS","-DYNAMIC"])this.setStyle(`FIELD${field}`,"width",this.fieldCellSize*width+"px"),this.setStyle(`FIELD${field}`,"height",this.fieldCellSize*height+"px");for(let field of["-INSANE-CANVAS","-INSANE","-BACK-CANVAS"])this.setStyle(`FIELD${field}`,"width",this.fieldCellSize*width+"px"),this.setStyle(`FIELD${field}`,"height",this.fieldCellSize*fieldHeight+"px");this.setCanvasSize("insane",width*this.cellSize,fieldHeight*this.cellSize),this.setCanvasSize("back",width*this.cellSize,fieldHeight*this.cellSize),this.setStyle("FIELD","width",this.fieldCellSize*width+"px"),this.setStyle("FIELD","height",this.fieldCellSize*fieldHeight+"px"),this.setStyle("FIELD-CHARACTER-CANVAS","width",this.fieldCellSize*width+"px"),this.setStyle("FIELD-CHARACTER-CANVAS","height",this.fieldCellSize*fieldHeight+"px");for(let field of["character","stack","piece"])this.setCanvasSize(field,width*this.cellSize,height*this.cellSize);this.setCanvasSize("character",width*this.cellSize,fieldHeight*this.cellSize);for(let field of["DIV","CANVAS","BEHIND-CANVAS"])this.setStyle(`GARBAGE-TRAY-${field}`,"width",6*this.fieldCellSize*2+"px"),this.setStyle(`GARBAGE-TRAY-${field}`,"height",2*this.fieldCellSize+"px"),"DIV"===field&&this.setStyle(`GARBAGE-TRAY-${field}`,"top",-1*this.fieldCellSize*2.5+"px");this.setCanvasSize("garbageTray",1200,200),this.setCanvasSize("garbageTrayBehind",1200,200);for(let field of["PLAYCHAR-CANVAS-DIV","PLAYCHAR-CANVAS"])this.setStyle(`${field}`,"width",26*this.fieldCellSize+"px"),this.setStyle(`${field}`,"height",26*this.fieldCellSize+"px");this.setStyle("PLAYCHAR-TEXT-DIV","width",24*this.fieldCellSize+"px"),this.setStyle("PLAYCHAR-TEXT-DIV","height",4*this.fieldCellSize+"px"),this.setStyle("PLAYCHAR-TEXT","font-size",4*this.fieldFontSize+"px");for(let hmll of["DIV","BG","CANVAS"])this.setStyle(`BLOB-NEXT-${hmll}`,"width",3*this.fieldCellSize*1.5+"px"),this.setStyle(`BLOB-NEXT-${hmll}`,"height",5*this.fieldCellSize*1.5+"px");this.setCanvasSize("blobNext",3*this.cellSize*1.5,5*this.cellSize*1.5);for(let hmll of["DIV","CANVAS"])this.setStyle(`RECTANIM-${hmll}`,"width",247*this.fieldCellSize*.06+"px"),this.setStyle(`RECTANIM-${hmll}`,"height",70*this.fieldCellSize*.06+"px");this.setStyle("WINS-SCORE","top",this.fieldCellSize*(height-this.visibleFieldBufferHeight+.5)+"px");let shm=0;this.isCompact,this.setStyle("WINS-SCORE","width",this.fieldCellSize*this.fieldSize.w+6+"px"),this.setStyle("WINS-SCORE","height",2*this.fieldCellSize+"px"),this.setStyle("TEAM-WIN","width",4*this.fieldCellSize+"px"),this.setStyle("TEAM-WIN","height",1.8*this.fieldCellSize+"px"),this.setStyle("TEAM-CANVAS","width",1.8*this.fieldCellSize+"px"),this.setStyle("TEAM-CANVAS","height",1.8*this.fieldCellSize+"px"),this.setStyle("WINS-DIV","width",2*this.fieldCellSize+"px"),this.setStyle("WINS-DIV","height",2*this.fieldCellSize+"px"),this.setStyle("TEAM-WIN","display",this.isCompact?"flex":"none"),this.setStyle("WINS-TEXT","font-size",1.28*this.fieldFontSize+"px"),this.setStyle("STATS-SCORE","width",this.fieldCellSize*this.fieldSize.w+2+"px"),this.setStyle("STATS-SCORE","height",1.5*this.fieldCellSize+"px"),this.setStyle("RECTANIM-DIV","top",this.fieldCellSize*(height+1-this.visibleFieldBufferHeight)+"px"),this.setStyle("HP-BAR-DIV","width",14*this.fieldCellSize+"px"),this.setStyle("HP-BAR-DIV","height",1.5*this.fieldCellSize+"px"),this.setStyle("HP-TEXT-DIV","width",2*this.fieldCellSize+"px"),this.setStyle("HP-TEXT-DIV","height",1.5*this.fieldCellSize+"px"),this.setStyle("HP-METER-CANVAS","width",12*this.fieldCellSize+"px"),this.setStyle("HP-METER-CANVAS","height",1.5*this.fieldCellSize+"px"),this.setStyle("HP-BAR-DIV","top",-1.6*this.fieldCellSize+"px"),this.setStyle("GARBAGE-TRAY-DIV","top",-1*this.fieldCellSize*(2.3+(this.rpgAttr.isOn?1.5:0))+"px"),this.setStyle("FIELD-CHARACTER-CANVAS","transform",`rotateY(${this.player%2==1?180:0}deg)`),this.setStyle("PLAYCHAR-CANVAS","transform",`rotateY(${this.player%2==1?180:0}deg)`),this.setStyle("RECTANIM-CANVAS","transform",`rotateY(${this.player%2==1?180:0}deg)`),this.setStyle("STATS-SCORE-TEXT","font-size",1.7*this.fieldFontSize+"px");let px=.47;this.setStyle("AUX-FIELD-CHARACTER-CANVAS","transform",`rotateY(${this.player%2==1?180:0}deg)`),this.setStyle("AUX-WHOLE","top",this.fieldCellSize*(this.isAux&&this.player%2==0?2:11)+"px"),this.setStyle("FEVER-GAUGE","top",6*this.fieldCellSize+"px"),this.setStyle("AUX-WHOLE",this.player%2==1?"left":"right",-2.7*this.fieldCellSize+"px"),this.setStyle("FEVER-GAUGE",this.player%2==1?"left":"right",-.3*this.fieldCellSize+"px"),this.setStyle("RPG-DECK",this.player%2==1?"left":"right",-.9*this.fieldCellSize+"px"),this.setStyle("RPG-DECK","top",9*this.fieldCellSize+"px");for(let hmll of["","-CANVAS"])this.setStyle(`FEVER-GAUGE${hmll}`,"width",6*this.fieldCellSize+"px"),this.setStyle(`FEVER-GAUGE${hmll}`,"height",15*this.fieldCellSize+"px");this.setCanvasSize("feverGauge",6*this.cellSize,15*this.cellSize),this.feverStat.resize(6*this.cellSize,15*this.cellSize,this.cellSize,this.player%2==1);for(let hmll of["","-CANVAS"])this.setStyle(`RPG-DECK${hmll}`,"width",8*this.fieldCellSize+"px"),this.setStyle(`RPG-DECK${hmll}`,"height",13*this.fieldCellSize+"px");this.setCanvasSize("rpgDeck",1600,2600);for(let field of["-CHARACTER-CANVAS","","-PIECE-CANVAS","-STACK-CANVAS","-DYNAMIC"])this.setStyle(`AUX-FIELD${field}`,"width",px*this.fieldCellSize*width+"px"),this.setStyle(`AUX-FIELD${field}`,"height",px*this.fieldCellSize*height+"px");for(let field of["-INSANE-CANVAS","-INSANE","-BACK-CANVAS"])this.setStyle(`AUX-FIELD${field}`,"width",px*this.fieldCellSize*width+"px"),this.setStyle(`AUX-FIELD${field}`,"height",px*this.fieldCellSize*fieldHeight+"px");for(let body of["BORDER","WHOLE","ROTATING-WHOLE"])this.setStyle(`AUX-${body}`,"width",px*this.fieldCellSize*(2*handWidth+width+2+2)+"px"),this.setStyle(`AUX-${body}`,"height",px*this.fieldCellSize*(fieldHeight+2+2)+"px");for(let field of["characterAux","stackAux","pieceAux","backAux"])this.setCanvasSize(field,width*this.cellSize,height*this.cellSize);this.setStyle("AUX-FIELD","width",this.fieldCellSize*width*px+"px"),this.setStyle("AUX-FIELD","height",this.fieldCellSize*fieldHeight*px+"px"),this.setStyle("AUX-FIELD-CHARACTER-CANVAS","width",this.fieldCellSize*width*px+"px"),this.setStyle("AUX-FIELD-CHARACTER-CANVAS","height",this.fieldCellSize*fieldHeight*px+"px"),this.setStyle("NAMEPLATE-DIV","top",this.fieldCellSize*(height+3-this.visibleFieldBufferHeight)+"px"),this.setStyle("NAMEPLATE-DIV","width",this.fieldCellSize*width*1.5+"px"),this.setStyle("NAMEPLATE-DIV","height",1.2*this.fieldCellSize+"px"),this.setCanvasSize("characterAux",width*this.cellSize,fieldHeight*this.cellSize),this.adjustBlockResize(),block.drawStack(),block.drawActivePiece(),this.drawCharacterBg(0),this.drawGarbageTray(),this.adjustBlobBlockBG(),this.adjustBlobBlockNexts(),this.setCanvasSize("playchar",600,600),this.setCanvasSize("rectanim",247,70);let origin=this.assetRect("OVERLAY-LAYER"),originX=origin.x+origin.width/2,originY=origin.y+origin.height/2;if(this.playerCenterPos.x=originX,this.playerCenterPos.y=originY+paddingY,this.isVisible){this.drawActivePlaycharExt(this.playcharExt.positions[this.playcharExt.active]);for(let e=0;e<this.animationLayerElements.length;e++){let ev=this.animationLayerElements[e],initid=this.getCanvasAnimationName(ev);if(animatedLayers.checkObject(initid)){let object=animatedLayers.getObject(initid);object.centerPos.x=this.playerCenterPos.x,object.centerPos.y=this.playerCenterPos.y,object.sizeMult=this.fieldCellSize}}}}adjustBlockResize(){let nextHeight=14.2,nextWidth=5,msd=this.fieldSize.w+2,msl=.5;this.isCompact&&(msd-=2,msd=-3,nextWidth=1.5*this.fieldSize.w,nextHeight=9.1,msl=-1);for(let canvas of["hold"])this.setCanvasSize(canvas,5*this.cellSize,4*this.cellSize);this.setCanvasSize("next",this.cellSize*nextWidth,this.cellSize*nextHeight),this.setStyle("BLOCK-NEXT","left",this.fieldCellSize*msd+"px"),this.setStyle("BLOCK-NEXT","top",this.fieldCellSize*-msl+"px"),this.setStyle("BLOCK-NEXT","width",this.fieldCellSize*nextWidth*.7+"px"),this.setStyle("BLOCK-NEXT","height",this.fieldCellSize*nextHeight*.7+"px"),this.setStyle("NEXT-CANVAS","width",this.fieldCellSize*nextWidth*.7+"px"),this.setStyle("NEXT-CANVAS","height",this.fieldCellSize*nextHeight*.7+"px"),this.setStyle("HOLD","left",.35*this.fieldCellSize+"px"),this.setStyle("HOLD","top",.225*this.fieldCellSize+"px"),this.setStyle("HOLD","width",5*this.fieldCellSize+"px"),this.setStyle("HOLD","height",4*this.fieldCellSize+"px"),this.setStyle("HOLD-CANVAS","width",5*this.fieldCellSize*.7+"px"),this.setStyle("HOLD-CANVAS","height",4*this.fieldCellSize*.7+"px")}adjustBlobBlockBG(u){let activeType=void 0!==u?u:this.activeType;if(this.setStyle("BORDER-BLOCK","display","none"),this.setStyle("BORDER-BLOB-1","display","none"),this.setStyle("BORDER-BLOB-2","display","none"),this.setStyle("BLOB-NEXT-BG-1","display","none"),this.setStyle("BLOB-NEXT-BG-2","display","none"),this.isCompact){let l=11;this.getAsset("BLOB-NEXT-DIV").style.setProperty("--bn-position-y",-this.fieldCellSize*l+"px"),this.getAsset("BLOCK-NEXT").style.setProperty("--bn-position-y",-this.fieldCellSize*l+"px"),this.getAsset("BLOB-NEXT-DIV").style.setProperty("--bn-position-x",this.fieldCellSize*(this.fieldSize.w/2)-this.fieldCellSize+"px"),this.getAsset("BLOCK-NEXT").style.setProperty("--bn-position-x",this.fieldCellSize*(this.fieldSize.w/2)-this.fieldCellSize+"px")}else this.getAsset("BLOB-NEXT-DIV").style.setProperty("--bn-position-y",-this.fieldCellSize+"px"),this.getAsset("BLOCK-NEXT").style.setProperty("--bn-position-y",-this.fieldCellSize+"px"),this.getAsset("BLOB-NEXT-DIV").style.setProperty("--bn-position-x",(this.player%2==0?1:-1)*(this.fieldCellSize*(this.fieldSize.w/2)+3*this.fieldCellSize*1.5)+"px"),this.getAsset("BLOCK-NEXT").style.setProperty("--bn-position-x",(this.player,1*(this.fieldCellSize*(this.fieldSize.w/2)+3*this.fieldCellSize*1.1))+"px");if(this.isVisible)if(1===activeType){this.isCompact||(this.setStyle("BORDER-BLOB-1","display",this.player%2==0?"block":"none"),this.setStyle("BORDER-BLOB-2","display",this.player%2==1?"block":"none"));let lm=this.player%2==0||this.isCompact,ls=this.player%2==1&&!this.isCompact;this.setStyle("BLOB-NEXT-BG-1","display",lm?"block":"none"),this.setStyle("BLOB-NEXT-BG-2","display",ls?"block":"none")}else this.isCompact||this.setStyle("BORDER-BLOCK","display","block")}adjustBlobBlockNexts(u){let activeType=void 0!==u?u:this.activeType;this.setStyle("BLOB-NEXT-DIV","display","none"),this.setStyle("BLOCK-NEXT","opacity","0%"),this.isVisible&&(1==activeType?this.setStyle("BLOB-NEXT-DIV","display","block"):this.setStyle("BLOCK-NEXT","opacity","100%"))}drawGarbageTray(){if(this.canvasClear("garbageTray"),this.isVisible)for(let x=0;x<6;x++)this.canvasCtx.garbageTray.drawImage(manager.skinGarb.canvas,200*this.garbageTrayObjects[x].x,200*this.garbageType,200,200,200*x+this.garbageTrayObjects[x].gx,0,200,200)}drawGarbageTrayBehind(){if(this.canvasClear("garbageTrayBehind"),this.isVisible)for(let x=0;x<6;x++)this.canvasCtx.garbageTrayBehind.drawImage(manager.skinGarb.canvas,200*this.garbageTrayBehindObjects[x].x,200*this.garbageType,200,200,200*x+this.garbageTrayBehindObjects[x].gx,0,200,200)}drawCharacterBg(n){this.canvasClear("character"),this.canvasCtx.character.drawImage(this.character.canvas,300*(n||0),0,300,600,0,0,this.fieldSize.w*this.cellSize,(this.fieldSize.vh+this.visibleFieldHeight)*this.cellSize),this.canvasClear("characterAux"),this.canvasCtx.characterAux.drawImage(this.character.canvas,300*(n||0),0,300,600,0,0,this.fieldSize.w*this.cellSize,this.fieldSize.vh*this.cellSize)}drawRect(ctx,x,y,row,column,sx,sy){x=~~(x*this.cellSize*sx),y=y*this.cellSize*sy;let c=this.canvasCtx[ctx];this.isVisible&&c.drawImage(manager.skin.canvas,row*this.cellSize,column*this.cellSize,this.cellSize,this.cellSize,x,y,this.cellSize*sx,this.cellSize*sy)}drawArray(ctx,arr,cx,cy,color,row,sx,sy,isEraseTop){for(var x=0,len=arr.length;x<len;x++)for(var y=0,wid=arr[x].length;y<wid;y++)if(arr[x][y]&&(this.drawRect(ctx,x+cx,y+cy,row,void 0!==color?color:arr[x][y],sx||1,sy||1),isEraseTop)){let a=this.canvasses[ctx];this.canvasCtx[ctx].clearRect(0,0,a.width,this.cellSize*this.visibleFieldBufferHeight)}}checkLose(){this.isDying=!0,this.conclude1v1Overhead(2)}checkWin(){this.isWin=!0,this.conclude1v1Overhead(2)}phaseLose(o){this.pressStr="",this.lastPressStr="",this.isDead=!0,this.isFinishAble=!1,this.playSound("lose"),this.resetAnimations(),this.delay[0]=80,o?"break"===o?(this.playAnimation("fieldDownDelayed"),this.delay[0]=140):(this.executeRotateWobble(0),1==this.activeType&&(this.blob.simulateSplashOut(),this.blob.resetGrid()),this.playAnimation("fieldFinisherFinalBlow1"),this.playAnimation("fieldFinisherFinalBlow2"),this.swapMode.isOn&&this.playAnimation("fieldDownAux")):(this.playAnimation("fieldDown"),this.swapMode.isOn&&this.playAnimation("fieldDownAux")),this.setStyle("WHOLE","opacity","0%"),this.setStyle("AUX-WHOLE","opacity","0%")}startNext(){0==this.activeType&&this.block.spawnPiece(this.block.previewNextBag(),!1),1==this.activeType&&this.blob.previewNextBlob()}engageShakeIntensityHit(x){this.styleVariable("WHOLE","shakehit-x",x),this.playAnimation("shakeUponHit")}simulateWMWShakeIntensityHit(){this.styleVariable("WHOLE","shakehit-wmw-x",this.fieldCellSize*(16*Math.random()-16*Math.random())+"px"),this.styleVariable("WHOLE","shakehit-wmw-y",this.fieldCellSize*(16*Math.random()-16*Math.random())+"px"),this.playAnimation("shakeWMWHit")}reset(){this.delay[1]=9,this.delay[2]=-8,this.block.reset(),this.blob.reset(),this.swapMode.reset(),this.woi.reset(),this.woiWormhole.reset(),this.feverStat.resetRound(),this.block.canControl=!0,this.blob.canControl=!0,this.lastPressStr=null,this.lastAckedFrame=0,this.inputFrames=0,this.apparentInputFrames=0,this.framePackets={},this.freeFramePackets={},this.lastCapturedInputFrame=0,this.shouldWaitForOpponent=!1,this.canWaitForOpponent=!1,this.callibrateCenter(),this.insaneBg.reset(),this.resetEmAnimation(),this.engagePlaycharExt(),this.fieldAnimations.tspid&&(this.isDelayStoppable=!0),this.isWin=!1,this.hasWon=!1,this.isDead=!1,this.isDying=!1,this.isFinishAble=!1,this.resetAnimations(),this.resetUFA(),this.block.insane.reset(),this.blob.insane.reset(),this.isLosePlayed=!1,this.insaneBg.moveEye(this.fieldSize.w/2,this.fieldSize.vh/2),this.isGarbageBehindActive=!1,this.rpgAttr.hpDamage=0,this.score=0,this.addScoreText="";for(let a in this.flagPresses)this.flagPresses[a]=!1,this.lastFlagPresses[a]=!1;for(let a in this.stats)this.stats[a]=0;this.playerTarget.length=0,this.character.activeVoiceline="",this.dividedBlobScoreGarbage=0,this.blobGarbage=0,this.garbage.length=0,this.garbageBehind.length=0,this.inputBuffer=1,this.pressStr=0,this.lastPressStr=null,this.delayedGarbage=0,this.garbageLength=this.calculateGarbage(),this.garbageBehindLength=this.calculateGarbageBehind(),this.garbageBehindLastForTray.assign(this.garbageBehindLength),this.garbageLastForTray.assign(this.garbageLength);for(let a=0;a<this.delayKeynamesCount;a++)this.delay[a]=-9;this.emAnimationSetting.on=!1,this.engageCleartext("b2b",!1,""),this.engageCleartextCombo(!1,0,"")}addGarbage(player,arr,wait,allMess,del,hpdmg){let mm=!1;for(let l=0,os=arr.length;l<os;l++){let n=~~(this.seeds.field.next()*this.block.fieldSize.w),i=arr[l],n2=n;for(mm=!0;;){let rand=this.seeds.field.next(),limit=0;if(allMess)for(;limit<i;){if(rand<this.messiness){for(;n==n2;)n=~~(this.seeds.field.next()*this.fieldSize.w);n2=n;break}limit++}else limit=i;if(mm=!0,this.garbage.push({id:btoa(Math.random()*Math.random()),wait:wait,row:n2,frames:this.garbageDelay+manager.frames+(del||0),player:player,count:limit,allmess:allMess,hpdmg:hpdmg*(100/(100+(this.rpgAttr.attributes.defense+this.rpgAttr.statusEffectsAttributes.defense)))}),i-=limit,0==i)break}}mm&&(this.garbageLength=this.calculateGarbage(),this.rpgAttr.hpDamage=this.calculateHPDamage())}addGarbageBehind(player,arr,wait,allMess,del,hpdmg,isDirect){let mm=!1;for(let l=0,os=arr.length;l<os;l++){let n=~~(this.seeds.field.next()*this.block.fieldSize.w),i=arr[l],n2=n;for(mm=!0;!(i<=0);){let rand=this.seeds.field.next(),limit=0;if(allMess)for(;limit<i;){if(rand<this.messiness){for(;n==n2;)n=~~(this.seeds.field.next()*this.fieldSize.w);n2=n;break}limit++}else limit=i;mm=!0,this.garbageBehind.push({id:btoa(Math.random()*Math.random()),wait:wait,row:n2,frames:this.garbageDelay+manager.frames+(del||0),player:player,count:limit,allmess:allMess,hpdmg:hpdmg*(isDirect?1:150/(150+(this.rpgAttr.attributes.defense+this.rpgAttr.statusEffectsAttributes.defense)))}),i-=limit}}mm&&(this.garbageBehindLength=this.calculateGarbageBehind(),this.rpgAttr.hpDamage=this.calculateHPDamage())}calculateGarbage(){let count=0;for(let h=0;h<this.garbage.length;h++)count+=~~this.garbage[h].count;return count}calculateGarbageBehind(){let count=0;for(let h=0;h<this.garbageBehind.length;h++)count+=~~this.garbageBehind[h].count;return count}calculateHPDamage(){let count=0;for(let h=0;h<this.garbage.length;h++)count+=~~(this.garbage[h].hpdmg*this.garbage[h].count);for(let h=0;h<this.garbageBehind.length;h++)count+=~~this.garbageBehind[h].hpdmg*this.garbageBehind[h].count;return count}switchGarbageBehind(truefalse){this.isGarbageBehindActive=truefalse,truefalse?(this.garbageBehind.push(...this.garbage),this.garbage.length=0,this.garbageLength=this.calculateGarbage(),this.garbageBehindLength=this.calculateGarbageBehind(),this.garbageLastForTray.assign(this.garbageLength),this.garbageBehindLastForTray.assign(this.garbageBehindLength),this.rpgAttr.hpDamage=this.calculateHPDamage()):(this.garbage.push(...this.garbageBehind),this.garbageLength=this.calculateGarbage(),this.garbageBehind.length=0,this.garbageBehindLength=this.calculateGarbageBehind(),this.garbageLastForTray.assign(this.garbageLength),this.garbageBehindLastForTray.assign(this.garbageBehindLength),this.rpgAttr.hpDamage=this.calculateHPDamage())}callibrateCenter(){let origin=this.assetRect("OVERLAY-LAYER"),originX=origin.x+origin.width/2,originY=origin.y+origin.height/2;this.playerCenterPos.x=originX,this.playerCenterPos.y=originY}controlsListen(canControl){this.simulPresses.enabled;{for(let g in this.simulPresses.events)this.simulPresses.events[g]=0;let input=this.pressStr;if(input!==this.lastPressStr){this.lastPressStr=input;for(let gsb in game.bitFlags)this.flagPresses[gsb]=input&game.bitFlags[gsb]}if(canControl){for(let gs=0;gs<3;gs++)this.flagPresses[`s${gs+1}`]&&!this.lastFlagPresses[`s${gs+1}`]&&this.rpgAttr.executeSkill(gs);this.flagPresses.hold&&!this.lastFlagPresses.hold&&this.block.isControl&&this.block.hold(),this.flagPresses.ccw&&!this.lastFlagPresses.ccw&&(this.block.isControl&&this.block.rotatePiece(-1),this.blob.isControl&&this.blob.rotatePiece(-1)),this.flagPresses.cw&&!this.lastFlagPresses.cw&&(this.block.isControl&&this.block.rotatePiece(1),this.blob.isControl&&this.blob.rotatePiece(1)),this.flagPresses.c180w&&!this.lastFlagPresses.c180w&&this.block.isControl&&this.block.rotatePiece(2),this.flagPresses.left&&!this.lastFlagPresses.left&&(this.block.isControl&&this.block.moveX(-1),this.blob.isControl&&this.blob.moveX(-1)),this.flagPresses.right&&!this.lastFlagPresses.right&&(this.block.isControl&&this.block.moveX(1),this.blob.isControl&&this.blob.moveX(1)),this.flagPresses.softdrop&&!this.lastFlagPresses.softdrop&&(this.block.isControl&&this.block.softDrop(),this.blob.isControl&&this.blob.softDrop()),this.flagPresses.harddrop&&!this.lastFlagPresses.harddrop&&(this.block.isControl&&this.block.hardDrop(),this.blob.isControl&&this.blob.hardDrop()),this.flagPresses.left||this.flagPresses.right||(this.block.isControl&&(this.block.handling.arr=0,this.block.handling.das=0),this.blob.isControl&&(this.blob.handling.arr=0,this.blob.handling.das=0))}}}inputRun(isPause){if(!game.replay.isOn&&this.ai.active){let prss=0;0==this.activeType&&(this.ai.run(),prss=this.ai.pressStr),1==this.activeType&&(this.aiBlob.run(),prss=this.aiBlob.pressStr),this.rpgAttr.isRPG&&this.aiRPG.run(),console.log(prss),this.pressStr=prss}game.replay.isOn?this.inputFrames in game.replay.data.players[this.player].keyData&&(this.pressStr=game.replay.data.players[this.player].keyData[this.inputFrames]):this.pressStr!==this.lastPressStr&&(game.replay.data.players[this.player].keyData[this.inputFrames]=this.pressStr),this.controlsListen(!isPause),isPause||(this.isDelayStoppable=!0,this.block.canControl=this.blob.canControl=!this.checkHalt(1,0),this.block.isControl&&this.block.shiftDelay(),this.blob.isControl&&this.blob.shiftDelay(),this.flagPresses.softdrop&&this.lastFlagPresses.softdrop?(this.block.isControl&&this.block.softDrop(),this.blob.isControl&&(this.blob.softDrop(),this.blob.piece.isAir||(this.blob.lock.lockSoftdrop--,this.blob.checkManipulatedPiece()))):this.blob.isEnable&&(this.blob.lock.lockSoftdrop=6),this.block.isEnable&&this.block.updatePiece(),this.blob.isEnable&&this.blob.updatePiece()),this.pressStr!==this.lastPressStr&&(this.lastPressStr=this.pressStr);for(let g in this.flagPresses)this.flagPresses[g]!==this.lastFlagPresses[g]&&(this.lastFlagPresses[g]=this.flagPresses[g]);this.recordedFramePackets[this.inputFrames]=this.pressStr,this.inputFrames++}drawPlayer(){if(this.block.isEnable){let bl=this.block;bl.drawActivePiece(),bl.effects.hardDrop.update(),bl.effects.appearAnim.update(),bl.effects.clearAnim.update(),bl.checkWarning(),bl.appearBlockFrame>-1&&(bl.appearBlockFrame--,0==bl.appearBlockFrame&&bl.drawStack(bl.stack)),bl.pcSpam.frame>=0&&(bl.pcSpam.frame--,0==bl.pcSpam.frame&&(bl.pcSpam.count=0)),this.block.insane.draw()}this.blob.isEnable&&(this.blob.drawActive(),this.blob.previewDrawUpdate(),this.blob.insane.draw()),this.woiWormhole.enable&&this.woiWormhole.draw(),this.feverStat.draw(),this.continuousUpdate()}continuousUpdate(){this.block.isEnable&&this.block.updateContinuousDelay(),this.blob.isEnable&&this.blob.updateContinuousDelay()}preupdate(){this.delay[1]>0&&(this.delay[1]--,1==this.delay[1]&&this.checkWaitDeterminism()),this.delay[2]>0&&(this.delay[2]--,2==this.delay[2]&&this.checkWaitDeterminism(),0==this.delay[2]&&(1==this.activeType&&this.blob.isEnable&&this.blob.isControl&&!(this.blob.insane.delay.ready>0||this.blob.insane.delay.readyHenshin>0)&&this.blob.previewNextBlob(),0==this.activeType&&this.block.isEnable&&this.block.isControl&&!(this.block.insane.delay.ready>0||this.blob.insane.delay.readyHenshin>0)&&this.block.spawnPiece(this.block.previewNextBag()),this.blob.isDelayEnabled=!0,this.block.isDelayEnabled=!0,this.rpgAttr.isRPG&&(this.rpgAttr.isUsableSkills=!0)))}playerUpdate(){this.checkHalt(0,1)||(this.block.isEnable&&this.block.updateDelay(),this.blob.isEnable&&this.blob.updateDelay());for(let j=0;j<this.halt.names.length;j++){let ref=this.halt.names[j];this.halt.delays[ref]>0&&this.halt.delays[ref]--}this.meterBar.right.assign(1==this.activeType?1:(this.block.fieldSize.vh+this.block.visibleFieldHeight-this.garbageLength)/(this.block.fieldSize.vh+this.block.visibleFieldHeight));{let garbageWait=0;for(let qq=0,leng=this.block.garbageWait.length;qq<leng;qq++)garbageWait+=this.block.garbageWait[qq].blob;this.meterBar.garbwait.assign([(this.fieldSize.vh+this.visibleFieldHeight-Math.max(0,Math.min(garbageWait,this.fieldSize.vh)))/(this.fieldSize.vh+this.visibleFieldHeight),(this.fieldSize.vh+this.visibleFieldHeight-Math.max(0,Math.min(garbageWait-this.fieldSize.vh,this.fieldSize.vh)))/(this.fieldSize.vh+this.visibleFieldHeight),(this.fieldSize.vh+this.visibleFieldHeight-Math.max(0,Math.min(garbageWait-2*this.fieldSize.vh,this.fieldSize.vh)))/(this.fieldSize.vh+this.visibleFieldHeight)])}this.block.isEnable&&this.clearText.tspin.run();for(let m of["b2b"])this.clearTextRenderers[m].run();if(this.blob.delay[2]>0&&this.blob.actualChain>0)this.scoreText.assign(this.addScoreText);else{let scr="",lsc=Math.min(99999999,this.score);for(let qu=0;qu<8&&(7!=qu||0!==lsc);qu++)10**qu>lsc&&(scr+="0");scr+=lsc,this.scoreText.assign(scr)}this.block.isEnable&&this.block.insane.update(),this.blob.isEnable&&this.blob.insane.update(),this.warningTrig.assign(!this.isWin&&(this.block.isEnable&&this.block.isWarning&&!this.block.isAux||this.blob.isEnable&&this.blob.isWarning&&!this.blob.isAux)?1:0),this.rectanim.run(),this.rpgAttr.update(),this.swapMode.run(),this.feverStat.run(),this.runDelay()}}const loadingScreen=new class{constructor(){this.element=id("GTRIS-LOAD-SCREEN"),this.canvas=id("LOAD-TRIVIA-CANVAS"),this.ctx=getCanvasCtx(this.canvas),this.canvas.width=1280,this.canvas.height=720,this.width=1280,this.height=720,this.images={},this.frame={closing:-9,opening:-9},this.drawnGapWidth=1,this.on=!1,this.isOpenable=!1}run(){this.on&&(this.frame.closing>0?(this.frame.closing--,this.drawnGapWidth=(20-this.frame.closing)/20):this.frame.opening>=0&&this.isOpenable&&(this.frame.opening--,this.drawnGapWidth=this.frame.opening/20,0==this.frame.opening&&(this.on=!1,styleelem(this.element,"display","none"))),this.draw())}draw(){this.ctx.clearRect(0,0,this.width,this.height);let lm=bezier1D(this.drawnGapWidth,0,1,0,1);this.ctx.drawImage(this.images.gate1,0,0,this.width,this.height,(lm-1)*this.width,0,this.width,this.height),this.ctx.drawImage(this.images.gate2,0,0,this.width,this.height,(1-lm)*this.width,0,this.width,this.height)}toggleOn(){this.on=!0,this.frame.opening=20,this.frame.closing=20,ih("LOAD-TEXT",language.translate("loading_prematch")),styleelem(this.element,"display","flex")}},manager=new class{#DelayHandler=class{constructor(delay,func){this.func=func,this.delay=delay,this.id=btoa(2147483647*Math.random())}run(){this.delay--,0==this.delay&&this.func()}};#customLoops=new ObjectFunctionIterator(obj=>{for(let ob in obj)obj[ob]()});constructor(){this.FPS=60,this.flagNames=["left","right","softdrop","harddrop","hold","ccw","cw","c180w","s1","s2","s3"],this.bitFlags={};for(let h=0;h<this.flagNames.length;h++)this.bitFlags[this.flagNames[h]]=bitwiseSL(h+1);this.synchroLoop=new RAFLoopHandler(this.FPS,_once=>{this.frameLoop(_once)}),this.presets={block:{},blobNormal:{},blobMicro:{}},this.resQualityMult=2,this.isRunning=!1,this.pause={on:!0,frame:0},this.matchEndHandler={frame:-9,on:!1,endable:!1,isFinishActual:!1,hasEnded:!1},this.lastPressStr="",this.fontSize=1,this.ratio={width:16,height:9},this.coreElement=id("CORE"),this.loopParams={isInsane:0,zerohp:0},Object.freeze(this.FPS),this.frames=0,this.countdown=120,this.waitCountdown=50,this.isFreezeHandlers=!1,this.assetHTML="",this.assetStyle="",this.resolution={w:1280,h:720},this.aspectResolution={w:1280,h:720},this.portrait={x:720,y:1289},this.landscape={x:720,y:1289},this.aspectRatio=16/9,this.orientation=null,this.cellSize=null,this.playerAreaSizeMult=.36,this.activePlayer=0,this.playerCount=null,this.players={},this.isSolo=!1,this.skinTemp={canvas:void 0,ctx:void 0},this.skin={canvas:void 0,ctx:void 0},this.skinBlob={canvas:void 0,ctx:void 0},this.skinBlobTemp={canvas:void 0,ctx:void 0},this.skinGarbTemp={canvas:void 0,ctx:void 0},this.skinParticle={canvas:void 0,ctx:void 0},this.skinParticleTemp={canvas:void 0,ctx:void 0},this.skinGarb={canvas:void 0,ctx:void 0},this.skinAppear={canvas:new OffscreenCanvas(700,280),ctx:void 0},this.skinAppear.ctx=this.skinAppear.canvas.getContext("2d"),this.skinClear={canvas:new OffscreenCanvas(700,420),ctx:void 0},this.skinClear.ctx=this.skinClear.canvas.getContext("2d"),this.loadCanvas={canvas:void 0,ctx:void 0},this.loadCanvas.canvas=id("LOAD-TRIVIA-CANVAS"),this.loadCanvas.ctx=this.loadCanvas.canvas.getContext("2d"),this.loadDiv={main:id("GTRIS-LOAD-SCREEN")},this.seeds={round:new ParkMillerPRNG,main:new ParkMillerPRNG},elem("CANVAS",canvas=>{canvas.width=4e3,canvas.height=4e3,this.skinBlob.canvas=canvas;let ctx=canvas.getContext("2d");this.skinBlob.ctx=ctx}),elem("CANVAS",canvas=>{canvas.width=4e3,canvas.height=4e3,this.skinBlobTemp.canvas=canvas;let ctx=canvas.getContext("2d");this.skinBlobTemp.ctx=ctx}),elem("CANVAS",canvas=>{canvas.width=520,canvas.height=1560,this.skin.canvas=canvas;let ctx=canvas.getContext("2d");this.skin.ctx=ctx}),elem("CANVAS",canvas=>{canvas.width=520,canvas.height=1560,this.skinTemp.canvas=canvas;let ctx=canvas.getContext("2d");this.skinTemp.ctx=ctx}),elem("CANVAS",canvas=>{canvas.width=1100,canvas.height=100,this.skinParticle.canvas=canvas;let ctx=canvas.getContext("2d");this.skinParticle.ctx=ctx}),elem("CANVAS",canvas=>{canvas.width=1100,canvas.height=100,this.skinParticleTemp.canvas=canvas;let ctx=canvas.getContext("2d");this.skinParticleTemp.ctx=ctx}),elem("CANVAS",canvas=>{canvas.width=780,canvas.height=520,this.skinGarb.canvas=canvas;let ctx=canvas.getContext("2d");this.skinGarb.ctx=ctx}),elem("CANVAS",canvas=>{canvas.width=1600,canvas.height=400,this.skinGarbTemp.canvas=canvas;let ctx=canvas.getContext("2d");this.skinGarbTemp.ctx=ctx}),this.henshinBg={},this.feverBg={},this.wormholeBg={},this.insaneEye={canvas:new OffscreenCanvas(200,200),ctx:void 0},this.insaneEye.ctx=this.insaneEye.canvas.getContext("2d"),this.pressStr=0,this.isRoundNext=!1,this.isRoundActive=!1,this.roundNextTime=-20,this.pressFlagInput={},this.visualFrames=0,this.misc={};this.matchSignal={html:{ready:id("OVERLAY-MS-READY"),start:id("OVERLAY-MS-START")},separator:{ready:new TextToHTMLLetterSeparator},main:new FrameRenderer(0,180,(frame,max)=>{if(frame<=120){let array=this.matchSignal.separator.ready.a,length=array.length;frame<110&&styleelem(this.matchSignal.html.ready,"animation-delay",~~(1e3/-60*Math.max(0,frame-30))+"ms"),30==frame&&sound.play("ready");for(let h=0;h<length;h++){let o=frame;120===frame&&(o=-1,styleelem(array[h],"opacity","0%")),styleelem(array[h],"animation-delay",~~(1e3/-60*Math.max(0,o))+"ms")}}if(frame<=180&&frame>59){let o=frame-120;7==o&&sound.play("start"),styleelem(this.matchSignal.html.start,"animation-delay",~~(1e3/-60*Math.max(0,o))+"ms")}})},this.replay={data:{},isOn:!1,isFile:!1,replays:[],replaysIndex:0},this.animations={fadein:new AnimationFrameRenderer(id("GTRIS-OVERLAY"),0,14,1e3/60,{name:"blackfade-in",timing:"linear"}),fadeout:new AnimationFrameRenderer(id("GTRIS-OVERLAY"),0,14,1e3/60,{name:"blackfade-out",timing:"linear"}),mswhready:new AnimationFrameRenderer(this.matchSignal.html.start,0,180,1e3/60,{name:"matchsignal-wormhole-ready",timing:"linear"}),mswhstart:new AnimationFrameRenderer(this.matchSignal.html.start,0,180,1e3/60,{name:"matchsignal-wormhole-start",timing:"linear"})},this.animationNames=Object.keys(this.animations),this.delayHandlers=[],this.continuousDelayHandlers=[],this.isGameLoaded=!0,this.isPlayerJsonLoaded=!0,this.targetPointSystem={initial:70,previous:70,iteration:0,iterIncDel:16*this.FPS,marginTime:1*this.FPS,targetPoint:90,on:!1,prep:{marginTime:1*this.FPS,initial:70}},this.numberExecHandlers={insaneMFX:new NumberChangeFuncExec(-1,am=>{background.setFGColor(0,0,0,0),1==am&&(music.play("insane",!0),background.setFGColor(0,0,0,.5)),6==am&&(music.play("insane_phylum",!0),background.setFGColor(0,0,0,.5)),7==am&&music.play("wmw_eval_phylum",!0),8==am&&(music.play("insane_phylum_continuation",!0),background.setFGColor(0,0,0,.5)),3==am&&music.play("wmw_eval"),2==am&&music.play("insane_transform"),4==am&&music.play("warning"),5==am&&music.play("game_match",!0),0==am&&music.stopAll()}),wormholeLoop:new NumberChangeFuncExec(-1,am=>{1==am&&sound.play("wormhole_loop"),0==am&&sound.stop("wormhole_loop")}),zerohp:new NumberChangeFuncExec(-1,am=>{am>=1?sound.play("rpg_zerohp"):sound.stop("rpg_zerohp")})},this.isFinish=!1,this.swapMode={on:!1,pickDel:120,blockOrBlob:0,time:0,decidedBlockOrBlob:0,maxTime:30*this.FPS,swapDel:-90},this.woiMode={isEvaluation:!1,shoot:0,time:0,restart:-9,timeDelay:-9,maxTime:80*this.FPS,rounds:0,loopRate:-1},this.timer=new FunctionTimer(this,(q,p)=>{if(3===this.inGameParameters.mode)this.timerDisplay.display(q),q<=0&&this.forEachPlayer(player=>{player.block.insane.isCommandedEnd=!0,player.blob.insane.isCommandedEnd=!0}),q<=10*this.FPS&&q>=0&&(q%this.FPS==0&&q>0&&(q>=4*this.FPS?sound.play("timer2_1"):q<=3*this.FPS&&sound.play("timer2_2")),0==q&&sound.play("timer_zero"))}),this.timerDisplay=new class{constructor(w){this.parent=w,this.timer=id("OVERLAY-TIMER-TEXT"),this.container=id("OVERLAY-TIMER-DIV"),this.isActive=!1}showHide(toggle){this.isActive=toggle,styleelem(this.container,"display",this.isActive?"flex":"none")}display(frame){let seconds=Math.ceil(frame/game.FPS),minutes=~~(seconds/60);ihelem(this.timer,`${minutes}:${~~(seconds/10)%6}${seconds%10}`)}}(this),this.timerDisplay.showHide(!1),this.actualParameters={mode:0,active:0,players:[],data:{},maxWins:5},this.inGameParameters={mode:null,active:0,players:{},playerOrder:[],data:{},isRPG:!1,round:0,maxWins:5},this.round=0,this.startGameParameters={frame:-28,type:""},this.enableWarning=!1,this.voiceVolume=1,this.isEverybodyPlay=!1,this.isPhylum=!1,this.winnerDeclaration={frames:-1,winners:[],losers:[]},this.inputFrames=0,this.bufferFrames=0,this.online={isOn:!1,frames:{},predictedInputs:[],isPrepared:!1,timeoutFrames:12e3,noPacketFrame:0}}addLoop(id,func){if("object"==typeof this.#customLoops.getItem(id))throw'a loop with this id "'+id+'" already exists! Yhrowing an error...';this.#customLoops.addItem(id,func)}removeLoop(id){if("undefined"===!this.#customLoops.getItem(id))throw'a loop with this id "'+id+'" already exists! Yhrowing an error...';this.#customLoops.remove(id)}getLoop(id){return this.#customLoops.getItem(id)}setupPlayers(){}createPlayerParam(name,team,char,ver,mode,isAi,rpg,params){return{character:char,team:team||0,version:ver,name:name,isAi:isAi,mode:mode,other:params,rpg:rpg}}setupAnimationElement(e,opacity,name,duration,timing){styleelem(e,"opacity",opacity),styleelem(e,"animation-name",name),styleelem(e,"animation-duration",~~(1e3/60*duration)+"ms"),styleelem(e,"animation-timing-function",timing),styleelem(e,"animation-play-state","paused")}resetReadyMatchSignal(state){let f=id("OVERLAY-MS-READY"),l=id("OVERLAY-MS-START");for(let e of this.matchSignal.separator.ready.a)styleelem(e,"animation","none"),e.offsetHeight;if(styleelem(f,"animation","none"),f.offsetHeight,styleelem(f,"animation-play-state","paused"),styleelem(l,"animation","none"),l.offsetHeight,styleelem(l,"animation-play-state","paused"),1==state){this.setupAnimationElement(f,"100%","matchsignal-body-anim-spacing",90,"cubic-bezier(0,1,0,1)");for(let o=0,q=this.matchSignal.separator.ready.a,e=q[o];o<q.length;o++,e=q[o])0==o?(this.setupAnimationElement(e,"100%","matchsignal-let-anim-first",120,"linear"),styleelem(e,"font-family","copd-bold")):this.setupAnimationElement(e,"100%","matchsignal-let-anim",120,"linear");this.setupAnimationElement(l,"0%","matchsignal-body-anim-start",50,"linear"),this.matchSignal.main.reset(0)}else 2==state?(styleelem(f,"opacity","0%"),styleelem(l,"opacity","0%"),this.matchSignal.main.toggleEnable(!1)):0==state&&(this.matchSignal.main.toggleEnable(!1),styleelem(f,"opacity","0%"),styleelem(l,"opacity","0%"))}addDelayHandler(delay,func,isContinuous){let a=this.delayHandlers;isContinuous&&(a=this.continuousDelayHandlers),a.push(new this.#DelayHandler(delay,func))}runDelayHandler(isContinuous){let a=this.delayHandlers;isContinuous&&(a=this.continuousDelayHandlers);let b=a.length;for(let c=0;c<b;c++)a[c].delay--,0==a[c].delay&&(a[c].func(),a.splice(c,1),b--,c--)}#fetchLoaded={};#fetchLoad(directory,type){return this.#fetchLoaded[directory]}initGame(){splash.showHide(!0,__main_params__.appinfo.android),alertWindow.showhide(!1),__main_params__.appinfo.android?(__main_params__.accessible.callSyncJava(k=>{k.switchLanguage(menu.storage.getItem("lang",""))}),__main_params__.database.read("local_data","userdata",async ev=>{void 0!==ev&&(menu.storage.loadUserData(ev.value),menu.storage.loadData(ev.value)),this.loadAssets()})):__main_params__.database.read("local_data","userdata",async ev=>{void 0!==ev&&(menu.storage.loadUserData(ev.value),menu.storage.loadData(ev.value));let version=menu.storage.getItem("version"),newVersion=__main_params__.appinfo.version;version!=newVersion&&(menu.storage.setItem("version",newVersion),menu.storage.setItem("patchnote_is_seen",0),menu.storage.save()),this.loadAssets()}),this.synchroLoop.confirmIsAsync=!0,this.synchroLoop.start(),menu.storage.initialize()}endGame(isForce){this.replay.isOn?touchButtons.enableControllers(!0):(this.replay.replays.push(JSON.stringify(this.replay.data)),menu.replayDataString=this.replayDataToString()),this.isRunning=!1,this.synchroLoop.confirmIsAsync=!0,this.isRoundActive=!1,this.matchEndHandler.hasEnded=!0,this.isFinish=!0,isForce&&(this.pause.on=!0),this.loopParams.isInsane=0,this.loopParams.zerohp=0,this.pause.on=!0,this.online.isOn=!1,this.showEndGameMenu()}showEndGameMenu(){let selectors=[];if(this.replay.isOn){let md=[];this.replay.isFile||online.isOnline||md.push({string:"gameend_startover",type:"button",action:"restart",onstate:"#ffff",offstate:"#fff2",desc:"gameend_startover_desc"}),online.isOnline||(md.push({string:"gameend_watchreplay",type:"button",action:"replayreload",onstate:"#ffff",offstate:"#fff2",desc:"gameend_watchreplay_desc"}),md.push({string:"gameend_replaycenter",type:"button",action:"replaycenter",onstate:"#ffff",offstate:"#fff2",backable:!0,desc:"gameend_replaycenter_desc"}));for(let lo of md)selectors.push(lo);this.replay.isFile||selectors.push({string:"gameend_downloadreplay",type:"button",action:"replaydownload",onstate:"#ffff",offstate:"#fff2",desc:"gameend_downloadreplay_desc"})}else{this.replay.isFile||online.isOnline||selectors.push({string:"gameend_startover",type:"button",action:"restart",onstate:"#ffff",offstate:"#fff2",desc:"gameend_startover_desc"});let zn=[];online.isOnline||zn.push({string:"gameend_watchreplay",type:"button",action:"replayreload",onstate:"#ffff",offstate:"#fff2",desc:"gameend_watchreplay_desc"}),online.isOnline||zn.push({string:"gameend_replaycenter",type:"button",action:"replaycenter",onstate:"#ffff",offstate:"#fff2",backable:!0,desc:"gameend_replaycenter_desc"});for(let lo of zn)selectors.push(lo);this.replay.isFile||selectors.push({string:"gameend_replay_download",type:"button",action:"replaydownload",onstate:"#ffff",offstate:"#fff2",desc:"gameend_replay_download_desc"})}online.isOnline?selectors.push({string:"gameend_online_mainmenu",type:"button",action:"online_menu",onstate:"#ffff",offstate:"#fff2",desc:"gameend_online_mainmenu_desc"}):selectors.push({string:"gameend_mainmenu",type:"button",action:"mainmenu",onstate:"#ffff",offstate:"#fff2",desc:"gameend_mainmenu_desc"});let gson={def:0,sel:selectors,title:this.replay.isOn?"gameend_replay_title":"gameend_title",name:"main",background:{type:"rgba",color:"#0004"}};menu.changeMenu(JSON.stringify(gson),!1),menu.showMenu(!0)}async loadAssets(){try{menu.characterMenu.setupAnims(),await language.load("en-US");let h=await load("./assets/init/init.json","text"),hh=JSON.parse(h),count=0,evt=(max,path)=>{count++;let p=language.translate("loading_init",[path]);count==max&&(p=language.translate("loading_init_other")),ih("SPLASH-TEXT-TEXT",`<gtris-plextext style="width:100%">${language.translate("loading_note")}<br />${p}</gtris-plextext><gtris-bar style="width: ${this.aspectResolution.w}px; background: #fff2; height: 1em; display: inline-block; bottom: 0"> <gtris-bar style="width: ${~~(this.aspectResolution.w*(count/max))}px; background: #fff; height: 1em; display: inline-block"> ${~~(count/max*100)}%</gtris-bar> </gtris-bar>`),this.checkGameLoad(count,max)},files=Object.keys(hh),fmax=files.length;for(let ge=0;ge<fmax;ge++){let g=hh[files[ge]];"image"==g.type?loadImage(g.path).then(img=>{this.#fetchLoaded[g.path]=img,evt(fmax,g.path)}):load(g.path,g.type).then(o=>{this.#fetchLoaded[g.path]=o,evt(fmax,g.path)})}}catch(e){}}async checkGameLoad(count,max){if(count>=max){menu.presetSettings=JSON.parse(this.#fetchLoad("./assets/settings/settings.json")),menu.checkStorageSettings(),this.assetHTML=this.#fetchLoad("./assets/field/main2.xml","text"),this.assetStyle=this.#fetchLoad("./assets/field/main2.css","text");let bpres=this.#fetchLoad("./assets/field/blobs_preset.json","text"),mbpres=this.#fetchLoad("./assets/field/microblob_preset.json","text"),gpres=this.#fetchLoad("./assets/field/blocks_preset.json","text");this.presets.blobNormal=JSON.parse(bpres),this.presets.blobMicro=JSON.parse(mbpres),this.presets.blockNormal=JSON.parse(gpres),this.misc.ai=this.#fetchLoad("./assets/ai_script/ai_sapphirus_core.js","text"),this.misc.ai_original=this.#fetchLoad("./assets/ai_script/ai_neoplex.js","text"),this.misc.ai_blob_original=this.#fetchLoad("./assets/ai_script/ai_neoplex_blob_core.js","text"),this.misc.ai_blob_functions=this.#fetchLoad("./assets/ai_script/ai_neoplex_blob_funcs.js","text"),this.misc.ai_blob_sapphirus=this.#fetchLoad("./assets/ai_script/ai_sapphirus_blob.js","text"),this.misc.blob_target=this.#fetchLoad("./assets/field/blob_target.png","image");let tspinImg=this.#fetchLoad("./assets/field/tspin.png"),tspinminiImg=this.#fetchLoad("./assets/field/mini.png"),henshinImg=this.#fetchLoad("./assets/field/henshin.png"),feverImg=(this.#fetchLoad("./assets/field/insane_eye.png"),this.#fetchLoad("./assets/field/fever.png")),frenzyImg=this.#fetchLoad("./assets/field/frenzy.png"),wormholeImg=this.#fetchLoad("./assets/field/wormhole.png");this.misc.menu_cs_border_black=this.#fetchLoad("./assets/menu/images/cs_border_black.png"),this.misc.menu_cs_border_yellow=this.#fetchLoad("./assets/menu/images/cs_border_yellow.png"),this.misc.menu_cs_border_green=this.#fetchLoad("./assets/menu/images/cs_border_green.png"),this.misc.menu_cs_back=this.#fetchLoad("./assets/menu/images/cs_back.png"),this.misc.menu_cs_removeplayer=this.#fetchLoad("./assets/menu/images/cs_removeplayer.png"),this.misc.menu_cs_team=this.#fetchLoad("./assets/menu/images/cs_team.png"),this.misc.menu_back_normal=this.#fetchLoad("./assets/menu/images/back_normal.png"),this.misc.menu_back_hover=this.#fetchLoad("./assets/menu/images/back_hover.png"),this.misc.menu_back_press=this.#fetchLoad("./assets/menu/images/back_press.png"),this.misc.menu_cs_mode_pick=this.#fetchLoad("./assets/menu/images/cs_mode_pick.png"),this.misc.menu_switch_on=this.#fetchLoad("./assets/menu/images/switch_on.png"),this.misc.menu_switch_off=this.#fetchLoad("./assets/menu/images/switch_off.png"),this.misc.block_next=this.#fetchLoad("./assets/field/block_next.png"),this.misc.block_hold=this.#fetchLoad("./assets/field/block_hold.png"),this.misc.block_nextqueue=this.#fetchLoad("./assets/field/block_nextqueue.png"),this.misc.team_colors=this.#fetchLoad("./assets/field/team_colors.png");let image=this.#fetchLoad("./assets/skins/default/block.png");this.skinTemp.ctx.drawImage(image,0,0,520,1560,0,0,520,1560);let imageBlob=this.#fetchLoad("./assets/skins/default/blob.png");this.skinBlobTemp.ctx.drawImage(imageBlob,0,0,4e3,4e3,0,0,4e3,4e3);let imageGarb=this.#fetchLoad("./assets/skins/default/garbage_block.png");this.skinGarbTemp.ctx.drawImage(imageGarb,0,0,1600,200,0,0,1600,200),this.skinGarbTemp.ctx.drawImage(this.#fetchLoad("./assets/skins/default/garbage_blob.png"),0,0,1600,200,0,200,1600,200);let imageParticle=this.#fetchLoad("./assets/skins/default/particle.png");particle.addImage("attack",imageParticle,100,100);let imageAppear=this.#fetchLoad("./assets/field/appear_block.png");this.skinAppear.ctx.drawImage(imageAppear,0,0,700,280,0,0,700,280);let imageClear=this.#fetchLoad("./assets/field/clear_block.png");this.skinClear.ctx.drawImage(imageClear,0,0,700,420,0,0,700,420),elem("CANVAS",n=>{let particleBlobCtx=getCanvasCtx(n);n.width=1100,n.height=200;for(let y=0;y<5;y++)particleBlobCtx.drawImage(imageBlob,0,250*y,250,250,100*y,0,100,100);for(let y=0;y<11;y++)particleBlobCtx.drawImage(image,0,130*y,130,130,100*y,100,100,100);particleBlobCtx.drawImage(imageBlob,0,1250,250,250,500,0,100,100),particle.addImage("blobblock",n,100,100)}),this.henshinBg=henshinImg,this.feverBg=feverImg,this.frenzyBg=frenzyImg,this.wormholeBg=wormholeImg,this.misc.tspin=tspinImg,this.misc.tspinmini=tspinminiImg,this.misc.menu_cs_border_black=this.#fetchLoad("./assets/menu/images/cs_border_black.png"),loadingScreen.images.gate1=this.#fetchLoad("./assets/menu/loading/images/gate1.png"),loadingScreen.images.gate2=this.#fetchLoad("./assets/menu/loading/images/gate2.png"),language.loadImgsByJson(this.#fetchLoad("./assets/init/lang_images.json"));let faviconURL=URL.createObjectURL(this.#fetchLoad("./assets/favicon/favicon.png"));id("SW-LOGO").src=faviconURL,elem("LINK",ma=>{ma.setAttribute("rel","icon"),ma.setAttribute("href",faviconURL),document.head.append(ma)});let mmm=[{dir:this.#fetchLoad("./assets/field/blob_hit.png"),name:"blob_hit"},{dir:this.#fetchLoad("./assets/field/block_hit.png"),name:"block_hit"},{dir:this.#fetchLoad("./assets/field/wormhole_explosion.png"),name:"wormhole_explosion"},{dir:this.#fetchLoad("./assets/field/wormhole.png"),name:"wormhole"},{dir:this.#fetchLoad("./assets/field/fever_shine.png"),name:"fever_shine"},{dir:this.#fetchLoad("./assets/field/swap_roulette.png"),name:"swap_roulette"},{dir:this.#fetchLoad("./assets/field/perfect_clear.png"),name:"perfect_clear"}];for(let ll=0;ll<5;ll++)mmm.push({dir:this.#fetchLoad(`./assets/skins/default/blob_pop${ll+1}.png`),name:`blob_pop${ll+1}`});animatedLayers.loadOfflineArr(mmm),await feverGaugeStorage.load("./assets/field/fever_gauge.png","./assets/field/fever_timer.png"),await background.loadBg(),game1v1.loadAImgOffline([{name:"overhead_center",image:this.#fetchLoad("./assets/field/overhead_1v1_center.png"),w:27,h:200,frame:120,bound:30}]),await menu.load(),splash.splashImage=this.#fetchLoad("./assets/splash/controls.png"),this.resize(),menu.setupMouseListener(),menu.showMenu(!0),menu.checkData(),splash.toggleRunner(!0)}}startReplay(isFile){this.replay.isFile=isFile,this.startGameSet("replay")}downloadReplayData(){btoa(this.replayDataToString())}parseReplayFile(jsonString,index,round,isFile){try{let json=JSON.parse(jsonString);if(this.replay.replays.length=0,"replays"in json)for(let h=index;h<json.replays.length&&h<round;h++)this.replay.replays.push(json.replays[h]);this.startReplay(isFile)}catch(e){}}setActualParameters(){let a=menu.storage,b={};switch(this.actualParameters.mode){case 0:b.insaneStart=a.getValueFromRangeListSpecific("set_prep_insane_start"),b.professional=a.getItem("set_prep_professional(zen)"),b.tsdonly=a.getItem("set_prep_tsdonly(zen)");break;case 1:b.professional=a.getItem("set_prep_professional(vs)"),b.maxWins=a.getItem("set_prep_wins(vs)");break;case 2:b.maxWins=a.getItem("set_prep_wins(swap)");break;case 3:b.maxWins=a.getItem("set_prep_wins(wmw)");break;case 4:b.maxWins=a.getItem("set_prep_wins(fever)");break;case 5:break;case 7:b.maxWins=a.getItem("set_prep_wins(rpg)")}this.actualParameters.data=b}setModeParameters(mode){sound.stop("wormhole_loop"),sound.stop("wormhole_ready"),this.woiMode.timeDelay=-9,this.woiMode.rounds=0,this.timer.enabled=0,this.timer.set(-9),this.timer.setMax(10*game.FPS),this.timerDisplay.showHide(!1),this.isRoundActive=!1,this.isProfessional=!1,this.misc.zenkeshi=language.getImage("images/zenkeshi.png"),this.targetPointSystem.on=!1,this.targetPointSystem.prep.initial=70,this.targetPointSystem.prep.marginTime=5760;let blobColors=[1,2,3,4,5],defaultBlobColors=[1,2,3,4,5];switch(sortRandomInt(blobColors,()=>this.seeds.main.next()),this.forEachPlayer(player=>{player.initialGarbage=0,player.player in this.inGameParameters.players||(this.inGameParameters.players[player.player]={}),this.inGameParameters.players[player.player].wins=this.replay.data.players[player.player].wins;let blub=player.blob,block=player.block;block.piece.is180able=!1,player.blob.colorSet=blobColors,block.insane.isCommandedEnd=!1,blub.insane.isCommandedEnd=!1,blub.garbageOrder.on=!1,blub.isChainOffsetting=!1,player.blob.insane.isUnlimited=player.block.insane.isUnlimited=0,player.feverStat.isUseTimer=!1,blub.insane.timeAdditions.timeAddMult=block.insane.timeAdditions.timeAddMult=0,blub.insane.timeAdditions.fixedTimeAdd=block.insane.timeAdditions.fixedTimeAdd=0,blub.insane.timeAdditions.allClear=block.insane.timeAdditions.allClear=0,player.simulPresses.enabled=!0,blub.insane.initialStart=!1,block.insane.initialStart=!1,blub.insane.initialStartHenshin=!1,block.insane.initialStartHenshin=!1,block.isAllSpin=!1,player.rpgAttr.reset(),player.rpgAttr.resetAttributes(),player.rpgAttr.enableSkills=!1,player.rpgAttr.isUsableSkills=!1,player.block.isTSDOnly=!1,ihelem(player.getAsset("WINS-TEXT"),player.wins)}),mode){case 0:{this.isSolo=!0;let p=this.getRDDataKey("insaneStart","0-0").split("-"),professional=1==this.getRDDataKey("professional",0),tsdonly=1==this.getRDDataKey("tsdonly",0);this.forEachPlayer(player=>{~~p[0]>0&&(player.block.insane.initialStart=0==player.activeType,player.blob.insane.initialStart=1==player.activeType,player.block.insane.initialStartHenshin=0==player.activeType,player.blob.insane.initialStartHenshin=1==player.activeType),player.blob.insane.delay.readyHenshin=1==player.activeType&&3==p[0]?6:-9,player.block.insane.delay.ready=0==player.activeType&&1==p[0]?6:-9,player.blob.insane.delay.ready=1==player.activeType&&2==p[0]?6:-9,player.blob.insane.timeAdditions.timeAddMult=1.5,player.blob.insane.fixedHenshinType=1==player.activeType?~~p[1]:0,player.initialGarbage=0,professional&&(player.block.isProfessional=!0,player.block.isAllSpin=!0,player.block.piece.is180able=!0),tsdonly&&(player.block.isTSDOnly=!0)}),this.isProfessional=professional;break}case 1:{this.targetPointSystem.on=!0,this.forEachPlayer(player=>{});let professional=1==this.getRDDataKey("professional",0);this.forEachPlayer(player=>{1===player.activeType&&(professional=!1)}),this.isProfessional=professional,this.isProfessional&&this.forEachPlayer(player=>{player.block.isProfessional=!0,player.block.isAllSpin=!0,player.block.piece.is180able=!0});break}case 2:this.swapMode.on=!0,this.targetPointSystem.on=!0,this.forEachPlayer(player=>{player.blob.insane.delay.ready=player.block.insane.delay.ready=0,player.switchModeType(0),player.swapMode.isOn=!0,player.enableAuxField(!0),player.block.meteredGarbageWaitMode=!1,player.block.attackType="scorebasedSwap",player.garbageBlocking="full",player.initialGarbage=0,player.setStyle("HOLD","display",0==player.activeType?"block":"none"),player.adjustBlobBlockBG(0),player.block.garbageLimit=8,player.blob.isChainOffsetting=!0}),this.swapMode.decidedBlockOrBlob=~~(2*this.seeds.main.next()),this.swapMode.blockOrBlob=this.swapMode.decidedBlockOrBlob,this.swapMode.pickDel=220,this.timerDisplay.showHide(!0);break;case 3:this.woiMode.on=!0,this.woiMode.timeDelay=1.5*this.FPS,this.timer.enabled=1,this.timer.set(80*this.FPS),this.timer.setMax(80*this.FPS),this.forEachPlayer(player=>{player.blob.insane.delay.ready=player.block.insane.delay.ready=3,player.blob.insane.isUnlimited=player.block.insane.isUnlimited=!0,player.block.insane.initialStart=!0,player.blob.insane.initialStart=!0,player.block.attackType="scorebasedWMW",player.blob.insane.maxTime=player.block.insane.maxTime=this.woiMode.maxTime=4800,player.blob.colors=4,player.isGarbageCollectionMode=!0,player.blob.insane.isExtra=!1,player.woi.isOn=!0,player.isInsaneModeOnly=!0,player.rpgAttr.openClose(!0),player.rpgAttr.setMaxHP(200),player.rpgAttr.reset(),player.rpgAttr.isWOIHPMode=!0,player.block.attackType="scorebased"}),this.timerDisplay.showHide(!0);break;case 4:this.targetPointSystem.prep.initial=120,this.targetPointSystem.prep.marginTime=11520,this.targetPointSystem.on=!0,this.forEachPlayer(player=>{player.switchModeType(1);let blob=player.blob;blob.isFever=!0,blob.isSpecialDropset=!0,player.garbageBlocking="full",player.feverStat.enable(!0),player.blob.insane.isUnlimited=player.block.insane.isUnlimited=!1,blob.dropsetReset(player.character.blob.dropset),blob.insane.timeAdditions.timeAddMult=1,blob.insane.timeAdditions.fixedTimeAdd=0,blob.insane.timeAdditions.allClear=5,blob.insane.timeMax=99,player.feverStat.isUseTimer=!0,blob.garbageOrder.on=!0,player.blob.insane.isExtra=!0,blob.colorSet=defaultBlobColors});break;case 7:this.targetPointSystem.on=!0,this.targetPointSystem.prep.initial=70,this.targetPointSystem.prep.marginTime=19200,this.forEachPlayer(player=>{let ap=this.replay.data.players[player.player].rpg;player.rpgAttr.isRPG=!0,player.rpgAttr.openClose(!0),player.rpgAttr.setMaxHP(ap.hp),player.rpgAttr.setMaxMana(ap.mana),player.rpgAttr.reset(),player.rpgAttr.resetAttributes();let pr=player.rpgAttr.attributes;pr.attack=ap.atk,pr.defense=ap.def,pr.lifesteal=ap.lifesteal,pr.lfa=ap.lfa,pr.deflect=ap.deflect;for(let pm=0;pm<3;pm++){let rs=player.rpgAttr.deck.characters[pm],om=ap.cards[pm].char.split("|");rs.character=~~om[0],rs.version=~~om[1],rs.skill.rawDesc=ap.cards[pm].rawdesc.split("|"),rs.skill.maxCD=ap.cards[pm].cd,rs.skill.mana=ap.cards[pm].mana,rs.skill.skillVoice=ap.cards[pm].voice,rs.skill.skillStatusEffects=ap.cards[pm].attr,rs.skill.name=ap.cards[pm].name,rs.skill.skillValues=ap.cards[pm].skillvalues;let strDesc="",lms=ap.cards[pm].desc.split(","),con=0;for(let g of lms)strDesc+=language.translate(`rpg_skilldesc_${g.trim()}`),con++,con<lms.length&&(strDesc+=",");rs.skill.desc=strDesc}player.garbageBlocking="linkblob-full",player.block.garbageLimit=8,player.blob.isChainOffsetting=!0}),this.forEachPlayer(player=>{player.rpgAttr.addStatusEffect(player.player,"regen","unli",{maxf:60,value:2})});break;case 8:this.isSolo=!0,this.forEachPlayer(player=>{player.garbageBlocking="linkblob-full",player.block.garbageLimit=8,player.blob.isChainOffsetting=!0,professional&&(player.block.isProfessional=!0,player.block.isAllSpin=!0,player.block.piece.is180able=!0)}),this.isProfessional=professional}}setRDDataKey(key,value){this.replay.data.data[key]=value}getRDDataKey(key,value){return this.replay.data.data[key]}startGameSet(m){this.startGameParameters.frame=43,loadingScreen.toggleOn(),loadingScreen.isOpenable=!1,this.startGameParameters.type=m}outputReplayData(){}initialize(mode,replay,parameters,isNext,isOnline){if(replay)this.replay.isOn=!0,this.replay.replaysIndex=0,this.parseReplayData(this.replay.replays[this.replay.replaysIndex]);else{this.replay.isOn=!1,this.replay.isFile=!1,keypressManager.setupKeybinds();let _mode=mode;"actualparameter"===mode&&(_mode=this.actualParameters.mode),this.replay.replays.length=0,isOnline||this.setActualParameters(),this.createReplayData(!0,_mode,0)}this.matchEndHandler.endable=!1,this.matchEndHandler.frame=-9,this.matchEndHandler.on=!1,this.matchEndHandler.isFinishActual=!1,this.matchEndHandler.hasEnded=!1,this.isEverybodyPlay=!1,this.replay.replaysIndex=0,sound.load("default"),this.enableWarning=menu.storage.getItem("set_session_fieldwarning",0),isNext||(music.resetAllSeek(),this.numberExecHandlers.insaneMFX.assign(0)),this.prepareInRoundAssets(),this.unpauseGame()}initializeNext(replay){replay?this.replay.replays.length>this.replay.replaysIndex&&(this.replay.replaysIndex++,this.parseReplayData(this.replay.replays[this.replay.replaysIndex]),this.prepareInRoundAssets(!0)):(this.inGameParameters.round++,this.replay.replays.push(JSON.stringify(this.replay.data)),this.createReplayData(!1,this.inGameParameters.mode,this.inGameParameters.round),this.prepareInRoundAssets(!0))}createRandomSeed(){return~~(2147483647*this.seeds.round.next())}createReplayData(reset,_mode,round){reset&&(this.inGameParameters.round=0);let m=void 0!==_mode?_mode:this.inGameParameters.mode,title="No Title";title=`Round ${this.inGameParameters.round+1}`,this.replay.data={players:{},playerOrder:this.actualParameters.playerOrder,data:{mode:m,seed:this.createRandomSeed(),round:round,maxWins:this.actualParameters.data.maxWins,title:title}};for(let h in this.actualParameters.data)this.replay.data.data[h]=this.actualParameters.data[h];for(let si=0;si<this.replay.data.playerOrder.length;si++){let i=this.replay.data.playerOrder[si];reset&&(this.inGameParameters.players[i]={wins:0}),this.replay.data.players[i]={keyData:{},name:this.actualParameters.players[i].name||"No Name",character:this.actualParameters.players[i].character,version:this.actualParameters.players[i].version,mode:this.actualParameters.players[i].mode,rpg:this.actualParameters.players[i]?.rpg||{},wins:this.inGameParameters.players[i].wins,team:this.actualParameters.players[i].team||0,color:["55BBFF","FF5555","55FF55","FF55BB"][i]}}}parseReplayData(replayData){let json=JSON.parse(replayData);this.replay.data=json}loadMusic(){let lm=[{name:"insane",path:"insane2",continuable:this.woiMode.on,bpmSync:{active:!1}},{name:"insane_transform",path:"insane_transform",continuable:!1,bpmSync:{active:!1}},{name:"game_match",path:menu.storage.getValueFromRangeListSpecific("set_global_musicbank"),continuable:!0,bpmSync:{active:!1}}];this.woiMode.on&&lm.push({name:"wmw_eval",path:"wmw_eval",continuable:!1}),this.isPhylum&&(lm.push({name:"insane_phylum",path:"phylum",continuable:!1,bpmSync:{active:!0,bpm:240,timeSignature:1}}),this.woiMode.on&&(lm.push({name:"wmw_eval_phylum",path:"phylum_wmw",continuable:!1,bpmSync:{active:!0,bpm:240,timeSignature:1}}),lm.push({name:"insane_phylum_continuation",path:"phylum_continuation",continuable:!1,bpmSync:{active:!0,bpm:240,timeSignature:1}}))),this.enableWarning&&lm.push({name:"warning",path:"warning",continuable:!1}),music.load(lm)}prepareInRoundAssets(isms){this.inGameParameters.playerOrder=this.replay.data.playerOrder||Object.keys(this.replay.data.players),this.isRunning=!1,game1v1.overhead.openClose(5),this.isPhylum=!1,this.forEachPlayer(player=>{player.resetEmAnimation()}),this.winnerDeclaration.winners.length=0,this.winnerDeclaration.losers.length=0,this.round=this.replay.data.data.round,this.loopParams.isInsane=0,this.loopParams.zerohp=0,this.inputFrames=0,this.bufferFrames=0;let isChange=this.createPlayer(Object.keys(this.replay.data.players).length);this.pause.frame=-9,this.pause.on=!1,touchButtons.enableControllers(!this.replay.isOn),game1v1.on=2==Object.keys(this.players).length,this.isEverybodyPlay=Object.keys(this.players).length>2,menu.showMenu(!1),this.inGameParameters.mode=this.replay.data.data.mode,this.inGameParameters.round=this.replay.data.data.round,this.isFreezeHandlers=!1;let isChangeChars={},teamNumbers=[];this.forEachPlayer(player=>{let tem=this.replay.data.players[player.player].team;player.actualTeam=void 0!==tem?tem:0,-1==teamNumbers.indexOf(player.actualTeam)&&teamNumbers.push(player.actualTeam)}),this.forEachPlayer(async player=>{let c=gtcharacter.characters[this.replay.data.players[player.player].character],v=c.versions[this.replay.data.players[player.player].version];c.core.path,v.path;player.team=~~(teamNumbers.length>1&&this.playerCount>2&&player.actualTeam>0?player.actualTeam:0x4cadec57e15be8*Math.random());let change=player.loadCharacter(c.core.path,v.path);c.core.phylum&&(this.isPhylum=!0),player.isPhylum=c.core.phylum,change&&(isChangeChars[`${player.character.char}/${player.character.ver}`]=1),isChange&&await player.clearText.tspin.loadImages([this.misc.tspin,this.misc.tspinmini]),player.changeBodyColorHex(`0x${this.replay.data.players[player.player].color}`)}),Object.keys(isChangeChars).length&&playerVoiceSystem.unloadAll(isChangeChars);let seed=this.replay.data.data.seed;this.isFinish=!1,this.swapMode.on=!1,this.swapMode.swapDel=-8,this.swapMode.blockOrBlob=0,this.swapMode.decidedBlockOrBlob=0,this.woiMode.isEvaluation=!1,this.woiMode.time=-19,this.woiMode.restart=-19,this.swapMode.time=30*this.FPS,this.frames=0,this.delayHandlers.length=0,this.continuousDelayHandlers.length=0,this.isSolo=!1,this.pause.on=!1,this.woiMode.loopRate=-1,this.isRoundNext=!1,this.roundNextTime=-20,this.countdown=180,this.waitCountdown=50,this.inGameParameters.maxWins=this.replay.data.data.maxWins,this.seeds.main.seed=seed,this.resetReadyMatchSignal(0);let blobVsBlock={},isTwo=0;this.forEachPlayer(player=>{let jm=this.replay.data.players[player.player];player.wins=jm.wins,player.blob.dropsetReset([]),player.switchModeType(Math.min(1,this.replay.data.players[player.player].mode)),player.swapMode.isOn=!1,player.block.dasCancellation.on=!0;let mseed=~~(2147483647*this.seeds.main.next());player.block.rngPreview.seed=mseed,player.seeds.field.seed=mseed,player.rpgAttr.seed.seed=mseed,player.block.insane.rng.seed=mseed,player.blob.insane.rng.seed=mseed,player.blob.rngPreview.seed=seed,player.block.attackType="normal",player.blob.isSpecialDropset=!1,player.feverStat.enable(!1),player.ai.active=!this.online.isOn&&this.activePlayer!==player.player,player.activeType in blobVsBlock||(blobVsBlock[player.activeType]=1),player.setStyle("HOLD","display",0==player.activeType?"block":"none"),player.enableAuxField(!1),player.rpgAttr.openClose(!1),player.setPlayerName(jm.name),player.block.isDelayEnabled=!1,player.blob.isDelayEnabled=!1,player.blob.targetPoint=this.targetPointSystem.initial,player.isGarbageCollectionMode=!1,player.isInsaneModeOnly=!1,player.woi.isOn=!1,player.block.garbageLimit=0,player.blob.isFever=!1,player.woi.reset(),this.isEverybodyPlay&&player.updateTeam()}),1 in blobVsBlock&&0 in blobVsBlock&&(isTwo=1),animatedLayers.remove("swap_roulette_object"),this.forEachPlayer(player=>{player.meterBar.garbwait.toggle(!1),player.meterBar.right.toggle(!1),player.block.isProfessional=!1,player.block.meteredGarbageWaitMode=!1,player.garbageBlocking="limited"}),this.gameRunningParameters={hasChain:[]},this.setModeParameters(this.inGameParameters.mode),this.loadMusic(),this.targetPointSystem.marginTime=this.targetPointSystem.prep.marginTime,this.targetPointSystem.iterIncDel=16*this.FPS,this.targetPointSystem.initial=this.targetPointSystem.prep.initial,this.targetPointSystem.targetPoint=this.targetPointSystem.initial,this.targetPointSystem.previous=this.targetPointSystem.initial,this.forEachPlayer(player=>{player.block.isAux=!1,player.blob.isAux=!1,player.garbageType=player.activeType,isTwo&&(0===player.activeType?(player.meterBar.garbwait.toggle(!0),player.garbageType=1):player.garbageType=0,player.block.isProfessional=!1,player.block.meteredGarbageWaitMode=!0,player.block.attackType="scorebased",player.block.garbageLimit=8),player.block.isProfessional&&(player.simulPresses.enabled=!1,player.block.attackType="multiplier",player.garbageBlocking="full")}),music.volumeSet(menu.storage.getItem("set_global_mfx",0)),game1v1.winstat.openClose(game1v1.on),game1v1.on&&game1v1.winstat.setMaxWins(this.inGameParameters.maxWins);let bgChange=menu.storage.getValueFromRangeListSpecific("set_global_bgtype","0="),msks="Ready?";this.inGameParameters.maxWins>1&&!this.isSolo&&(msks="Round "+(this.round+1)),this.matchSignal.separator.ready.setSeparatedText(id("OVERLAY-MS-READY"),msks),ihelem(id("OVERLAY-MS-START"),"START");let bgType=bgChange.split("=")[0];switch(background.isOn=!1,bgType){case"0":background.canvas.style.background="#000";break;case"1":background.canvas.style.background="#900";break;case"2":background.canvas.style.background="#090";break;case"3":background.canvas.style.background="#009";break;case"4":background.isOn=!0,background.canvas.style.background="#000"}background.loadBg(bgChange),this.forEachPlayer(player=>{player.setStyle("METERBAR-GARBWAIT-LEFT","background",player.block.meteredGarbageWaitMode&&!player.woi.isOn?"#000":"rgba(0,0,0,0)")}),this.online.isOn&&!this.replay.isOn&&(this.online.isPrepared=!1),online.isReady=!1,this.startLoadLoop(isms)}resetPlayers(){this.forEachPlayer(player=>{let tempBlock=player.block.insane.delay.ready,tempBlob=player.blob.insane.delay.ready,tempHenBlock=player.block.insane.delay.readyHenshin,tempHenBlob=player.blob.insane.delay.readyHenshin;player.block.insane.initialStart||(tempBlock=-99),player.block.insane.initialStartHenshin||(tempHenBlock=-99),player.blob.insane.initialStart||(tempBlob=-99),player.blob.insane.initialStartHenshin||(tempHenBlob=-99),player.blob.dropsetReset(player.character.blob.dropset),player.reset(),player.block.insane.delay.ready=tempBlock,player.blob.insane.delay.ready=tempBlob,player.block.insane.delay.readyHenshin=tempHenBlock,player.blob.insane.delay.readyHenshin=tempHenBlob,player.addGarbage("system",[player.initialGarbage]),player.garbageLastForTray.assign(player.garbageLength)})}resetCountdown(){this.resetReadyMatchSignal(0),this.countdown=180,this.waitCountdown=10}startLoadLoop(){this.isGameLoaded&&this.loadLoop()}loadLoop(s){let loaded=!0,canLoad=!0,jsonLoaded=!0,isOnline=this.online.isOn&&!this.replay.isOn;if(sound.isReady&&music.isReady&&background.isReady||(canLoad=!1),this.forEachPlayer(player=>{player.character.load||(canLoad=!1),player.character.loadedJson||(canLoad=!1,jsonLoaded=!1)}),canLoad)if(isOnline){if(!this.online.isPrepared){this.online.isPrepared=!0;let wr=online.createWriter("MATCH_PREPARE",1),ms=1;for(let h in online.matchPlayers){let gs=online.matchPlayers[h];gs.id!==online.userID&&(gs.ready||(ms=0))}wr.u8(ms),online.send(wr.buffer)}loaded=online.isReady}else loaded=!0;else loaded=!1;if(loaded)this.isGameLoaded||(this.synchroLoop.confirmIsAsync=!1),this.isGameLoaded=!0,loadingScreen.isOpenable=!0,this.playAnimation("fadeout"),style("GTRIS-OVERLAY","background","#0000"),this.resize(),this.resetPlayers(),game1v1.on&&this.forEachPlayer(player=>{0==player.player&&(game1v1.winstat.loadPlayer("left",{red:player.color.r,green:player.color.g,blue:player.color.b}),game1v1.winstat.setWins("left",player.wins)),1==player.player&&(game1v1.winstat.loadPlayer("right",{red:player.color.r,green:player.color.g,blue:player.color.b}),game1v1.winstat.setWins("right",player.wins))}),this.forEachPlayer(player=>{player.block.drawStack(),player.block.drawActivePiece(),player.blob.targetPoint=this.targetPointSystem.initial,player.block.holdDraw(),player.framePackets={}}),this.online.timeoutFrames=12*this.FPS,this.online.frames={},this.online.predictedInputs.length=0,this.online.latestSimFrames=0;else{let l="";Object.keys(this.players).forEach(a=>{l+=`${a}: ${this.players[a].character.loadedJson}, `}),this.isGameLoaded&&this.resize(),loadingScreen.isOpenable=!1,this.isGameLoaded=!1,jsonLoaded!==this.isPlayerJsonLoaded&&(this.isPlayerJsonLoaded=jsonLoaded,jsonLoaded&&this.loadPlayerAssets()),window.requestAnimationFrame(()=>{this.loadLoop()})}}loadPlayerAssets(){let storage={},is1v1=game1v1.on,overheadSrcs={};if(this.forEachPlayer(player=>{player.loadAssets();let imageURLs=player.character.json.sources.image,mainDir=`/assets/characters/${player.character.char}/${player.character.ver}`;for(let file in imageURLs){let ref=`${mainDir}/${imageURLs[file]}`;storage[`${player.character.char}/${player.character.ver}/${file}`]=ref}}),this.forEachPlayer(player=>{let i=player.character.json,a=`${player.character.char}/${player.character.ver}`;if("ca_overhead"in i.init){let h=i.init.ca_overhead;i.sources.image[h.image];"image"in h&&(overheadSrcs[a]=storage[`${a}/${h.image}`])}}),is1v1){let left=this.players[0],right=this.players[1],ma=`${left.character.char}/${left.character.ver}`,mb=`${right.character.char}/${right.character.ver}`,n=[];for(let j in overheadSrcs)n.push({name:j,dir:overheadSrcs[j]});game1v1.overhead.loadImg(n),game1v1.overhead.loadPlayer("left",{image:ma,red:left.color.r,green:left.color.g,blue:left.color.b}),game1v1.overhead.loadPlayer("right",{image:mb,red:right.color.r,green:right.color.g,blue:right.color.b})}}resize(){this.resolution.w=Math.max(document.documentElement.clientWidth,window.innerWidth,1),this.resolution.h=Math.max(document.documentElement.clientHeight,window.innerHeight,1),style("CORE","width",`${this.resolution.w}px`),style("CORE","height",`${this.resolution.h}px`);let ms=this.isEverybodyPlay?.875:1,screenWidth=this.resolution.w,screenHeight=this.resolution.h,ratioWidth=screenWidth,ratioHeight=screenHeight,aspectRatio=this.aspectRatio;this.landscape.x=this.portrait.x=screenWidth,this.landscape.y=this.portrait.y=screenHeight,screenWidth<=screenHeight?(this.orientation="portrait",ratioHeight=Math.floor(Math.min(screenWidth*aspectRatio,screenHeight)),screenWidth*aspectRatio>=screenHeight&&(ratioWidth=screenWidth-(screenWidth*aspectRatio-screenHeight)/2),this.portrait.y=ratioHeight,this.portrait.x=ratioWidth,this.landscape.x=ratioWidth,this.landscape.y=Math.floor(ratioWidth/aspectRatio)):(this.orientation="landscape",ratioWidth=Math.floor(screenHeight*aspectRatio),this.landscape.y=ratioHeight,this.landscape.x=ratioWidth,this.portrait.x=ratioHeight,this.portrait.y=Math.floor(ratioHeight/aspectRatio));let cellSize=Math.max(ratioWidth,ratioHeight)/50*1,fontSizePerPx=16/__main_params__.appinfo.fontsize;this.fontSize=cellSize*fontSizePerPx,this.cellSize=~~cellSize,document.documentElement.style.fontSize=this.fontSize+"px",document.body.style["text-shadow"]=`-${fontSizePerPx}px 0 ${2*fontSizePerPx}px black, 0 ${fontSizePerPx}px ${2*fontSizePerPx}px black, ${fontSizePerPx}px 0 ${2*fontSizePerPx}px black, 0 -${fontSizePerPx}px ${2*fontSizePerPx}px black`,"landscape"==this.orientation&&(this.playerAreaSizeMult=.82,this.aspectResolution.w=this.landscape.x,this.aspectResolution.h=this.landscape.y),"portrait"==this.orientation&&(this.playerAreaSizeMult=1/this.aspectRatio*.82,this.aspectResolution.w=this.portrait.x,this.aspectResolution.h=this.portrait.y);for(let m of["SCREEN","GTRIS-AREA"])style(m,"width",`${this.aspectResolution.w}px`),style(m,"height",`${this.aspectResolution.h}px`);animatedLayers.cellSize=this.cellSize*this.playerAreaSizeMult,this.skinBlob.canvas.width=16*this.cellSize*this.resQualityMult,this.skinBlob.canvas.height=16*this.cellSize*this.resQualityMult,this.skinBlob.ctx.drawImage(this.skinBlobTemp.canvas,0,0,16*this.cellSize*this.resQualityMult,16*this.cellSize*this.resQualityMult),touchButtons.resize(this.orientation,this.resolution.w,this.resolution.h,this.aspectResolution.w,this.aspectResolution.h,this.cellSize),this.skin.canvas.width=4*this.cellSize*this.resQualityMult,this.skin.canvas.height=11*this.cellSize*this.resQualityMult,this.skin.ctx.drawImage(this.skinTemp.canvas,0,0,4*this.cellSize*this.resQualityMult,12*this.cellSize*this.resQualityMult),this.skinGarb.canvas.width=1600,this.skinGarb.canvas.height=400,this.skinGarb.ctx.drawImage(this.skinGarbTemp.canvas,0,0,1600,400,0,0,1600,400),this.skinParticle.canvas.width=11*this.cellSize,this.skinParticle.canvas.height=1*this.cellSize,this.skinParticle.ctx.drawImage(this.skinParticleTemp.canvas,0,0,11*this.cellSize,1*this.cellSize),style("BEHIND-OVERLAY-BACKGROUND","width",`${this.resolution.w}px`),style("BEHIND-OVERLAY-BACKGROUND","height",`${this.resolution.h}px`),style("BACKGROUND-FOREGROUND-LAYER","width",`${this.landscape.x}px`),style("BACKGROUND-FOREGROUND-LAYER","height",`${this.landscape.y}px`),style("PARTICLE-PARTICLE-CANVAS","width",`${this.resolution.w}px`),style("PARTICLE-PARTICLE-CANVAS","height",`${this.resolution.h}px`),style("OVERLAY-TIMER","width",`${this.resolution.w}px`),style("OVERLAY-TIMER","height",`${this.resolution.h}px`),style("OVERLAY-TIMER-DIV","width",6*this.cellSize+"px"),style("OVERLAY-TIMER-DIV","height",5*this.cellSize+"px"),style("OVERLAY-TIMER-TEXT","font-size",1.2*this.fontSize+"px"),style("OVERLAY-TIMER-DIV","transform",`translate(0, -${this.landscape.y/2*(this.isEverybodyPlay?.9:.3)}px)`),style("OVERLAY-WINS-STATUSBAR","width",`${this.landscape.x}px`),style("OVERLAY-WINS-STATUSBAR","height",`${this.landscape.y}px`),style("WINSBAR-BAR","width",12*this.cellSize*this.playerAreaSizeMult+"px"),style("WINSBAR-BAR","height",3*this.cellSize*this.playerAreaSizeMult+"px"),style("WINSBAR-BAR","bottom",2*this.cellSize*this.playerAreaSizeMult+"px"),game1v1.winstat.resize(this.cellSize*this.playerAreaSizeMult),style("GTRIS-PARTICLE-SCREEN","width",`${this.resolution.w}px`),style("GTRIS-PARTICLE-SCREEN","height",`${this.resolution.h}px`),style("GTRIS-SPLASH-DIV","width",`${this.resolution.w}px`),style("GTRIS-SPLASH-DIV","height",`${this.resolution.h}px`),style("GTRIS-FADE","width",`${this.landscape.x}px`),style("GTRIS-FADE","height",`${this.landscape.y}px`),style("LOAD-TEXT","font-size",1.05*this.fontSize+"px"),style("LOAD-ICON","width",1*this.cellSize+"px"),style("LOAD-ICON","height",1*this.cellSize+"px"),style("GTRIS-HTMLEFF-SCREEN","width",`${this.resolution.w}px`),style("GTRIS-HTMLEFF-SCREEN","height",`${this.resolution.h}px`),style("GTRIS-LOAD-SCREEN","width",`${this.resolution.w}px`),style("GTRIS-LOAD-SCREEN","height",`${this.resolution.h}px`),styleelem(loadingScreen.canvas,"width",`${this.landscape.x}px`),styleelem(loadingScreen.canvas,"height",`${this.landscape.y}px`),style("LOAD-DIV","width",`${this.landscape.x}px`),style("LOAD-DIV","height",`${this.landscape.y}px`);let landscapeCellSize=~~(Math.max(this.landscape.x,this.landscape.y)/50),landscapeFontSize=~~(Math.max(this.landscape.x,this.landscape.y)/50*fontSizePerPx);if(particle.size(this.resolution.w,this.resolution.h),style("GTRIS-AREA","grid-template-columns","landscape"===this.orientation?"auto auto auto":"auto auto"),menu.resize(landscapeCellSize,landscapeFontSize,this.landscape.x,this.landscape.y),splash.resize(this.landscape.x,this.landscape.y,landscapeCellSize),animatedLayers.checkObject("swap_roulette_object")){let ghe=animatedLayers.getObject("swap_roulette_object");ghe.centerPos.x=this.resolution.w/2,ghe.centerPos.y=this.resolution.h/2,ghe.sizeMult=this.cellSize*this.playerAreaSizeMult}game1v1.resize(this.landscape.x,this.landscape.y),background.resize(this.landscape.x,this.landscape.y),fsw.resize(this.resolution.w,this.resolution.h,this.fontSize,this.cellSize),alertWindow.resize(this.resolution.w,this.resolution.h,this.fontSize),this.forEachPlayer(player=>{player.resize(~~this.cellSize,~~(this.fontSize*ms),this.playerAreaSizeMult*ms,this.isEverybodyPlay)})}forEachPlayer(func){let a=0;for(;a in this.players;){let h=this.inGameParameters.playerOrder[a];func(this.players[h],h),a++}}createPlayer(a){if(a!==this.playerCount){this.playerCount=a,this.players={},ih("PLAYER-STYLES",""),ih("GTRIS-AREA","");for(let i=0;i<a;i++){this.players[i]=new Player(i);let b=this.players[i];id("GTRIS-AREA").innerHTML+=b.assetHTML,id("PLAYER-STYLES").innerHTML+=b.assetStyle}return this.forEachPlayer(player=>{player.storeElementsToMemory(),player.meterBar.right.initialize(player.getAsset("METERBAR-RIGHT"),[player.getAsset("MB-HAND-RIGHT"),player.getAsset("MB-HAND-RIGHT-BEHIND")]),player.meterBar.garbwait.initialize(player.getAsset("METERBAR-GARBWAIT-LEFT"),[player.getAsset("MB-HAND-LEFT-GWLV1"),player.getAsset("MB-HAND-LEFT-GWLV2"),player.getAsset("MB-HAND-LEFT-GWLV3")]),player.insaneBg.fetchAsset(player.canvasses.insane,player.canvasCtx.insane),player.woiWormhole.fetchAsset(player.canvasses.wormhole,player.canvasCtx.wormhole),player.feverStat.fetchAsset(player.canvasses.feverGauge,player.canvasCtx.feverGauge,player.getAsset("FEVER-GAUGE"))}),!0}return!1}updateInput(){this.forEachPlayer(player=>{this.activePlayer,player.player}),this.lastPressStr=this.pressStr}typeInput(char,type){this.replay.isOn||menu.isMenu||this.pause.on||(type?this.pressStr|=char:this.pressStr^=char)}keyToBit(c){}replayDataToString(){return JSON.stringify({title:`[${new Date(Date.now()).toLocaleString(navigator.language)}] Replay of ${menu.storage.getItem("playername")}, version ${__main_params__.appinfo.version}`,replays:this.replay.replays})}frameLoop(_once){if(this.#customLoops.update(),menu.isMenu&&menu.run(),menu.pressAButtonDelay>0&&menu.pressAButtonDelay--,this.coreElement.scrollTop&&(this.coreElement.scrollTop=0),menu.runInBackground(),fsw.update(),alertWindow.update(),this.startGameParameters.frame>0&&(this.startGameParameters.frame--,0==this.startGameParameters.frame&&("actual"===this.startGameParameters.type&&this.initialize("actualparameter",!1),"actual_online"===this.startGameParameters.type&&this.initialize("actualparameter",!1,null,!1,!0),"restart"===this.startGameParameters.type&&this.initialize(void 0,!1),"replay"===this.startGameParameters.type&&this.initialize(void 0,!0))),loadingScreen.run(),this.pause.on&&this.pause.frame>0&&(this.pause.frame-=1,1==this.pause.frame&&(this.synchroLoop.confirmIsAsync=!1,this.pause.on=!1)),!this.pause.on&&this.isGameLoaded&&this.startGameParameters.frame<=0){background.ctx.clearRect(0,0,1280,720),background.drawVideo();let isInsane=this.matchEndHandler.on||!this.isGameLoaded||this.isFinish?0:5,zerohp=0,isInsanePhylum=!1;game1v1.overhead.drawImageToBG();let isRepeat=!1,isOnce=!0,isSent=!0,playerInputFrames=0,playerInputBit=Object.create(null),isReplay=this.replay.isOn,isOnline=this.online.isOn&&!isReplay,isPlayerTick=!1;do{isRepeat=!1;let canContinueHaltFrame=!1,hasChainOngoing=!1,isStillFinishable=!1;this.forEachPlayer(player=>{player.runUnfreezableAnims()});let isHandlePause=!1,isNextFrame=!1,canNextFrame=!isOnline||isReplay;this.isRoundNext&&(canNextFrame=!0),this.countdown;let framePacketArrived=!0,allPlayerInputsForFrame=!0,fetchedFrames=0;isReplay||this.updateInput();let implicitAckMinimumF=99999,isNonLockSafe=!1;if(this.forEachPlayer(player=>{this.activePlayer==player.player&&((0==player.activeType&&player.block.isNonLockSafe||1==player.activeType&&player.blob.isNonLockSafe)&&(isNonLockSafe=!0),player.inputFrames in player.framePackets||(player.framePackets[player.inputFrames]=this.pressStr))}),isOnline&&this.forEachPlayer(player=>{this.frames in player.framePackets||(allPlayerInputsForFrame=!1)}),allPlayerInputsForFrame?!isReplay&&isOnline&&(isRepeat=!0,this.forEachPlayer(player=>{player.lastCapturedInputFrame;player.lastCapturedInputFrame+=1,player.lastAckedFrame++})):framePacketArrived=!1,isOnline&&!isReplay||(framePacketArrived=!0),framePacketArrived?(canNextFrame=!0,fetchedFrames=this.frames,this.online.timeoutFrames=12*this.FPS):this.online.timeoutFrames--,isOnline&&this.online.timeoutFrames<=0&&(log.error("Network Error!","Network error occurred. This match will end."),online.emit("MATCH_END",[]),this.endGame(),isRepeat=!1),canNextFrame&&this.bufferFrames++,this.frames<this.bufferFrames&&(isNextFrame=!0,playerInputFrames=0,this.online.timeoutFrames=12*this.FPS,this.frames++),this.forEachPlayer(player=>{this.activePlayer!==player.player||isReplay?(player.inputBuffer=!isOnline||isReplay||framePacketArrived?1:0,player.lastAckedFrame<implicitAckMinimumF&&(implicitAckMinimumF=player.lastAckedFrame)):(player.canWaitForOpponent=!(this.frames>=player.inputFrames),player.canWaitForOpponent||(player.shouldWaitForOpponent=!1),!player.shouldWaitForOpponent&&isOnce?(player.inputBuffer=1,isPlayerTick=!0):player.inputBuffer=0),player.inputFrames<20&&(player.pressStr=0),player.inputBuffer>0&&(this.online.timeoutFrames=12*this.FPS,player.preupdate()),this.activePlayer,player.player}),isNextFrame){if(this.swapMode.on&&this.swapMode.pickDel>=0){if(this.swapMode.pickDel-=1,canContinueHaltFrame=!0,210==this.swapMode.pickDel&&animatedLayers.create("swap_roulette_object",120,this.resolution.w/2,this.resolution.h/2,0,0,0,200,200,11,11,1,"swap_roulette",10,this.cellSize*this.playerAreaSizeMult,{isOn:!0,resetFrame:47,targetFrame:59},!1,!0),100==this.swapMode.pickDel&&animatedLayers.checkObject("swap_roulette_object")){let ghe=animatedLayers.getObject("swap_roulette_object");ghe.loop.isOn=!1,ghe.setFrame([61,98][this.swapMode.decidedBlockOrBlob]),sound.play("swap_pick")}if(this.swapMode.pickDel<=172&&this.swapMode.pickDel>=101&&this.swapMode.pickDel%5==0&&sound.play("swap_roulette"),90==this.swapMode.pickDel&&animatedLayers.checkObject("swap_roulette_object")){animatedLayers.getObject("swap_roulette_object").isPaused=!0}10==this.swapMode.pickDel&&animatedLayers.checkObject("swap_roulette_object")&&animatedLayers.setOpacity("swap_roulette_object",0,10),0==this.swapMode.pickDel&&this.forEachPlayer(player=>{1==this.swapMode.blockOrBlob&&player.swapMode.playSwapAnim(),player.switchAuxToMain(this.swapMode.decidedBlockOrBlob),player.playVoice(["swap_gtris","swap_blob"][this.swapMode.decidedBlockOrBlob]),player.convertGarbageBlockToGarbageBlob(this.swapMode.blockOrBlob)})}else if(this.swapMode.swapDel>=0)this.swapMode.swapDel--,isHandlePause=!0,0==this.swapMode.swapDel&&(this.isFreezeHandlers=!1,game1v1.overhead.openClose(5),this.forEachPlayer(player=>{player.switchAuxToMain(this.swapMode.blockOrBlob),player.canvasClear("back"),player.canvasClear("backAux"),player.engageCleartext("b2b",!1,""),player.engageCleartextCombo(!1,0,""),player.swapMode.reset(),player.swapMode.time=16*this.FPS,player.convertGarbageBlockToGarbageBlob(this.swapMode.blockOrBlob),this.isRoundActive&&(1==this.swapMode.blockOrBlob&&(player.blob.setDelay(0,5),player.blob.isWarning?player.playVoice("swap_danger"):player.block.isWarning?player.playVoice("swap_closecall"):player.playVoice("swap_swap")),0==this.swapMode.blockOrBlob&&(player.block.setDelay(0,5),player.block.isWarning?player.playVoice("swap_danger"):player.blob.isWarning?player.playVoice("swap_closecall"):player.playVoice("swap_swap")))}));else if(this.waitCountdown>0)this.waitCountdown--,0==this.waitCountdown&&this.forEachPlayer(player=>{player.delay[2]=179});else if(this.countdown>0)this.countdown--,179==this.countdown&&(this.resetReadyMatchSignal(1),this.isRunning=!0,this.isRoundActive=!0),0==this.countdown&&this.forEachPlayer(player=>{player.callibrateCenter()});else{if(this.targetPointSystem.on){if(this.targetPointSystem.marginTime>=0&&(this.targetPointSystem.marginTime--,0==this.targetPointSystem.marginTime&&this.targetPointSystem.targetPoint>1)){this.targetPointSystem.marginTime;let currentTargetPoint=this.targetPointSystem.targetPoint;this.targetPointSystem.targetPoint=~~(.75*this.targetPointSystem.initial),this.targetPointSystem.previous=currentTargetPoint}if(this.targetPointSystem.marginTime<=0&&(this.targetPointSystem.iterIncDel--,this.targetPointSystem.iterIncDel<=0&&this.targetPointSystem.targetPoint>1)){this.targetPointSystem.iterIncDel=16*this.FPS;let currentTargetPoint=this.targetPointSystem.targetPoint;this.targetPointSystem.targetPoint=~~(.5*this.targetPointSystem.previous),this.targetPointSystem.previous=currentTargetPoint}}!this.isRoundNext&&this.isRoundActive&&(0==this.swapMode.time?(this.swapMode.time=30*this.FPS,this.swapMode.swapDel=40,this.isFreezeHandlers=!0,sound.play("swap_swap"),0==this.swapMode.blockOrBlob?this.swapMode.blockOrBlob=1:1==this.swapMode.blockOrBlob&&(this.swapMode.blockOrBlob=0),this.forEachPlayer(player=>{player.swapMode.playSwapAnim(),player.block.canRaiseGarbage=!1,player.blob.canFallTrash=!1,player.refreshBorderField(this.swapMode.blockOrBlob)})):this.swapMode.on==this.swapMode.time>=0&&(this.swapMode.time--,this.timerDisplay.display(this.swapMode.time)),this.swapMode.time==~~(.3*this.FPS)&&this.forEachPlayer(player=>{player.block.isActive=!1,player.blob.isActive=!1}),this.swapMode.time<=3*this.FPS&&this.swapMode.time>.1*this.FPS&&0==this.swapMode.time%this.FPS&&sound.play("timer_basic"))}this.matchSignal.main.run()}if(this.forEachPlayer(player=>{player.inputBuffer>0&&(isReplay||(player.pressStr=player.framePackets[player.inputFrames]),player.inputRun(isHandlePause),isHandlePause||player.playerUpdate()),isOnce&&player.drawPlayer()}),isNextFrame){if(!this.isFreezeHandlers){for(let pla in this.gameRunningParameters.hasChain)delete this.gameRunningParameters.hasChain[pla];let teamsAlive={},insaneDetected=0;switch(this.forEachPlayer(player=>{player.blob.insane.isOn&&(insaneDetected=2),player.block.insane.isOn&&(insaneDetected=2)}),0==insaneDetected&&this.enableWarning&&this.forEachPlayer(player=>{player.isWarning&&(isInsane=4)}),this.forEachPlayer(player=>{player.blob.decreaseTargetPoint=Math.max(1,this.targetPointSystem.initial/this.targetPointSystem.targetPoint),player.isDead||player.isDying||player.hasWon||(teamsAlive[player.team]=1,player.blob.forecastedChain>0&&(player.blob.chain>0||player.blob.isChainUp)&&player.blob.actualChain<player.blob.forecastedChain&&(hasChainOngoing=!0)),player.isFinishAble&&(isStillFinishable=!0),player.blob.isChainUp&&(this.gameRunningParameters.hasChain[player.team]=1),player.isDead||this.isFinish||!player.block.insane.isOn&&!player.blob.insane.isOn||(0==player.blob.insane.insaneType&&(isInsane=1,player.isPhylum&&(isInsanePhylum=!0)),2==player.blob.insane.insaneType&&(isInsane=2),1==player.blob.insane.insaneType&&(isInsane=2)),!player.rpgAttr.isZeroHPWarning||player.isDead||player.isDying||player.hasWon||(zerohp+=1)}),isInsanePhylum&&(isInsane=6),this.inGameParameters.mode){case 3:{let isInsaneOff=!0,isInsaneOn=!1,isInsanePrep=!1;if(this.forEachPlayer(player=>{let block=player.block,blob=player.blob;(0==player.activeType&&(block.insane.isOn||block.insane.delay.ready>0||block.insane.delay.in>0||block.insane.delay.out>0)||1==player.activeType&&(blob.insane.isOn||blob.insane.delay.ready>0||blob.insane.delay.readyHenshin>0||blob.insane.delay.in>0||blob.insane.delay.out>0))&&(isInsaneOff=!1,isInsanePrep=!0),(0==player.activeType&&block.insane.isOn||1==player.activeType&&blob.insane.isOn)&&(isInsaneOn=!0)}),isInsaneOn&&(this.woiMode.timeDelay>=0&&(this.woiMode.timeDelay-=1),this.timer.increment(this.woiMode.timeDelay>0?0:-1)),this.timer.update(),isInsanePrep&&(isInsane=this.frames>32?this.isPhylum?this.woiMode.rounds>0?8:6:1:0),isInsaneOff?this.woiMode.time>=0&&(this.woiMode.time--,isInsane=this.isPhylum?7:3):this.woiMode.time<4*this.FPS&&(this.woiMode.time=4*this.FPS),this.woiMode.time==4*this.FPS-2&&(sound.play("wormhole_ready"),this.playAnimation("mswhready"),ihelem(this.matchSignal.html.start,"Get ready..."),this.forEachPlayer(player=>{player.isDead||player.woiWormhole.engage(0),player.woi.damageSent=~~((0==player.activeType?1*player.block.garbageConversion(.75*player.woi.a).a:player.woi.a)/6)}),this.woiMode.rounds++),this.woiMode.time==0*this.FPS&&(sound.play("wormhole_blast"),sound.stop("wormhole_ready"),this.woiMode.loopRate=1.017,this.playAnimation("mswhstart"),ihelem(this.matchSignal.html.start,"The Wormhole!"),this.woiMode.isEvaluation=!0,this.woiMode.shoot=-50,this.forEachPlayer(player=>{player.isDead||(player.woi.damageSent<=0?player.woiWormhole.engage(2):(animatedLayers.create(void 0,60,player.playerCenterPos.x,player.playerCenterPos.y,0,0,0,200,200,15,15,1,"wormhole_explosion",10,3),player.playAnimation("fieldShake")),player.isDead||player.playVoice("wormhole_enter"))})),this.woiMode.isEvaluation&&(this.woiMode.shoot+=Math.min(2,this.woiMode.loopRate-.017),this.woiMode.loopRate+=.0173,isInsane=this.isPhylum?7:3,this.woiMode.shoot>=10)){this.woiMode.shoot-=10;let attacks={},blocks={},isCounter=!1,isAttack=!1;this.forEachPlayer(player=>{player.woi.damageSent>0&&(attacks[player.player]=[],player.woi.damageSentPerHit=Math.max(Math.min(player.woi.damageSent,~~(this.targetPointSystem.initial/this.targetPointSystem.targetPoint*10)),0),blocks[player.player]=player.woi.damageSentPerHit,player.woi.damageSent-=player.woi.damageSentPerHit,(player.woi.damageSent<0||0==player.woi.damageSent)&&(player.woi.damageSent=0,player.woiWormhole.engage(2),player.stopAnimation("fieldShake")),this.forEachPlayer(opponent=>{opponent.team===player.team||player.player===opponent.player||opponent.isDead||attacks[player.player].push(opponent.player)}))});this.cellSize,Math.random(),Math.random();let ry=this.cellSize*(5*Math.random()-5*Math.random());this.forEachPlayer(player=>{if(player.player in attacks&&!player.isDead)for(let nb of attacks[player.player]){let bez={x1:0,x2:.1,x3:1.9,x4:1,y1:0,y2:0,y3:.9,y4:1},asset=player.assetRect("FIELD-INSANE-CANVAS"),aw=asset.width,ah=asset.height,ax=asset.x,ay=asset.y,particleSpeed=40,lx=this.resolution.w/2,ly=this.resolution.h/2,dmg=player.woi.damageSentPerHit,particleColor=(player.fieldCellSize,player.player);if(sound.play("wormhole_transmit"),nb in blocks){let dmgNeut=blocks[nb],dmgSent=player.woi.damageSentPerHit;dmg=Math.max(0,dmgSent-dmgNeut);let opp=nb;ly+=ry,this.addDelayHandler(particleSpeed,()=>{}),dmg>0&&(isCounter=!0,this.addDelayHandler(particleSpeed,()=>{this.forEachPlayer(opponent=>{if(opp===opponent.player){player.woi.damageInflicted+=dmg,opponent.woi.damageReceived+=dmg;let target=opponent.assetRect("FIELD-CHARACTER-CANVAS"),gw=target.width,gh=target.height,gx=target.x,gy=target.y,mlx=gx+gw/2+this.cellSize*(5*Math.random()-5*Math.random()),mly=gy+gh/2+this.cellSize*(5*Math.random()-5*Math.random());this.addDelayHandler(particleSpeed,()=>{opponent.rpgAttr.addHP(-dmg),sound.play("wormhole_hit"),opponent.simulateWMWShakeIntensityHit(),animatedLayers.create(void 0,30,mlx,mly,0,0,0,200,200,5,5,.5,(1==player.activeType?"blob":"block")+"_hit",10,2)}),player.addParticle(!0,"attack",0,particleColor+2,lx,ly,mlx,mly,particleSpeed,1.3,!1,bez,!0,{frame:.5*particleSpeed,r:255,g:255,b:255})}})}))}else this.forEachPlayer(opponent=>{if(nb===opponent.player){player.woi.damageInflicted+=dmg,opponent.woi.damageReceived+=dmg;let target=opponent.assetRect("FIELD-CHARACTER-CANVAS"),gw=target.width,gh=target.height,gx=target.x,gy=target.y;lx=gx+gw/2+this.cellSize*(5*Math.random()-5*Math.random()),ly=gy+gh/2+this.cellSize*(5*Math.random()-5*Math.random()),this.addDelayHandler(particleSpeed,()=>{opponent.rpgAttr.addHP(-dmg),sound.play("wormhole_hit"),opponent.simulateWMWShakeIntensityHit(),animatedLayers.create(void 0,30,lx,ly,0,0,0,200,200,5,5,.5,(1==player.activeType?"blob":"block")+"_hit",10,2)})}});player.addParticle(!0,"attack",0,particleColor+2,ax+aw/2,ay+ah/2,lx,ly,particleSpeed,1.3,!1,bez,!0,{frame:.8*particleSpeed,r:255,g:255,b:255})}}),this.forEachPlayer(player=>{player.woi.damageSent>0&&(isAttack=!0)}),isAttack?sound.play("wormhole_transmit"):(this.woiMode.restart<=75&&(this.woiMode.restart=75),this.woiMode.isEvaluation=!1,isCounter&&this.woiMode.restart<=105&&(this.woiMode.restart=105))}if(this.woiMode.restart>=0&&(this.woiMode.restart--,isInsane=isInsane=this.isPhylum?7:0,0==this.woiMode.restart)){this.woiMode.isEvaluation=!1;let isStillAlive={};this.forEachPlayer(player=>{player.rpgAttr.checkZeroHP()||player.isDead||(isStillAlive[player.team]=0)});let mn=Object.keys(isStillAlive).length;mn>=1&&(this.woiMode.timeDelay=1.5*this.FPS,this.timer.set(80*game.FPS)),this.forEachPlayer(player=>{player.woi.a=0,player.rpgAttr.checkZeroHP()?player.isDead||(player.playVoice("wormhole_lose"),player.phaseLose("break"),player.playSound("wormhole_break")):(mn>1?player.woi.damageReceived>0?player.woi.damageReceived>=.5*player.rpgAttr.maxHP?player.playVoice("wormhole_damage2"):player.playVoice("wormhole_damage1"):player.woi.damageInflicted>0&&(player.woi.damageInflicted>=.5*player.rpgAttr.maxHP?player.playVoice("wormhole_inflict2"):player.playVoice("wormhole_inflict1")):player.playVoice("wormhole_win"),player.woi.reset(),mn>1&&(0==player.activeType&&(player.block.insane.delay.ready=50),1==player.activeType&&(player.blob.insane.delay.ready=50)))})}break}}this.runDelayHandler();let teamAliveCount=Object.keys(teamsAlive).length,playerWin=0,hasMaxPointsWinner=!1;if(this.forEachPlayer(player=>{teamAliveCount==(this.isSolo?0:1)&&!player.isWin&&player.team in teamsAlive&&(player.isWin=!0,player.block.piece.enable=0,player.blob.piece.enable=0,player.block.isActive=0,player.blob.isActive=0,this.isRoundActive=!1),!player.isDying||player.isFinishAble||player.isDead||player.isWin||(player.block.piece.enable=0,player.blob.piece.enable=0,player.block.isActive=0,player.blob.isActive=0,player.blob.isEnable=0,player.block.isEnable=0,player.rpgAttr.isRPG&&(player.rpgAttr.isUsableSkills=!1),hasChainOngoing&&!(player.team in this.gameRunningParameters.hasChain)?(player.isDead=!1,player.isFinishAble=!0):player.isFinishAble||player.phaseLose()),!(player.team in teamsAlive)||!player.isWin||player.hasWon||hasChainOngoing||isStillFinishable||player.team in this.gameRunningParameters.hasChain||(player.block.piece.enable=0,player.blob.piece.enable=0,player.block.isActive=0,player.blob.isActive=0,player.rpgAttr.isRPG&&(player.rpgAttr.isUsableSkills=!1),player.hasWon=!0,player.isDead||(player.playEmAnimation("win"),player.engagePlaycharExt("result"),player.editIH("PLAYCHAR-TEXT","Yeah!")),playerWin++,this.inGameParameters.players[player.player].wins++,this.inGameParameters.players[player.player].wins>=this.inGameParameters.maxWins&&(hasMaxPointsWinner=!0))}),!this.isRoundNext&&(this.isSolo?0:1)>=teamAliveCount&&!hasChainOngoing&&!isStillFinishable){this.roundNextTime=170,(this.isSolo||hasMaxPointsWinner)&&(this.replay.isOn||this.matchEndHandler.isFinishActual||(this.matchEndHandler.isFinishActual=!0),this.isFinish=!0,this.winnerDeclaration.winners.length=0,this.winnerDeclaration.losers.length=0,hasMaxPointsWinner&&this.forEachPlayer(player=>{this.inGameParameters.players[player.player].wins>=this.inGameParameters.maxWins?this.winnerDeclaration.winners.push(player):this.winnerDeclaration.losers.push(player)}));let loseNotReady=0;this.forEachPlayer(player=>{!player.isLosePlayed&&player.isDead&&loseNotReady++}),0==loseNotReady&&(this.isRoundNext=0==loseNotReady)}if(this.isRoundNext&&this.roundNextTime>=-1){let playerDoneLose=!0;if(this.forEachPlayer(player=>{player.checkVoicePlaying("lose")&&(playerDoneLose=!1)}),playerDoneLose&&this.roundNextTime--,168==this.roundNextTime&&(this.forEachPlayer(player=>{player.hasWon&&(player.isCompact&&ihelem(player.getAsset("WINS-TEXT"),player.wins+1),player.isDead||player.playVoice("win"))}),game1v1.on&&this.forEachPlayer(player=>{player.hasWon&&!player.isDead&&(0==player.player&&game1v1.winstat.setWins("left",player.wins+1,!0),1==player.player&&game1v1.winstat.setWins("right",player.wins+1,!0))}),this.replay.isOn?this.replay.replaysIndex+1>=this.replay.replays.length&&(this.matchEndHandler.on=!0):this.matchEndHandler.isFinishActual&&(this.matchEndHandler.on=!0),this.winnerDeclaration.winners.length>0&&(this.forEachPlayer(player=>{player.playcharExt.anim.fadeout.play(),player.setStyle("PLAYCHAR-TEXT-DIV","opacity","0%")}),this.winnerDeclaration.frames=50)),6==this.roundNextTime){if(this.replay.isOn,this.matchEndHandler.on){if(this.endGame(),isOnline){let wr=online.createWriter("MATCH_END",0);online.send(wr.buffer)}this.roundNextTime=-9999}else this.playAnimation("fadein"),style("GTRIS-OVERLAY","background","#000");this.woiMode.loopRate=-1}0==this.roundNextTime&&(this.matchEndHandler.on||this.initializeNext(this.replay.isOn),this.isRoundNext=!1)}if(this.winnerDeclaration.frames>=0){switch(this.winnerDeclaration.frames){case 30:for(let player of this.winnerDeclaration.winners)player.playcharExt.anim.windeclare.play(),player.setStyle("PLAYCHAR-TEXT-DIV","opacity","100%"),player.editIH("PLAYCHAR-TEXT",language.translate("result_match_win"));for(let player of this.winnerDeclaration.losers)player.playcharExt.anim.losedeclare.play(),player.setStyle("PLAYCHAR-TEXT-DIV","opacity","100%"),player.editIH("PLAYCHAR-TEXT",language.translate("result_match_lose"));break;case 15:this.winnerDeclaration.losers.length>0&&sound.play("blub_garbage2");break;case 0:this.winnerDeclaration.winners.length>0&&sound.play("allclear")}this.winnerDeclaration.frames--}}this.loopParams.isInsane=isInsane,this.loopParams.zerohp=zerohp}isOnce=!1}while(isRepeat);if(this.forEachPlayer(player=>{this.activePlayer==player.player&&(playerInputFrames=player.inputFrames,playerInputBit=player.recordedFramePackets)}),isOnline&&this.visualFrames%4==0){isSent=!1;let hs=playerInputFrames-1,m=[],sf=Math.max(hs-180,this.frames-60);for(let g=hs;g>=sf;g--)m.push(playerInputBit[g]);let wr=new BinaryWriter(5+2*m.length);wr.u32(hs),wr.u8(m.length);for(let g=0;g<m.length;g++)wr.u16(m[g]||0);online.sendRTC("input",wr.buffer)}this.visualFrames++,game1v1.run(),particle.refresh(),htmlEffects.run(),this.forEachPlayer(player=>{player.runAnimations()}),this.synchroLoop.confirmIsAsync=!this.isRunning;for(let h=0,m=this.animationNames.length;h<m;h++)this.animations[this.animationNames[h]].run();this.woiMode.loopRate>=0&&(this.woiMode.loopRate-=.017,sound.rate("wormhole_loop",this.woiMode.loopRate))}this.runDelayHandler(!0),this.numberExecHandlers.wormholeLoop.assign(!this.pause.on&&this.woiMode.loopRate>0?1:0),this.numberExecHandlers.insaneMFX.assign(this.loopParams.isInsane),this.numberExecHandlers.zerohp.assign(this.loopParams.zerohp),log.run()}pauseGame(){this.pause.on||!this.isGameLoaded||this.online.isOn&&!this.replay.isOn||(this.pause.on=!0,this.replay.isOn&&touchButtons.enableControllers(!0),menu.changeMenu(this.replay.isOn?JSON.stringify(menu.pauseReplaySels):JSON.stringify(menu.pauseSels),!1),menu.showMenu(!0),this.synchroLoop.confirmIsAsync=!0)}unpauseGame(){this.pause.on&&this.isGameLoaded&&(this.pause.frame=50,this.replay.isOn&&touchButtons.enableControllers(!1),menu.showMenu(!1))}playAnimation(h){this.animations[h].play()}resetAnimations(){for(let h=0,m=this.animationNames.length;h<m;h++)this.animations[this.animationNames[h]].reset()}},game=manager,keypressManager=new class{#listeners={};constructor(){this.isKeyBindingMode=!1,this.pressedKeys={},this.BIND_NAMES={0:["left","right","softdrop","harddrop","hold","cw","ccw","c180w","s1","s2","s3"],1:["left","right","softdrop","harddrop","cw","ccw","s1","s2","s3"],general:["pause","restart"]},this.bindsDefault={0:{arrowleft:"left",arrowright:"right",arrowdown:"softdrop",arrowup:"cw"," ":"harddrop",c:"hold",x:"ccw",z:"c180w",1:"s1",2:"s2",3:"s3"},1:{arrowleft:"left",arrowright:"right",arrowdown:"softdrop",arrowup:"harddrop",x:"cw",z:"ccw",1:"s1",2:"s2",3:"s3"},general:{escape:"pause",r:"restart"}},this.binds=JSON.parse(JSON.stringify(this.bindsDefault));for(let aa in this.bindsDefault){this.binds[aa]={};for(let ab in this.bindsDefault[aa])this.binds[aa][ab]=this.bindsDefault[aa][ab]}this.lastKeys={},this.flags={left:{up:"a",down:"A"},right:{up:"b",down:"B"},softdrop:{up:"c",down:"C"},harddrop:{up:"d",down:"D"},hold:{up:"e",down:"E"},ccw:{up:"f",down:"F"},cw:{up:"g",down:"G"},c180w:{up:"h",down:"H"},s1:{up:"1n",down:"1N"},s2:{up:"2n",down:"2N"},s3:{up:"3n",down:"3N"}},this.STRING_SEPARATOR="//",this.isTyping=!1,this.evtTypeInt={keydown:1,keyup:0}}keyGeneral(code,type){if(code in this.binds.general){if("keydown"===type&&"pause"===this.binds.general[code])game.pauseGame();return!0}return!1}keyFlag(code,categ){if(code&&code in this.binds[categ]&&this.binds[categ][code]in this.flags){return game.bitFlags[this.binds[categ][code]]}return""}addListener(id,func){id in this.#listeners||(this.#listeners[id]=(k,t)=>{func(k,t)})}removeListener(id){id in this.#listeners&&delete this.#listeners[id]}setupKeybinds(){let data=menu.storage.getItem("keyboard");for(let aa in data){this.binds[aa]={};for(let ab in data[aa]){let arr=data[aa][ab].split(this.STRING_SEPARATOR);for(let ac of arr)this.binds[aa][ac]=ab}}}listen(evt){let key=evt.key.toLowerCase();if(-1!==[" ","arrowleft","arrowright","arrowup","arrowdown"].indexOf(key)&&evt.preventDefault(),key in this.lastKeys){if(this.lastKeys[key]===evt.type)return;this.lastKeys[key]=evt.type}else this.lastKeys[key]=evt.type;for(let gn in this.#listeners)this.#listeners[gn](key,evt.type);if(!this.isTyping&&!(this.isKeyBindingMode||game.startGameParameters.frame>0))if(splash.isActive)splash.nextSlide();else if(fsw.isShown)fsw.keyInput(key,evt.type);else if(menu.isMenu){if(menu.characterMenu.isActive)"keydown"==evt.type&&menu.characterMenu.controlsListen(key);else if(menu.isMenu){let ms=evt.type.replace(/key/gim,"");switch(`${key}`){case"arrowdown":menu.controlsListen("down",ms);break;case"arrowup":menu.controlsListen("up",ms);break;case"arrowleft":menu.controlsListen("left",ms);break;case"arrowright":menu.controlsListen("right",ms);break;case"enter":menu.controlsListen("a",ms);break;case"backspace":menu.controlsListen("b",ms)}}}else do{if(this.keyGeneral(key,evt.type))break;let player=manager.players[manager.activePlayer],flag=this.keyFlag(key,player.activeType);manager.typeInput(flag,this.evtTypeInt[evt.type])}while(0)}defaultToSortedJSON(){let json={0:{},1:{},general:{}};for(let m in this.bindsDefault)for(let k in this.bindsDefault[m])this.bindsDefault[m][k]in json||(json[m][this.bindsDefault[m][k]]=[]),json[m][this.bindsDefault[m][k]].push(k);let fjson={0:{},1:{},general:{}};for(let m in json)for(let k in json[m])fjson[m][k]=json[m][k].join(this.STRING_SEPARATOR);return fjson}},htmlEffects=new class{constructor(){this.main=$("GTRIS-HTMLEFF-SCREEN"),this.a=new ArrayFunctionIterator(at=>{for(let ptl=0;ptl<at.length;ptl++){let pl=at[ptl],element=pl.element;element.parentNode;pl.frame++,pl.frame<pl.maxf?styleelem(element,"animation-delay",~~(1e3/-60*Math.min(pl.maxf,pl.frame))+"ms"):(this.main.removeChild(element),at.splice(ptl,1),ptl--)}})}add(text,posX,posY,frame,animation,style,id){let a=document.createElement("GTRIS-HTMLEFF-ELEM");a.innerHTML=text,a.style=style,a.style.position="absolute",a.style.transform="translateX(var(--tx)) translateY(var(--ty))",a.style.setProperty("--tx",posX+"px"),a.style.setProperty("--ty",posY+"px"),a.style["animation-name"]=animation.name,styleelem(a,"animation-duration",~~(1e3/60*Math.max(0,frame))+"ms"),styleelem(a,"animation-iteration-count",animation.iter),styleelem(a,"animation-timing-function",animation.timefunc),styleelem(a,"animation-delay",animation.initdel||0),styleelem(a,"animation-play-state","paused"),this.main.appendChild(a),this.a.addItem({element:a,frame:0,maxf:frame})}run(){this.a.update()}};__main_params__.__private.game=manager,__main_params__.__private.keypressManager=keypressManager,__main_params__.__private.htmlEffects=htmlEffects,__main_params__.handle.__setHandle=()=>{window.addEventListener("resize",()=>{game.resize(),window.requestAnimationFrame(()=>{game.resize()})},!1),window.addEventListener("blur",()=>{audioMaster.suspendResume(!0)}),window.addEventListener("focus",()=>{audioMaster.suspendResume(!1)}),game.resize(),game.initGame();for(let a of["keydown","keyup"])window.addEventListener(a,evt=>{keypressManager.listen(evt)});window.onerror=(event,source,lineno,colno,error)=>{log.error_program(event,source,lineno,colno,error)}};class BinaryWriter{constructor(bytes){this.buffer=new ArrayBuffer(bytes),this.view=new DataView(this.buffer),this.offset=0}i8(value){this.view.setInt8(this.offset,value),this.offset+=1}i16(value){this.view.setInt16(this.offset,value,!0),this.offset+=2}i32(value){this.view.setInt32(this.offset,value,!0),this.offset+=4}u8(value){this.view.setUint8(this.offset,value),this.offset+=1}u16(value){this.view.setUint16(this.offset,value,!0),this.offset+=2}u32(value){this.view.setUint32(this.offset,value,!0),this.offset+=4}f32(value){this.view.setFloat32(this.offset,value,!0),this.offset+=4}f64(value){this.view.setFloat64(this.offset,value,!0),this.offset+=8}string(value,lentype=8){let enc=(new TextEncoder).encode(value);this[`u${lentype}`](enc.byteLength);for(let h=0;h<enc.byteLength;h++)this.u8(enc[h])}}class BinaryReader{constructor(buffer){this.buffer=buffer,this.view=new DataView(buffer),this.offset=0}i8(){let a=this.view.getInt8(this.offset);return this.offset+=1,a}i16(){let a=this.view.getInt16(this.offset,!0);return this.offset+=2,a}i32(){let a=this.view.getInt32(this.offset,!0);return this.offset+=4,a}u8(){let a=this.view.getUint8(this.offset);return this.offset+=1,a}u16(){let a=this.view.getUint16(this.offset,!0);return this.offset+=2,a}u32(){let a=this.view.getUint32(this.offset,!0);return this.offset+=4,a}f32(){let a=this.view.getFloat32(this.offset,!0);return this.offset+=4,a}f64(){let a=this.view.getFloat64(this.offset,!0);return this.offset+=8,a}string(lentype=8){let l=this[`u${lentype}`](),u=new Uint8Array(this.buffer).subarray(this.offset,l+this.offset),a=(new TextDecoder).decode(u);return this.offset+=l,a}}const online=new class{locator=window.location;#urls=["ws://localhost:27200"];#socket={};userID=null;roomID=null;userPos=0;isOnline=!1;isReady=!1;isPrepared=!1;#channels={SERVER_CONNECT:0,SERVER_LOGIN:1,SERVER_CLOSE:2,INITIALIZE_MATCH:3,START_QUICK_MATCH:4,STOP_QUICK_MATCH:5,MATCH_PREPARE:6,MATCH_END:7,PLAYER_INPUT:8,RTC:9,RTC_START:10,RTC_READY:11};selectedCharacter={character:0,version:0};#events={LOAD:0,ROUND_END:1,ROUND_NEXT:2,MATCH_END:3,DISCONNECT:4};#uit={8:1,16:2,32:4,64:8};playerPos=-1;matchPlayers={};Player=class{rtcChannels={OFFER:0,ANSWER:1,CANDIDATE:2};constructor(parent){this.parent=parent,this.id="0",this.visualPos=0,this.parameters={},this.ready=!1,this.rtc=new RTCPeerConnection({iceServers:[{urls:["stun:stun1.l.google.com:19302"]}]}),this.channels={};let hbs=0;for(let g of["input","inmatch"])this.channels[g]=this.rtc.createDataChannel(g,{negotiated:!0,ordered:!1,id:hbs,maxRetransmits:0}),hbs++,this.setupChannelRTC(this.channels[g]);this.rtc.onicecandidate=e=>{e.candidate&&this.sendRTCInit("CANDIDATE",e.candidate)}}setupChannelRTC(c){if(c.binaryType="arraybuffer","input"===c.label)c.onmessage=e=>{let rd=new BinaryReader(e.data),sframe=rd.u32(),flen=rd.u8(),vis=this.visualPos;for(let _f=0;_f<flen;_f++){let frame=sframe-_f,press=rd.u16();frame in game.players[vis].framePackets||(game.players[vis].framePackets[frame]=press)}},c.onopen=ev=>{this.ready=!0;let wr=online.createWriter("MATCH_PREPARE",1);wr.u8(1),online.send(wr.buffer),log.warn("Starting","")}}async handleRTCInit(channel,content){switch(channel){case this.rtcChannels.OFFER:await this.rtc.setRemoteDescription(new RTCSessionDescription(content.content)),this.answer(content.content);break;case this.rtcChannels.ANSWER:if("have-local-offer"!==this.rtc.signalingState){log.error("Oops!","RTC connection state is not satisfied.");break}await this.rtc.setRemoteDescription(new RTCSessionDescription(content.content));break;case this.rtcChannels.CANDIDATE:await this.rtc.addIceCandidate(new RTCIceCandidate(content.content))}}sendRTCInit(channel,content,isFeedback){let g={recipient:this.parent.userID,content:content,id:isFeedback?this.parent.userID:this.id},ks=JSON.stringify(g),wr=new BinaryWriter(4+(new TextEncoder).encode(ks).byteLength);wr.u8(9),wr.u8(this.rtcChannels[channel]),wr.string(ks,16),this.parent.send(wr.buffer)}sendRTC(channel,buffer){this.channels[channel].send(buffer)}async offer(){let offer=await this.rtc.createOffer();await this.rtc.setLocalDescription(offer),this.sendRTCInit("OFFER",offer)}async answer(offer){let answer=await this.rtc.createAnswer(offer);await this.rtc.setLocalDescription(answer),this.sendRTCInit("ANSWER",answer)}};User=class{constructor(parent){this.parent=parent,this.id="0",this.playerPos=0,this.parameters={}}};constructor(){this.isPrep=!1}createWriter(channel,byte){let wr=new BinaryWriter(byte+1);return wr.u8(this.#channels[channel]),wr}emit(channel,data){let byteLength=1;for(let h=0;h<data.length;h++){let ref=data[h],endsWith=ref[0].split(""),byteFromType=endsWith[endsWith.length-1];"g"==byteFromType&&(byteLength+=(new TextEncoder).encode(ref[1]).length+this.#uit[ref?.[2]||8]),"8"==byteFromType&&(byteLength+=1),"6"==byteFromType&&(byteLength+=2),"2"==byteFromType&&(byteLength+=4),"4"==byteFromType&&(byteLength+=8)}let wr=new BinaryWriter(byteLength);wr.u8(this.#channels[channel]);for(let h=0;h<data.length;h++){let ref=data[h];wr[ref[0]](ref[1],ref?.[2]||8)}this.send(wr.buffer)}emitEvent(event,byte){let wr=new BinaryWriter(2+byte);return wr.u8(this.#channels.PLAYER_EVENTS),wr.u8(this.#events[event]),wr}sendRTC(channel,data){for(let h in this.matchPlayers){let player=this.matchPlayers[h];player.id!==this.userID&&player.sendRTC(channel,data)}}send(data){this.#socket&&this.#socket.send(data)}rtcSend(data){this.#socket&&this.#socket.send(data)}init(){}close(){this.#socket&&(this.#socket.close(),this.isOnline=!1)}prepReady(){let wr=new BinaryWriter(1);wr.u8(this.#channels.ROOM_USER_READY),this.#socket.send(wr.buffer)}enterRoom(){}connect(callback,closeCallback){let tries=0,urls=this.#urls,sj=prompt("Enter websocket address (port 27200) (e.g. 192.168.1.1:27200)","localhost").replace("http://","").replace("https://","");if(sj)try{urls=[`wss://${sj}`,`ws://${sj}`,`ws://${sj}:27200`,...this.#urls];let j=()=>{this.#socket=new WebSocket(urls[tries]),this.#socket.binaryType="arraybuffer";let isOpen=!1,isCheck=!1;this.#socket.onerror=err=>{this.#socket.close()};for(let j in this.matchPlayers)delete this.matchPlayers[j];this.#socket.onopen=e=>{isOpen=!0,isCheck=!0,callback(1,e),this.emit("SERVER_CONNECT",[])},this.#socket.onclose=e=>{if(!isCheck)return tries++,void(tries<4?j():(console.error("Failed to connect to server"),closeCallback(500)));this.isOnline=!1,this.isReady=!1,this.isPrepared=!1,this.#socket=null},this.#socket.onmessage=e=>{let rd=new BinaryReader(e.data);switch(rd.u8()){case 0:{let userID=rd.string(16);this.userID=userID,this.isOnline=!0;break}case this.#channels.RTC:{let m=rd.u8(),g=JSON.parse(rd.string(16));for(let h in this.matchPlayers){let player=this.matchPlayers[h];player.id==g.recipient&&player.handleRTCInit(m,g)}break}case this.#channels.RTC_START:if(rd.u8())for(let h in this.matchPlayers){let player=this.matchPlayers[h];player.id!=this.userID&&player.offer()}ih("LOAD-TEXT",language.translate("loading_prematch_rtc"));break;case this.#channels.MATCH_PREPARE:this.isReady=!0;break;case this.#channels.PLAYER_INPUT:{let sframe=rd.u32(),count=rd.u8();game.online.latestSimFrames=sframe;for(let h=0;h<count;h++){let pos=rd.u8(),h=[],flen=rd.u8(),vis=this.matchPlayers[pos].visualPos;for(let _f=0;_f<flen;_f++){let frame=sframe+_f,press=rd.u16();h.push(press),pos!==this.userPos&&(game.players[vis].framePackets[frame]=press)}}break}case this.#channels.INITIALIZE_MATCH:{game.online.isOn=!0,this.isReady=!1,this.isRunning=!0;rd.string(16);let parameters=JSON.parse(rd.string(16)),curParams={maxWins:1,mode:1,seed:0};"maxWins"in parameters&&(curParams.maxWins=parameters.maxWins),"mode"in parameters&&(curParams.mode=parameters.mode),"seed"in parameters&&(curParams.seed=parameters.seed),game.seeds.round.seed=curParams.seed;let count=rd.u8(),activePos=menu.storage.getValueFromRangeListSpecific("set_online_boardpos"),visualOrder={},identifiedPos=0;this.matchPlayers={};for(let h=0;h<count;h++){let pos=rd.u8(),id=rd.string(16),name=rd.string(16),character=rd.u8(),version=rd.u8(),mode=rd.u8(),player=new this.Player(this);if(player.parameters={name:name,character:character,version:version,mode:mode},player.id=id,player.visualPos=pos,id==this.userID)identifiedPos=pos;else{let _char=gtcharacter.characters[character],char=language.charTranslate(_char.core.name);log.notification("Match found!",`${name} (${char}) has entered the session. Get ready.`)}this.matchPlayers[pos]=player}let isOccupied={},isCurrent={},sn=0,matchPlayers=Object.keys(this.matchPlayers);for(let h=0;h<matchPlayers.length;h++){let _g=matchPlayers[h];if(_g==identifiedPos){let g=activePos;visualOrder[g]=_g,this.matchPlayers[_g].visualPos=g,isCurrent[_g]=1,isOccupied[g]=1}else sn++}{let i=0,t=0;for(;sn>=t;)t in isCurrent?t++:(i in isOccupied||(visualOrder[i]=t,this.matchPlayers[t].visualPos=i,t++),i++)}this.userPos=identifiedPos;let a=game.actualParameters;a.mode=curParams.mode,a.maxWins=curParams.maxWins,a.playerOrder=[];let gsv=Object.keys(visualOrder);for(let h=0;h<gsv.length;h++)a.playerOrder.push(visualOrder[gsv[h]]);a.players.length=0;for(let u=0;u<a.playerOrder.length;u++){let h=this.matchPlayers[a.playerOrder[u]].parameters,rpg={hp:0,mana:0,atk:0,def:0,lifesteal:0,lfa:0,deflect:0,cards:{}};a.players.push(game.createPlayerParam(h.name,0,h.character,h.version,h.mode,!1,rpg))}game.activePlayer=~~activePos,game.actualParameters.data.maxWins=~~curParams.maxWins,game.startGameSet("actual_online");break}}}};j()}catch(e){closeCallback(e)}}},game1v1=new class{#AnimatedImage=class{constructor(image,frame,w,h,bound){this.a=image||new Image,this.max=frame,this.dims={w:w||100,h:h||100},this.bound=bound||10}};constructor(){this.on=!1,this.dim={w:1e3,h:1e3},this.animatedImages={},this.loaded=!1,this.overhead=new class{constructor(p){this.parent=p,this.div=id("OVERLAY-1V1-OVERHEAD"),this.container=id("OVERLAY-1V1-OVERHEAD-DIV"),this.canvas=new OffscreenCanvas(1280,100),this.ctx=this.canvas.getContext("2d"),this.width=100,this.height=10,this.aspectRatio=.078125,this.pixelPerCell=20,this.canvasSize=1280,this.canvas.width=this.canvasSize,this.canvas.height=this.canvasSize*this.aspectRatio,this.isActive=!1,this.on=!1,this.maxGarbage=0,this.garbage=0,this.position=0,this.offsetPosition=0,this.supposedPosition=.2,this.isPlayerTargeted=0,this.timers=[-1,0,0],this.images={},this.loaded=!0,this.playerImages={left:"f",right:"r"},this.playerColors={},this.spriteDims={w:1280,h:140},this.spriteCenterRatio={w:27,h:200},this.frame=0}resize(w,h){this.width=w,this.height=w*this.aspectRatio,styleelem(this.container,"width",`${w}px`),styleelem(this.container,"height",`${h}px`);this.width,this.pixelPerCell,this.height,this.pixelPerCell}run(){if(this.ctx.clearRect(0,0,1280,100),this.on){let position=this.position+.005*Math.random()-.005*Math.random(),gap=0,fade=1;this.frame++,this.frame>=120&&(this.frame=0);for(let h=0;h<3;h++){this.timers[h]>-1&&this.timers[h]--}if(this.timers[2]>=0){if(fade=Math.max(this.timers[2]-10,0)/15,0==this.timers[2])return this.on=!1,void(this.isActive=!1)}if(this.timers[1]>=0){let mm=Math.max(this.timers[1],0)/5;position=this.position+this.offsetPosition*mm}if(this.timers[0]>=0){gap=1*(Math.max(this.timers[0]-5,0)/12),0==this.timers[0]&&this.movePos(this.supposedPosition),position=.5}this.drawChars(1==~~this.isPlayerTargeted?1-position:position,gap,5*Math.random()+10,fade)}}drawImageToBG(){background.drawImage(this.canvas,0,0,1280,1280*this.aspectRatio,0,0,1280,1280*this.aspectRatio,!1)}drawChars(position,gap,y,fade){let ratio=this.spriteCenterRatio.w/this.spriteCenterRatio.h,center=this.parent.getAnimatedImage("overhead_center");if(this.ctx.globalAlpha=fade,this.playerImages.left in this.images&&this.images[this.playerImages.left].loaded){let img=this.images[this.playerImages.left].a;{let col=this.playerColors.left;this.ctx.fillStyle=`rgb(${col.r},${col.g},${col.b})`,this.ctx.fillRect(0,0,~~(position*this.canvasSize-gap*this.spriteDims.w),this.canvasSize*this.aspectRatio)}this.ctx.drawImage(img,0,y+10,1280,1280*this.aspectRatio,~~(position*this.canvasSize-this.spriteDims.w*gap-this.spriteDims.w),0,this.canvasSize,this.canvasSize*this.aspectRatio)}if(this.playerImages.right in this.images&&this.images[this.playerImages.right].loaded){let img=this.images[this.playerImages.right].a;{let col=this.playerColors.right;this.ctx.fillStyle=`rgb(${col.r},${col.g},${col.b})`,this.ctx.fillRect(~~(position*this.canvasSize+gap*this.spriteDims.w),0,this.canvasSize-~~(position*this.canvasSize+gap*this.spriteDims.w),this.canvasSize*this.aspectRatio)}this.ctx.drawImage(img,0,this.spriteDims.h/1280*1280+y+10,1280,1280*this.aspectRatio,~~(position*this.canvasSize+this.spriteDims.w*gap),0,this.canvasSize,this.canvasSize*this.aspectRatio)}if(0==gap){this.ctx.drawImage(center.a,this.spriteCenterRatio.w*(this.frame%center.bound),this.spriteCenterRatio.h*~~(this.frame/center.bound),this.spriteCenterRatio.w,this.spriteCenterRatio.h,position*this.canvasSize-ratio*this.canvasSize*this.aspectRatio*0-ratio*this.canvasSize*this.aspectRatio,0,this.canvasSize*ratio*this.aspectRatio,this.canvasSize*this.aspectRatio),this.ctx.fillStyle="#fff";let mcx=.05;this.ctx.fillRect(0,this.canvasSize*this.aspectRatio-this.canvasSize*this.aspectRatio*mcx,this.canvasSize,this.canvasSize*this.aspectRatio*mcx)}this.ctx.globalAlpha=1}openClose(number,player,garbage,lastGarbage){switch(this.isActive=!1,number){case 1:this.timers[0]=25,this.timers[1]=0,this.timers[2]=-1,this.on=!0,this.isActive=!0,this.isPlayerTargeted=player,this.checkGarbage(player,garbage,lastGarbage),this.position=.5;break;case 2:this.movePos(1.5),this.timers[2]=25;break;case 3:this.movePos(-.5),this.timers[2]=25;break;case 4:this.timers[2]=25;break;case 5:this.on=!1}}async loadImg(arr){arr.length;for(let h of arr)h.name in this.images||(this.images[h.name]={a:new Image,loaded:!1},this.loaded=!1);for(let h of arr)h.name in this.images&&(this.images[h.name].a=await loadImage(h.dir),this.images[h.name].loaded=!0);this.loaded=!0}movePos(position){let lastPos=this.position;this.supposedPosition=position,this.offsetPosition=lastPos-position,this.position=position,this.timers[1]=5}checkGarbage(player,garbage,lastGarbage){if(this.on&&this.isActive&&~~this.isPlayerTargeted==~~player){this.garbage=garbage,this.garbage>this.maxGarbage&&(this.maxGarbage=this.garbage),void 0!==lastGarbage&&lastGarbage>0&&(this.maxGarbage=lastGarbage);let p=this.garbage/this.maxGarbage;this.movePos((10*(1-p)+2)/14)}}loadPlayer(l,n){this.playerImages[l]=n.image,this.playerColors[l]={r:n.red,g:n.green,b:n.blue}}}(this),this.winstat=new class{constructor(p){this.parent=p,this.container=id("WINSBAR-BAR"),this.players={},this.layers={},this.stars={},this.texts={},this.maxWins=2;{let h=[{name:"star1_l",id:"STAR1-LEFT",type:"star"},{name:"starnumber_l",id:"TEXT-LEFT",type:"text"},{name:"star2_l",id:"STAR2-LEFT",type:"star"},{name:"star_c",id:"STAR-CENTER",type:"star"},{name:"objective_text",id:"TEXT-CENTER",type:"text"},{name:"star2_r",id:"STAR2-RIGHT",type:"star"},{name:"starnumber_r",id:"TEXT-RIGHT",type:"text"},{name:"star1_r",id:"STAR1-RIGHT",type:"star"}];for(let g of h)elem("GTRIS-WINSTAT-LAYER",a=>{if("text"==g.type){let m=document.createElement("gtris-text");this.texts[g.name]=m,this.texts[g.name].style.scale="65%",a.appendChild(m)}if("star"==g.type){let m=createSVG("100%","100%");m.setAttribute("xml:space","preserve"),m.setAttribute("viewBox","0 0 47.94 47.94");let f=document.createElementNS("http://www.w3.org/2000/svg","path");f.style.stroke="#000",f.style.setProperty("stroke-width","2px"),f.setAttribute("d","M26.285,2.486l5.407,10.956c0.376,0.762,1.103,1.29,1.944,1.412l12.091,1.757\tc2.118,0.308,2.963,2.91,1.431,4.403l-8.749,8.528c-0.608,0.593-0.886,1.448-0.742,2.285l2.065,12.042\tc0.362,2.109-1.852,3.717-3.746,2.722l-10.814-5.685c-0.752-0.395-1.651-0.395-2.403,0l-10.814,5.685\tc-1.894,0.996-4.108-0.613-3.746-2.722l2.065-12.042c0.144-0.837-0.134-1.692-0.742-2.285l-8.749-8.528\tc-1.532-1.494-0.687-4.096,1.431-4.403l12.091-1.757c0.841-0.122,1.568-0.65,1.944-1.412l5.407-10.956\tC22.602,0.567,25.338,0.567,26.285,2.486z"),f.style.setProperty("fill","#ffffffaa"),m.appendChild(f),a.appendChild(m),m.style.width=m.style.height="100%",this.stars[g.name]=f}a.style.display="flex",a.style.position="relative",styleelem(a,"justify-content","center"),styleelem(a,"align-items","center"),a.style.width="20px",a.style.height="20px",a.style.position="relative",this.container.appendChild(a),this.layers[g.name]=a})}}getLayer(layername){}resize(w,f){this.cellSize=w,styleelem(this.container,"width",12*w+"px"),styleelem(this.container,"height",2*w+"px"),styleelem(this.container,"bottom",2*w+"px");for(let h=1;h<=2;h++)styleelem(this.layers[`star${h}_l`],"width",1.75*w+"px"),styleelem(this.layers[`star${h}_l`],"height",1.75*w+"px"),styleelem(this.layers[`star${h}_r`],"width",1.75*w+"px"),styleelem(this.layers[`star${h}_r`],"height",1.75*w+"px");for(let j of["l","r"])styleelem(this.layers[`starnumber_${j}`],"width",1.55*w+"px"),styleelem(this.layers[`starnumber_${j}`],"height",1.55*w+"px"),styleelem(this.texts[`starnumber_${j}`],"font-size",1.55*f+"px");styleelem(this.layers.objective_text,"width",4*w+"px"),styleelem(this.layers.objective_text,"height",2*w+"px"),styleelem(this.texts.objective_text,"font-size",2*f+"px"),styleelem(this.layers.star_c,"width",2.2*w+"px"),styleelem(this.layers.star_c,"height",2.2*w+"px"),styleelem(this.layers.star_c,"margin-left",.5*w+"px"),styleelem(this.layers.star_c,"margin-right",.5*w+"px")}run(){if(this.ctx.clearRect(0,0,1280,100),this.on){let position=this.position+.005*Math.random()-.005*Math.random(),gap=0,fade=1;this.frame++,this.frame>=120&&(this.frame=0);for(let h=0;h<3;h++){this.timers[h]>-1&&this.timers[h]--}if(this.timers[2]>=0){if(fade=Math.max(this.timers[2]-10,0)/15,0==this.timers[2])return this.on=!1,void(this.isActive=!1)}if(this.timers[1]>=0){let mm=Math.max(this.timers[1],0)/5;position=this.position+this.offsetPosition*mm}if(this.timers[0]>=0){gap=1*(Math.max(this.timers[0]-5,0)/12),0==this.timers[0]&&this.movePos(this.supposedPosition),position=.5}this.drawChars(1==~~this.isPlayerTargeted?1-position:position,gap,5*Math.random()+10,fade)}}openClose(bool){this.isActive=bool,styleelem(this.container,"display",bool?"flex":"none")}loadPlayer(l,n){l in this.players||(this.players[l]={}),this.players[l]={r:n.red,g:n.green,b:n.blue,wins:0}}setWins(l,num,isShine){if(!this.isActive)return;let a=this.players[l];if(a.wins=num,styleelem(this.stars.star_c,"fill","#555"),this.maxWins>3)"left"==l&&(styleelem(this.stars.star1_l,"fill",`rgb(${a.r},${a.g},${a.b})`),styleelem(this.texts.starnumber_l,"color",`rgb(${a.r},${a.g},${a.b})`),ihelem(this.texts.starnumber_l,a.wins)),"right"==l&&(styleelem(this.stars.star1_r,"fill",`rgb(${a.r},${a.g},${a.b})`),styleelem(this.texts.starnumber_r,"color",`rgb(${a.r},${a.g},${a.b})`),ihelem(this.texts.starnumber_r,a.wins));else{if("left"==l){for(let h=1;h<this.maxWins;h++)styleelem(this.stars[`star${h}_l`],"fill",h<=a.wins?`rgb(${a.r},${a.g},${a.b})`:"#333");a.wins===this.maxWins&&styleelem(this.stars.star_c,"fill",`rgb(${a.r},${a.g},${a.b})`)}if("right"==l){for(let h=1;h<this.maxWins;h++)styleelem(this.stars[`star${h}_r`],"fill",h<=a.wins?`rgb(${a.r},${a.g},${a.b})`:"#333");a.wins===this.maxWins&&styleelem(this.stars.star_c,"fill",`rgb(${a.r},${a.g},${a.b})`)}}}setMaxWins(num){if(this.maxWins=num,this.isActive)if(num>3){styleelem(this.layers.star_c,"display","none");for(let h=1;h<3;h++)styleelem(this.layers[`star${h}_l`],"display",h<2?"flex":"none"),styleelem(this.layers[`star${h}_r`],"display",h<2?"flex":"none");ihelem(this.texts.objective_text,language.translate("first_to",[this.maxWins]));for(let j of["l","r"])styleelem(this.layers[`starnumber_${j}`],"display","flex");styleelem(this.layers.objective_text,"display","flex")}else{styleelem(this.layers.star_c,"display","flex");for(let h=1;h<3;h++)styleelem(this.layers[`star${h}_l`],"display",h<num?"flex":"none"),styleelem(this.layers[`star${h}_r`],"display",h<num?"flex":"none");for(let j of["l","r"])styleelem(this.layers[`starnumber_${j}`],"display","none");styleelem(this.layers.objective_text,"display","none")}}}(this)}resize(w,h){this.dim.w=w,this.dim.h=h,this.overhead.resize(w,h)}run(){this.on&&this.overhead.run()}async loadAImg(arr){let loadable=[];for(let g of arr)g.name in this.animatedImages||loadable.push(g);if(loadable.length>0){this.loaded=!1;for(let h of loadable){let l=await loadImage(h.dir);this.animatedImages[h.name]=new this.#AnimatedImage(l,h.frame,h.w,h.h,h.bound)}this.loaded=!0}}loadAImgOffline(arr){let loadable=[];for(let g of arr)g.name in this.animatedImages||loadable.push(g);if(loadable.length>0){for(let h of loadable){let l=h.image;this.animatedImages[h.name]=new this.#AnimatedImage(l,h.frame,h.w,h.h,h.bound)}this.loaded=!0}}getAnimatedImage(image){return this.animatedImages[image]}},splash=new class{constructor(){this.video,this.res={w:0,h:0,size:0},this.isActive=!1,this.container=id("SPLASH-MAIN-CONTAINER"),this.frame=0,this.#showHideComponent("MAIN-CANVAS",0),this.splashImage,this.isNext=!1,this.isRunning=!1,this.slides=[{2:()=>{this.#showHideComponent("TEXT-TEXT",0),this.renderer.play("text-show-out"),this.ctx.drawImage(this.splashImage,0,0,1280,720)},17:()=>{__main_params__.appinfo.android?(this.showHide(0),this.toggleRunner(!1),touchButtons.initiateButtons(),fsw.functions.Changelog.start()):(this.#showHideComponent("MAIN-CANVAS",100),this.renderer.play("canvas-show-in"))}},{2:()=>{this.#showHideComponent("MAIN-CANVAS",0),this.renderer.play("canvas-show-out")},17:()=>{this.showHide(0),this.toggleRunner(!1),touchButtons.initiateButtons();let tmbtog=menu.storage.getItem("set_global_toggle_mobilebuttons",1);touchButtons.enableButtons(tmbtog),fsw.functions.Changelog.start()}}],this.slideNumber=0,this.canvas=id("SPLASH-MAIN-CANVAS"),this.ctx=this.canvas.getContext("2d"),this.canvasDim=[1280,720],this.canvas.width=this.canvasDim[0],this.canvas.height=this.canvasDim[1],this.runner=new DateSynchronizedLoopHandler(60,()=>{this.frame++;let a=this.slides[this.slideNumber];this.frame in a&&a[this.frame](),this.renderer.run()});let mm=[];for(let i of["in","out"])mm.push({name:`text-show-${i}`,a:new AnimationFrameRenderer(id("SPLASH-TEXT-TEXT"),0,20,1e3/60,{name:`fade-${i}`,timing:"cubic-bezier(0,0,1,1)"})}),mm.push({name:`canvas-show-${i}`,a:new AnimationFrameRenderer(this.canvas,0,15,1e3/60,{name:`fade-${i}`,timing:"cubic-bezier(0,0,1,1)"})});this.runner.isAsynchronous=!0,this.renderer=new FrameRendererSet(mm,"play","stop","run"),__main_params__.appinfo.android||this.canvas.addEventListener("click",()=>{this.nextSlide()})}switchSlide(number){this.frame=-1,this.slideNumber=number}nextSlide(){this.isRunning&&0==this.slideNumber&&this.switchSlide(1)}toggleRunner(toggle){this.isRunning=toggle,toggle?this.runner.start():this.runner.stop()}showHide(bool){this.isActive=bool,styleelem(id("GTRIS-SPLASH-DIV"),"display",bool?"flex":"none")}#showHideComponent(id,bool){style(`SPLASH-${id}`,"opacity",bool+"%")}resize(w,h,size){this.res.w=w,this.res.h=h,this.res.size=size,styleelem(this.container,"width",`${w}px`),styleelem(this.container,"height",`${h}px`),styleelem(this.canvas,"width",`${w}px`),styleelem(this.canvas,"height",`${h}px`),styleelem(this.container,"font-size",`${size}px`)}},background=new class{constructor(){this.backgroundElem=document.createElement("video"),this.backgroundSrc=document.createElement("source"),this.backgroundElem.append(this.backgroundSrc),this.backgroundFG=id("BACKGROUND-FOREGROUND-LAYER"),this.canvas=id("BG-BG-CANVAS"),this.ctx=getCanvasCtx(this.canvas),this.sizeMult=.421875,this.width=1280*this.sizeMult,this.height=720*this.sizeMult,this.canvas.width=this.width,this.canvas.height=this.height,this.aspectRatio=16/9,this.isOn=!1,this.active="",this.isReady=!0,this.backgroundElem.muted=!0}resize(w,h){this.width=w*this.sizeMult,this.height=w*this.aspectRatio*this.sizeMult,styleelem(this.canvas,"width",`${w}px`),styleelem(this.canvas,"height",`${h}px`)}drawImage(input,sx,sy,sw,sh,x,y,w,h,isFlipped){let ctx=this.ctx,sm=this.sizeMult;isFlipped?(ctx.save(),ctx.translate(x*sm,y*sm),ctx.scale(-1,1),ctx.drawImage(input,sx,sy,sw,sh,-w*sm,0,w*sm,h*sm),ctx.restore()):ctx.drawImage(input,sx,sy,sw,sh,x*sm,y*sm,w*sm,h*sm)}async loadBg(active){if(this.isOn)try{if(active!==this.active){this.isReady=!1,this.active=active;let url=active.split("=")[1];if(""!==url){let blob=await load(url,"blob");this.backgroundSrc.src=URL.createObjectURL(blob),this.backgroundElem.muted=!0,this.backgroundElem.loop=!0,this.backgroundElem.pause(),this.backgroundElem.addEventListener("loadeddata",()=>{this.backgroundElem.play(),this.isReady=!0}),this.backgroundElem.load()}else this.isReady=!0}}catch(e){}else this.isReady=!0}drawVideo(){this.isOn&&this.ctx.drawImage(this.backgroundElem,0,0,1280*this.sizeMult,720*this.sizeMult)}setFGColor(r,g,b,a){styleelem(this.backgroundFG,"background",`rgba(${r},${g},${b},${a})`)}},menu=new class{#charselectCreateSelector(name,isAi){return{version:0,selection:0,character:0,mode:0,team:0,activeControl:0,isOK:0,lastSelection:0,name:name,isAi:isAi,canOK:!1,isAvail:!0,isCharacterCardSelect:0,characterCards:[{version:0,selection:0,lastSelection:0,isOK:0},{version:0,selection:1,lastSelection:0,isOK:0},{version:0,selection:2,lastSelection:0,isOK:0}],characterCardIndex:0}}#SelectionGroup=class{constructor(parent,parameters){this.parent=parent,this.selectedIndex=0,this.isActive=!1,this.entities=[],this.selectables=[],this.mainElememt=parameters.element}changeSelectables(a){this.selectables.length=0;for(let h of a.selectables)this.selectables.push(this.entities[h]);this.selectedIndex=a.default||0}showHide(bool){}};#Selectable=class{constructor(parent,parameters){if(this.parent=parent,this.parameters=parameters,this.string="[No Name]","string"in parameters&&(this.string=language.translate(parameters.string)),"raw_string"in parameters&&(this.string=parameters.raw_string),this.descProps=[],this.items=[],this.current=0,this.absolutePos={},this.absolutePos.y=0,this.absolutePos.my=0,"property"in parameters&&(this.current=parent.storage.getItem(parameters.property,0),-1!==this.parameters.type.indexOf("session")&&(this.current=parent.sessionStorage.getItem(parameters.property,0))),"range_list_specific"===parameters.type)for(let j of this.parent.storage.getList(parameters.property).choices)this.items.push(language.settingTranslate(j)[0]);if(this.description="","desc"in parameters){let k=language.translate(parameters.desc),mm=k.split("$<");for(let j=0;j<mm.length;j++){let r=mm[j].split(">")[0];-1===this.descProps.indexOf(r)&&this.descProps.push(r)}for(let g of this.descProps){let temp=k.replace(new RegExp(`\\$\\<${g}\\>`,"gm"),this.parent.storage.getItem(g));k=temp}this.description=k}"raw_desc"in parameters&&(this.description=parameters.raw_desc)}select(){let a=this.parameters;if("button"===a.type)switch(a.action){case"changelog":fsw.functions.Changelog.open();break;case"discord":{let mm=document.createElement("a");mm.href="https://discord.com/invite/mnSQJQEuXy",mm.target="_blank",mm.click();break}case"submenu":this.parent.changeMenuAsync(a.submenu,a.backable);break;case"submenu_sync":this.parent.changeMenu(a.submenu,a.backable,!1);break;case"unpause":this.parent.game.unpauseGame();break;case"restart":this.parent.game.startGameSet("restart");break;case"end":game.endGame(!0);break;case"mainmenu":this.goToMainMenu();break;case"online_menu":online.isOnline?this.parent.changeMenuAsync("online/main.json",!1):this.goToMainMenu();break;case"start_online":alertWindow.editText("Connecting..."),alertWindow.showhide(!0),online.connect(()=>{alertWindow.showhide(!1),this.parent.changeMenuAsync("online/main.json",!1)},()=>{alertWindow.showhide(!1),log.error("504: Service Unavailable","The server the Game is trying to connect to is down or is experiencing a traffic overload. If this problem persists, contact the developer.")});break;case"online_vsquick":this.parent.characterMenu.setParameters({is_fixed:!0,is_pick_mode:!0,is_ai:!1,players:1,playerpos:"first"}),this.parent.characterMenu.showHide(1),this.parent.characterMenu.setCallback(e=>{let player=e.players[0],name=player.name,character=player.character,version=player.version,mode=player.mode,mel={def:0,name:"vsquick_matchmaking",title:"vsquick_matchmaking",sel:[{string:"vsquick_matchmaking_stop",type:"button",action:"online_vsquick_stop",onstate:"#ffff",offstate:"#fff2",desc:"vsquick_matchmaking_stop_desc",backable:!1}],background:{type:"rgba",color:"#222F"}};this.parent.changeMenu(JSON.stringify(mel),!1);let wr=online.createWriter("START_QUICK_MATCH",2+name.length+3);wr.string(name,16),wr.u8(character),wr.u8(version),wr.u8(mode),online.send(wr.buffer)}),this.parent.characterMenu.parameters.modeparams.length=0,this.parent.characterMenu.selectUnderControl=0;break;case"online_disconnect":this.goToMainMenu(),online.close();break;case"online_vsquick_stop":online.emit("STOP_QUICK_MATCH",[]),online.isOnline?this.parent.changeMenuAsync("online/main.json",!1):this.goToMainMenu();break;case"online_createroom":fsw.functions.OnlineCreateRoom.open();break;case"init":{let param=JSON.parse(JSON.stringify(a.charselect_param));param.is_fixed||(param.players=parseInt(this.parent.storage.getValueFromRangeListSpecific("set_session_playeramount"))),this.parent.characterMenu.setParameters(param),this.parent.characterMenu.showHide(1),this.parent.setInit(a.init),this.parent.characterMenu.parameters.modeparams.length=0;for(let z of a.mode_param)this.parent.characterMenu.parameters.modeparams.push(z);this.parent.characterMenu.selectUnderControl=0,this.parent.characterMenu.setCallback(res=>{game.actualParameters.players=res.players,game.actualParameters.playerOrder=res.playerOrder;let sms=this.parent.characterMenu;game.seeds.round.seed=~~(2147483647*Math.random());let main=this.parent,professionalExists=!1,sel=[{string:"gameprep_start",type:"button",action:"actualinit",onstate:"#ffff",offstate:"#fff2",desc:"replaycenter_loadexternal_desc",backable:!0}];for(let g of sms.parameters.modeparams){let w=g.split("|"),setting=main.storage.getList(`set_prep_${w[0]}`);"professional"==w[0]&&(professionalExists=!0),sel.push({string:`gameprepset_${w[2]}`,type:setting.type,onstate:"#ffff",offstate:"#fff2",property:`set_prep_${w[1]}`,list:`set_prep_${w[0]}`,desc:`gameprepset_${w[2]}_desc`})}main.sessionStorage.createTempList("das",{});let mel={def:0,name:"gameprep_start",title_raw:language.translate("gameprep_title"),sel:sel,background:{type:"rgba",color:"#222F"}};main.changeMenu(JSON.stringify(mel),!0)});break}case"actualinit":game.startGameSet("actual");break;case"function":{let result=a.function;if("args"in a){let args=JSON.parse(JSON.stringify(g.args)),ii=Object.keys(args);for(let v=0;v<ii.length;v++){let varInstance=args[ii[v]],placeholder=`#par=${ii[v]}`,regExp=new RegExp(placeholder,"gm");result=result.replace(regExp,varInstance)}}new Function(["menu_global","evt"],result)(__main_params__.__private.menu,event);break}case"nameplate":this.parent.storage.getItem("playername");fsw.functions.Nameplate.open();break;case"keybindsetting":fsw.functions.Keybinds.openSettings(a.keybind);break;case"choiceselect":{this.parent.storage.setItem(a.select_property,a.select_choice);let ay=this.parent.submenuSequence.pop();this.parent.changeMenu(ay,!1,!0),this.parent.switchSelectionNumber(a.parent_order),this.parent.saveFrame=60;break}case"replaycenter":this.parent.openReplayCenter();break;case"replaycurrent":this.parent.loadReplayData(game.replayDataToString(),!1);break;case"replayreload":this.parent.loadReplayData(this.parent.replayDataString,!1);break;case"replaydownload":this.parent.downloadReplayData();break;case"replayreplay":game.startReplay();break;case"replayupload":{let y=document.createElement("input");y.setAttribute("type","file"),y.onchange=event=>{let h=event.target.files[0];if(h.name.endsWith(".gtlrx")){let reader=new FileReader;reader.readAsText(h,"UTF-8"),reader.onload=read=>{var ctx=read.target.result;try{let test=ctx;this.parent.loadReplayData(test,!1)}catch(e){this.parent.playSound("error")}}}else this.parent.playSound("error")},y.click();break}case"replayminmax":{let lam=JSON.parse(this.parent.replayDataString),replays=lam.replays,selectedReplays=[],min=this.parent.sessionStorage.getItem("replay_start_round"),max=this.parent.sessionStorage.getItem("replay_end_round");if(max>min)for(let i=min;i<=max;i++)selectedReplays.push(replays[i]);else for(let i=min;i>=max;i--)selectedReplays.push(replays[i]);lam.replays=selectedReplays,game.parseReplayFile(JSON.stringify(lam),0,9999,this.parameters.is_file);break}case"replayallstart":game.parseReplayFile(this.parent.replayDataString,0,9999,a.is_file)}if("range_list_specific"===a.type&&this.parent.openChoices(language.translate(a.string,void 0),a.property,a.list,this.current,a.order),"switch"===a.type){let prop=a.property,b=this.parent.storage.getItem(prop);b=[1,0][this.parent.storage.getItem(prop)],this.parent.storage.setItem(prop,b),this.current=b,this.parent.saveFrame=60}}goToMainMenu(){this.parent.changeMenu(JSON.stringify(this.parent.mainMenu),!1)}hover(){""!==this.description&&ih("MMC-FOOTER-TEXT",this.description)}adjust(number){let a=this.parameters;if("range_minmax"===a.type){let prop=a.property,setting=a.list,b=this.parent.storage.getItem(prop),preset=this.parent.presetSettings[setting];b+=number,b>preset.max&&(b=preset.max),b<preset.min&&(b=preset.min),this.parent.storage.setItem(prop,b),this.current=b,this.parent.saveFrame=60}if("session_range_minmax"===a.type){let prop=a.property,temp=a.templist,b=this.parent.sessionStorage.getItem(prop),preset=this.parent.sessionStorage.getTempList(temp);b+=number,b>preset.max&&(b=preset.max),b<preset.min&&(b=preset.min),this.parent.sessionStorage.setItem(prop,b),this.current=b}if("range_list_specific"===a.type){let prop=a.property,setting=a.list,b=this.parent.storage.getItem(prop),preset=this.parent.storage.getList(setting);b+=number,b>preset.max&&(b=preset.max),b<preset.min&&(b=preset.min),this.parent.storage.setItem(prop,b),this.current=b,this.parent.saveFrame=60}}};storage=new class{constructor(){this.fixedData={playername:"Player 1",lang:"en-US",keyboard:{},patchnote_is_seen:0,version:""},this.data=JSON.parse(JSON.stringify(this.fixedData)),this.stringFetchData="",this.lists={}}initialize(){this.data.keyboard=keypressManager.defaultToSortedJSON()}setItem(prop,val){this.data[prop]=val}loadData(jsonString){let evaluator=JSON.parse(jsonString),func=(base,check)=>{if(void 0!==check)for(let a in base)base[a]instanceof Object?func(base[a],check[a]):typeof check[a]==typeof base[a]&&(base[a]=check[a])};func(this.data,evaluator)}loadUserData(lo){this.stringFetchData=lo}createList(name,obj){this.lists[name]=obj}getList(a){return this.lists[a]}getItem(prop,substitute){return prop in this.data?this.data[prop]:void 0!==substitute?substitute:null}getValueFromRangeListSpecific(prop){return this.getList(prop).choices[this.getItem(prop,0)].split("||")[1]}save(){__main_params__.database.write("local_data","userdata",JSON.stringify(this.data))}};sessionStorage=new class{constructor(){this.data={replayfrom:0,replayto:0,replayselections:"0,1,2,3,4,5,6"},this.tempLists={}}createTempList(name,obj){this.tempLists[name]=obj}getTempList(a){return this.tempLists[a]}setItem(prop,val){this.data[prop]=val}getItem(prop,substitute){return prop in this.data?this.data[prop]:void 0!==substitute?substitute:null}};constructor(){this.canvas={},this.game=game,this.pauseSels={def:0,name:"pause",title:"pause_title",sel:[{string:"pause_resume",type:"button",action:"unpause",onstate:"#ffff",offstate:"#fff2",desc:"pause_resume_desc"},{string:"pause_restart",type:"button",action:"restart",onstate:"#ffff",offstate:"#fff2",desc:"pause_restart_desc"},{string:"pause_end",type:"button",action:"end",onstate:"#f00f",offstate:"#f002",desc:"pause_end_desc"}],background:{type:"rgba",color:"#222F"}},this.pauseReplaySels={def:0,name:"pause",title:"pause_replay_title",sel:[{string:"pause_resume",type:"button",action:"unpause",onstate:"#ffff",offstate:"#fff2",desc:"pause_replay_resume_desc"},{string:"pause_restart",type:"button",action:"replayreplay",onstate:"#ffff",offstate:"#fff2",desc:"pause_replay_restart_desc"},{string:"pause_replay_end",type:"button",action:"end",onstate:"#f00f",offstate:"#f002",desc:"pause_replay_end_desc"}],background:{type:"rgba",color:"#222F"}},this.isControlsEdit=!1,this.controlsEditCancelTime=0,this.isPressed=!1;let gson={def:0,sel:[{string:"menu_start",desc:"menu_start_desc",type:"button",action:"submenu",onstate:"#ffff",offstate:"#fff2",backable:!0,submenu:"start/start.json"},{string:"menu_replaycenter",desc:"menu_replaycenter_desc",type:"button",action:"replaycenter",onstate:"#ffff",offstate:"#fff2",backable:!0},{string:"menu_settings",desc:"menu_settings_desc",type:"button",action:"submenu",init:4,onstate:"#ffff",offstate:"#fff2",backable:!0,submenu:"settings/list.json"},{string:"menu_changelog",desc:"menu_changelog_desc",type:"button",action:"changelog",onstate:"#ffff",offstate:"#fff2"},{string:"menu_discord",desc:"menu_discord_desc",type:"button",action:"discord",onstate:"#ffff",offstate:"#fff2"}],title:"menu_main",name:"main",background:{type:"rgba",color:"#222F"}};this.pressAButtonDelay=0,this.mainMenu=JSON.parse(JSON.stringify(gson)),this.sounds={},this.saveFrame=-1,elem("canvas",canvas=>{canvas.width=1280,canvas.height=720,this.canvas=canvas,this.ctx=canvas.getContext("2d")}),this.presetSettings={},this.center={x:640,y:360},this.landscape={w:0,h:0},this.cellSize=0,this.layout={},this.isMenu=!1,this.isControllable=!0,this.transitionFrame=0,this.submenuSequence=[],this.menus={},this.hold={frame:0,on:!1,press:""},this.touchArea={x:0,y:0,start:{x:0,y:0},difference:{x:0,y:0},isPress:!1,isNoMove:!1,isSelectable:!1},this.touchSensitivity={x:3,y:3,difference:{x:0,y:0},direction:0},this.interactHardwareType=0,this.mouseArea={x:0,y:0,start:{x:0,y:0},difference:{x:0,y:0},isPress:!1,isNoMove:!1,isSelectable:!1},this.mouseSensitivity={x:3,y:3,difference:{x:0,y:0},direction:0},this.nativeElementsUnderHardwareInput={back:!1},this.canBack=!1,this.temporaryElements={elements:{},elementObjects:{},resizeObjects:{}},this.menuList={},this.elementObjects={},this.resizeObjects={},this.mainElement=document.createElement("GTRIS-MENU-SCREEN"),this.mainElement.style="display: flex; justify-content: center; align-items: center; flex-direction: column;",this.container=id("MENU-MAIN-CONTENT"),this.pauseContainer=id("MENU-PAUSE-DIV"),this.headerContainer=id("MENU-HEADER"),this.characterContainer=id("MENU-CHARSELECT-DIV"),this.core=id("GTRIS-MENU-DIV"),this.canvas=id("MM-CONTENT-CANVAS"),this.ctx=getCanvasCtx(this.canvas),this.canvasDims={ar:16/9,w:1280,h:720,c:1280/30},this.canvas.width=this.canvasDims.w,this.canvas.height=this.canvasDims.h,this.elements={},this.selectables=[],this.selectionGroupName="",this.selectableActive=0,this.selectedJson="",this.scroll={y:0,currentY:0,startY:0},this.isLoading=!1,this.replayDataString="",this.characterMenu.showHide(0),this.keybindChange={duration:45,isActive:!1,change:0,index:0},this.volume=1}loadReplayData(dataString,isFile){let a=JSON.parse(dataString);this.replayDataString=dataString;let max=a.replays.length-1,sel=[{string:"replayload_playall",type:"button",action:"replayallstart",onstate:"#ffff",offstate:"#fff2",is_file:isFile,desc:"replayload_playall_desc"}];if(max>0){this.sessionStorage.setItem("replay_start_round",0),this.sessionStorage.setItem("replay_end_round",max),this.sessionStorage.createTempList("replay_start_round",{type:"range_minmax",min:0,max:max,text:"text_limit_of",offset:1}),this.sessionStorage.createTempList("replay_end_round",{type:"range_minmax",min:0,max:max,text:"text_limit_of",offset:1});let h=[{string:"replayloadmm_range_start_slider",type:"session_range_minmax",action:"unpause",onstate:"#ffff",offstate:"#fff2",property:"replay_start_round",templist:"replay_start_round",desc:"replayload_range_start_slider_desc"},{string:"replayloadmm_range_end_slider",type:"session_range_minmax",action:"unpause",onstate:"#ffff",offstate:"#fff2",property:"replay_end_round",templist:"replay_end_round",desc:"replayload_range_end_slider_desc"},{string:"replayloadmm_play",type:"button",action:"replayminmax",onstate:"#ffff",offstate:"#fff2",is_file:isFile,desc:"replayload_playall_desc"}],shel={def:0,name:"replaymenu",title_raw:`${a.title}`,sel:h,background:{type:"rgba",color:"#225F"}};sel.push({string:"replayload_minmax",type:"button",action:"submenu_sync",onstate:"#ffff",offstate:"#fff2",submenu:JSON.stringify(shel),desc:"replayload_minmax_desc",backable:!0})}let mel={def:0,name:"replaymenu",title_raw:a.title,sel:sel,background:{type:"rgba",color:"#222F"}};this.changeMenu(JSON.stringify(mel),!0)}openChoices(title,prop,current,setting,order){let a=this.storage.getList(prop),j=a.choices,sel=(a.max,[]);for(let y=0;y<j.length;y++){let p=j[y],h=language.settingTranslate(p);sel.push({raw_string:h[0],type:"button",action:"choiceselect",select_property:prop,onstate:"#ffff",offstate:"#fff2",select_choice:y,parent_order:order,raw_desc:h[1]})}let mel={def:this.storage.getItem(prop,0),name:"selector",title_raw:title,sel:sel,background:{type:"rgba",color:"#222F"}};this.changeMenu(JSON.stringify(mel),!0)}openPreselectionSettings(a){let param=a.charselect_param;this.parent.characterMenu.setParameters(param),this.parent.characterMenu.showHide(1),this.parent.setInit(a.init),this.parent.characterMenu.parameters.modeparams.length=0;for(let z of a.mode_param)this.parent.characterMenu.parameters.modeparams.push(z)}openReplayCenter(){let sel=[{string:"replaycenter_upload",type:"button",action:"replayupload",onstate:"#ffff",offstate:"#fff2",desc:"replaycenter_upload_desc",backable:!0}];""!==this.replayDataString&&sel.push({string:"replaycenter_current",type:"button",action:"replayreload",onstate:"#ffff",offstate:"#fff2",desc:"replaycenter_current_desc",backable:!0});let mel={def:0,name:"replaycenter",title:"replaycenter_title",sel:sel,background:{type:"rgba",color:"#222F"}};this.changeMenu(JSON.stringify(mel),!0)}downloadReplayData(){let u=game.replayDataToString(),a=document.createElement("a"),blob=new Blob([u],{type:"application/octet-stream"});a.setAttribute("href",URL.createObjectURL(blob)),a.setAttribute("download",`gtrislegends-${Date.now()}.gtlrx`),a.click()}MenuElementFrameAnimationRenderer=class{constructor(element,initial,max,fps,param,addFunc){this.param=param||{};let paramDel="delay"in param?param.delay:0;this.a=new FrameRenderer(initial,max+paramDel,(frame,maxFrame)=>{maxFrame-Math.max(0,frame-paramDel)>=0&&styleelem(this.element,"animation-delay",~~(1e3/-60*Math.min(maxFrame,Math.max(frame+1-paramDel,1)))+"ms")},addFunc,"loop"in param&&param.loop),this.element=element,this.fps=fps,this.max=max,this.isLoop="loop"in param&&param.loop}play(){this.element.offsetHeight,styleelem(this.element,"animation-name",this.param.name),styleelem(this.element,"animation-duration",~~(this.fps*this.max)+"ms"),styleelem(this.element,"animation-timing-function",this.param.timing),styleelem(this.element,"animation-iteration-count",this.isLoop?"infinite":"1"),styleelem(this.element,"animation-play-state","paused"),this.a.reset()}run(){this.a.run()}reset(){styleelem(this.element,"animation-name","none"),this.a.toggleEnable(!1)}};load(){return new Promise(async res=>{let a=await load("./assets/menu/menu.json","text"),json=JSON.parse(a);this.changeMenu(JSON.stringify(this.mainMenu),!1),id("HEADER-BACK").addEventListener("click",()=>{this.backButton()},!1);for(let g in json.sounds)this.sounds[g]=audioMaster.createAudio({src:`/assets/menu/${json.sounds[g]}`,format:"ogg",loop:!1,preload:!1}),await this.sounds[g].load();res()})}elementFocus(){this.isElementFocus=!0}saveData(){this.storage.save(),this.checkData()}checkData(){let mfxvol=this.storage.getItem("set_global_mfx",0);mfxvol!==music.volume&&music.volumeSet(mfxvol);let sfxvol=this.storage.getItem("set_global_sfx",0);sfxvol!==sound.volume&&sound.volumeSet(sfxvol);let vofxvol=this.storage.getItem("set_global_voice",0);vofxvol!==game.voiceVolume&&(game.voiceVolume=vofxvol);let ifxvol=this.storage.getItem("set_global_interface_sfx",0);ifxvol!==this.volume&&(this.volume=ifxvol);let tmbtog=this.storage.getItem("set_global_toggle_mobilebuttons",1);touchButtons.enableButtons(tmbtog)}checkStorageSettings(){let data={};""!==this.storage.stringFetchData&&(data=JSON.parse(this.storage.stringFetchData));for(let b in this.presetSettings){let c=this.presetSettings[b];"range_list_specific"===c.type&&(c.min=0,c.max=c.choices.length-1),"switch"===c.type&&(c.min=0,c.max=1),this.storage.setItem(b,b in data?data[b]:c.default);for(let h in c.default_obj){let t=`${b}(${h})`;this.storage.setItem(t,t in data?data[t]:c.default_obj[h])}this.storage.createList(b,c)}}changeSelectables(_json){this.selectables.length=0;let json=JSON.parse(JSON.stringify(_json));for(let u=0;u<json.sel.length;u++){let ref=json.sel[u];ref.size=1,ref.order=u}for(let g of json.sel)this.selectables.push(new this.#Selectable(this,g));for(let u=0;u<this.selectables.length;u++){this.selectables[u].size=1}json.def;this.selectables[json.def]&&this.switchSelectionNumber(json.def),this.checkSelectables(),this.elementFocus()}changeMenu(_json,backable,isBack){let json=JSON.parse(_json);backable?(this.submenuSequence.push(this.selectedJson),style("HEADER-TITLE-DIV","margin-left","5em"),this.canBack=!0):(isBack||(this.submenuSequence.length=0),style("HEADER-TITLE-DIV","margin-left",this.submenuSequence.length>0?"5em":"0em"),this.canBack=this.submenuSequence.length>0),"title"in json&&ih("HEADER-TITLE-TEXT",language.translate(json.title)),"title_raw"in json&&ih("HEADER-TITLE-TEXT",json.title_raw),this.selectedJson=_json,this.changeSelectables(json),this.elementFocus()}refreshMenu(){let sel=this.selectableActive;this.changeSelectables(JSON.parse(this.selectedJson)),this.selectableActive=sel,this.selectables[this.selectableActive].hover(),this.elementFocus()}changeMenuAsync(url,backable){this.isLoading=!0,load(`assets/menu/sections/${url}`,"text").then(m=>{this.isLoading=!1,this.changeMenu(m,backable),this.elementFocus()})}switchSelectionNumber(number){this.selectableActive!=number&&(this.selectableActive=number,this.playSound("hover"))}refreshSelectionGroup(){this.selectionGroup={};for(let h in this.elementObjects){let a=this.elementObjects[h];"default_attributes"in a&&"id_selectable"in a.default_attributes&&"number_selectable"in a.default_attributes&&(a.default_attributes.id_selectable in this.selectionGroup||(this.selectionGroup[a.default_attributes.id_selectable]={def:0,elem:{},number:0}),this.selectionGroup[a.default_attributes.id_selectable].elem[a.default_attributes.number_selectable]={a:a,name:h,hoverIn:a.__event_functions.mouseover,hoverOut:a.__event_functions.mouseout,click:a.__event_functions.click},"is_default_select"in a.default_attributes&&a.default_attributes.is_default_select&&(this.selectionGroup[a.default_attributes.id_selectable].def=this.selectionGroup[a.default_attributes.id_selectable].number=a.default_attributes.number_selectable))}}playSound(name){this.sounds[name].stop(),this.sounds[name].play(),this.sounds[name].volume(this.volume/100)}run(){this.pressAButtonDelay>0&&this.pressAButtonDelay--,this.ctx.clearRect(0,0,1280,720);let ld=id("GTRIS-MENU-DIV").getBoundingClientRect(),lx=this.touchArea.x-ld.x,ly=this.touchArea.y-ld.y;0==this.interactHardwareType?(lx=this.mouseArea.x-ld.x,ly=this.mouseArea.y-ld.y):(lx=this.touchArea.x-ld.x,ly=this.touchArea.y-ld.y),this.touchArea.isSelectable=!1,this.mouseArea.isSelectable=!1;for(let s in this.nativeElementsUnderHardwareInput)this.nativeElementsUnderHardwareInput[s]=!1;if(lx/this.landscape.w*this.canvasDims.w>=0&&lx/this.landscape.w*this.canvasDims.w<=3*this.canvasDims.c&&ly/this.landscape.h*this.canvasDims.h>=0&&ly/this.landscape.h*this.canvasDims.h<=1.5*this.canvasDims.c)this.nativeElementsUnderHardwareInput.back=!0;else for(let g=0;g<this.selectables.length;g++){let mm=this.selectables[g],reference=mm.parameters,my=0;this.selectableActive,"button"===reference.type&&(my=reference.size*this.canvasDims.c*1.8),"range_minmax"===reference.type&&(my=reference.size*this.canvasDims.c*1*2.6),"session_range_minmax"===reference.type&&(my=reference.size*this.canvasDims.c*1*2.6),"range_list_specific"===reference.type&&(my=reference.size*this.canvasDims.c*1*2.6),"switch"===reference.type&&(my=reference.size*this.canvasDims.c*1.8),this.ctx.fillStyle="#8388",(this.touchArea.isPress||0==this.interactHardwareType)&&lx/this.landscape.w*this.canvasDims.w>=0*this.canvasDims.w&&lx/this.landscape.w*this.canvasDims.w<=.75*this.canvasDims.w&&ly/this.landscape.h*this.canvasDims.h>=mm.absolutePos.y&&ly/this.landscape.h*this.canvasDims.h<=my+mm.absolutePos.y&&(this.switchSelectionNumber(g),0==this.interactHardwareType&&(this.mouseArea.isSelectable=!0),1==this.interactHardwareType&&(this.touchArea.isSelectable=!0))}this.isElementFocus&&(this.isElementFocus=!1,this.scroll.currentY=this.selectables[this.selectableActive].absolutePos.my),this.draw()}runInBackground(){this.hold.on&&(this.hold.frame--,0==this.hold.frame&&this.controlsListen(this.hold.press,"hold")),this.saveFrame>=0&&(this.saveFrame--,0==this.saveFrame&&this.saveData())}selectableClick(){this.nativeElementsUnderHardwareInput.back&&this.pressBButton(),(this.touchArea.isSelectable||this.mouseArea.isSelectable)&&this.pressAButton()}draw(){this.characterMenu.draw();let my=0;for(let g=0;g<this.selectables.length;g++){let mm=this.selectables[g],reference=mm.parameters,le="#fff6";if(g==this.selectableActive&&(le="#ffff"),this.scroll.y=this.canvasDims.h/2-this.scroll.currentY,mm.absolutePos.y=this.scroll.y+my,mm.absolutePos.my=my,"button"===reference.type){this.ctx.fillStyle=le;let p=this.ctx;p.beginPath(),p.moveTo(0,this.scroll.y+my-reference.size*this.canvasDims.c*.5),p.lineTo(.7*this.canvasDims.w,this.scroll.y+my-reference.size*this.canvasDims.c*.5),p.lineTo(.65*this.canvasDims.w,this.scroll.y+my+reference.size*this.canvasDims.c*1.3),p.lineTo(0*this.canvasDims.w,this.scroll.y+my+reference.size*this.canvasDims.c*1.3),this.ctx.fill(),this.ctx.font=reference.size*this.canvasDims.c+"px default-ttf",this.ctx.strokeStyle="#000",this.ctx.lineWidth=10,this.ctx.strokeText(mm.string,.15*this.canvasDims.w,this.scroll.y+my+reference.size*this.canvasDims.c*.75),this.ctx.fillText(mm.string,.15*this.canvasDims.w,this.scroll.y+my+reference.size*this.canvasDims.c*.75),my+=reference.size*this.canvasDims.c*2}if("range_minmax"===reference.type){my+=reference.size*this.canvasDims.c*1;let prop=this.presetSettings[reference.list];this.ctx.font=reference.size*this.canvasDims.c*.8+"px default-ttf",this.ctx.strokeStyle="#000";let lo=`${mm.string}: ${language.translate(prop.text,[mm.current])}`;this.ctx.lineWidth=10,this.ctx.strokeText(lo,.15*this.canvasDims.w,this.scroll.y+my),this.ctx.fillStyle=le,this.ctx.fillText(lo,.15*this.canvasDims.w,this.scroll.y+my),my+=reference.size*this.canvasDims.c*.6;let lsd=this.canvasDims.w-.1*this.canvasDims.w*2;this.ctx.fillRect(.1*this.canvasDims.w,my+this.scroll.y,lsd,reference.size*this.canvasDims.c*1);let pad=.1*this.canvasDims.c*reference.size;this.ctx.clearRect(.1*this.canvasDims.w+pad/2,this.scroll.y+my+pad/2,lsd-pad,reference.size*this.canvasDims.c*1*.9),this.ctx.fillRect(.1*this.canvasDims.w+pad/2,this.scroll.y+my+pad/2,(mm.current-prop.min)/(prop.max-prop.min)*(lsd-pad),reference.size*this.canvasDims.c*1*.9),my+=reference.size*this.canvasDims.c*1*2}if("session_range_minmax"===reference.type){my+=reference.size*this.canvasDims.c*1;let prop=this.sessionStorage.getTempList(reference.templist);this.ctx.font=reference.size*this.canvasDims.c*.8+"px default-ttf",this.ctx.strokeStyle="#000";let off="offset"in prop?prop.offset:0,lo=`${mm.string}: ${language.translate(prop.text,[mm.current+off,prop.max+off])}`;this.ctx.lineWidth=10,this.ctx.strokeText(lo,.15*this.canvasDims.w,this.scroll.y+my),this.ctx.fillStyle=le,this.ctx.fillText(lo,.15*this.canvasDims.w,this.scroll.y+my),my+=reference.size*this.canvasDims.c*.6;let lsd=this.canvasDims.w-.1*this.canvasDims.w*2;this.ctx.fillRect(.1*this.canvasDims.w,my+this.scroll.y,lsd,reference.size*this.canvasDims.c*1);let pad=.1*this.canvasDims.c*reference.size;this.ctx.clearRect(.1*this.canvasDims.w+pad/2,this.scroll.y+my+pad/2,lsd-pad,reference.size*this.canvasDims.c*1*.9),this.ctx.fillRect(.1*this.canvasDims.w+pad/2,this.scroll.y+my+pad/2,(mm.current-prop.min)/(prop.max-prop.min)*(lsd-pad),reference.size*this.canvasDims.c*1*.9),my+=reference.size*this.canvasDims.c*1*2}if("range_list_specific"===reference.type){my+=reference.size*this.canvasDims.c*1;let prop=this.presetSettings[reference.list];this.ctx.font=reference.size*this.canvasDims.c*.8+"px default-ttf",this.ctx.strokeStyle="#000";let lo=`${mm.string}: ${mm.items[mm.current]}`;this.ctx.lineWidth=10,this.ctx.strokeText(lo,.15*this.canvasDims.w,this.scroll.y+my),this.ctx.fillStyle=le,this.ctx.fillText(lo,.15*this.canvasDims.w,this.scroll.y+my);let lsd=this.canvasDims.w-.1*this.canvasDims.w*2,msd=reference.size*this.canvasDims.c*.6;this.ctx.fillRect(.1*this.canvasDims.w,my+this.scroll.y+msd,lsd,reference.size*this.canvasDims.c*1);let pad=.1*this.canvasDims.c*reference.size;this.ctx.clearRect(.1*this.canvasDims.w+pad/2,this.scroll.y+my+pad/2+msd,lsd-pad,reference.size*this.canvasDims.c*1*.9),this.ctx.fillRect(.1*this.canvasDims.w+pad/2,this.scroll.y+my+pad/2+msd,(mm.current-prop.min)/(prop.max-prop.min)*(lsd-pad),reference.size*this.canvasDims.c*1*.9),my+=reference.size*this.canvasDims.c*1*2.6}if("switch"===reference.type){my+=reference.size*this.canvasDims.c*1;let prop=this.presetSettings[reference.list];this.ctx.font=reference.size*this.canvasDims.c*.8+"px default-ttf",this.ctx.strokeStyle="#000";let lo=`${mm.string}: ${language.settingTranslate(1==mm.current?prop.on:prop.off)[0]}`,lc=reference.size*this.canvasDims.c*1.6;this.ctx.drawImage(game.misc[1==mm.current?"menu_switch_on":"menu_switch_off"],.15*this.canvasDims.w,this.scroll.y+my-lc/1.6,lc,lc),this.ctx.lineWidth=10,this.ctx.strokeText(lo,.16*this.canvasDims.w+lc,this.scroll.y+my),this.ctx.fillStyle=le,this.ctx.fillText(lo,.16*this.canvasDims.w+lc,this.scroll.y+my),my+=reference.size*this.canvasDims.c*2}}if(this.canBack){let mms="normal";this.nativeElementsUnderHardwareInput.back&&(mms=this.touchArea.isPress||this.mouseArea.isPress?"press":"hover"),this.ctx.drawImage(game.misc[`menu_back_${mms}`],0,0,3*this.canvasDims.c,1.5*this.canvasDims.c)}}moveUp(){this.characterMenu.isActive?this.characterMenu.controlsListen("arrowup"):this.isControllable&&0!==this.selectables.length&&(this.selectableActive--,this.selectableActive<0?this.selectableActive=0:(this.checkSelectables(),this.playSound("move"),this.elementFocus()))}moveDown(){this.characterMenu.isActive?this.characterMenu.controlsListen("arrowdown"):this.isControllable&&(this.selectableActive++,this.selectableActive>this.selectables.length-1?this.selectableActive=this.selectables.length-1:(this.checkSelectables(),this.playSound("move"),this.elementFocus()))}setupMouseListener(){for(let pp of["mouseover","contextmenu","mousedown","mouseup","mousemove","wheel"])window.addEventListener(pp,ee=>{fsw.isShown||(ee.preventDefault(),this.mouseListen(ee),this.characterMenu.panelInteractListen(ee))},!0)}mouseListen(evt){if(splash.isActive)return;let t=evt;if(!fsw.isShown&&!this.characterMenu.isActive&&menu.isControllable&&menu.isMenu)if(this.interactHardwareType=0,"wheel"==evt.type){evt.deltaY>=0?this.scroll.currentY+=1*this.canvasDims.c:this.scroll.currentY-=1*this.canvasDims.c}else if("mouseover"==evt.type);else if("mousemove"==evt.type){if(this.mouseArea.x=t.pageX,this.mouseArea.y=t.pageY,this.touchArea.isPress=!1,this.touchArea.isNoMove=!1,this.mouseArea.isPress){this.mouseArea.difference.x=t.pageX-this.mouseArea.start.x,this.mouseArea.difference.y=t.pageY-this.mouseArea.start.y;let dx=this.mouseArea.x-this.mouseSensitivity.difference.x,dy=this.mouseArea.y-this.mouseSensitivity.difference.y,hs=!0;if(1==this.mouseSensitivity.direction||0==this.mouseSensitivity.direction){let l=!1;for(0==this.mouseSensitivity.direction&&(Math.abs(dx)>=2*game.cellSize&&(this.mouseSensitivity.direction=1),Math.abs(dy)>=2*game.cellSize&&(this.mouseSensitivity.direction=2),Math.abs(dx)>=.5*game.cellSize&&(hs=!1),Math.abs(dy)>=.5*game.cellSize&&(hs=!1));1==this.mouseSensitivity.direction&&dx>this.mouseSensitivity.x;)this.mouseSensitivity.difference.x+=this.mouseSensitivity.x,dx-=this.mouseSensitivity.x,this.moveRight(),l=!0;for(;dx<-this.mouseSensitivity.x;)this.mouseSensitivity.difference.x-=this.mouseSensitivity.x,dx+=this.mouseSensitivity.x,this.moveLeft(),l=!0;l&&(this.mouseSensitivity.direction=1),hs=l}if(2==this.mouseSensitivity.direction||0==this.mouseSensitivity.direction){let l=Math.abs(this.mouseArea.difference.y)>1;l&&(this.mouseSensitivity.direction=2),hs=l,this.scroll.currentY=this.scroll.startY-this.mouseArea.difference.y}hs&&(this.mouseArea.isNoMove=!1)}}else fsw.isShown||this.characterMenu.isActive||("mousedown"==evt.type&&(this.mouseSensitivity.direction=0,this.mouseArea.isPress=!0,this.mouseArea.isNoMove=!0,this.mouseArea.start.x=t.pageX,this.mouseArea.start.y=t.pageY,this.mouseArea.difference.x=0,this.mouseArea.difference.y=0,this.mouseArea.x=t.pageX,this.mouseArea.y=t.pageY,this.mouseSensitivity.difference.x=t.pageX,this.mouseSensitivity.difference.y=t.pageY,this.scroll.startY=this.scroll.currentY),"mouseup"==evt.type&&(this.mouseArea.isNoMove&&this.selectableClick(),this.touchArea.isPress=!1,this.touchArea.isNoMove=!1,this.mouseArea.isPress=!1,this.mouseArea.isNoMove=!1))}checkSelectables(){this.selectables[this.selectableActive].hover()}moveLeft(){if(this.characterMenu.isActive)return void this.characterMenu.controlsListen("arrowleft");if(!this.isControllable)return;if(0===this.selectables.length)return;this.selectables[this.selectableActive].adjust(-1),this.playSound("move")}moveRight(){if(this.characterMenu.isActive)return void this.characterMenu.controlsListen("arrowright");if(!this.isControllable)return;if(0===this.selectables.length)return;this.selectables[this.selectableActive].adjust(1),this.playSound("move")}pressAButton(){if(!(this.pressAButtonDelay>0))if(this.characterMenu.isActive)this.characterMenu.controlsListen("enter");else if(0!==this.selectables.length&&this.isControllable&&!(this.selectables.length<0)){if(this.isControllable){this.selectables[this.selectableActive].select(),this.playSound("select")}this.pressAButtonDelay=10}}pressBButton(){this.isControllable&&this.backButton()}controlsListen(name,k){if(!this.isLoading&&!this.characterMenu.isWait&&!splash.isActive&&game.startGameParameters.frame<=0&&!fsw.isShown){let preventHold=!1;switch(name){case"up":"up"!==k&&this.moveUp();break;case"down":"up"!==k&&this.moveDown();break;case"left":"up"!==k&&this.moveLeft();break;case"right":"up"!==k&&this.moveRight();break;case"a":"up"!==k&&(this.pressAButton(),preventHold=!0);break;case"b":"up"!==k&&(this.pressBButton(),preventHold=!0)}preventHold||(this.hold.press=name,"down"==k&&(this.hold.frame=25,this.hold.on=!0),"hold"==k&&this.hold.on&&(this.hold.frame=2),"up"==k&&(this.hold.on=!1))}}getID(elementID){let h=0;return elementID in this.elements&&(h=this.elements[elementID]),h}isExistingElement(elementID){return elementID in this.elements}isExistingObj(elementID){return elementID in this.elementObjects}getIDTemp(elementID){let h=0;return elementID in this.temporaryElements.elements&&(h=this.temporaryElements.elements[elementID]),h}isExistingElementTemp(elementID){return elementID in this.temporaryElements.elements}resize(cellSize,fontSize,w,h){this.cellSize=cellSize,this.fontSize=fontSize,this.landscape.w=w,this.landscape.h=h;let header=id("MENU-HEADER");id("MENU-HEADER");styleelem(this.container,"width",`${w}px`),styleelem(this.container,"height",`${h}px`),styleelem(this.pauseContainer,"width",`${w}px`),styleelem(this.pauseContainer,"height",`${h}px`),styleelem(this.characterContainer,"width",`${w}px`),styleelem(this.characterContainer,"height",`${h}px`),styleelem(this.core,"width",`${w}px`),styleelem(this.core,"height",`${h}px`),styleelem(this.canvas,"width",`${w}px`),styleelem(this.canvas,"height",`${h}px`),styleelem(header,"width",`${w}px`),styleelem(header,"height",2*this.cellSize+"px"),styleelem(this.mainElement,"width",`${w}px`),styleelem(this.mainElement,"height",`${h}px`),styleelem(this.core,"fontSize",`${this.cellSize}px`),style("HEADER-BACK","width",2*this.cellSize+"px"),style("HEADER-BACK","height",2*this.cellSize+"px"),style("HEADER-TITLE-DIV","padding-left",.5*this.cellSize+"px"),style("HEADER-TITLE-TEXT","font-size",1.5*this.fontSize+"px"),style("MM-CONTENT-FOOTER","width",`${w}px`),style("MM-CONTENT-FOOTER","height",5*this.cellSize+"px"),style("MM-CONTENT-FOOTER","font-size",1*this.fontSize+"px"),style("MMC-FOOTER-TEXT","width",.9*w+"px"),this.characterMenu.resize()}convertJSONSimpleToJSONComplex(simple){let complex=[],n=0;for(let g of simple){let mfunc="",lo=g.name||9999*Math.random();complex[n]={type:"none",size:{type:"cell",width:10,height:2},id:lo,tag:"menu-object",inner_html:"",default_attributes:{mouseout_color:"#0000",mouseover_color:"#0000"},style:{display:"flex","justify-content":"center","align-items":"center"},attributes:{},event_listeners:{},children:{}};let m=complex[n];if("textbox"==g.type&&(m.children[0]={type:"none",font_size:1,id:"HELL-BOX",tag:"menu-object",inner_html:g.string,tag:"textarea",default_attributes:{id_selectable:!1,is_default_select:!1},style:{width:"100%",height:"100%"},attributes:{},event_listeners:{change:{func:"",once:!1}}},m.children[0].event_listeners.change.func=`let __value__ = evt.target.value; ${g.change};`),"button"==g.type&&(m.children[0]={type:"none",font_size:1,id:lo+"-_-TEXT",tag:"menu-object",inner_html:g.string,default_attributes:{},attributes:{style:"pointer-events: none; position: absolute"}},m.style["justify-content"]="left",m.style["flex-direction"]="column",m.event_listeners={mouseover:{once:!1,func:`menu_global.hoverButton(${lo}, "${g.onstate}");`},mouseout:{once:!1,func:`menu_global.hoverButton(${lo},"${g.offstate}");`},click:{once:!1,func:mfunc}},m.default_attributes.id_selectable=g.selectname,m.default_attributes.number_selectable=g.selectnumber,m.default_attributes.is_default_select=g.is_default,m.style.background=g.offstate,"init"in g)){let param=JSON.parse(JSON.stringify(g.charselect_param)),loo=`menu_global.characterMenu.setParameters(${JSON.stringify(param)});`;loo+=`menu_global.characterMenu.showHide(1);menu_global.setInit(${g.init});`,m.event_listeners.click.func=loo}if("button2"==g.type){if(m.size.type="whole",m.size.width=1,m.size.height=.14,m.style["clip-path"]="polygon(0 0, 92% 0, 86% 97%, 0% 97%)",m.style["align-items"]="left",m.style["padding-left"]="1.3em",m.style["flex-direction"]="column",m.default_attributes.id_selectable=g.selectname,m.default_attributes.number_selectable=g.selectnumber,m.default_attributes.is_default_select=g.is_default,m.children[0]={type:"none",font_size:2,id:lo+"-_-TEXT",tag:"menu-object",inner_html:g.string,default_attributes:{},attributes:{style:"pointer-events: none; position: relative; display: inline-block"}},m.children[1]={type:"none",font_size:1,id:lo+"-_-TEXT2",tag:"menu-object",inner_html:g.hint||"  ",default_attributes:{},attributes:{style:"pointer-events: none; position: relative; display: inline-block"}},m.event_listeners={mouseover:{once:!1,func:`menu_global.hoverButton(${lo}, "${g.onstate}");`},mouseout:{once:!1,func:`menu_global.hoverButton(${lo},"${g.offstate}");`},click:{once:!1,func:mfunc}},m.style.background=g.offstate,"init"in g){let param=JSON.parse(JSON.stringify(g.charselect_param)),loo=`menu_global.characterMenu.setParameters(${JSON.stringify(param)});`;loo+=`menu_global.characterMenu.showHide(1);menu_global.setInit(${g.init});`,m.event_listeners.click.func=loo}if("function"in g){let result=g.function;if("args"in g){let args=JSON.parse(JSON.stringify(g.args)),ii=Object.keys(args);for(let v=0;v<ii.length;v++){let varInstance=args[ii[v]],placeholder=`#par=${ii[v]}`,regExp=new RegExp(placeholder,"gm");result=result.replace(regExp,varInstance)}}m.event_listeners.click.func=result}}n++}return complex}setInit(g){game.actualParameters.mode=g}resetTemp(){for(let j in this.temporaryElements.elements)delete this.temporaryElements.elements[j];for(let j in this.temporaryElements.elementObjects)delete this.temporaryElements.elementObjects[j];for(let j in this.temporaryElements.resizeObjects)delete this.temporaryElements.resizeObjects[j]}showMenu(bool){this.isMenu=bool,this.isControllable=bool,styleelem(this.container,"display",bool?"flex":"none"),styleelem(this.headerContainer,"display",bool?"flex":"none")}hoverButton(id,on){let j={},exist=!1;this.isExistingElement(id)&&(j=this.getID(id),exist=!0),this.isExistingElementTemp(id)&&(j=this.getIDTemp(id),exist=!0),exist&&(j.style.background=on)}backButton(){if(this.characterMenu.isActive)this.characterMenu.back();else{if(this.submenuSequence.length>0){let a=this.submenuSequence.pop();this.changeMenu(a,!1,!0)}this.playSound("cancel")}}jsonMenuManager=new class{constructor(){this.loadedJson={},this.isLoaded=!1}};characterMenu=new class{constructor(a,b){this.parents={main:a,char:b},this.isActive=0,this.touchPanelSystem=new DOMTouchInteractivity(id("CSFRONT-PANEL"),event=>{this.panelInteractListen(event)}),this.animations={},this.animNames=[],this.charNames={},this.charSidesSelector={};for(let kl of["left","right"]){let ll={left:1,right:2}[kl];this.charSidesSelector[kl]=ll-1,this.charNames[kl]=new ChangeFuncExec("-1|-1",ev=>{let split=ev.split("|"),isNegative=~~split[0]<0;if(style(`CSBEHIND-P${ll}-CHARNAME`,"display",isNegative?"nome":"block"),style(`CSBEHIND-P${ll}-VERSIONNAME`,"display",isNegative?"nome":"block"),split[0]>-1){if(~~split[0]>this.parents.char.characters.length-1)return;let reference=this.parents.char.characters[~~split[0]];ih(`CSBEHIND-P${ll}-CHARNAME`,language.charTranslate(`${reference.core.name}`));let ver=reference.versions[~~split[1]];ih(`CSBEHIND-P${ll}-VERSIONNAME`,language.charTranslate(`${ver.lang_path}>${ver.name}`))}})}this.canvasDims={panel:[700,400],background:[1280,720]},this.panelSize={x:0,y:0,w:0,h:0},this.panelInteraction={x:0,y:0},this.panelInteractionDown={x:0,y:0},this.selSqSzMrg={w:72,h:48,m:20*.14},this.modeSqSzMrg={w:96,h:96,m:2.24},this.teamSqSzMrg={w:42,h:42,m:7*.14},this.checkSqSzMrg={w:72,h:72,m:20*.14},this.canvasses={},this.canvassesCtx={},this.selectUnderControl=0,this.isPanelPressed=0,this.isPanelPressedDown=0,this.activeSelection=[];for(let st=0;st<2;st++)this.activeSelection[st]=this.parents.main.#charselectCreateSelector();this.parameters={dual:1,ai:1,modePick:!0,players:2,rpg:!1,modeparams:[]},this.page=0,this.isOkaySelection={},this.characterSelectBoxes={};let sj=0;for(let h=0;h<36;h++){let sg=sj;31==h&&(sg=-1),this.characterSelectBoxes[h]={character:sg,index:h,version:0,x:h%8,y:~~(h/8),selected:{},canOK:!1,poscent:{x:0,y:0,w:0,h:0}},32!==h&&sj++}this.modeSelectBoxes={};for(let h=0;h<2;h++)this.modeSelectBoxes[h]={mode:h,x:h,selected:{},poscent:{x:0,y:0,w:0,h:0}};this.teamSelectBoxes={};for(let h=0;h<5;h++)this.teamSelectBoxes[h]={mode:h,x:h,selected:{},poscent:{x:0,y:0,w:0,h:0}};this.selectImages={},this.introductionSounds={},this.canvasTemp={background:"CSBEHIND-BG-CANVAS",panel:"CSFRONT-PANEL-CANVAS"},this.isWait=!1,this.startDelay=0;for(let g in this.canvasTemp){let h=this.canvasTemp[g],cid=id(h);this.canvasses[g]=cid,this.canvassesCtx[g]=cid.getContext("2d"),cid.width=this.canvasDims[g][0],cid.height=this.canvasDims[g][1]}}setupAnims(){this.animations={csShow:new AnimationFrameRenderer(this.parents.main.characterContainer,0,25,1e3/60,{name:"menu-layer-in",timing:"cubic-bezier(0,0,0,1)"}),csHide:new AnimationFrameRenderer(this.parents.main.characterContainer,0,25,1e3/60,{name:"menu-layer-out",timing:"cubic-bezier(0,0,0,1)"})},this.animNames=[];for(let aa in this.animations)this.animNames.push(aa)}playAnimation(name){name in this.animations&&this.animations[name].play()}showHide(toggle){this.isPanelPressed=!1,this.isPanelPressedDown=-99,this.isActive=toggle?1:0,this.playAnimation("cs"+(this.isActive?"Show":"Hide")),toggle&&(this.startDelay=30),styleelem(this.parents.main.characterContainer,"display",this.isActive?"flex":"none")}setParameters(param){this.parameters.dual=!1,this.parameters.ai=!1,this.parameters.modePick=!1,this.parameters.rpg=!1,this.parameters.noteam=param.players<2,this.parameters.activepos="first","no_team"in param&&(this.parameters.noteam=param.no_team),2==param.players&&(this.parameters.dual=!0,this.parameters.noteam=!0),"is_ai"in param&&(this.parameters.ai=param.is_ai),"is_pick_mode"in param&&(this.parameters.modePick=param.is_pick_mode),"rpg"in param&&(this.parameters.rpg=param.rpg),"playerpos"in param&&(this.parameters.activepos=param.playerpos),this.loadImages(),this.parameters.rpg&&this.loadRPGCards(),this.activeSelection.length=0;let pos=0;"first"==this.parameters.activepos&&(pos=0),game.actualParameters.active=pos,this.parameters.players=param.players,this.selectUnderControl=0,this.parameters.dual;for(let h=0;h<param.players;h++){let name="Computer "+h,ai=this.parameters.ai;pos==h&&(name=this.parents.main.storage.getItem("playername","Player 1"));let lsms=this.parents.main.#charselectCreateSelector(name,pos==h?0:ai);lsms.selection=h,lsms.character=h,this.activeSelection.push(lsms),ih(`CSBEHIND-P${Math.min(2,h+1)}-PLAYERNAME`,name)}style("CSBEHIND-DET-P2-DIV","display",this.parameters.dual?"flex":"none")}#callback=null;isCallback=!0;setCallback(cb){this.#callback=cb,this.isCallback=!0}loadImages(){for(let char of this.parents.char.characters)for(let ver in char.versions){let version=char.versions[ver],selectSrc=`${`${char.core.path}/${version.path}`}/${version.select_image}`;try{loadImage(`assets/characters/${selectSrc}`).then(img=>{this.selectImages[`${char.core.path}||${version.path}`]=img})}catch(e){this.selectImages[`${char.core.path}||${version.path}`]=new Image}}}async loadRPGCards(){for(let char of this.parents.char.characters)for(let ver in char.versions){let version=char.versions[ver],selectSrc=`${`${char.core.path}/${version.path}`}/${version.rpg_card}`;try{let img=await memoryManager.asyncLoad(`assets/characters/${selectSrc}`,"image");this.selectImages[`${char.core.path}||${version.path}(rpg)`]=img}catch(e){this.selectImages[`${char.core.path}||${version.path}(rpg)`]=new Image}}}#clearCanvas(canvas){let c=this.canvasses[canvas];this.canvassesCtx[canvas].clearRect(0,0,c.width,c.height)}async setupPlayerGame(){this.isWait=!0;let _b=this.activeSelection,b=[],mplayers=[],isPlayer=(this.parents.main,{}),isOccupied={},order={};for(let u=0;u<_b.length;u++){let h=_b[u];-1!==h.character&&b.push(h)}if(0===b.length)return;2==b.length?game.activePlayer=~~menu.storage.getValueFromRangeListSpecific("set_session_boardpos_mp")%2:b.length>2?game.activePlayer=Math.min(~~menu.storage.getValueFromRangeListSpecific("set_session_boardpos_mp"),b.length):game.activePlayer=0;let count=0;for(let u=0;u<b.length;u++){if(b[u].isAi)count++;else{let g=game.activePlayer;order[g]=u,isPlayer[u]=g,isOccupied[g]=1}}let i=0,t=0;for(;count>=t;)t in isPlayer?t++:(i in isOccupied||(order[i]=t,t++),i++);for(let u=0;u<b.length;u++){let h=b[order[u]],rpg={hp:0,mana:0,atk:0,def:0,lifesteal:0,lfa:0,deflect:0,cards:{}};if(this.parameters.rpg){for(let ua=0;ua<3;ua++){let oo=h.characterCards[ua],sel=this.parents.char.characters[oo.selection],ver=sel.versions[oo.version];0==ua&&(h.character=oo.selection),rpg.cards[ua]={cd:0,mana:0,name:"",desc:"",char:`${oo.selection}|${oo.version}`};let rpgString=await memoryManager.asyncLoad(`assets/characters/${sel.core.path}/${ver.path}/${ver.rpg_attr_init}`),rpgJson=JSON.parse(rpgString),skill=rpg.cards[ua];skill.cd=rpgJson?.skill.cooldown||0,skill.voice=rpgJson?.skill.voice||"",skill.mana=rpgJson?.skill.mana||0,skill.name=rpgJson?.skill.skill||"",skill.rawdesc=rpgJson?.skill.rawdesc||"",skill.attr=rpgJson?.skill.attr||[],skill.skillvalues=rpgJson?.skill.skillvalues,skill.desc=rpgJson?.skill.desc||"",rpg.hp+=rpgJson?.hp||0,rpg.mana+=rpgJson?.mana||0,rpg.atk+=rpgJson?.atk||0,rpg.def+=rpgJson?.def||0,rpg.lifesteal+=.01*(rpgJson?.lifesteal||0),rpg.lfa+=.01*(rpgJson?.lfa||0)}}mplayers.push(game.createPlayerParam(h.name,h.team,h.character,h.version,h.mode,h.isAi,rpg))}let playerOrder=[],om=Object.keys(order);for(let sm=0;sm<om.length;sm++)playerOrder.push(sm);let result={players:mplayers,playerOrder:playerOrder};this.#callback(result),this.showHide(0),this.activeSelection.length=0,this.isWait=!1}checkButton(select){if(!this.characterSelectBoxes[select.selection].canOK)return void this.parents.main.playSound("error");let isError=!1,playerCount=0;if(1!==this.parameters.players){for(let sh of this.activeSelection)-1!==sh.character&&playerCount++;playerCount<2&&(isError=!0)}if(this.activeSelection[this.selectUnderControl].isAi||-1!=this.activeSelection[this.selectUnderControl].character||(isError=!0),isError)menu.playSound("error");else{if(this.parameters.rpg){let chars={};for(let cardIndex=0;cardIndex<select.characterCards.length;cardIndex++){chars[`${select.characterCards[cardIndex].selection}`]=0}for(let cardIndex=0;cardIndex<select.characterCards.length;cardIndex++){let str=`${select.characterCards[cardIndex].selection}`;if(str in chars&&(chars[str]++,chars[str]>1&&cardIndex==select.characterCardIndex))return void this.parents.main.playSound("error")}if(select.characterCardIndex<2){select.characterCardIndex++;let newSel=select.characterCards[select.characterCardIndex];newSel.lastSelection=newSel.selection}else this.checkSel(),select.isOK=1}else this.checkSel(),select.isOK=1;this.parents.main.playSound("select")}}back(){let a=this,isSelActive=!1;if(a.parameters.rpg){let isBack=!1;for(let g=a.activeSelection.length-1;g>=0;g--){let hh=a.activeSelection[g];if(isBack&&hh.characterCardIndex++,hh.characterCardIndex>0?(isSelActive=!0,hh.characterCardIndex--,hh.isOK=0,0==hh.characterCardIndex&&(hh.isOK=0)):hh.isOK=0,isSelActive)break;a.selectUnderControl==g&&(isBack=!0),a.parameters.ai==!(g-1<0)&&(a.selectUnderControl=g-1)}}else for(let g=a.activeSelection.length-1;g>=0;g--){let hh=a.activeSelection[g];if(hh.isOK&&(isSelActive=!0,hh.isOK=0),isSelActive)break;a.parameters.ai==!(g-1<0)&&(a.selectUnderControl=g-1)}isSelActive||a.showHide(0),!this.parameters.dual&&this.selectUnderControl>0&&ih("CSBEHIND-P1-PLAYERNAME",this.activeSelection[this.selectUnderControl].name),this.parents.main.playSound("cancel")}checkSel(){this.selectUnderControl<this.activeSelection.length-1?(this.selectUnderControl++,this.parameters.dual||ih("CSBEHIND-P1-PLAYERNAME",this.activeSelection[this.selectUnderControl].name)):this.setupPlayerGame()}draw(){if(!this.isActive)return;this.startDelay>0&&this.startDelay--;for(let h=0,m=this.animNames.length;h<m;h++)this.animations[this.animNames[h]].run();this.#clearCanvas("background"),this.#clearCanvas("panel");for(let g=0;g<36;g++){let gw=g%9,boxref=this.characterSelectBoxes[g],lx=this.canvasDims.panel[0]/2-(9*this.selSqSzMrg.w+8*this.selSqSzMrg.m)/2+(this.selSqSzMrg.w*gw+this.selSqSzMrg.m*(gw+1)),ly=(this.selSqSzMrg.h+this.selSqSzMrg.m)*~~(g/9)+3*this.selSqSzMrg.m,lw=this.selSqSzMrg.w,lh=this.selSqSzMrg.h;this.canvassesCtx.panel.fillStyle="#2228",boxref.canOK=!1,this.canvassesCtx.panel.fillRect(lx,ly,lw,lh);let charref=this.parents.char.characters[boxref.character],reference=null;if(-1==boxref.character);else{if(!charref)continue;if(!(`${charref.core.path}||${charref.versions[boxref.version].path}`in this.selectImages))continue}boxref.canOK=!0,-1==boxref.character?(reference=game.misc.menu_cs_removeplayer,this.canvassesCtx.panel.drawImage(reference,0,0,150,100,lx,ly,lw,lh)):reference=this.selectImages[`${charref.core.path}||${charref.versions[boxref.version].path}`],reference&&this.canvassesCtx.panel.drawImage(reference,600,0,140,2/3*140,lx,ly,lw,lh),boxref.poscent.x=lx/this.canvasDims.panel[0],boxref.poscent.y=ly/this.canvasDims.panel[1],boxref.poscent.w=(lw+lx)/this.canvasDims.panel[0],boxref.poscent.h=(lh+ly)/this.canvasDims.panel[1];let hover=game.misc.menu_cs_border_black;if(boxref.poscent.x<=this.panelInteraction.x&&boxref.poscent.w>=this.panelInteraction.x&&boxref.poscent.y<=this.panelInteraction.y&&boxref.poscent.h>=this.panelInteraction.y&&(hover=game.misc.menu_cs_border_yellow),this.canvassesCtx.panel.drawImage(hover,0,0,150,100,lx,ly,lw,lh),this.isPanelPressedDown>0&&boxref.poscent.x<=this.panelInteractionDown.x&&boxref.poscent.w>=this.panelInteractionDown.x&&boxref.poscent.y<=this.panelInteractionDown.y&&boxref.poscent.h>=this.panelInteractionDown.y){let select=this.activeSelection[this.selectUnderControl];this.changeSelectionChar(select,boxref.index,boxref.character)}}if(this.parameters.modePick){let selected1=0,selected0=0;if(this.parameters.ai){let boxref=this.activeSelection[this.selectUnderControl];0==boxref.mode&&selected0++,1==boxref.mode&&selected1++}else for(let g=0;g<this.parameters.players;g++){let boxref=this.activeSelection[g];0==boxref.mode&&selected0++,1==boxref.mode&&selected1++}for(let g=0;g<2;g++){let gw=g%8,boxref=this.modeSelectBoxes[g],lx=.05*this.canvasDims.panel[0]+(this.modeSqSzMrg.w*gw+this.modeSqSzMrg.m*(gw+1)),ly=.735*this.canvasDims.panel[1],lw=this.modeSqSzMrg.w,lh=this.modeSqSzMrg.h;boxref.poscent.x=lx/this.canvasDims.panel[0],boxref.poscent.y=ly/this.canvasDims.panel[1],boxref.poscent.w=(lw+lx)/this.canvasDims.panel[0],boxref.poscent.h=(lh+ly)/this.canvasDims.panel[1];let hover=0;if(boxref.poscent.x<=this.panelInteraction.x&&boxref.poscent.w>=this.panelInteraction.x&&boxref.poscent.y<=this.panelInteraction.y&&boxref.poscent.h>=this.panelInteraction.y&&(hover=1,this.isPanelPressing&&(hover=2)),this.canvassesCtx.panel.drawImage(game.misc.menu_cs_mode_pick,100*(hover>0?hover:selected0&&0==g||selected1&&1==g?3:0),100+100*g,100,100,lx,ly,lw,lh),this.isPanelPressedDown>0&&boxref.poscent.x<=this.panelInteractionDown.x&&boxref.poscent.w>=this.panelInteractionDown.x&&boxref.poscent.y<=this.panelInteractionDown.y&&boxref.poscent.h>=this.panelInteractionDown.y){this.activeSelection[this.selectUnderControl].mode=g}}}if(!this.parameters.noteam)for(let g=0;g<5;g++){let gw=g%8,ss=this.activeSelection[this.selectUnderControl],boxref=this.teamSelectBoxes[g],lx=.05*this.canvasDims.panel[0]+(this.teamSqSzMrg.w*gw+this.teamSqSzMrg.m*(gw+1)),ly=.6*this.canvasDims.panel[1],lw=this.teamSqSzMrg.w,lh=this.teamSqSzMrg.h;boxref.poscent.x=lx/this.canvasDims.panel[0],boxref.poscent.y=ly/this.canvasDims.panel[1],boxref.poscent.w=(lw+lx)/this.canvasDims.panel[0],boxref.poscent.h=(lh+ly)/this.canvasDims.panel[1];let hover=0;if(boxref.poscent.x<=this.panelInteraction.x&&boxref.poscent.w>=this.panelInteraction.x&&boxref.poscent.y<=this.panelInteraction.y&&boxref.poscent.h>=this.panelInteraction.y&&(hover=1,this.isPanelPressing&&(hover=2)),this.canvassesCtx.panel.drawImage(game.misc.menu_cs_team,100*g,0,100,100,lx,ly,lw,lh),this.canvassesCtx.panel.drawImage(game.misc.menu_cs_team,100*(hover>0?hover:g==ss.team?3:0),100,100,100,lx,ly,lw,lh),this.isPanelPressedDown>0&&boxref.poscent.x<=this.panelInteractionDown.x&&boxref.poscent.w>=this.panelInteractionDown.x&&boxref.poscent.y<=this.panelInteractionDown.y&&boxref.poscent.h>=this.panelInteractionDown.y){this.activeSelection[this.selectUnderControl].team=g}}{let lx=this.canvasDims.panel[0]/2-this.checkSqSzMrg.w/2,ly=.8*this.canvasDims.panel[1],lw=this.checkSqSzMrg.w,lh=this.checkSqSzMrg.h,bx=lx/this.canvasDims.panel[0],by=ly/this.canvasDims.panel[1],bw=(lw+lx)/this.canvasDims.panel[0],bh=(lh+ly)/this.canvasDims.panel[1],hover=0;if(bx<=this.panelInteraction.x&&bw>=this.panelInteraction.x&&by<=this.panelInteraction.y&&bh>=this.panelInteraction.y&&(hover=1,this.isPanelPressing&&(hover=2)),this.canvassesCtx.panel.drawImage(game.misc.menu_cs_mode_pick,100*(hover>0?hover:0),0,100,100,lx,ly,lw,lh),this.isPanelPressedDown>0&&bx<=this.panelInteractionDown.x&&bw>=this.panelInteractionDown.x&&by<=this.panelInteractionDown.y&&bh>=this.panelInteractionDown.y){let select=this.activeSelection[this.selectUnderControl];this.checkButton(select)}}{let select=this.activeSelection[this.parameters.dual?this.charSidesSelector.left:this.selectUnderControl],g=this.parameters.rpg?select.characterCards[select.characterCardIndex].selection:select.selection,gw=g%9,v=this.parameters.rpg?select.characterCards[select.characterCardIndex].version:select.version,lx=this.canvasDims.panel[0]/2-(9*this.selSqSzMrg.w+8*this.selSqSzMrg.m)/2+(this.selSqSzMrg.w*gw+this.selSqSzMrg.m*(gw+1)),ly=(this.selSqSzMrg.h+this.selSqSzMrg.m)*~~(g/9)+3*this.selSqSzMrg.m,lw=this.selSqSzMrg.w,lh=this.selSqSzMrg.h;this.canvassesCtx.panel.drawImage(game.misc.menu_cs_border_green,0,0,150,100,lx,ly,lw,lh);let charref=this.parents.char.characters[g];if(!this.parameters.rpg&&charref?.core&&`${charref.core.path}||${charref.versions[select.version].path}`in this.selectImages){let reference=this.selectImages[`${charref.core.path}||${charref.versions[select.version].path}`];this.canvassesCtx.background.drawImage(reference,0,0,600,600,-140,0,720,720)}if(this.parameters.rpg)for(let kr=0;kr<3;kr++){let rcharref=this.parents.char.characters[select.characterCards[kr].selection];if(rcharref?.core&&`${rcharref.core.path}||${rcharref.versions[select.characterCards[kr].version].path}(rpg)`in this.selectImages){let reference=this.selectImages[`${rcharref.core.path}||${rcharref.versions[select.characterCards[kr].version].path}(rpg)`],aspect=2.2;this.canvassesCtx.background.drawImage(reference,0,0,550,250,10,60+122*kr,120*aspect,120)}}this.parameters.modePick?this.canvassesCtx.background.drawImage(game.misc.menu_cs_mode_pick,100*(select.isOK?3:0),100+100*select.mode,100,100,20,420,120,120):select.isOK&&this.canvassesCtx.background.drawImage(game.misc.menu_cs_mode_pick,300,0,100,100,20,420,120,120);let kse=select.isOK?select.selection:g,kve=select.isOK?select.version:v;this.charNames.left.assign(`${kse}|${kve}`)}if(void 0!==this.activeSelection[this.charSidesSelector.right]&&this.parameters.dual){let select=this.activeSelection[this.charSidesSelector.right],g=this.parameters.rpg?select.characterCards[select.characterCardIndex].selection:select.selection,gw=g%9,v=this.parameters.rpg?select.characterCards[select.characterCardIndex].version:select.version,lx=this.canvasDims.panel[0]/2-(9*this.selSqSzMrg.w+8*this.selSqSzMrg.m)/2+(this.selSqSzMrg.w*gw+this.selSqSzMrg.m*(gw+1)),ly=(this.selSqSzMrg.h+this.selSqSzMrg.m)*~~(g/9)+3*this.selSqSzMrg.m,lw=this.selSqSzMrg.w,lh=this.selSqSzMrg.h;this.canvassesCtx.panel.drawImage(game.misc.menu_cs_border_green,0,0,150,100,lx,ly,lw,lh);let charref=this.parents.char.characters[g];if(!this.parameters.rpg&&charref?.core&&`${charref.core.path}||${charref.versions[select.version].path}`in this.selectImages){let reference=this.selectImages[`${charref.core.path}||${charref.versions[select.version].path}`];this.canvassesCtx.background.drawImage(reference,0,600,600,600,700,0,720,720)}if(this.parameters.rpg)for(let kr=0;kr<3;kr++){let rcharref=this.parents.char.characters[select.characterCards[kr].selection];if(rcharref?.core&&`${rcharref.core.path}||${rcharref.versions[select.characterCards[kr].version].path}(rpg)`in this.selectImages){let reference=this.selectImages[`${rcharref.core.path}||${rcharref.versions[select.characterCards[kr].version].path}(rpg)`],aspect=2.2;this.canvassesCtx.background.save(),this.canvassesCtx.background.translate(1280-(120*aspect+10)+120*aspect/2,60+122*kr+60),this.canvassesCtx.background.scale(-1,1),this.canvassesCtx.background.drawImage(reference,0,0,550,250,-120*aspect/2,-60,120*aspect,120),this.canvassesCtx.background.restore()}}this.parameters.modePick?this.canvassesCtx.background.drawImage(game.misc.menu_cs_mode_pick,100*(select.isOK?3:0),100+100*select.mode,100,100,1140,420,120,120):select.isOK&&this.canvassesCtx.background.drawImage(game.misc.menu_cs_mode_pick,300,0,100,100,1140,420,120,120);let kse=select.isOK?select.selection:g,kve=select.isOK?select.version:v;this.charNames.right.assign(`${kse}|${kve}`)}this.isPanelPressed>0&&(this.isPanelPressed=0),this.isPanelPressedDown>0&&(this.isPanelPressedDown=0)}changeSelectionChar(_select,n,s){let select=_select;if(this.parameters.rpg)return 0==_select.characterCardIndex&&select.lastSelection!==n&&(select.selection=n,select.lastSelection=n,select.version=0),select=_select.characterCards[_select.characterCardIndex],void(select.lastSelection!==n&&(select.selection=n,select.lastSelection=n,select.version=0));select.lastSelection!==n&&(select.character=s,select.selection=n,select.lastSelection=n,select.version=0)}resize(){let size=this.parents.main.cellSize,font=this.parents.main.fontSize,ls=this.parents.main.landscape,bg=this.canvasses.background,pn=id("CSFRONT-PANEL"),pnc=this.canvasses.panel;styleelem(bg,"width",`${ls.w}px`),styleelem(bg,"height",`${ls.h}px`);for(let ll of["FRONT","BEHIND"])style(`CHARSELECT-${ll}-DIV`,"width",`${ls.w}px`),style(`CHARSELECT-${ll}-DIV`,"height",`${ls.h}px`);style("CSBEHIND-DETAILS-DIV","width",`${ls.w}px`),style("CSBEHIND-DETAILS-DIV","height",`${ls.h}px`);for(let ll of[1,2]){style(`CSBEHIND-DET-P${ll}-DIV`,"width",`${ls.w}px`),style(`CSBEHIND-DET-P${ll}-DIV`,"height",5.6*size+"px"),style(`CSBEHIND-P${ll}-VERSIONNAME`,"font-size",~~(1*font*1.3)+"px"),style(`CSBEHIND-P${ll}-CHARNAME`,"font-size",~~(1*font*2.7)+"px"),style(`CSBEHIND-P${ll}-PLAYERNAME`,"font-size",~~(1*font*1.6)+"px"),style(`CSBEHIND-P${ll}-VERSIONNAME`,"width",`${ls.w}px`),style(`CSBEHIND-P${ll}-VERSIONNAME`,"height",~~(1.3*size)+"px"),style(`CSBEHIND-P${ll}-CHARNAME`,"width",`${ls.w}px`),style(`CSBEHIND-P${ll}-CHARNAME`,"height",~~(2.6*size)+"px"),style(`CSBEHIND-P${ll}-PLAYERNAME`,"width",`${ls.w}px`),style(`CSBEHIND-P${ll}-PLAYERNAME`,"height",~~(1.7*size)+"px");for(let hh of["VERSIONNAME","PLAYERNAME","CHARNAME"])style(`CSBEHIND-P${ll}-${hh}`,"text-align",["left","right"][ll-1]),style(`CSBEHIND-P${ll}-${hh}`,"vertical-align","center"),style(`CSBEHIND-P${ll}-${hh}`,"position","relative"),style(`CSBEHIND-P${ll}-${hh}`,"bottom","0"),style(`CSBEHIND-P${ll}-${hh}`,["left","right"][ll-1],1*size+"px")}styleelem(pn,"width",35*size+"px"),styleelem(pn,"height",20*size+"px"),styleelem(pn,"top",2*size+"px"),this.panelSize.w=35*size,this.panelSize.h=20*size,styleelem(pnc,"width",35*size+"px"),styleelem(pnc,"height",20*size+"px");let rect=pn.getBoundingClientRect();this.panelSize.x=rect.x,this.panelSize.y=rect.y}panelInteractListen(evt){if(!this.isActive||fsw.isShown)return;let rect=id("CSFRONT-PANEL").getBoundingClientRect();this.panelSize.x=rect.x,this.panelSize.y=rect.y;let pageX=evt.pageX,pageY=evt.pageY;if("touchstart"!=evt.type&&"touchmove"!=evt.type||(pageX=evt.touches[0].pageX,pageY=evt.touches[0].pageY),"mousemove"==evt.type||"touchmove"==evt.type){let x=(pageX-this.panelSize.x)/this.panelSize.w,y=(pageY-this.panelSize.y)/this.panelSize.h;this.panelInteraction.x=x,this.panelInteraction.y=y,this.isPanelPressed=1}if("mousedown"==evt.type||"touchstart"==evt.type){this.isPanelPressing=1;let x=(pageX-this.panelSize.x)/this.panelSize.w,y=(pageY-this.panelSize.y)/this.panelSize.h;this.panelInteractionDown.x=x,this.panelInteractionDown.y=y}"mouseup"!=evt.type&&"touchend"!=evt.type||(this.startDelay<=0&&(this.isPanelPressedDown=1),this.isPanelPressing=0),this.isPanelPressed}controlsListen(key){let addition=0,select=this.activeSelection[this.selectUnderControl],change=this.parameters.rpg?select.characterCards[select.characterCardIndex].selection:select.selection;"arrowleft"===key&&(addition=-1,~~(change/9)-~~((change+addition)/9)==1&&(addition+=9)),"arrowright"===key&&(addition=1,~~(change/9)-~~((change+addition)/9)==-1&&(addition-=9)),"arrowup"===key&&(addition=-9),"arrowdown"===key&&(addition=9),"enter"===key&&this.parents.main.pressAButtonDelay<=0&&this.checkButton(select),"m"===key&&(select.mode=[1,0][select.mode]),"backspace"===key&&this.parents.main.backButton(),change+=addition,console.log(change),change>=36&&(change-=9),change<0&&(change+=9),-1!==change&&("enter"!==key&&this.changeSelectionChar(select,change,this.characterSelectBoxes[change].character),0!==addition&&this.parents.main.playSound("move"))}}(this,gtcharacter)};__main_params__.__private.menu=menu,__main_params__.appinfo.android&&(__main_params__.accessible.menu=menu);class FullscreenWindow{Page=class{constructor(parent){this.parent=parent,this.elements={},this.dpadBehavior={type:"branch",vertical:null,horizontal:null,sped:1},this.json={string:"",elements:{},definedElementIds:{},selectables:[],horizontalSelectables:[],verticalSelectables:[],eventListeners:{},lastSelectableX:0,lastSelectableY:0,maxSelectables:0},this.core=document.createElement("temporary"),this.coreTemp=document.createElement("temporary"),this.selectableIndex={x:0,y:0,vertical:0,horizontal:0},this.scrollableIds={horizontal:"",vertical:""},this.headerTitle=""}loadJSON(jsonString,isNextPage){let json=JSON.parse(jsonString),core=document.createElement("gtris-temporary-core");core.innerHTML="";let parents={},defaultSelectable={x:0,y:0,horizontal:0,vertical:0};this.dpadBehavior.type=json?.dpad_behavior||"branch";let vertical=json?.scroll_vertical_id||"",horizontal=json?.scroll_horizontal_id||"";this.scrollableIds.horizontal=horizontal,this.scrollableIds.vertical=vertical,json?.title_lang&&(this.parent.header.titleValue.innerHTML=language.translate(json.title_lang,[__main_params__.appinfo.version],"")),this.jsonRecursion(json.element,(element,parent)=>{let uuid=generateUUID(),a=document.createElement(element.tag);this.elements[uuid]=a,this.json.elements[uuid]=element;let innerhtml="";async function func(_innerhtml){let innerhtml=_innerhtml;if(element?.markdown){let arr=_innerhtml.split("\n"),jsa="";for(let ar of arr){let ks=document.createElement("gtris-subdiv");ks.style.width="100%",ks.style.height="auto",ks.style.position="relative",ks.style.display="flex",ks.style.flexDirection="column";let indent=0;for(;" "===ar[indent];)indent++;let trim=ar.trim();if(indent>0){let kksa=document.createElement("gtris-subdiv");kksa.style.fontSize="2.75em",kksa.style.width=.5*indent+"em",kksa.style.height="100%",ks.append(kksa)}let kksa=document.createElement("gtris-subdiv");if(kksa.style.fontSize="1em",kksa.style.width=`calc(100% - ${.5*indent}em)`,kksa.style.height="100%",ks.append(kksa),trim.startsWith("=# ")){let mnt=trim.replace("=#","");kksa.style.fontSize="2.75em",kksa.innerHTML=mnt}else if(trim.startsWith("## ")){let mnt=trim.replace("## ","");kksa.style.fontSize="1.75em",kksa.innerHTML=mnt}else if(trim.startsWith("# ")){let mnt=trim.replace("# ","");kksa.style.fontSize="2.25em",kksa.innerHTML=mnt}else if(trim.startsWith("- ")){let mnt=trim.replace("- ","");kksa.style.fontSize="1em";let svg='<svg style="animation:board-fallrot-finisher-chain 2500ms infinite linear;width:0.75em;height:0.75em;margin-left:0.1em;margin-right:0.1em" viewBox="0 0 60 60" xmlns=\'http://www.w3.org/2000/svg\' width=60 height=60><polygon style="stroke-width:0.1em;stroke:#000;fill:#fff" points="0,20 20,20 20,0 40,0 40,20 60,20 60,40 0,40"/></svg>';kksa.innerHTML=svg+mnt}else kksa.innerHTML=ar,0==ar.length&&(ks.style.height="0.8em");jsa+=ks.outerHTML}innerhtml=jsa}a.innerHTML=innerhtml}if("text_lang"in element)innerhtml=func(language.translate(element.text_lang,[],"no langname"));else if("load_text_lang"in element)try{load(language.getLocalizationPath(element.load_text_lang)).then(mm=>{func(mm)})}catch(e){}else innerhtml=func(element?.text_raw||"");let hk=this.json.elements[uuid];hk.fontSize=1,hk.width=null,hk.height=null,hk.typeWidth=-1,hk.typeHeight=-1,hk.focus_horizontal="",hk.focus_vertical="",hk.selectable={type:"none",x:0,y:0,vertical:0,horizontal:0},hk.maxSelectable=0,hk.functions={};for(let attrName in hk.attributes){let attr=element.attributes[attrName];switch(attrName){case"mattr":for(let k in attr){let attribute=attr[k];a.setAttribute(k,attribute)}break;case"id":this.json.definedElementIds[attr]=uuid,a.setAttribute("ids",attr);break;case"font_size":hk.fontSize=attr;break;case"width":hk.width=attr;break;case"height":hk.height=attr;break;case"value":a.value=attr;break;case"width_type":hk.typeWidth=attr;break;case"height_type":hk.typeHeight=attr;break;case"scroll_vertical":this.dpadBehavior.vertical=a;break;case"selectable":{let lg=attr.split("default")[0].split("|");hk.selectable.x=~~lg[1],hk.selectable.y=~~lg[0],hk.selectable.type="branch",attr.includes("default")&&(defaultSelectable.x=~~lg[1],defaultSelectable.y=~~lg[0]);break}case"selectable_vertical":{let ls=attr.split("default")[0];hk.selectable.type="vertical",hk.selectable.vertical=~~ls,attr.includes("default")&&(defaultSelectable.vertical=~~ls);break}case"selectable_horizontal":{let ls=attr.split("default")[0];hk.selectable.type="horizontal",hk.selectable.horizontal=~~ls,attr.includes("default")&&(defaultSelectable.horizontal=~~ls);break}case"target_scroll_y":hk.focus_vertical=attr;case"target_scroll_x":hk.focus_horizontal=attr;case"style":for(let k in attr){let style=attr[k];a.style.setProperty(k,style)}break;case"event_functions":for(let k in attr){let el=attr[k],fun=new Function(["__this","local","__fsw","__hover","__getElementId","__inputfocus"],el);hk.functions[k]=(event,type)=>{fun(a,__main_params__.__private,this.parent,()=>{"branch"==hk.selectable.type&&this.hoverSelectable(hk.selectable.y,hk.selectable.x),"horizontal"==hk.selectable.type&&this.hoverSelectableX(hk.selectable.horizontal),"vertical"==hk.selectable.type&&this.hoverSelectableY(hk.selectable.vertical)},id=>{let lla=this.getElementById(id);return this.elements[lla]},()=>{let aj=function(ns){keypressManager.isTyping=!1,keypressManager.removeListener("typing")};a.addEventListener("blur",aj,{once:!0}),keypressManager.isTyping||(keypressManager.isTyping=!0,a.focus(),keypressManager.addListener("typing",(code,type)=>{"keydown"==type&&"escape"==code&&aj()}))})}}break;case"event_listeners":for(let k in attr){let el=attr[k];a.addEventListener(k,ev=>{hk.functions[el](ev,k)})}}}element.uuid=uuid},{}),this.jsonRecursion(json.element,(element,parent)=>{let parentStr="core";"uuid"in parent&&(parentStr=parent.uuid),parents[element.uuid]=parentStr},{});for(let elemn in parents){let parent=parents[elemn];"core"==parent?core.appendChild(this.elements[elemn]):this.elements[parent].appendChild(this.elements[elemn])}for(let elemn in this.json.elements){let m=this.json.elements[elemn];if("branch"==m.selectable.type&&m.selectable.x>=0&&m.selectable.y>=0){let selectionYIndex=m.selectable.y;this.json.selectables[selectionYIndex]||(this.json.selectables[selectionYIndex]=[]),this.json.selectables[selectionYIndex].push(elemn)}"vertical"==m.selectable.type&&m.selectable.vertical>=0&&this.json.verticalSelectables.push(elemn),"horizontal"==m.selectable.type&&m.selectable.vertical>=0&&this.json.horizontalSelectables.push(elemn)}switch(this.core=core,this.dpadBehavior.type){case"branch":this.hoverSelectable(defaultSelectable.y,defaultSelectable.x);break;case"smooth_vertical":case"horizontal":this.hoverSelectableX(defaultSelectable.horizontal);break;case"smooth_horizontal":case"vertical":this.hoverSelectableY(defaultSelectable.vertical)}}jsonRecursion(elem,func,parent){if(func(elem,parent),"children"in elem)for(let k of elem.children)this.jsonRecursion(k,func,elem)}getElementById(id){return this.json.definedElementIds[id]}hoverSelectable(indexY,indexX,isSelect){if(-1==indexX){let j=0;for(;this.json.selectables[indexY][j];)j++;indexX=j}if(this.json.selectables[indexY][indexX]||(indexX=0),this.json.selectables[indexY]&&this.json.selectables[indexY][indexX]){let lastSelectable=this.json.selectables[this.selectableIndex.y][this.selectableIndex.x];this.selectableIndex.x=indexX,this.selectableIndex.y=indexY;let newElem=this.json.selectables[indexY][indexX],cur=this.elements[newElem],jsoncur=this.json.elements[newElem];if(""!==jsoncur.focus_horizontal||""!==jsoncur.focus_vertical){if(""!==jsoncur.focus_horizontal){let sivArgs={block:"center",inline:"nearest",behavior:"smooth"};sivArgs.scrollable=this.elements[this.json.definedElementIds[jsoncur.focus_horizontal]],cur.scrollIntoView(sivArgs)}if(""!==jsoncur.focus_vertical){let sivArgs={block:"center",inline:"nearest",behavior:"smooth"};sivArgs.scrollable=this.elements[this.json.definedElementIds[jsoncur.focus_vertical]],cur.scrollIntoView(sivArgs)}}if(isSelect)return void this.json.elements[newElem].functions.select();"hoverout"in this.json.elements[lastSelectable]?.functions&&this.json.elements[lastSelectable].functions.hoverout(),this.json.elements[newElem].functions.hoverin()}}hoverSelectableX(index,isSelect){let selSet=this.json.horizontalSelectables;if(this.json.horizontalSelectables[index]){let lastSelectable=selSet[this.selectableIndex.horizontal];this.selectableIndex.horizontal=index;let newElem=selSet[index],cur=this.elements[newElem],jsoncur=this.json.elements[newElem];if(""!==jsoncur.focus_horizontal||this.scrollableIds.horizontal){let sivArgs={block:"center",inline:"nearest",behavior:"smooth"};""!==jsoncur.focus_horizontal?sivArgs.scrollable=this.elements[this.json.definedElementIds[jsoncur.focus_horizontal]]:""!==this.scrollableIds.horizontal&&(sivArgs.scrollable=this.elements[this.json.definedElementIds[this.scrollableIds.horizontal]]),cur.scrollIntoView(sivArgs)}if(isSelect)return void this.json.elements[newElem].functions.select();"hoverout"in this.json.elements[lastSelectable]?.functions&&this.json.elements[lastSelectable].functions.hoverout(),this.json.elements[newElem].functions.hoverin()}}hoverSelectableY(index,isSelect){let selSet=this.json.verticalSelectables;if(this.json.verticalSelectables[index]){let lastSelectable=selSet[this.selectableIndex.vertical];this.selectableIndex.vertical=index;let newElem=selSet[index],cur=this.elements[newElem],jsoncur=this.json.elements[newElem];if(""!==jsoncur.focus_vertical||this.scrollableIds.vertical){let sivArgs={block:"center",inline:"nearest",behavior:"smooth"};""!==jsoncur.focus_vertical?sivArgs.scrollable=this.elements[this.json.definedElementIds[jsoncur.focus_vertical]]:""!==this.scrollableIds.vertical&&(sivArgs.scrollable=this.elements[this.json.definedElementIds[this.scrollableIds.vertical]]),cur.scrollIntoView(sivArgs)}if(isSelect)return void this.json.elements[newElem].functions.select();"hoverout"in this.json.elements[lastSelectable]?.functions&&this.json.elements[lastSelectable].functions.hoverout(),this.json.elements[newElem].functions.hoverin()}}upOrDown(num){if(0==num)return;let u=this.dpadBehavior.type;switch("vertical"===u?u="smooth_horizontal":"horizontal"===u&&(u="smooth_vertical"),u){case"branch":{let value=this.selectableIndex.y+num;this.hoverSelectable(value,this.selectableIndex.x);break}case"smooth_horizontal":{let value=this.selectableIndex.vertical+num;this.hoverSelectableY(value);break}case"smooth_vertical":{let value=this.selectableIndex.herizontal+num;this.hoverSelectableX(value);break}case"vertical":{let value=this.selectableIndex.vertical+num;this.hoverSelectableY(value);break}case"horizontal":{let value=this.selectableIndex.herizontal+num;this.hoverSelectableX(value);break}}}leftOrRight(num){if(0==num)return;let u=this.dpadBehavior.type;switch("vertical"===u?u="horizontal":"horizontal"===u&&(u="vertical"),u){case"branch":{let value=this.selectableIndex.x+num;this.hoverSelectable(this.selectableIndex.y,value);break}case"smooth_vertical":{let value=this.selectableIndex.horizontal+num;this.hoverSelectableX(value);break}}}selectOrBack(num){let u=this.dpadBehavior.type;if("vertical"===u?u="smooth_horizontal":"horizontal"===u&&(u="smooth_vertical"),1==num)switch(u){case"branch":{let value=this.selectableIndex.x;this.hoverSelectable(this.selectableIndex.y,value,!0);break}case"smooth_vertical":{let value=this.selectableIndex.horizontal;this.hoverSelectableX(value,!0);break}case"smooth_horizontal":{let value=this.selectableIndex.vertical;this.hoverSelectableY(value,!0);break}}else-1===num&&this.parent.back()}listen(oneBitkey,type){let v=0,h=0,ab=0;oneBitkey&this.parent.flags.down&&(v=1),oneBitkey&this.parent.flags.up&&(v=-1),oneBitkey&this.parent.flags.left&&(h=-1),oneBitkey&this.parent.flags.right&&(h=1),oneBitkey&this.parent.flags.a&&(ab=1),oneBitkey&this.parent.flags.b&&(ab=-1),"keydown"===type&&(this.upOrDown(v),this.leftOrRight(h)),"keyup"===type&&this.selectOrBack(ab)}update(){switch(this.dpadBehavior.type){case"smooth_horizontal":{if(!this.dpadBehavior.horizontal)return;let v=0,oneBitkey=this.parent.bitkey;oneBitkey|this.parent.flags.left&&(v=1),oneBitkey|this.parent.flags.right&&(v=-1),this.dpadBehavior.horizontal.scrollTop=Math.max(this.dpadBehavior.horizontal.scrollTop+v,0);break}case"smooth_vertical":{if(!this.dpadBehavior.vertical)return;let v=0,oneBitkey=this.parent.bitkey;oneBitkey|this.parent.flags.down&&(v=1),oneBitkey|this.parent.flags.up&&(v=-1),this.dpadBehavior.horizontal.scrollTop=Math.max(this.dpadBehavior.vertical.scrollTop+v,0);break}case"vertical":{let v=0,oneBitkey=this.parent.bitkey;oneBitkey|this.parent.flags.left&&(v=1),oneBitkey|this.parent.flags.right&&(v=-1);break}case"horizontal":{let v=0,oneBitkey=this.parent.bitkey;oneBitkey|this.parent.flags.down&&(v=1),oneBitkey|this.parent.flags.up&&(v=-1);break}}}resizeElements(w,h,fs,cs){for(let uuid in this.json.elements){let ref=this.json.elements[uuid],element=this.elements[uuid];if(null!==ref.width&&-1!==ref.typeWidth){let width=[cs,w/100][ref.typeWidth]*ref.width;element.style.width=width+"px"}if(null!==ref.height&&-1!==ref.typeHeight){let height=[cs,h/100][ref.typeHeight]*ref.height;element.style.height=height+"px"}element.style.fontSize=fs*ref.fontSize+"px"}}};functions={Keybinds:class{constructor(p){this.a=p}static checkKeybindSimilarities(main,keytest,type){let zl=["general"];"general"!==type&&zl.push(type);for(let km of zl)for(let mk of keypressManager.BIND_NAMES[km]){let lc=main[km][mk].split(keypressManager.STRING_SEPARATOR);for(let sj=0;sj<lc.length;sj++){let hl=lc[sj];hl in keytest?keytest[hl]++:keytest[hl]=1}}}static openSettings(type,isReturn){let b=fsw.functions.Keybinds,main=menu.storage.getItem("keyboard"),data=main[type],keytest={};b.checkKeybindSimilarities(main,keytest,type);let a=fsw,mo="general";"general"!==type&&(mo=["gtris","blob"][type]);let json={title_lang:"fsw_kb_ig_"+mo,prevent_default:!0,dpad_behavior:"vertical",scroll_vertical_id:"scroll_y",element:{}};json.element={tag:"gtris-div",attributes:{id:"scroll_y",font_size:2,width:100,height:100,width_type:1,height_type:1,style:{display:"block",position:"relative",overflow:"hidden scroll"}},children:[]};let listIndex=0;for(let y of keypressManager.BIND_NAMES[type]){let _mk=[],lc=data[y].split(keypressManager.STRING_SEPARATOR);for(let u of lc)" "==u?_mk.push("[SPACE BAR]"):_mk.push(u);let mk="",isError=!1;for(let sj=0;sj<lc.length;sj++){let hl=lc[sj];hl in keytest&&keytest[hl]>1&&(isError=!0),mk+=`<span style="padding: 0.4em; margin: 0.6em; background: #646">${_mk[sj]}</span>`,_mk.length-1!==sj&&(mk+=", ")}let bg=isError?"#d66":"#ddd",mjson={tag:"gtris-button",attributes:{font_size:1,width:90,width_type:1,selectable_vertical:`${listIndex}${0==listIndex?"default":""}`,style:{height:"3em",display:"flex","justify-content":"center","align-items":"center","flex-direction":"column",position:"relative","margin-left":"auto","margin-right":"auto",border:"3px solid #000",background:bg,padding:"0.2em 0.2em 0.2em 0.2em"},event_functions:{hoverin:'__this.style.background = "#a3a";',hoverout:`__this.style.background = "${bg}";`,mouseover:"__hover();",select:`__fsw.functions.Keybinds.openFlag("${type}", ${listIndex});`},event_listeners:{mouseover:"mouseover",click:"select"}},children:[{tag:"gtris-button-text",text_lang:`fsw_kb_ig_${mo}_${y}`,attributes:{font_size:1.3,style:{width:"auto",height:"calc(100% - 0.9em)",text_align:"center",position:"relative",display:"blcok"}}}]};mjson.children.push({tag:"gtris-button-text",text_raw:mk,attributes:{font_size:.9,style:{width:"auto",height:"0.9em",position:"relative"}}}),json.element.children.push(mjson),listIndex++}if(isReturn)return JSON.stringify(json);a.loadPageSync(JSON.stringify(json),void 0)}static openFlag(type,flag,isReturn){let b=fsw.functions.Keybinds,main=menu.storage.getItem("keyboard"),data=main[type][keypressManager.BIND_NAMES[type][flag]].split(keypressManager.STRING_SEPARATOR),keytest={};b.checkKeybindSimilarities(main,keytest,type);let a=fsw,mo="general";"general"!==type&&(mo=["gtris","blob"][type]);let mq=keypressManager.BIND_NAMES[type][flag],json={title_lang:"fsw_kb_ig_"+mo,prevent_default:!0,dpad_behavior:"branch",element:{}};json.element={tag:"gtris-div",attributes:{id:"scroll_y",font_size:2,width:100,height:100,width_type:1,height_type:1,style:{display:"block",position:"relative",overflow:"hidden scroll"}},children:[]},json.element.children.push({tag:"gtris-div",attributes:{font_size:2,width:100,width_type:1,style:{display:"flex","flex-direction":"row",position:"relative",height:"auto","justify-content":"center","align-items":"center",overflow:"hidden"}},children:[]}),json.element.children[0].children.push({tag:"gtris-div",attributes:{font_size:4,style:{display:"flex","flex-direction":"column",position:"relative",height:"auto","justify-content":"center","align-items":"center"}},children:[{tag:"gtris-button-text",text_lang:`fsw_kb_ig_${mo}_${mq}`,attributes:{font_size:1.215,style:{text_align:"center",position:"relative","text-align":"center","vertical-align":"center",display:"block"}}},{tag:"gtris-button-text",text_lang:`fsw_kb_ig_${mo}_${mq}_desc`,attributes:{font_size:.9,style:{text_align:"center",position:"relative","text-align":"center","vertical-align":"center",display:"block"}}}]}),json.element.children.push({tag:"gtris-div",attributes:{font_size:2,width:100,width_type:1,style:{display:"flex",position:"relative",height:"auto","justify-content":"center","align-items":"center",overflow:"hidden hidden"}},children:[]}),json.element.children.push({tag:"gtris-div",attributes:{font_size:4,style:{display:"flex","flex-direction":"column",position:"relative",height:"auto","justify-content":"center","align-items":"center"}},children:[{tag:"gtris-button-text",text_lang:"fsw_kb_buttonslist_text",attributes:{font_size:1.215,style:{text_align:"center",position:"relative","text-align":"center","vertical-align":"center",display:"block"}}}]}),json.element.children.push({tag:"gtris-div",attributes:{id:"scroll_x",font_size:2,width:100,width_type:1,style:{display:"flex",position:"relative",height:"auto","justify-content":"flex-start","align-items":"center",overflow:"scroll hidden"}},children:[]}),json.element.children.push({tag:"gtris-div",attributes:{font_size:2,width:100,width_type:1,style:{display:"flex",position:"relative",height:"auto","justify-content":"center","align-items":"center",overflow:"hidden hidden"}},children:[]}),json.element.children[1].children.push({tag:"gtris-button",attributes:{font_size:1,width:7,height:2,width_type:0,height_type:0,selectable:"0|0default",style:{display:"flex","justify-content":"center","align-items":"center","flex-direction":"column",position:"relative","margin-left":"auto","margin-right":"auto",border:"3px solid #000",background:"#ddd",padding:"0.2em 0.2em 0.2em 0.2em"},event_functions:{hoverin:'__this.style.background = "#a3a";',hoverout:'__this.style.background = "#ddd";',mouseover:"__hover();",select:`__fsw.functions.Keybinds.addButton(${type}, ${flag});`},event_listeners:{mouseover:"mouseover",click:"select"}},children:[{tag:"gtris-button-text",text_lang:"fsw_kb_ig_add",attributes:{font_size:1.215,style:{text_align:"center",position:"relative",display:"blcok"}}}]});let listIndex=0;for(let u of data){let mk=u;" "==u&&(mk="[SPACE BAR]");let bg=u in keytest&&keytest[u]>1?"#d66":"#ddd";json.element.children[3].children.push({tag:"gtris-button",attributes:{font_size:1,width:7,height:2,width_type:0,height_type:0,selectable:`1|${listIndex}`,style:{display:"flex","justify-content":"center","align-items":"center","flex-direction":"column",position:"relative","margin-left":"auto","margin-right":"auto",border:"3px solid #000",background:bg,padding:"0.2em 0.2em 0.2em 0.2em"},event_functions:{hoverin:'__this.style.background = "#f3a";',hoverout:`__this.style.background = "${bg}";`,mouseover:"__hover();",select:`__fsw.functions.Keybinds.changeButton(${type}, ${flag}, ${listIndex});`},event_listeners:{mouseover:"mouseover",click:"select"}},children:[{tag:"gtris-button-text",text_raw:mk,attributes:{font_size:1.215,style:{text_align:"center",position:"relative",display:"blcok"}}}]}),listIndex++}if(isReturn)return JSON.stringify(json);a.loadPageSync(JSON.stringify(json),void 0)}static addButton(type,flag){let a=fsw,b=a.functions.Keybinds;alertWindow.showhide(!0);let flagname=keypressManager.BIND_NAMES[type][flag],str=language.translate("fsw_kb_adding_text_you",[language.translate(`fsw_kb_ig_${["gtris","blob"][type]}_${flagname}`)]).split("[nl]").join("<br />"),isUnique=!0,started=!1,del=0,saveTime=-1,isKeyDown=!1,isKeyUp=!1,isDone=!1,isAllGood=!1,keycode="",startable=!0,kk=menu.storage.getItem("keyboard"),data=kk[type][flagname].split(keypressManager.STRING_SEPARATOR);window.addEventListener("mousedown",function mmm(){isDone=!0,isKeyUp=1,del=10,window.removeEventListener("mousedown",mmm)}),keypressManager.isKeyBindingMode=!0,alertWindow.editText(str),keypressManager.addListener("adding",(_keycode,type)=>{if("keydown"==type&&!started){isKeyDown=!0,started=!0,keycode=_keycode;for(let j of data)if(keycode==j){isUnique=!1;break}}if("keyup"==type){if(!started||keycode!==_keycode)return;isKeyUp=!0}}),startable&&(startable=!1,game.addLoop("addingbind",()=>{let mstr="";if(!isKeyUp&&isKeyDown&&(del++,mstr=language.translate("fsw_kb_adding_binding_you",[keycode]),mstr+=`<br /><gs style="display: inline-block; position: relative; border: 2px solid #fff; width: ${.8*fsw.width}px; height: 1em; text-align: left"><gs style="position: relative; background:#fff; width: ${del/60*100}%; display: inline-block; height: 100%"></gs></gs>`,alertWindow.editText(str),1==del&&menu.playSound("keybindready1"),30==del&&menu.playSound("keybindready2"),60==del&&(isDone=!0,isUnique?(menu.playSound("keybindready3"),isAllGood=!0,saveTime=10,data.push(keycode),kk[type][flagname]=data.join(keypressManager.STRING_SEPARATOR),menu.storage.setItem("keyboard",kk)):log.error(language.translate("error_kb_duplicate",[keycode]),language.translate("error_kb_duplicate_desc")),menu.saveFrame=10)),isKeyUp&&(isDone=!0),isDone)do{if(keypressManager.isKeyBindingMode=!1,del>=60?mstr=language.translate("fsw_kb_setting_saving_you",[keycode]):menu.playSound("keybindcancel"),isAllGood&&saveTime>0){if(saveTime--,!(saveTime<=0))break;a.loadPageSync(b.openSettings(type,!0),a.pageIndex-1,!0),a.loadPageSync(b.openFlag(type,flag,!0),a.pageIndex,!1)}game.removeLoop("addingbind"),keypressManager.removeListener("adding"),window.setTimeout(()=>{alertWindow.showhide(!1)},10)}while(0);alertWindow.editText(str+"<br /><br />"+mstr)}))}static changeButton(type,flag,index){let a=fsw,b=a.functions.Keybinds;alertWindow.showhide(!0);let flagname=keypressManager.BIND_NAMES[type][flag],kk=menu.storage.getItem("keyboard"),data=kk[type][flagname].split(keypressManager.STRING_SEPARATOR),activeKeycode=data[index],str=language.translate("fsw_kb_changing_text_you",[language.translate(`fsw_kb_ig_${["gtris","blob"][type]}_${flagname}`),activeKeycode]).split("[nl]").join("<br />"),isUnique=!0,started=!1,del=0,saveTime=-1,isKeyDown=!1,isKeyUp=!1,isDone=!1,isAllGood=!1,keycode="",startable=!0,isRemove=!1;keypressManager.isKeyBindingMode=!0,alertWindow.editText(str),window.addEventListener("mousedown",function mmm(){isDone=!0,isKeyUp=1,del=10,window.removeEventListener("mousedown",mmm)}),keypressManager.addListener("changing",(_keycode,type)=>{if("keydown"==type&&!started){isKeyDown=!0,started=!0,keycode=_keycode;activeKeycode==keycode&&(isRemove=!0);for(let j of data)if(keycode==j){isUnique=!1;break}}if("keyup"==type){if(!started||keycode!==_keycode)return;isKeyUp=!0}}),startable&&(startable=!1,game.addLoop("changingbind",()=>{let mstr="";if(!isKeyUp&&isKeyDown&&(del++,mstr=isRemove?language.translate("fsw_kb_changing_removing_you",[keycode]):language.translate("fsw_kb_changing_binding_you",[keycode]),mstr+=`<br /><gs style="display: inline-block; position: relative; border: 2px solid #fff; width: ${.8*fsw.width}px; height: 1em; text-align: left"><gs style="position: relative; background:#fff; width: ${del/60*100}%; display: inline-block; height: 100%"></gs></gs>`,alertWindow.editText(str),1==del&&menu.playSound("keybindready1"),30==del&&menu.playSound("keybindready2"),60==del&&(isDone=!0,isUnique?(menu.playSound("keybindready3"),isAllGood=!0,saveTime=10,data[index]=keycode,kk[type][flagname]=data.join(keypressManager.STRING_SEPARATOR),menu.storage.setItem("keyboard",kk),menu.saveFrame=10):isRemove||log.error(language.translate("error_kb_duplicate",[keycode]),language.translate("error_kb_duplicate_desc")),isRemove)))do{menu.playSound("keybindready3");let newData=[];for(let i=0;i<data.length;i++)index!=i&&newData.push(data[i]);if(0==newData.length)break;isAllGood=!0,saveTime=10,kk[type][flagname]=newData.join(keypressManager.STRING_SEPARATOR),menu.storage.setItem("keyboard",kk),menu.saveFrame=10}while(0);if(isKeyUp&&(isDone=!0),isDone)do{if(keypressManager.isKeyBindingMode=!1,del>=60?mstr=language.translate("fsw_kb_setting_saving_you",[keycode]):menu.playSound("keybindcancel"),isAllGood&&saveTime>0){if(saveTime--,!(saveTime<=0))break;a.loadPageSync(b.openSettings(type,!0),a.pageIndex-1,!0),a.loadPageSync(b.openFlag(type,flag,!0),a.pageIndex,!1)}game.removeLoop("changingbind"),keypressManager.removeListener("changing"),window.setTimeout(()=>{alertWindow.showhide(!1)},10)}while(0);alertWindow.editText(str+"<br /><br />"+mstr)}))}},Changelog:class{static start(){0===menu.storage.getItem("patchnote_is_seen")&&(fsw.functions.Changelog.open(),menu.storage.setItem("patchnote_is_seen",1),menu.saveFrame=5)}static open(){fsw.loadPage("fsw/changelog.json")}static full(){log.notification(language.translate("fsw_patch_notes_coming_soon"),language.translate("fsw_patch_notes_coming_soon_desc"))}static close(){fsw.close(),menu.storage.setItem("patchnote_is_seen",1),menu.saveFrame=5}},Nameplate:{open(){let json={title_lang:"fsw_nameplate",prevent_default:!0,dpad_behavior:"branch",scroll_vertical:"a",element:{tag:"gtris-div",attributes:{font_size:.7,width:100,height:100,width_type:1,height_type:1,style:{display:"flex","flex-direction":"column","justify-content":"center","align-items":"center",position:"relative",overflow:"hidden hidden"}},children:[{tag:"gtris-div",id:"a",attributes:{font_size:1,width:95,height:4.15,width_type:1,height_type:0,style:{display:"flex","flex-direction":"column","justify-content":"center","align-items":"center",overflow:"hidden scroll"}},children:[{tag:"input",attributes:{id:"editable",font_size:2.5,mattr:{type:"text"},width:90,height:3.1,width_type:1,height_type:0,selectable:"0|0default",event_functions:{hoverin:'__this.style.background = "#a3a";',hoverout:'__this.style.background = "#ddd";',mouseover:"__hover();",select:"__inputfocus()"},value:menu.storage.getItem("playername"),event_listeners:{mouseover:"mouseover",click:"select",focus:"select"},style:{"font-family":"default-ttf",position:"relative",border:"0.1em solid #282",color:"#fff"}}}]},{tag:"gtris-m",attributes:{id:"m",width:100,height:10,width_type:1,height_type:1,style:{display:"flex",position:"relative","flex-direction":"row","justify-content":"center","align-items":"flex-start"}},children:[{tag:"gtris-button",attributes:{id:"save",font_size:1,width:20,height:1.5,width_type:1,height_type:0,selectable:"1|0",style:{display:"flex",position:"relative","justify-content":"center","align-items":"center",border:"3px solid #000",background:"#ddd"},event_functions:{hoverin:'__this.style.background = "#a3a";',hoverout:'__this.style.background = "#ddd";',mouseover:"__hover();",select:'__fsw.functions.Nameplate.save(__getElementId("editable").value);'},event_listeners:{mouseover:"mouseover",click:"select"}},children:[{tag:"gtris-button-text",text_lang:"fsw_nameplate_save",attributes:{font_size:.8,style:{width:"auto",height:"auto",position:"absolute"}}}]},{tag:"gtris-button",attributes:{id:"save",font_size:1,width:20,height:1.5,width_type:1,height_type:0,selectable:"1|1",style:{display:"flex",position:"relative","justify-content":"center","align-items":"center",border:"3px solid #000",background:"#ddd"},event_functions:{hoverin:'__this.style.background = "#a3a";',hoverout:'__this.style.background = "#ddd";',mouseover:"__hover();",select:'__fsw.functions.Nameplate.reset(__getElementId("editable"));'},event_listeners:{mouseover:"mouseover",click:"select"}},children:[{tag:"gtris-button-text",text_lang:"fsw_nameplate_reset",attributes:{font_size:.8,style:{width:"auto",height:"auto",position:"absolute"}}}]}]}]}};fsw.loadPageSync(JSON.stringify(json))},save(_value){let value=_value.trim(),length=value.length,presaved=menu.storage.getItem("playername","");value!==presaved?0!=length?(menu.storage.setItem("playername",value),menu.refreshMenu(),menu.saveFrame=22,fsw.close()):log.warn(language.translate("fsw_nameplate_noname_title"),language.translate("fsw_nameplate_noname_desc")):log.error(language.translate("fsw_nameplate_samename_title"),language.translate("fsw_nameplate_samename_desc",[presaved]))},reset(element){element.value=menu.storage.getItem("playername","")}}};constructor(){this.width=0,this.height=0,this.fontSize=0,this.cellSize=0,this.background=id("GTRIS-SECONDARY-WINDOW-BACKGROUND"),this.window=id("GTRIS-SECONDARY-WINDOW"),this.header={main:id("SW-HEADER"),logo:id("SW-LOGO-DIV"),logoValue:id("SW-LOGO"),back:id("SW-BACK-DIV"),backValue:id("SW-BACK"),title:id("SW-TITLE-DIV"),titleValue:id("SW-TITLE")},this.content=id("SW-CONTENT"),this.isShown=!1,this.isActive=!1,this.frame={start:-1,end:-1,switch:-1},this.pages=[],this.pageIndex=-1,this.bitkey=0,this.lastBitkey=0,this.bindsKeyboard={arrowleft:"left",arrowright:"right",arrowup:"up",arrowdown:"down",enter:"a",backspace:"b"},this.flags={left:8,right:4,up:2,down:1,a:16,b:32},this.animations={switch:new AnimationFrameRenderer(this.content,0,30,1e3/60,{name:"blur-out-in",timing:"ease-in-out"})},this.loadList=[],this.header.back.addEventListener("click",()=>{this.back()}),this.isTextareaFocus=!1}showhide(bool){this.isShown=bool,this.frame.start=-1,this.frame.end=-1,bool?(this.background.style.display="flex",this.frame.start=25):(this.frame.end=25,this.pages.length=0)}close(){this.showhide(!1),this.pages.length=0,this.pageIndex=-1,this.content.innerHTML=""}back(){this.frame.switch>14||(this.pageIndex--,this.pages.pop(),this.pageIndex<=-1?this.showhide(!1):(this.frame.switch=30,this.animations.switch.play()))}startReload(arr){let isPage=!1;for(let m of arr)m.isOpen&&(isPage=!0);isPage&&(this.loadList=arr,this.frame.reload=30)}loadBatch(){let currentPage=this.pageIndex;for(let m of this.loadList){let a=new this.Page(this);a.loadJSON(m.str),this.pages[m.page]=a}for(let m of this.loadList)if(m.isOpen){currentPage=m.page;break}this.loadList.length=0,this.pageIndex=currentPage}loadPage(url,isLoadOnly){load("assets/menu/"+url).then(u=>{this.loadPageSync(u,this.pages.length,isLoadOnly)})}loadPageSync(jsonString,page,isLoadOnly){this.loadList.push({str:jsonString,page:void 0!==page?page:this.pages.length+this.loadList.length,isOpen:!isLoadOnly}),isLoadOnly||(this.frame.switch=30,this.animations.switch.play(),this.loadList.length>=1&&!this.isShown&&this.showhide(!0))}keyInput(c,updown){if(!(c in this.bindsKeyboard)||keypressManager.isKeyBindingMode)return;let bind=this.bindsKeyboard[c],flag=this.flags[bind];this.pages[this.pageIndex];"down"===updown&&(this.bitkey|=flag),"up"===updown&&(this.bitkey^=flag);let a=this.pages[this?.pageIndex||0];a&&a.listen(flag,updown)}update(){this.frame.start>0&&(this.frame.start--,0==this.frame.start&&(this.isActive=!0),this.window.style.setProperty("--cb",bezier(this.frame.start/25,1,0,0,0,0,1))),this.frame.end>0&&(this.frame.end--,0==this.frame.end&&(this.isActive=!1,this.background.style.display="none"),this.window.style.setProperty("--cb",bezier(this.frame.end/25,0,1,0,0,0,1))),this.frame.switch>0&&(this.frame.switch--,15==this.frame.switch&&(this.loadList.length&&this.loadBatch(),this.switchPage(this.pageIndex)),this.window.style.setProperty("--cb",bezier(this.frame.start/25,1,0,0,0,0,1))),this.animations.switch.run(),!this.isActive||this.pageIndex<0||(this.pages[this?.pageIndex||0].update(),this.lastBitkey=this.bitkey)}switchPage(number){this.pageIndex;this.pageIndex=number,this.content.innerHTML="",this.pages,this.content.appendChild(this.pages[number].core),this.resize(this.width,this.height,this.fontSize,this.cellSize)}createElement(json){let a={children:[]};return a}resize(fwidth,fheight,fontSize,cellSize){this.width=fwidth,this.height=fheight,this.fontSize=fontSize,this.cellSize=cellSize,this.background.style.width=~~fwidth+"px",this.background.style.height=~~fheight+"px";let windowWidth=fwidth-cellSize,windowHeight=fheight-cellSize;this.window.style.width="calc(var(--cb) * "+~~windowWidth+"px)",this.window.style.height="calc(var(--cb) * "+~~windowHeight+"px)";let headerHeight=2.25*cellSize;this.header.main.style.width=~~windowWidth+"px",this.header.main.style.height=~~headerHeight+"px";let mwidth=0;for(let hh of["logo","back"])this.header[hh].style.width=~~headerHeight+"px",this.header[hh].style.height=~~headerHeight+"px",mwidth+=~~headerHeight;this.header.title.style.width=~~(windowWidth-mwidth)+"px",this.header.title.style.height=~~headerHeight+"px",this.header.titleValue.style.fontSize=~~(.8*fontSize)+"px",this.content.style.width=~~windowWidth+"px",this.content.style.height=~~(windowHeight-headerHeight)+"px";for(let h of this.pages)h.resizeElements(windowWidth,windowHeight-headerHeight,fontSize,cellSize)}}const fsw=new FullscreenWindow;__main_params__.__private.fsw=fsw;const alertWindow=new class{constructor(){this.isShown=!1,this.a=id("GTRIS-ALERT-WINDOW"),this.text=id("AW-TEXT"),this.frame={hide:0,show:0}}showhide(bool){this.isShown=bool,this.frame.show=-1,this.frame.hide=-1,this.isShown?(styleelem(this.a,"display","flex"),this.frame.show=20):this.frame.hide=20}editText(m){ihelem(this.text,m)}update(){this.frame.show>0&&(this.frame.show--,this.a.style.setProperty("opacity",bezier((20-this.frame.show)/20,0,1,0,0,0,1))),this.frame.hide>0&&(this.frame.hide--,0==this.frame.hide&&styleelem(this.a,"display","none"),this.a.style.setProperty("opacity",bezier(this.frame.hide/20,0,1,0,0,0,1)))}resize(w,h,fs){styleelem(this.a,"width",`${w}px`),styleelem(this.a,"height",`${h}px`),styleelem(this.text,"fontSize",`${fs}px`)}},log=new class{constructor(){this.main=$("ERROR-STACK"),this.a=new ArrayFunctionIterator(at=>{for(let ptl=0;ptl<at.length;ptl++){let pl=at[ptl],element=pl.element;element.parentNode;pl.frame--,15==pl.frame&&pl.delay>0&&(pl.frame=16,pl.delay--),pl.frame>0?styleelem(element,"animation-delay",~~(1e3/-60*Math.min(pl.maxf-pl.frame))+"ms"):(this.main.removeChild(element),at.splice(ptl,1),ptl--)}})}createLog(a){a.style["animation-name"]="error-slide",styleelem(a,"animation-duration",~~(1e3/60*Math.max(0,30))+"ms"),styleelem(a,"animation-iteration-count",1),styleelem(a,"animation-timing-function","ease-in-out"),styleelem(a,"animation-delay",0),styleelem(a,"animation-play-state","paused"),this.main.appendChild(a),this.a.addItem({element:a,frame:30,delay:300,maxf:30})}error_program(event,source,lineno,colno,error){try{elem("gtris-error-error",e=>{let g=document.createElement("gtris-error-source");g.innerHTML=`${source} ${lineno?"@":""}${lineno}`,g.style="border-bottom:0.5px solid #fff;pointer-events:none",e.appendChild(g);let text=document.createElement("gtris-error-source");text.innerHTML=`<br />${error}`,text.style="font-size:0.5em;pointer-events:none",e.appendChild(text),e.style="z-index: 500; position: relative; background: rgba(0, 0, 0, 0.7); margin: 0.5 em; padding: 0.4 em; border-left: 5px solid #f00",this.createLog(e)}),menu.playSound("error")}catch(o){}}error(title,error){try{elem("gtris-error-error",e=>{let g=document.createElement("gtris-error-source");g.innerHTML=title,g.style="border-bottom:0.5px solid #fff;pointer-events:none",e.appendChild(g);let text=document.createElement("gtris-error-source");text.innerHTML=`<br />${error}`,text.style="font-size:0.5em;pointer-events:none",e.appendChild(text),e.style="z-index: 500; position: relative; background: rgba(0, 0, 0, 0.7); margin: 0.5 em; padding: 0.4 em; border-left: 5px solid #f00",this.createLog(e)}),menu.playSound("error")}catch(o){}}notification(title,notification){try{elem("gtris-error-error",e=>{let g=document.createElement("gtris-error-source");g.innerHTML=title,g.style="border-bottom:0.5px solid #fff;pointer-events:none",e.appendChild(g);let text=document.createElement("gtris-error-source");text.innerHTML=`<br />${notification}`,text.style="font-size:0.5em;pointer-events:none",e.appendChild(text),e.style="z-index: 500; position: relative; background: rgba(0, 0, 0, 0.7); margin: 0.5 em; padding: 0.4 em; border-left: 5px solid #70f",this.createLog(e)}),menu.playSound("notification")}catch(o){}}warn(title,notification){try{elem("gtris-error-error",e=>{let g=document.createElement("gtris-error-source");g.innerHTML=title,g.style="border-bottom:0.5px solid #fff;pointer-events:none",e.appendChild(g);let text=document.createElement("gtris-error-source");text.innerHTML=`<br />${notification}`,text.style="font-size:0.5em;pointer-events:none",e.appendChild(text),e.style="z-index: 500; position: relative; background: rgba(0, 0, 0, 0.7); margin: 0.5 em; padding: 0.4 em; border-left: 5px solid #ff0",this.createLog(e)}),menu.playSound("exclam")}catch(o){}}run(){this.a.update()}};